(function ($, undefined) {
    $.widget('ui.docViewer', {
        _viewModel: null,
        options: {
            fileId: 0,
            fileVersion: 1,
            userId: 0,
            userKey: null,
            baseUrl: null,
            _mode: 'full',
            _docGuid: '',
            quality: null,
            use_pdf: "true",
            showHyperlinks: true
        },

        _create: function () {
            $.extend(this.options, {
                documentSpace: this.element,
                emptyImageUrl: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII="
            });
            if (this.options.createHtml) {
                this._createHtml();
            }
            this._viewModel = this.getViewModel();
            ko.applyBindings(this._viewModel, this.element.get(0));
        },

        _init: function () {
            $(this._viewModel).bind('getPagesCount', function (e, pagesCount) {
                $(this.element).trigger('getPagesCount', [pagesCount]);
            }.bind(this));

            $(this._viewModel).bind('onDocumentLoaded', function (e, response) {
                this.element.trigger('onDocumentLoaded', response);
            }.bind(this));

            $(this._viewModel).bind('onDocumentPasswordRequired', function (e) {
                $(this.element).trigger('onDocumentPasswordRequired');
            }.bind(this));

            $(this._viewModel).bind('_onProcessPages', function (e, data) {
                $(this.element).trigger('_onProcessPages', [data]);
            }.bind(this));

            $(this._viewModel).bind('onProcessPages', function (e, guid) {
                $(this.element).trigger('onProcessPages', [guid]);
            }.bind(this));

            $(this._viewModel).bind('onScrollDocView', function (e, data) {
                $(this.element).trigger('onScrollDocView', [data]);
            }.bind(this));

            $(this._viewModel).bind('onBeforeScrollDocView', function (e, data) {
                $(this.element).trigger('onBeforeScrollDocView', [data]);
            }.bind(this));

            $(this._viewModel).bind('onDocumentLoadComplete', function (e, data, pdf2XmlWrapper) {
                $(this.element).trigger('onDocumentLoadComplete', [data, pdf2XmlWrapper]);
            }.bind(this));

            $(this._viewModel).bind('onSearchPerformed', function (e, searchCountItem) {
                $(this.element).trigger('onSearchPerformed', [searchCountItem]);
            }.bind(this));

            $(this._viewModel).bind('onPageImageLoaded', function (e) {
                $(this.element).trigger('onPageImageLoaded');
            }.bind(this));

            $(this._viewModel).bind('onDocViewScrollPositionSet', function (e, data) {
                $(this.element).trigger('onDocViewScrollPositionSet', [data]);
            }.bind(this));

            $(this._viewModel).bind('onDocumentPageSet', function (e, newPageIndex) {
                $(this.element).trigger('onDocumentPageSet', [newPageIndex]);
            }.bind(this));
        },

        getViewModel: function () {
            if (this._viewModel == null) {
                this._viewModel = this._createViewModel();
            }

            return this._viewModel;
        },

        _createViewModel: function () {
            var vm = new docViewerViewModel(this.options);
            return vm;
        },

        applyBindings: function () {
            ko.applyBindings(this._viewModel, this.element.get(0));
        },

        _createHtml: function () {
            var rotationMarkup;
            if (this.options.supportPageRotation) {
                rotationMarkup = ' + \' translateY(\' + (($root.isHtmlDocument() && $data.rotation() == 180) ? \'100%\' : \'0\') + \') \' +' +
                    ' \'rotate(\' + $data.rotation() + \'deg)\' +' +
                    ' \' translateX(\' + (($data.rotation() == 180 || $data.rotation() == 270) ? \'-100%\' : \'0\') + \')\' +' +
                    ' \' translateY(\' + (($data.rotation() == 90 || (!$root.isHtmlDocument() && $data.rotation() == 180)) ? \'-100%\' : \'0\') + \') \'  ';
            }
            else {
                rotationMarkup = "";
            }

            var msScale = '\'-ms-transform\': \'scale(\' + $data.heightRatio() * $root.zoom() / 100.0 + \')\' ';

            if (this.options.pageContentType == "html" && $.browser.msie) {
                if ($.browser.version == 8)
                    msScale = 'zoom: $data.heightRatio() * $root.zoom() / 100.0 ';
                else {
                    msScale += rotationMarkup;
                }
            }
            msScale += ",";

            var htmlBasedWatermarkMarkup;
            if (this.options.watermarkText) {
                htmlBasedWatermarkMarkup =
                '<svg xmlns="http://www.w3.org/2000/svg" class="html_watermark" data-bind="attr:{width: $root.pageWidth() + $root.imageHorizontalMargin + \'px\', height: $root.pageWidth() * $data.prop() + \'px\', viewBox:\'0 0 100 \' + 100 * $data.prop()}" pointer-events="none">' +
                        '<text data-bind="text:$root.watermarkText, style:{fill:$root.intToColor($root.watermarkColor)}, ' +
                        'attr:{transform:$root.watermarkTransform($data, $element), ' +
                        'y:$root.watermarkPosition.indexOf(\'Top\') == -1 ? 100 * $data.prop() :\'10\'}" font-family="Verdana" font-size="10" x="0" y="0" ></text>' +
                        '</svg>';
            }
            else {
                htmlBasedWatermarkMarkup = "";
            }
            var htmlPageContentsWithTransformScaling =
'           <div class="html_page_contents"' +
'                 data-bind="' + (this.options.useVirtualScrolling ? 'parsedHtml' : 'html') + ': htmlContent(), ' +
                         'attr: { id:\'' + this.options.docViewerId + 'pageHtml-\' + number }, ' +
                         'searchText: searchText, ' +
'                        css: {chrome: $root.browserIsChrome(), \'page-image\': !$root.useTabsForPages()}, ' +
'                        style: { ' +
'                                 width: $root.rotatedWidth(), ' +
            msScale +
'                                 MozTransform: \'scale(\' + $data.heightRatio() * $root.zoom() / 100.0  + \')\' ' + rotationMarkup + ', ' +
'                                 \'-webkit-transform\': \'scale(\' + $data.heightRatio() * $root.zoom() / 100.0  + \')\' ' + rotationMarkup +
'                               }">' +
'            </div>' + htmlBasedWatermarkMarkup;

            var htmlPageContentsWithEmScaling =
'           <div class="page-image html_page_contents"' +
'                 data-bind="html: htmlContent, attr: { id:\'' + this.options.docViewerId + 'pageHtml-\' + number }, ' +
'                        searchText: searchText, ' +
'                        style:{fontSize: ($data.heightRatio() * 100.0) + \'%\'},' +
'                        css: {chrome: $root.browserIsChrome()} ">' +
'            </div>';

            var htmlPageContents;
            if (this.options.useEmScaling)
                htmlPageContents = htmlPageContentsWithEmScaling;
            else
                htmlPageContents = htmlPageContentsWithTransformScaling;

            var pagesContainerElementHtml;
            var useHtmlBasedEngine = (this.options.pageContentType == "html");
            if (useHtmlBasedEngine && this.options.useEmScaling) {
                pagesContainerElementHtml = 'class="pages_container html_pages_container" data-bind="style:{fontSize: (16.* $root.zoom() / 100.0) + \'px\'}"';
            }
            else {
                pagesContainerElementHtml = 'class="pages_container ' + (useHtmlBasedEngine ? 'html_pages_container' : '') + '" data-bind="style: { height: $root.useVirtualScrolling ? ($root.documentHeight() + \'px\') : \'auto\', width: ($root.layout() == $root.Layouts.TwoPagesInRow || $root.layout() == $root.Layouts.CoverThenTwoPagesInRow) ? ($root.pageWidth() + $root.imageHorizontalMargin) * 2 + \'px\': \'auto\'}"';
            }

            var viewerHtml =

'<div id="' + this.options.docViewerId + 'PagesContainer" ' + pagesContainerElementHtml + '>' +
    '<!-- ko foreach: { data: $root.useVirtualScrolling ? pages.slice(firstVisiblePageForVirtualMode(), lastVisiblePageForVirtualMode() + 1) : pages, afterRender: function(){$root.visiblePagesChangedHandler();} } -->' +
    '<div class="doc-page" data-bind="attr: {id: $root.pagePrefix + (($root.useVirtualScrolling ? $root.firstVisiblePageForVirtualMode() : 0) + $index() + 1)}, style: $root.pageElementStyle($index()), css: {cover_page: ($root.layout() == $root.Layouts.CoverThenTwoPagesInRow && ($root.useVirtualScrolling ? $root.firstVisiblePageForVirtualMode() : 0) + $index() == 0)}" >' +

'       <div class="viewer_loading_overlay" data-bind="visible: ($root.alwaysShowLoadingSpinner() || $root.inprogress() || !visible()), style: { zIndex: ($root.inprogress() || !visible() ? 2 : 0), width: $root.pageWidth() + \'px\', height: $parent.pageWidth() * $data.prop() + \'px\', backgroundColor: ($root.inprogress() || !visible() ? \'\' : \'transparent\')}" style="width: 850px; height: 1100px;position: absolute;left:0;top:0">' +
'           <div class="loading_overlay_message">' +
'               <span class="progresspin"></span>' +
'               <p data-localize="LoadingYourContent">Loading your content...</p>' +
'           </div>' +
'       </div>' +

(useHtmlBasedEngine ?
(
    htmlPageContents
)
:
'           <div class="button-pane"></div>' +
'           <div class="highlight-pane"></div>' +
'           <div class="custom-pane"></div>' +
'           <div class="search-pane"></div>' +
'           <img class="page-image" src="' + this.options.emptyImageUrl + '" data-bind="event: {load: function(item, e){$root.firePageImageLoadedEvent($index(), e);}, error: function(item, e){$root.firePageImageLoadErrorEvent($index(), e);} }, attr: { id: \'' + this.options.docViewerId + '\' + \'-img-\' + ($index() + 1), src: (visible() ? url : $root.emptyImageUrl) }, ' +
'           style: { width: $parent.pageWidth() + \'px\', height: $parent.pageWidth() * $data.prop() + \'px\' }"/>'
) +

'   </div>' +
    '<!-- /ko -->' +

'</div>' +

'<div class="tab_control_wrapper" data-bind="visible: useTabsForPages && tabs().length > 0">' +
'<ul class="doc_viewer_tab_control" data-bind="foreach: tabs, visible: useTabsForPages && tabs().length > 0">' +
'   <li data-bind="css:{active:$index() == $root.activeTab()}">' +
'      <a href="#" data-bind="text:name, click: function(){$root.activateTab($index());}"></a>' +
'   </li>' +
'</ul>' +
'</div>';

            var root = this.element;
            $(viewerHtml).appendTo(root);
            root.trigger("onHtmlCreated");
            this.element = $("#" + this.options.docViewerId);
        }
    });

    // Doc Viewer Model
    docViewerModel = function (options) {
        $.extend(this, options);
        this._init();
    };

    $.extend(docViewerModel.prototype, {
        _init: function () {
            this._portalService = Container.Resolve("PortalService");
        },

        loadDocument: function (fileId, pagesCountToShow, imageWidth, password, fileDisplayName,
                                watermarkText, watermarkColor, watermarkPosition, watermarkWidth,
                                ignoreDocumentAbsence,
                                supportPageRotation,
                                supportListOfContentControls, supportListOfBookmarks,
                                instanceIdToken,
                                callback, errorCallback,
                                locale, passwordForOpening) {
            var self = this;
            var onSucceded = function (response) {
            	var guid;
                if (response.data != null) {
                	if (response.data.path && typeof response.data.guid == "undefined")
                		response.data.guid = response.data.path;

                    if (self._mode == 'webComponent')
                        guid = response.data.path;
                    else
                        guid = response.data.guid;
                }
                
                if (typeof guid !== "undefined") {
                    callback.apply(this, [response.data]);
                }
                else {
                    errorCallback.apply(this, [{ code: response.data.code, Reason: (response.data ? response.data.Reason : null) }]);
                }
            };

            switch (this._mode) {
                case 'embed':
                    this._portalService.viewEmbedDocumentAllAsync(this.userId, this.userKey, fileId, imageWidth, this.quality, this.use_pdf, this.preloadPagesCount, password, fileDisplayName, onSucceded, errorCallback);
                    break;
                case 'webComponent':
                    this._portalService.viewDocument(fileId, imageWidth, this.quality, this.usePdf, this.preloadPagesCount, password, fileDisplayName,
                        watermarkText, watermarkColor, watermarkPosition, watermarkWidth,
                        ignoreDocumentAbsence, supportPageRotation,
                        supportListOfContentControls, supportListOfBookmarks,
                        onSucceded, errorCallback,
                        false,
                        instanceIdToken,
                        locale,
                        passwordForOpening
                    );
                    break;
                case 'annotatedDocument':
                    this._portalService.viewAnnotatedDocumentAsync(this.userId, this.userKey, fileId, null, pagesCountToShow, imageWidth, null, this.quality, this.use_pdf, { text: watermarkText, color: watermarkColor, position: watermarkPosition, fontSize: watermarkWidth }, onSucceded, errorCallback, false);
                    break;
                default:
                    this._portalService.viewDocumentAllAsync(this.userId, this.userKey, fileId, null, pagesCountToShow, imageWidth, null, this.quality, this.use_pdf, onSucceded, errorCallback, false);
                    break;
            }
        },

        loadDocumentAsHtml: function (fileId, pagesCountToShow, fileDisplayName, usePngImages, convertWordDocumentsCompletely,
                                      watermarkText, watermarkColor, watermarkPosition, watermarkWidth,
                                      ignoreDocumentAbsence, supportPageRotation,
                                      supportListOfContentControls, supportListOfBookmarks,
                                      embedImagesIntoHtmlForWordFiles,
                                      instanceIdToken,
                                      saveFontsInAllFormats,
                                      callback, errorCallback, locale, passwordForOpening) {
            this._portalService.viewDocumentAsHtml(this.userId, this.userKey, fileId, this.preloadPagesCount, fileDisplayName, usePngImages,
                                                   convertWordDocumentsCompletely,
                                                   watermarkText, watermarkColor, watermarkPosition, watermarkWidth,
                                                   ignoreDocumentAbsence, supportPageRotation,
                                                   supportListOfContentControls, supportListOfBookmarks,
                                                   embedImagesIntoHtmlForWordFiles,
                                                   saveFontsInAllFormats,
                function (response) {
                    if (response.data && typeof (response.data.path) !== "undefined") {
                        callback.apply(this, [response.data]);
                    }
                    else {
                        errorCallback.apply(this);
                    }
                },
                function (error) {
                    errorCallback.apply(this, [error]);
                },
                false,
                instanceIdToken,
                locale,
                passwordForOpening
            );
        },

        loadProperties: function (fileId, callback) {
            this._portalService.getDocInfoAsync(this.userId, this.userKey, fileId,
                function (response) {
                    callback.apply(this, [response.data]);
                });
        },

        loadHyperlinks: function (fileId, callback, errorCallback) {
            this._portalService.getDocumentHyperlinks(fileId,
                function (response) {
                    callback.apply(this, [response.data]);
                },
                function (error) {
                    errorCallback.apply(this, [error]);
                });
        },

        retrieveImageUrls: function (fileId, token, imageCount, pagesDimension,
                                         watermarkText, watermarkColor,
                                         watermarkPosition, watermarkWidth,
                                         ignoreDocumentAbsence,
                                         useHtmlBasedEngine,
                                         supportPageRotation,
                                         instanceIdToken,
                                         callback, errorCallback,
                                         locale) {
            this._portalService.getImageUrlsAsync(this.userId, this.userKey, fileId, pagesDimension, token, 0, imageCount, this.quality == null ? '' : this.quality, this.use_pdf, this.fileVersion,
                                              watermarkText, watermarkColor, watermarkPosition, watermarkWidth,
                                              ignoreDocumentAbsence,
                                              useHtmlBasedEngine, supportPageRotation,
            function (response) {
                callback.apply(this, [response.data]);
            },
            function (error) {
                errorCallback.apply(this, [error]);
            },
            instanceIdToken,
            locale
        );
        },

        getDocumentPageHtml: function (fileId, pageNumber, usePngImages,
                                       embedImagesIntoHtmlForWordFiles,
                                       instanceIdToken,
                                       saveFontsInAllFormats,
                                       callback, errorCallback, locale) {
            this._portalService.getDocumentPageHtml(fileId, pageNumber, usePngImages,
                embedImagesIntoHtmlForWordFiles,
                saveFontsInAllFormats,
                function (response) {
                    callback.apply(this, [response.data]);
                },
                function (error) {
                    errorCallback.apply(this, [error]);
                },
                instanceIdToken,
                locale
            );
        },

        reorderPage: function (fileId, oldPosition, newPosition, instanceIdToken, callback, errorCallback) {
            this._portalService.reorderPage(fileId, oldPosition, newPosition,
                function (response) {
                    callback.apply(this, [response.data]);
                },
                function (error) {
                    errorCallback.apply(this, [error]);
                },
                instanceIdToken
            );
        },

        rotatePage: function (path, pageNumber, rotationAmount, instanceIdToken, successCallback, errorCallback) {
            this._portalService.rotatePage(path, pageNumber, rotationAmount,
                function (response) {
                    successCallback.apply(this, [response.data]);
                },
                function (error) {
                    errorCallback.apply(this, [error]);
                },
                instanceIdToken
            );
        }
    });

    // Doc Viewer View Model
    docViewerViewModel = function (options) {
        $.extend(this, options);
        this._create(options);
    };
    $.extend(docViewerViewModel.prototype, {
        Layouts: { ScrollMode: 1, BookMode: 2, OnePageInRow: 3, TwoPagesInRow: 4, CoverThenTwoPagesInRow: 5 },
        _model: null,
        pagesDimension: null,
        pageImageWidth: 0,
        imageHorizontalMargin: 34,
        pageWrapperHorizontalMargin: 7,
        imageVerticalMargin: 0,
        initialZoom: 100,
        zoom: null,
        scale: null,
        docWasLoadedInViewer: false,
        scrollPosition: [0, 0],
        inprogress: null,
        pages: null,
        pageInd: null,
        pageWidth: null,
        pageHeight: null,
        pageCount: null,
        docType: null,
        fileId: null,
        _dvselectable: null,
        _thumbnailHeight: 140,
        _firstPage: null,
        _sessionToken: '',
        imageUrls: [],
        pagePrefix: "page-",
        documentName: null,
        fit90PercentWidth: false,
        _pageBounds: null,
        unscaledPageHeight: null,
        unscaledPageWidth: null,
        pageLeft: null,
        preloadPagesCount: null,
        viewerLayout: 1,
        changedUrlHash: false,
        hashPagePrefix: "page",
        pageContentType: "image",
        scrollbarWidth: null,
        password: null,
        useJavaScriptDocumentDescription: false,
        minimumImageWidth: null,
        fileDisplayName: null,
        hyperlinks: null,
        watermarkText: null,
        watermarkWidth: null,
        watermarkColor: null,
        watermarkLeft: null,
        watermarkTop: null,
        watermarkScreenWidth: null,
        searchText: null,
        htmlSearchHighlightClassName: "search_highlight_html",
        htmlSearchHighlightElement: "span",
        htmlSearchHighlightSvgElement: "tspan",
        currentWordCounter: 0,
        matchedNods: null,
        searchMatches: null,
        matchedNodsCount: 0,
        matchesCount: null,
        searchSeparatorsList: "\\-[\\]{}()*+?\\\\^|\\s.,:;+\"/",
        usePngImagesForHtmlBasedEngine: false,
        loadAllPagesOnSearch: false,
        serverPages: null,
        convertWordDocumentsCompletely: false,
        ignoreDocumentAbsence: false,
        tabs: null,
        useTabsForPages: null,
        tabPanelHeight: 30,
        supportPageRotation: false,
        fileType: null,
        activeTab: null,
        autoHeight: null,
        isHtmlDocument: null,
        rotatedWidth: null,
        alwaysShowLoadingSpinner: null,
        supportListOfContentControls: false,
        supportListOfBookmarks: false,
        isDocumentLoaded: false,
        _isTextPositionsCalculationFinished: true,
        initStorageOnMouseStart: false,
        
        options: {
            showHyperlinks: true
        },

        _create: function (options) {
            this._model = new docViewerModel(options);
            this._init(options);
        },

        _init: function (options) {
            var self = this;
            this.initCustomBindings();

            if (this.viewerLeft != 0) {
                this.viewerWidth -= this.viewerLeft;
                this.documentSpace.css("width", this.viewerWidth + "px");
            }
            var defaultPageImageWidth = 852;
            var defaultPageImageHeight = 1100;
            this.pageImageWidth = defaultPageImageWidth;

            this.pages = ko.observableArray([]);
            this.scale = ko.observable(this.initialZoom / 100);
            this.inprogress = ko.observable(false),
            this.pageLeft = ko.observable(0);
            this.pageInd = ko.observable(1);
            this.pageWidth = ko.observable(defaultPageImageWidth);
            this.pageHeight = ko.observable(defaultPageImageHeight);
            this.pageCount = ko.observable(0);
            this.docType = ko.observable(-1);
            this.documentName = ko.observable("");
            this.password = ko.observable("");
            this.preloadPagesCount = options.preloadPagesCount;
            this.browserIsChrome = ko.observable(false);
            this.hyperlinks = ko.observableArray();
            this.useTabsForPages = ko.observable(null); // it's undefined 
            this.tabs = ko.observableArray([]);
            this.activeTab = ko.observable(0);
            this.autoHeight = ko.observable(false);
            this.isHtmlDocument = ko.observable(false);
            this.alwaysShowLoadingSpinner = ko.observable(false);
            this.rotatedWidth = ko.computed(function () {
                if (this.useTabsForPages()) {
                    var width;
                    width = this.pageWidth();
                    if (this.autoHeight())
                        return "auto";
                    return width / this.zoom() * 100.0 + "px";
                }
                else
                    return "auto";
            }, this);

            this.layout = ko.observable(this.viewerLayout);
            this.firstVisiblePageForVirtualMode = ko.observable(0)
                .extend({ rateLimit: { method: "notifyWhenChangesStop", timeout: 400 } });;
            this.lastVisiblePageForVirtualMode = ko.observable(0)
                .extend({ rateLimit: { method: "notifyWhenChangesStop", timeout: 400 } });;
            this.documentHeight = ko.observable(0);

            if (this.pageContentType == "html") {
                this.imageHorizontalMargin = 0;
                this.calculatePointToPixelRatio();
            }

            if (!this.docViewerId)
                this.docViewerId = this.documentSpace.attr('id');
            this.pagePrefix = this.docViewerId + "-page-";

            if (options.fit90PercentWidth)
                this.pageImageWidth = this.documentSpace.width() * 0.9 - 2 * this.imageHorizontalMargin;

            if (this.pageContentType == "image")
                this.initialWidth = this.pageImageWidth;

            if (this.zoomToFitWidth) {
                this.initialWidth = this.pageImageWidth = this.getFitWidth();
            }

            this.zoom = ko.observable(this.initialZoom);
            this.documentHeight = ko.observable(0);

            this.options.showHyperlinks = (options.showHyperlinks != false && this.use_pdf != 'false');
            this.options.highlightColor = options.highlightColor;
            this.matchedNods = [];
            this.searchMatches = [];
            this.serverPages = [{ w: this.initialWidth, h: 100 }];

            var pageDescription;
            if (this.pages().length == 0) {
                pageDescription = { number: 1, visible: ko.observable(false), url: ko.observable(this.emptyImageUrl), htmlContent: ko.observable(""), searchText: ko.observable(null) };
                if (this.supportPageRotation)
                    pageDescription.rotation = ko.observable(0);
                if (this.variableHeightPageSupport) {
                    pageDescription.prop = ko.observable(1);
                    pageDescription.heightRatio = ko.observable(1);
                }
                if (this.useVirtualScrolling) {
                    pageDescription.left = 0;
                    pageDescription.top = ko.observable(0);
                }
                this.pages.push(pageDescription);
            }
            this.pagesContainerElement = this.documentSpace.find(".pages_container");
            this.contentControlsFromHtml = new Array();

            if (options.fileId) {
                this.loadDocument();
            }
            else {
                pageDescription.visible(true);
            }
        },

        loadDocument: function (fileId) {
            this.inprogress(true);
            this.documentSpace.trigger('onDocumentloadingStarted');

            var functionErrorCallback = function(error) {
                this._onDocumentLoadFailed(error, fileId || this.fileId);
            };

            var pageCountToShow = 1;
            if (this.pageContentType == "image") {
                var pageWidth;
                if (this.shouldMinimumWidthBeUsed(this.pageImageWidth * this.initialZoom / 100, false))
                    pageWidth = this.minimumImageWidth;
                else
                    pageWidth = Math.round(this.pageImageWidth * this.initialZoom / 100);

                this._model.loadDocument(fileId || this.fileId, pageCountToShow, pageWidth, this.password(), this.fileDisplayName,
                    this.watermarkText, this.watermarkColor, this.watermarkPosition, this.watermarkWidth,
                    this.ignoreDocumentAbsence, this.supportPageRotation,
                    this.supportListOfContentControls, this.supportListOfBookmarks,
                    this.instanceIdToken,
                    function (response) {
                        //this._onDocumentLoaded(response);
                        if (typeof (fileId) !== 'undefined')
                            this.fileId = fileId;
                        this.pageWidth(this.pageImageWidth * (this.initialZoom / 100));
                        this.zoom(this.initialZoom);
                        if (this.docWasLoadedInViewer)
                            this.setPageNumerInUrlHash(1);

                        this._onDocumentLoadedBeforePdf2Xml(response);
                        //this.preloadImages(response, this.preloadPagesCount);
                    }.bind(this),
                    functionErrorCallback.bind(this),
                    this.locale,
                    this.passwordForOpening
                );
            }
            else if (this.pageContentType == "html") {
                this._model.loadDocumentAsHtml(fileId || this.fileId, pageCountToShow, this.fileDisplayName, this.usePngImagesForHtmlBasedEngine,
                    this.convertWordDocumentsCompletely,
                    this.watermarkText, this.watermarkColor, this.watermarkPosition, this.watermarkWidth,
                    this.ignoreDocumentAbsence, this.supportPageRotation,
                    this.supportListOfContentControls, this.supportListOfBookmarks,
                    this.embedImagesIntoHtmlForWordFiles,
                    this.instanceIdToken,
                    this.saveFontsInAllFormats,
                    function (response) {
                        if (typeof (fileId) !== 'undefined')
                            this.fileId = fileId;
                        this.pageWidth(this.pageImageWidth * (this.initialZoom / 100));
                        this._onDocumentLoadedBeforePdf2Xml(response);
                        //this._onDocumentLoaded(response);
                    }.bind(this),
                    functionErrorCallback.bind(this),
                    this.locale,
                    this.passwordForOpening
                );
            }

            if (typeof viewModelPathOnlineDoc !== 'undefined')
                viewModelPathOnlineDoc.pathOnlineDoc('');
        },

        getDocumentPageHtml: function (pageNumber, successCallback) {
            var page;
            if (this.useTabsForPages()) {
                page = this.tabs()[pageNumber];
            }
            else {
                page = this.pages()[pageNumber];
            }

            if (!page.visible() && !page.startedDownloadingPage) {
                var pageHtml = this.preloadedPages && this.preloadedPages.html[pageNumber];
                if (pageHtml) {
                    page.htmlContent(pageHtml);
                    var pageCss = this.preloadedPages.css[pageNumber];
                    this.setPageHtml(page, pageNumber, pageHtml, pageCss);
                    if (successCallback)
                        successCallback.call();
                    return;
                }

                page.startedDownloadingPage = true;
                this._model.getDocumentPageHtml(this.fileId, pageNumber, this.usePngImagesForHtmlBasedEngine,
                    this.embedImagesIntoHtmlForWordFiles,
                    this.instanceIdToken,
                    this.saveFontsInAllFormats,
                    function (response) {
                        this.setPageHtml(page, pageNumber, response.pageHtml, response.pageCss);
                        if (successCallback)
                            successCallback.call();
                    }.bind(this),
                    function (error) {
                        page.startedDownloadingPage = false;
                        this._onError(error);
                    }.bind(this),
                    this.locale
                );
            }
        },


        setPageHtml: function (page, pageNumber, pageHtml, pageCss) {
            var css = pageCss;

            if (!this.pageCssElement)
                this.pageCssElement = $([]);

            if (this.browserIsIE9OrLess) {
                var firstStyle = this.pageCssElement.filter("style:first");
                css = firstStyle.html();
                firstStyle.remove();
                css += pageCss;
            }

            var styleElement = $("<style type='text/css'>" + css + "</style>");
            this.pageCssElement = this.pageCssElement.add(styleElement);
            styleElement.appendTo("head");

            var useTabsForPages = this.useTabsForPages();
            if (useTabsForPages || useTabsForPages === null) { // null means no document loaded
                pageHtml = pageHtml.replace(/^[\r\n\s]+|[\r\n\s]+$/g, "");
            }

            page.htmlContent(pageHtml);

            var searchParameters = {
                text: this.searchText,
                isCaseSensitive: false,
                searchForSeparateWords: this.searchForSeparateWords,
                treatPhrasesInDoubleQuotesAsExact: this.treatPhrasesInDoubleQuotesAsExact,
                pageNumber: pageNumber
            };

            if (this.useVirtualScrolling) {
                page.parsedHtmlElement = $(pageHtml);
                page.currentValue = pageHtml;
                this.parseSearchParameters(page.parsedHtmlElement.not("style")[0], searchParameters);
            }
            page.searchText(searchParameters);
            page.visible(true);
            page.startedDownloadingPage = false;
            this.markContentControls(pageNumber);
        },

        addPageCss: function (pageCss) {
            var css = pageCss;

            if (!this.pageCssElement)
                this.pageCssElement = $([]);

            if (this.browserIsIE9OrLess) {
                var firstStyle = this.pageCssElement.filter("style:first");
                css = firstStyle.html();
                firstStyle.remove();
                css += pageCss;
            }

            var styleElement = $("<style type='text/css'>" + css + "</style>");
            this.pageCssElement = this.pageCssElement.add(styleElement);
            styleElement.appendTo("head");
        },

        retrieveImageUrls: function (imageCount) {
            var i;
            var pageDimension, pageWidth;
            if (this.shouldMinimumWidthBeUsed(this.pageWidth(), true))
                pageWidth = this.minimumImageWidth;
            else
                pageWidth = this.pageWidth();

            pageDimension = Math.floor(pageWidth) + "x";
            
            this._model.retrieveImageUrls(this.fileId, this._sessionToken, imageCount, (this._mode == 'webComponent' ? Math.floor(pageWidth) : pageDimension),
                this.watermarkText, this.watermarkColor, this.watermarkPosition, this.watermarkWidth,
                this.ignoreDocumentAbsence,
                this.useHtmlBasedEngine, this.supportPageRotation,
                this.instanceIdToken,
                function (response) {
                    var imageUrls;
                    if (response.imageUrls && typeof response.image_urls == "undefined")
                        imageUrls = response.imageUrls;
                    else
                        imageUrls = response.image_urls;

                    for (i = 0; i < imageCount; i++) {
                        this.pages()[i].url(imageUrls[i]);
                        this.loadImagesForVisiblePages();
                    }
                }.bind(this),
                function (error) {
                    this._onError(error);
                }.bind(this),
                this.locale);
        },

        _onError: function (error, fileId) {
            this.inprogress(false);
            var errorFunction = window.jerror || (window.jGDError && window.jGDError[this.instanceId]);
            if (errorFunction)
                errorFunction(error.Reason || "The document couldn't be loaded...", error.ErrorCode , fileId);
        },

        _onDocumentLoadFailed: function (error, fileId) {
            this.inprogress(false);

            if (error.code == 'Unauthorized')
                $(this).trigger('onDocumentPasswordRequired');
            else {
                this._onError(error, fileId);
                this.documentSpace.trigger("documentLoadFailed.groupdocs");
            }
        },

        _onDocumentLoadedBeforePdf2Xml: function (response) {
            var self = this;

            function callOnDocumentLoaded() {
                self._onDocumentLoaded(response);
            }

            if (response.path && typeof response.guid == "undefined")
                response.guid = response.path;

            var options = {
                userId: this.userId,
                privateKey: this.userKey,
                fileId: this.fileId,
                guid: response.guid,
                documentDescription: response.documentDescription,
                callback: callOnDocumentLoaded,
                setTextPositionsCalculationFinishedCallback: this._setTextPositionsCalculationFinished,
                viewerThis: this
            };

            if (this.useJavaScriptDocumentDescription) {
                options.synchronousWork = this.textSelectionSynchronousCalculation;
                options.descForHtmlBasedEngine = (this.pageContentType == "html"
                    || this.use_pdf == 'false');
                this._pdf2XmlWrapper = new jGroupdocs.Pdf2JavaScriptWrapper(options);
                this._onDocumentLoaded(response);
            }
            else {
                if (this.use_pdf == 'false')
                    this._onDocumentLoaded(response);
                else
                    this._pdf2XmlWrapper = new jSaaspose.Pdf2XmlWrapper(options);
            }
        },

        _onDocumentLoaded: function (response) {
        	this.isDocumentLoaded = true;

            if (this.useJavaScriptDocumentDescription) {
                response.page_count = this._pdf2XmlWrapper.getPageCount();
            }
            else if (typeof response.page_count == "undefined" && response.documentDescription) {
                var documentDescription = JSON.parse(response.documentDescription);
                if (documentDescription.pages && typeof documentDescription.pages.length != "undefined")
                    response.page_count = documentDescription.pages.length;
                // for compatibility with Comparison which does not use Pdf2JavaScriptWrapper
            }

            if (response.docType && typeof response.doc_type == "undefined")
                response.doc_type = response.docType;

            if (response.imageUrls && typeof response.image_urls == "undefined")
                response.image_urls = response.imageUrls;

            if (response.path && typeof response.guid == "undefined")
                response.guid = response.path;
                
            if (!response.page_size)
                response.page_size = {};

            $(this).trigger('onDocumentLoaded', response);
            var self = this;

            this._sessionToken = response.token;
            this.docGuid = response.guid;            
            this.pageCount(response.page_count);
            this.documentName(response.name);
            this.docType(response.doc_type);
            this.password(response.password);
            this.matchesCount = 0;

            $(this).trigger('getPagesCount', response.page_count);

            if (this.variableHeightPageSupport) {
                response.documentDescription = this._pdf2XmlWrapper.documentDescription;
            }

            var pages = null;
            var pageSize = null;
            var i;
            var rotationFromServer;
            var isTextDocument;
            var scaleRatio;
            if (this.supportListOfContentControls)
                this.contentControls = this._pdf2XmlWrapper.getContentControls();
            if (this.supportListOfBookmarks)
                this.bookmarks = this._pdf2XmlWrapper.getBookmarks();

            if (this.pageContentType == "image") {
                if (this.use_pdf != 'false' || this.variableHeightPageSupport) {
                    pageSize = this._pdf2XmlWrapper.getPageSize();
                    if (this.variableHeightPageSupport) {
                        response.page_size.Width = pageSize.width;
                        response.page_size.Height = pageSize.height;
                    }

                    this.scale(this.pageImageWidth * (this.initialZoom / 100) / pageSize.width);
                    this.unscaledPageHeight = Number(pageSize.height);
                    this.unscaledPageWidth = Number(pageSize.width);
                }

                this.heightWidthRatio = parseFloat(response.page_size.Height / response.page_size.Width);
                this.pageHeight(Math.round(this.pageImageWidth * this.heightWidthRatio * (this.initialZoom / 100)));

                $(this).trigger('_onProcessPages', response);
            }
            else if (this.pageContentType == "html") {
                this.watermarkScreenWidth = null;
                this.zoom(100);
                this.fileType = response.fileType;
                this.urlForResourcesInHtml = response.urlForResourcesInHtml;
                isTextDocument = (this.fileType == "Txt" || this.fileType == "Xml");
                this.isHtmlDocument(this.fileType == "Html" || this.fileType == "Htm" || isTextDocument);
                var isDocumentSinglePaged = (response.doc_type == "Cells" || this.isHtmlDocument());
                this.useTabsForPages(isDocumentSinglePaged);
                isDocumentSinglePaged |= (response.doc_type == "Image");
                this.documentSpace.trigger("isDocumentSinglePaged.groupdocs", isDocumentSinglePaged);
                this.alwaysShowLoadingSpinner(!isDocumentSinglePaged);

                var browserIsChrome = $.browser.webkit && !!window.chrome;
                var isChromium = window.chrome;
                var vendorName = window.navigator.vendor;
                var isOpera = window.navigator.userAgent.indexOf("OPR") > -1;
                if (!!isChromium && vendorName === "Google Inc." && isOpera == false)
                    browserIsChrome = true;
                this.browserIsChrome(browserIsChrome);

                var pageCss = response.pageCss[0];
                if (!pageCss)
                    pageCss = "";

                if (this.pageCssElement)
                    this.pageCssElement.remove();

                this.urlForImagesInHtml = response.urlForImagesInHtml;
                this.urlForFontsInHtml = response.urlForFontsInHtml;
                this.pageCssElement = $([]);
                this.preloadedPages = { html: response.pageHtml, css: response.pageCss };
                var firstPageHtml = response.pageHtml[0];
                var firstPage = this.pages()[0];

                pages = this._pdf2XmlWrapper.documentDescription.pages;
                this.autoHeight(this.useTabsForPages());

                var element;
                if (this.useTabsForPages()) {
                    this.pageCount(1);
                    if (this.isHtmlDocument()) {
                        var bodyContents;
                        if (isTextDocument) {
                            bodyContents = "<div class='text_document_wrapper'>" + firstPageHtml + "</div>";
                        }
                        else {
                            var headContents = this.getHtmlElementContents(firstPageHtml, "head");
                            if (headContents) {
                                var styleElementContents = this.getHtmlElements(headContents, "style");
                                var linkElementContents = this.getHtmlElementAttributess(headContents, "link");

                                if (linkElementContents != null) {
                                    this.linkElementsToLoad = 0;
                                    for (i = 0; i < linkElementContents.length; i++) {
                                        element = $(linkElementContents[i]);
                                        var rel = element.attr("rel");
                                        if (rel == "stylesheet") {
                                            this.linkElementsToLoad++;
                                            var uri = element.attr("href");
                                            $.get(uri, 
                                                function (response) {
                                                    var styleElement = $("<style type='text/css'>" + response + "</style>");
                                                    self.pageCssElement = self.pageCssElement.add(styleElement);
                                                    styleElement.prependTo("head");
                                                    self.linkElementsToLoad--;
                                                    if (self.linkElementsToLoad == 0) {
                                                        self.autoHeight(true);
                                                        self._calculatePageSizeFromDOM();
                                                        self.adjustInitialZoom();
                                                    }
                                                })
                                            .fail(function () {
                                                self.linkElementsToLoad--;
                                                if (self.linkElementsToLoad == 0) {
                                                    self.autoHeight(true);
                                                    self._calculatePageSizeFromDOM();
                                                    self.adjustInitialZoom();
                                                }
                                            });
                                        }
                                    }
                                }

                                if (styleElementContents) {
                                    for (i = 0; i < styleElementContents.length; i++) {
                                        var css = styleElementContents[i];
                                        pageCss += css;
                                    }
                                }
                            }

                            bodyContents = this.getPageBodyContentsWithReplace(firstPageHtml);
                        }
                        var bodyContentsElement = $(bodyContents);
                        bodyContentsElement.find("script").remove();
                        bodyContentsElement.addClass('html_document_wrapper');
                        firstPageHtml = bodyContentsElement[0].outerHTML;

                        var fontSizeStyle = ".grpdx .ie .doc-page .html_page_contents > div {font-size:1em;}";
                        pageCss += fontSizeStyle;
                    }
                }
                else {
                    pageSize = this._pdf2XmlWrapper.getPageSize();

                    firstPage.prop(pages[0].h / pages[0].w);
                    scaleRatio = this.getScaleRatioForPage(pageSize.width, pageSize.height, pages[0].w, pages[0].h);
                    firstPage.heightRatio(scaleRatio);

                    this.documentSpace.css("background-color", "inherit");
                }

                var sharedCss = response.sharedCss;
                if (sharedCss) {
                    var sharedElement = $("<style>" + sharedCss + "</style>");
                    this.pageCssElement = this.pageCssElement.add(sharedElement);
                    sharedElement.appendTo("head");
                }

                element = $("<style>" + pageCss + "</style>");
                this.pageCssElement = this.pageCssElement.add(element);
                element.appendTo("head");

                this.calculatePointToPixelRatio();

                var htmlPageContents = this.documentSpace.find(".html_page_contents:first");
                firstPage.htmlContent(firstPageHtml);
                firstPage.visible(true);

                this.clearContentControls();
                this.markContentControls(0);

                this.tabs.removeAll();
                if (this.useTabsForPages()) {
                    var sheets = this._pdf2XmlWrapper.documentDescription.sheets;
                    if (sheets) {
                        for (i = 0; i < sheets.length; i++) {
                            this.tabs.push({
                                name: sheets[i].name,
                                visible: ko.observable(false),
                                htmlContent: ko.observable(""),
                                searchText: ko.observable(null)
                            });
                        }
                    }
                    this.activeTab(0);
                    this.documentSpace.css("background-color", "white");
                }

                if (this.useTabsForPages() && this.tabs().length > 0)
                    this.documentSpace.addClass("doc_viewer_tabs");
                else
                    this.documentSpace.removeClass("doc_viewer_tabs");

                var pageElement = htmlPageContents.children("div,table,img");
                var pageElementWidth;
                if (this.useTabsForPages()) {
                    pageElementWidth = pageElement.width();
                    var pageElementHeight = pageElement.height();
                    firstPage.prop(pageElementHeight / pageElementWidth);
                    pageSize = { width: pageElementWidth, height: pageElementHeight };
                    firstPage.heightRatio(1);
                }

                if (this.supportPageRotation) {
                    if (pages)
                        rotationFromServer = pages[0].rotation;
                    else
                        rotationFromServer = 0;

                    if (typeof rotationFromServer == "undefined")
                        rotationFromServer = 0;
                    this.applyPageRotationInBrowser(0, firstPage, rotationFromServer);
                }

                this.imageHorizontalMargin = 7;

                response.page_size.Width = pageSize.width;
                response.page_size.Height = pageSize.height;
                var pageWidthFromServer = pageSize.width;
                var onlyImageInHtml = false;
                var pageElementChildren = pageElement.children();
                if (pageElementChildren.length == 1 && pageElementChildren.filter("img").length == 1)
                    onlyImageInHtml = true;

                var oldWidth = null;
                if (!onlyImageInHtml && !this.useTabsForPages()) {
                    oldWidth = pageElement.css("width");
                    pageElement.css("width", pageWidthFromServer + "pt");
                }

                if (this.isHtmlDocument())
                    pageElementWidth = this.getFitWidth();
                else
                    pageElementWidth = pageElement.width();

                this.heightWidthRatio = parseFloat(response.page_size.Height / response.page_size.Width);

                if (!this.useTabsForPages() || !this.supportPageRotation || firstPage.rotation % 180 == 0)
                    this.pageWidth(pageElementWidth);

                if (oldWidth !== null && typeof oldWidth != "undefined")
                    pageElement.css("width", oldWidth);
                this.pageHeight(Math.round(this.pageWidth() * this.heightWidthRatio));
                this.initialWidth = this.pageWidth();
            }

            var pageCount = this.pageCount();
            if (!response.lic && pageCount > 3)
                pageCount = 3;

            var pagesNotObservable = [];
            var pageDescription;

            if (this.pageContentType == "image") {
                //this.pages.removeAll();
                var pageImageUrl, pageDescriptionCount;
                if (this.variableHeightPageSupport) {
                    this.serverPages = pages = this._pdf2XmlWrapper.documentDescription.pages;
                    pageDescriptionCount = this._pdf2XmlWrapper.getPageCount();
                    //pageDescriptionCount = pages.length;
                }

                for (i = 0; i < pageCount; i++) {
                    if (i < response.image_urls.length)
                        pageImageUrl = response.image_urls[i];
                    else
                        pageImageUrl = "";

                    pageDescription = {
                        number: i + 1,
                        visible: ko.observable(false),
                        url: ko.observable(pageImageUrl)
                    };
                    if (this.variableHeightPageSupport) {
                        if (i < pageDescriptionCount && pages)
                            pageDescription.prop = ko.observable(pages[i].h / pages[i].w);
                        else
                            pageDescription.prop = ko.observable(this.pageHeight() / this.pageWidth());
                    }

                    if (this.supportPageRotation) {
                        rotationFromServer = this.serverPages[i].rotation;
                        if (typeof rotationFromServer == "undefined")
                            rotationFromServer = 0;
                        pageDescription.rotation = ko.observable(rotationFromServer);
                        this.applyPageRotationInBrowser(i, pageDescription, rotationFromServer);
                    }
                    if (this.useVirtualScrolling) {
                        pageDescription.left = 0;
                        pageDescription.top = ko.observable(0);
                    }

                    pagesNotObservable.push(pageDescription);
                }
            }
            else if (this.pageContentType == "html") {
                this.serverPages = pages = this._pdf2XmlWrapper.documentDescription.pages;
                //this.pages.splice(1, this.pages().length - 1);
                //var documentHeight = 0;
                //var pageTop = 0;

                pageWidth = this.pageWidth();
                pageDescription = this.pages()[0];
                //var layout = this.layout();
                //if (layout != this.Layouts.TwoPagesInRow)
                //    pageTop += pageWidth * pageDescription.prop();
                //documentHeight += pageWidth * pageDescription.prop();
                pagesNotObservable.push(pageDescription);
                var proportion;
                //var cssForAllPages = "";
                for (i = 1; i < pageCount; i++) {
                    scaleRatio = this.getScaleRatioForPage(pageSize.width, pageSize.height, pages[i].w, pages[i].h);
                    proportion = pages[i].h / pages[i].w;

                    pageDescription = {
                        number: i + 1,
                        visible: ko.observable(false),
                        htmlContent: ko.observable(""),
                        prop: ko.observable(proportion),
                        heightRatio: ko.observable(scaleRatio),
                        searchText: ko.observable(null)
                    };

                    //var pageHtml = this.preloadedPages && this.preloadedPages.html[i];
                    //if (pageHtml) {
                    //    pageDescription.htmlContent(pageHtml);
                    //    if (this.preloadedPages.css[i])
                    //        cssForAllPages += this.preloadedPages.css[i];
                    //    pageDescription.visible(true);
                    //}

                    if (this.supportPageRotation) {
                        rotationFromServer = this.serverPages[i].rotation;
                        if (typeof rotationFromServer == "undefined")
                            rotationFromServer = 0;
                        pageDescription.rotation = ko.observable(rotationFromServer);
                        this.applyPageRotationInBrowser(i, pageDescription, rotationFromServer);
                    }
                    if (this.useVirtualScrolling) {
                        pageDescription.left = 0;
                        pageDescription.top = ko.observable(0);
                    }
                    //    if (layout == this.Layouts.OnePageInRow
                    //        || (layout == this.Layouts.TwoPagesInRow && i % 2 == 1)
                    //        || (layout == this.Layouts.CoverThenTwoPagesInRow && i % 2 == 0)) {
                    //        pageTop += pageWidth * proportion;
                    //        documentHeight = pageTop;
                    //    }
                    //    else
                    //        documentHeight = pageTop + pageHeight;

                    //    //pageTop += pageWidth * proportion * scaleRatio;
                    //}
                    pagesNotObservable.push(pageDescription);
                }

                //if (this.useVirtualScrolling)
                //    this.documentHeight(documentHeight);
                if (isDocumentSinglePaged)
                    response.page_count = 0; // for thumbnails after rotation
                this.documentSpace.trigger('_onProcessPages', [response, pagesNotObservable, this.getDocumentPageHtml, this, this.pointToPixelRatio, this.docViewerId]);
            }

            this.pages(pagesNotObservable);
            this.calculatePagePositionsForVirtualMode();

            this._firstPage = this.documentSpace.find("#" + this.pagePrefix + "1");
            if (this.pages().length > 0 && this._firstPage.length == 0 && !this.useVirtualScrolling) // viewer destroyed while loading document
                return;

            $(this).trigger('onProcessPages', [this.docGuid]);
            this.inprogress(false);

            if (this.pageContentType == "image") {
                this.recalculatePageLeft();
            }

            //var hCount = Math.floor(this.pagesContainerElement.width() / this._firstPage.width());
            var hCount = Math.floor(this.pagesContainerElement.width() / this.pageWidth());
            if (hCount == 0)
                hCount = 1;
            if (this.layout() == this.Layouts.OnePageInRow)
                hCount = 1;

            if (this._pdf2XmlWrapper && this._pdf2XmlWrapper._setTextPositionsCalculationFinished)
                this._isTextPositionsCalculationFinished = false;
            var scale = this.scale();

            this._dvselectable = this.pagesContainerElement.dvselectable({
                txtarea: this.selectionContent,
                pdf2XmlWrapper: this._pdf2XmlWrapper,
                startNumbers: this.getVisiblePagesNumbers(),
                pagesCount: this.pageCount(),
                proportion: scale,
                pageHeight: this.getPageHeight(),
                horizontalPageCount: hCount,
                docSpace: this.documentSpace,
                pagePrefix: this.pagePrefix,
                searchPartialWords: this.searchPartialWords,
                storeAnnotationCoordinatesRelativeToPages: this.storeAnnotationCoordinatesRelativeToPages,
                initializeStorageOnly: this.pageContentType == "html",
                preventTouchEventsBubbling: this.preventTouchEventsBubbling,
                highlightColor: this.options.highlightColor,
                useVirtualScrolling: this.useVirtualScrolling,
                pageLocations: (this.useVirtualScrolling ? this.pages() : null),
                initStorageOnMouseStart: this.initStorageOnMouseStart
            });
            this._dvselectable.dvselectable("setVisiblePagesNumbers", this.getVisiblePagesNumbers());

            if (!this.docWasLoadedInViewer && (this.usePageNumberInUrlHash === undefined || this.usePageNumberInUrlHash == true)) {
                var firstPageLocation = location.pathname;
                if (location.hash.substring(1, this.hashPagePrefix.length + 1) != this.hashPagePrefix)
                    this.setPage(1);

                Sammy(function () {
                    this.get(/\#page(.*)/i, openPath);
                    this.get(firstPageLocation, openFirstPage);

                    function openFirstPage() {
                        if (self.pageInd() != 1)
                            self.setPage(1);
                    }

                    function openPath() {
                        if (!self.changedUrlHash) {
                            if (this.params.splat.length == 0 || this.params.splat[0].length == 0) {
                            }
                            else {
                                var hashString = this.params.splat[0];
                                //hashString = hashString.substring(1);
                                var newPageIndex = Number(hashString);
                                if (isNaN(newPageIndex))
                                    newPageIndex = 1;
                                if (newPageIndex > self.pageCount())
                                    newPageIndex = self.pageCount();
                                if (newPageIndex < 1)
                                    newPageIndex = 1;
                                self.setPage(newPageIndex);
                            }
                        }
                    }
                }).run();
            }
            else {
                this.setPage(1);
            }

            if (!this.zoomToFitHeight)
                this.loadImagesForVisiblePages(true);

            this.adjustInitialZoom();
            this.docWasLoadedInViewer = true;

            // get a list of document hyperlinks from the server
            if (this.pageContentType == "image" && this._mode != "webComponent" && this._mode != "annotatedDocument") {
                this._loadHyperlinks();
            }

            if (this.preloadPagesOnBrowserSide) {
                var preloadPagesCount = this.preloadPagesCount;
                if (preloadPagesCount === null || preloadPagesCount > this.pageCount())
                    preloadPagesCount = this.pageCount();

                this.loadImagesForPages(1, preloadPagesCount);
            }

            $(this).trigger('onScrollDocView', { pi: 1, direction: "up", position: 0 });
            $(this).trigger("onDocumentLoadComplete", [response, this._pdf2XmlWrapper]);
            if (this._isTextPositionsCalculationFinished)
                this.raiseDocumentLoadCompletedEvent();
        },

        _onDocumentHyperlinksLoaded: function (response) {
            if (!response || !response.links) {
                this.hyperlinks.removeAll();
                return;
            }

            var links = [];
            var self = this;
            var selectable = this.getSelectableInstance();

            $.each(response.links, function () {
                var l = {
                    url: this.Url,
                    pageNumber: this.PageNumber,
                    targetPage: this.TargetPage,
                    rect: new jSaaspose.Rect(this.Bounds.X, this.Bounds.Y, this.Bounds.X + this.Bounds.Width, this.Bounds.Y + this.Bounds.Height)
                };
                l.frame = ko.observable(selectable != null ? selectable.convertPageAndRectToScreenCoordinates(l.pageNumber, l.rect) : l.rect);
                /*var frame = l.rect.clone().scale(self.scale());
                if (frame.top() < 0)
                frame.setTop(0);
                frame.add(selectable.pages[l.pageNumber].rect.topLeft);

                return frame;
                }, self);*/

                links.push(l);
            });

            this.hyperlinks(links);
        },

        _loadHyperlinks: function () {
            if (this.options.showHyperlinks == true) {
                this._model.loadHyperlinks(
                    this.fileId,
                    this._onDocumentHyperlinksLoaded.bind(this),
                    function (error) {
                    });
            }
        },

        _refreshHyperlinkFrames: function () {
            var selectable = this.getSelectableInstance();

            $.each(this.hyperlinks(), function () {
                this.frame(selectable != null ? selectable.convertPageAndRectToScreenCoordinates(this.pageNumber, this.rect) : this.rect);
            });
        },

        setPageWidth: function (val) {
            this.pageImageWidth = val;
        },

        setContainerWidth: function (containerWidth) {
            this.viewerWidth = containerWidth;
        },

        getFitWidth: function () {
            var viewerWidth;
            if (this.viewerWidth)
                viewerWidth = this.viewerWidth;
            else
                viewerWidth = this.documentSpace.width();
            var scrollbarWidth = this.getScrollbarWidth();
            var fittingWidth = viewerWidth - scrollbarWidth - 2 * (this.imageHorizontalMargin + 1);
            if (!this.useTabsForPages()) {
                var layout = this.layout();
                if (layout == this.Layouts.TwoPagesInRow
                    || layout == this.Layouts.CoverThenTwoPagesInRow)
                    fittingWidth = fittingWidth / 2;
            }
            return fittingWidth;
        },

        getFitWidthZoom: function () {
            return this.getFitWidth() / this.initialWidth * 100;
        },

        setContainerHeight: function (containerHeight) {
            this.viewerHeight = containerHeight;
        },

        getViewerHeight: function () {
            var viewerHeight;
            if (this.viewerHeight)
                viewerHeight = this.viewerHeight;
            else
                viewerHeight = this.documentSpace.parent().height();
            return viewerHeight;
        },

        getFitHeightZoom: function () {
            var viewerHeight = this.getViewerHeight();
            return (viewerHeight - (this.imageVerticalMargin + 2)) / Math.round(this.initialWidth * this.heightWidthRatio) * 100;
            //return viewerHeight / Math.round(this.pageImageWidth * this.heightWidthRatio) * 100;
        },

        getScrollbarWidth: function () {
            if (this.scrollbarWidth == null) {
                // Create the measurement node
                var scrollDivJquery = $("<div/>").css("width", "100px").css("height", "100px")
                    .css("overflow", "scroll").css("position", "absolute").css("top", "-9999px");
                var scrollDiv = scrollDivJquery[0];
                document.body.appendChild(scrollDiv);

                // Get the scrollbar width
                this.scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;

                // Delete the DIV 
                document.body.removeChild(scrollDiv);
            }
            return this.scrollbarWidth;
        },

        getPageHeight: function () {
            return this.unscaledPageHeight * this.scale();
        },

        getSelectable: function () {
            return this._dvselectable;
        },

        _onPropertiesLoaded: function (response) {
            $(this).trigger('onDocumentLoaded', { fileId: this.fileId, response: response });
        },

        getFileId: function () {
            return this.fileId;
        },

        ScrollDocView: function (item, e) {
            var isSetCalled = this.isSetCalled;
            this.isSetCalled = false;
            if (isSetCalled)
                return;
            if (this.useTabsForPages())
                return;
            //var direction;
            var pageIndex = null;
            var panelHeight = this.documentSpace.height();
            var st = $(e.target).scrollTop();

            $(this).trigger('onBeforeScrollDocView', { position: st });
            if (this.variableHeightPageSupport) {
                var selectable = this.getSelectableInstance();
                if (selectable == null)
                    return null;

                selectable.initStorage();

                var pageLocations = selectable.pageLocations;
                var pageImageTop, pageImageBottom;
                var pages = this.pages();

                var visiblePageNumbers;
                visiblePageNumbers = this.getVisiblePagesNumbers();

                var documentSpaceHeight = this.documentSpace.height();
                var nearestPageNumber = null, maxPartWhichIntersects = null;
                var topOfIntersection, bottomOfIntersection, lengthOfIntersection, partWhichIntersects;
                for (var i = visiblePageNumbers.start - 1; i <= visiblePageNumbers.end - 1; i++) {
                    if (this.useVirtualScrolling)
                        pageImageTop = pages[i].top();
                    else
                        pageImageTop = pageLocations[i].y;
                    pageHeight = pages[i].prop() * this.pageWidth();
                    pageImageBottom = Math.floor(pageImageTop + pageHeight);
                    topOfIntersection = Math.max(pageImageTop, st);
                    bottomOfIntersection = Math.min(pageImageBottom, st + documentSpaceHeight);
                    lengthOfIntersection = bottomOfIntersection - topOfIntersection;
                    partWhichIntersects = lengthOfIntersection / pageHeight;

                    if (maxPartWhichIntersects == null || partWhichIntersects > maxPartWhichIntersects) {
                        maxPartWhichIntersects = partWhichIntersects;
                        nearestPageNumber = i;
                    }
                }
                pageIndex = nearestPageNumber + 1;
            }
            else {
                if (this._firstPage != null) {
                    pageIndex = (st + panelHeight / 2) / (this._firstPage.outerHeight(true));
                    var hCount = Math.floor(this.pagesContainerElement.width() / this._firstPage.width());
                    if (hCount == 0)
                        hCount = 1;
                    if (this.layout() == this.Layouts.OnePageInRow)
                        hCount = 1;
                    pageIndex = (pageIndex >> 0);

                    var totalPageCount = this.pageCount();
                    if (pageIndex != totalPageCount)
                        pageIndex = pageIndex + 1;
                    pageIndex = (pageIndex - 1) * hCount + 1;
                    if (pageIndex > totalPageCount)
                        pageIndex = totalPageCount;
                }
            }
            if (pageIndex !== null) {
                this.pageInd(pageIndex);
                this.setPageNumerInUrlHash(pageIndex);
                $(this).trigger('onScrollDocView', { pi: pageIndex, position: st });
                this.documentSpace.trigger("documentScrolledToPage.groupdocs", [pageIndex]);
            }
        },

        ScrollDocViewEnd: function (item, e) {
            if (this.useTabsForPages())
                return;

            this.isSetCalled = false;
            this.scrollPosition = [$(e.target).scrollLeft(), $(e.target).scrollTop()];
            var numbers = this.loadImagesForVisiblePages();

            if (this._dvselectable) {
                $(this._dvselectable).dvselectable("setVisiblePagesNumbers", numbers);
            }
            $(this).trigger('onDocumentPageSet', [this.pageInd()]);
            this.documentSpace.trigger("documentScrolledToPage.groupdocs", [this.pageInd()]);
        },

        getVisiblePagesNumbers: function () {
            if (!this.isDocumentLoaded)
                return null;
            if (this.useTabsForPages()) {
                return { start: 1, end: 1 };
            }

            var start = null;
            var end = null;
            var scrollTop = this.documentSpace.scrollTop();
            var pageHeight;
            var startIndex = null;
            var documentSpaceHeight = this.documentSpace.height();

            if (this.variableHeightPageSupport) {
                var selectable = this.getSelectableInstance();
                if (selectable == null && !this.useVirtualScrolling)
                    return null;
                var pages = this.pages();
                var pageLocations;
                var pageCount;
                if (this.useVirtualScrolling)
                    pageCount = pages.length;
                else {
                    pageLocations = selectable.pageLocations;
                    if (pageLocations.length != pages.length)
                        return null;
                    pageCount = pageLocations.length;
                }

                var pageImageTop, pageImageBottom;
                for (var i = 0; i < pageCount; i++) {
                    if (this.useVirtualScrolling)
                        pageImageTop = pages[i].top();
                    else
                        pageImageTop = pageLocations[i].y;

                    pageHeight = pages[i].prop() * this.pageWidth();

                    pageImageBottom = pageImageTop + pageHeight;
                    if ((pageImageTop >= scrollTop && pageImageTop <= scrollTop + documentSpaceHeight) ||
                        (pageImageBottom >= scrollTop && pageImageBottom <= scrollTop + documentSpaceHeight) ||
                        (pageImageTop <= scrollTop && pageImageBottom >= scrollTop + documentSpaceHeight)) {
                        if (start === null)
                            start = i + 1;
                        else
                            end = i + 1;
                    }
                }
                if (end === null)
                    end = start;

            }
            else {
                if (this._firstPage != null) {
                    pageHeight = this._firstPage.outerHeight(true); // div height
                    var pageWidth = this._firstPage.outerWidth(true); // div width
                    //var scrollTop = this.scrollPosition[1], //scroll top
                    var dsW = this.pagesContainerElement.width();
                    startIndex = Math.floor(scrollTop / pageHeight) + 1;
                    var endIndex = Math.floor((scrollTop + documentSpaceHeight) / pageHeight) + 1;

                    var hCountToShow = Math.floor(dsW / pageWidth);

                    if (hCountToShow == 0)
                        hCountToShow = 1;
                    if (this.layout() == this.Layouts.OnePageInRow)
                        hCountToShow = 1;

                    start = startIndex != 1 ? (startIndex - 1) * hCountToShow + 1 : 1;
                    end = endIndex * hCountToShow <= this.pageCount() ? endIndex * hCountToShow : this.pageCount();
                }
            }
            return { start: start, end: end };
        },

        loadImagesForVisiblePages: function (forceLoading) {
            var numbers = this.getVisiblePagesNumbers();
            if (numbers != null) {
                var start = numbers.start;
                var end = numbers.end;
                if (start !== null && end !== null) {
                    this.loadImagesForPages(start, end, forceLoading);
                    if (this.useVirtualScrolling) {
                        this.firstVisiblePageForVirtualMode(numbers.start - 1);
                        this.lastVisiblePageForVirtualMode(numbers.end - 1);
                    }
                }
            }
            return numbers;
        },

        loadImagesForPages: function (start, end, forceLoading) {
            var pages = this.pages();
            var cssForAllPages = "";
            var page;
            var isPageVisible;
            if (pages.length < end) end = pages.length;
            for (var i = start; i <= end; i++) {
                page = pages[i - 1];
                isPageVisible = page.visible();
                if (isPageVisible)
                    this.markContentControls(i - 1);

                if (this.pageContentType == "image") {
                    this.triggerImageLoadedEvent(i);

                    if (this.supportPageRotation && forceLoading) {
                        this.addSuffixToImageUrl(page);
                    }
                }
                else if (this.pageContentType == "html") {
                    if (!isPageVisible) {
                        this.getDocumentPageHtml(i - 1);
                    }
                }
                page.visible(true);
            }

            if (this.pageContentType == "html" && cssForAllPages != "")
                this.addPageCss(cssForAllPages);
        },

        setPage: function (index) {
            this.isSetCalled = true;
            var newPageIndex = Number(index);

            if (isNaN(newPageIndex) || newPageIndex < 1)
                newPageIndex = 1;

            this.pageInd(newPageIndex);

            var pageTop;
            if (this.variableHeightPageSupport) {
                if (this.useVirtualScrolling) {
                    pageTop = this.pages()[newPageIndex - 1].top();
                }
                else {
                    var selectable = this.getSelectableInstance();
                    if (selectable != null) {
                        if (selectable.pageLocations && selectable.pageLocations.length > 0) {
                            var pageImageTop = selectable.pageLocations[newPageIndex - 1].y;
                            pageTop = pageImageTop;
                        }
                    }
                }
            }
            else {
                var hCount = Math.floor(this.pagesContainerElement.width() / this._firstPage.width());
                if (hCount == 0)
                    hCount = 1;
                if (this.layout() == this.Layouts.OnePageInRow)
                    hCount = 1;
                var selIndex = Math.ceil(newPageIndex / hCount) - 1;
                pageTop = selIndex * this._firstPage.outerHeight(true);
            }

            var oldScrollTop = this.documentSpace.scrollTop();
            this.documentSpace.scrollTop(pageTop);
            if (this.documentSpace.scrollTop() == oldScrollTop) {
                this.isSetCalled = false;
            }

            $(this).trigger('onDocViewScrollPositionSet', { position: pageTop });
            var page = this.pages()[newPageIndex - 1];

            if (this.pageContentType == "image") {
                this.triggerImageLoadedEvent(newPageIndex);
                page.visible(true);
            }
            else if (this.pageContentType == "html") {
                if (!page.visible()) {
                    this.getDocumentPageHtml(newPageIndex - 1);
                }
            }

            //this.isSetCalled = false;

            this.setPageNumerInUrlHash(newPageIndex);
            $(this).trigger('onDocumentPageSet', [newPageIndex]);
            this.documentSpace.trigger("documentPageSet.groupdocs", newPageIndex);
        },

        triggerImageLoadedEvent: function (pageIndex) {
            if ($.browser.msie) {
                if (!this.pages()[pageIndex - 1].visible()) {
                    $("img#img-" + pageIndex).load(function () {
                        $(this).trigger("onPageImageLoaded");
                    });
                }
            }
        },

        setZoom: function (value) {
            this.zoom(value);
            this.loadPagesZoomed();
            this.clearContentControls();

            if (this.pageContentType == "image") {
                if (this._pdf2XmlWrapper) {
                    var pageSize = this._pdf2XmlWrapper.getPageSize();
                    this.scale(this.pageImageWidth / pageSize.width * value / 100);
                }

                this.getSelectableInstance().changeSelectedRowsStyle(this.scale());
                this.reInitSelectable();
                if (this.useVirtualScrolling) {
                    this.getSelectableInstance().recalculateSearchPositions(this.scale());
                    this.highlightSearch();
                }
                this.recalculatePageLeft();
                this.setPage(this.pageInd());

                if (this.shouldMinimumWidthBeUsed(this.pageWidth(), true))
                    this.loadImagesForVisiblePages();

                if (this.options.showHyperlinks) {
                    this._refreshHyperlinkFrames();
                }
            }
            else if (this.pageContentType == "html") {
                this.reInitSelectable();
                this.setPage(this.pageInd());
                this.loadImagesForVisiblePages();
                this.reflowPagesInChrome(true);
            }
        },

        loadPagesZoomed: function () {
            if (this.useTabsForPages()) {
                this._calculatePageSizeFromDOM();
                return;
            }

            var newWidth = Math.round(this.initialWidth * (this.zoom()) / 100);
            var newHeight = Math.round(newWidth * this.heightWidthRatio);

            if (newWidth != this.pageWidth() || newHeight != this.pageHeight()) {
                this.pagesDimension = Math.floor(newWidth) + 'x';

                this.pageWidth(newWidth);
                this.pageHeight(newHeight);

                if (!this.useTabsForPages()) {
                    this.calculatePagePositionsForVirtualMode();
                }

                if (this.pageContentType == "image") {
                    var pageCount = this.pageCount();
                    if (!this.shouldMinimumWidthBeUsed(newWidth, true))
                        this.retrieveImageUrls(pageCount);
                }
            }
        },

        performSearch: function (value, isCaseSensitive, searchForSeparateWords, treatPhrasesInDoubleQuotesAsExact, useAccentInsensitiveSearch) {
            if (this.pageContentType == "image") {
                var selectable = this.getSelectableInstance();
                if (selectable != null) {
                    var searchCountItem = selectable.performSearch(value, this.scale(), isCaseSensitive, searchForSeparateWords, treatPhrasesInDoubleQuotesAsExact, useAccentInsensitiveSearch);
                    $(this).trigger('onSearchPerformed', [searchCountItem]);
                }
            }
            else {
                this.searchText = value;
                this.searchForSeparateWords = searchForSeparateWords;
                this.treatPhrasesInDoubleQuotesAsExact = treatPhrasesInDoubleQuotesAsExact;
                var pages = this.pages();
                var page;

                if (this.loadAllPagesOnSearch)
                    this.loadImagesForPages(1, pages.length);

                for (var i = 0; i < pages.length; i++) {
                    page = pages[i];
                    if (page.visible()) {
                        var searchParameters = {
                            text: value,
                            isCaseSensitive: isCaseSensitive,
                            searchForSeparateWords: searchForSeparateWords,
                            treatPhrasesInDoubleQuotesAsExact: treatPhrasesInDoubleQuotesAsExact,
                            pageNumber: i
                        };

                        page.searchText(searchParameters);
                    }
                }
            }
        },

        searchHtmlElement: function (node, nodeName, className, words, wordsWithAccentedChars,
            searchForSeparateWords, isCaseSensitive, fullWordsOnly, pageNumber) {

            nodeName = nodeName || this.htmlSearchHighlightElement;
            var totalWordCount;
            var pattern, currentNodeMatchCount = 0;
            var match = null;
            var nodeText = null;
            var regexp;

            if (node.nodeType === 3) {
                if (words) {
                    totalWordCount = words.length;

                    var trimmedText = node.data.replace(/[\r\n\s]+$/g, "");
                    var separatorsRegexString = "[" + this.searchSeparatorsList + "]";
                    var wordStartSeparatorsRegexString;
                    var wordEndSeparatorsRegexString;
                    var reservedSymbolsInEndRegExp = /[\-[\]{}()*+?\\^|\s.,:;+"]+$/g;
                    var currentWord, currentWordWithAccentedChars;
                    var index, length;
                    var highlightElementName;
                    var matchNum;
                    var previousMatchPosition = -1, matchLength = 0, previousMatchEndPosition = 0;
                    trimmedText = trimmedText.replace(reservedSymbolsInEndRegExp, "");
                    if (trimmedText.length == 0)
                        return 0;

                    if (searchForSeparateWords && !fullWordsOnly) {
                        var searchMatches = new Array();
                        for (var wordNum = 0; wordNum < words.length; wordNum++) {
                            currentWord = words[wordNum];
                            currentWordWithAccentedChars = wordsWithAccentedChars[wordNum];

                            pattern = currentWordWithAccentedChars;
                            length = pattern.length;
                            nodeText = node.data;

                            if (!isCaseSensitive) {
                                pattern = pattern.toLocaleLowerCase();
                                nodeText = nodeText.toLocaleLowerCase();
                            }
                            previousMatchEndPosition = 0;
                            do {
                                index = nodeText.indexOf(pattern, previousMatchEndPosition);
                                if (index != -1) {
                                    searchMatches.push({ index: index, length: length });
                                    previousMatchEndPosition = index + length;
                                }
                            } while (index != -1);
                        }

                        searchMatches.sort(function (match1, match2) {
                            return match2.index - match1.index;
                        });

                        var containingMatches = new Array();
                        // remove overlapping search hits but keep one of two hits overlapping each other
                        searchMatches = searchMatches.filter(function (match, index) {
                            return !searchMatches.some(function (innerMatch, innerIndex) {
                                var isContainedInAnother = innerIndex != index &&
                                       (match.index >= innerMatch.index && match.index < innerMatch.index + innerMatch.length)
                                    || (match.index + match.length > innerMatch.index && match.index + match.length < innerMatch.index + innerMatch.length);
                                if (isContainedInAnother) {
                                    if (containingMatches.indexOf(match) != -1)
                                        return false;
                                    containingMatches.push(innerMatch);
                                }
                                return isContainedInAnother;
                            });
                        });
                        var newNodesCreated = 0;
                        for (matchNum = 0; matchNum < searchMatches.length; matchNum++) {
                            highlightElementName = "search_highlight" + this.matchesCount.toString();
                            this.matchesCount++;
                            newNodesCreated += this.highlightOneNode(node, searchMatches[matchNum].index, searchMatches[matchNum].length, highlightElementName, className, pageNumber);
                        }
                        return newNodesCreated;
                    }

                    var isFirstWord, isLastWord;
                    var foundFirstWordsButDidNotFindOthers;

                    do {
                        currentWord = words[this.currentWordCounter];
                        currentWordWithAccentedChars = wordsWithAccentedChars[this.currentWordCounter];
                        isFirstWord = (this.currentWordCounter == 0);
                        isLastWord = (this.currentWordCounter == totalWordCount - 1);

                        if (isFirstWord && !fullWordsOnly) {
                            wordStartSeparatorsRegexString = "";
                        }
                        else {
                            wordStartSeparatorsRegexString = "(?:" + separatorsRegexString + "|^)+";
                        }

                        if (isLastWord && !fullWordsOnly) {
                            wordEndSeparatorsRegexString = "";
                        }
                        else {
                            wordEndSeparatorsRegexString = "(?:" + separatorsRegexString + "|$)+";
                        }

                        pattern = wordStartSeparatorsRegexString + "(" + currentWordWithAccentedChars + wordEndSeparatorsRegexString + ")";
                        nodeText = node.data;
                        nodeText = nodeText.substr(previousMatchEndPosition, nodeText.length - previousMatchEndPosition);
                        if ((this.matchedNodsCount > 0 && previousMatchPosition == -1) || previousMatchPosition != -1) // if searching a new <span> or not first word inside first span then search from beginning of string
                            pattern = "^" + pattern;
                        regexp = new RegExp(pattern, isCaseSensitive ? "" : "i");
                        foundFirstWordsButDidNotFindOthers = false;

                        match = nodeText.match(regexp);
                        if (match) {
                            if (previousMatchPosition == -1)
                                this.matchedNodsCount++;
                            currentNodeMatchCount++;
                            this.matchedNods.push(node);
                            index = previousMatchEndPosition + match.index;
                            length = match[0].length;

                            if (isFirstWord) {
                                index = previousMatchEndPosition + nodeText.indexOf(match[1], match.index);
                                length = match[1].length;
                            }

                            if (isLastWord && !this.useAccentInsensitiveSearch) {
                                var word = words[this.currentWordCounter];
                                var nodeTextToSearchIn = nodeText;
                                if (!isCaseSensitive) {
                                    word = word.toLowerCase();
                                    nodeTextToSearchIn = nodeTextToSearchIn.toLowerCase();
                                }
                                var wordIndex = previousMatchEndPosition + nodeTextToSearchIn.indexOf(word, match.index);
                                length = word.length + wordIndex - index;
                            }
                            this.searchMatches.push({ index: index, length: length });

                            previousMatchPosition = previousMatchEndPosition + match.index;
                            matchLength = match[0].length;
                            previousMatchEndPosition = previousMatchPosition + matchLength;

                            this.currentWordCounter++;
                            if (this.currentWordCounter >= totalWordCount) {
                                highlightElementName = "search_highlight" + this.matchesCount.toString();
                                for (matchNum = totalWordCount - 1; matchNum >= 0; matchNum--)
                                    this.highlightOneNode(this.matchedNods[matchNum], this.searchMatches[matchNum].index, this.searchMatches[matchNum].length, highlightElementName, className, pageNumber);
                                this.currentWordCounter = 0;
                                this.matchedNods = [];
                                this.searchMatches = [];
                                this.matchedNodsCount = 0;
                                this.matchesCount++;
                                return currentNodeMatchCount;
                            }
                        }
                        else {
                            this.matchedNods = [];
                            this.searchMatches = [];
                            if (this.currentWordCounter > 0) {
                                // found first word or words (on previous step) inside this <span/> but failed to find others
                                previousMatchPosition = -1;
                                this.matchedNodsCount = 0;
                                foundFirstWordsButDidNotFindOthers = true;
                            }
                            this.currentWordCounter = 0;
                        }
                    } while ((match && previousMatchEndPosition < trimmedText.length) || foundFirstWordsButDidNotFindOthers);

                    if (!match)
                        this.matchedNodsCount = 0;
                    return 0;
                }
            }
            else if ((node.nodeType === 1 && node.childNodes) && // only element nodes that have children
                !/(script|style)/i.test(node.tagName) && // ignore script and style nodes
                !(node.tagName === nodeName.toUpperCase() && node.className === className)) { // skip if already highlighted
                var startNodeNum = 0;
                //var endNodeNum = node.childNodes.length;
                var i;

                for (i = startNodeNum; i < node.childNodes.length; i++) {
                    i += this.searchHtmlElement(node.childNodes[i], nodeName, className, words, wordsWithAccentedChars,
                        searchForSeparateWords, isCaseSensitive, fullWordsOnly, pageNumber);
                }
            }
            return 0;
        },

        highlightOneNode: function (node, matchIndex, matchLength, highlightElementName, className, pageNumber) {
            var isSvg = false;
            var nodeJquery = $(node);
            var highlight, nodeName;
            if (nodeJquery.is("tspan") || nodeJquery.parent().is("tspan")) {
                isSvg = true;
                nodeName = this.htmlSearchHighlightSvgElement;
                var xmlns = "http://www.w3.org/2000/svg";
                highlight = document.createElementNS(xmlns, nodeName);
                highlight.setAttribute("class", className || this.htmlSearchHighlightClassName);
            }
            else {
                nodeName = this.htmlSearchHighlightElement;
                highlight = document.createElement(nodeName);
                highlight.className = className || this.htmlSearchHighlightClassName;
            }
            var highlightJquery = $(highlight);
            if (highlightElementName)
                highlightJquery.attr("name", highlightElementName);
            highlightJquery.attr("data-page-num", pageNumber.toString());

            var newNodesCreated = 0;
            var wordNode;
            if (matchIndex == 0) {
                wordNode = node;
            }
            else {
                wordNode = node.splitText(matchIndex);
                newNodesCreated++;
            }

            if (wordNode.textContent.length > matchLength) {
                newNodesCreated++;
                wordNode.splitText(matchLength);
            }
            var wordClone = wordNode.cloneNode(true);
            highlight.appendChild(wordClone);
            wordNode.parentNode.replaceChild(highlight, wordNode);
            return newNodesCreated;
        },

        removeSearchHighlight: function (element) {
            var htmlHighlightQuery = this.htmlSearchHighlightElement + "." + this.htmlSearchHighlightClassName;
            var svgHighlightQuery = this.htmlSearchHighlightSvgElement + "." + this.htmlSearchHighlightClassName;
            $(element).find(htmlHighlightQuery + "," + svgHighlightQuery).each(function () {
                var parent = this.parentNode;
                parent.replaceChild(this.firstChild, this);
                parent.normalize();
            });
        },

        getWords: function (phrase) {
            var separatorsRegexString = "[^" + this.searchSeparatorsList + "]+";
            var separatorsRegex = new RegExp(separatorsRegexString, "g");
            var matches = phrase.match(separatorsRegex);
            var words;
            if (matches == null) {
                words = null;
            }
            else {
                words = $.map(matches,
                function (val, index) {
                    if (val != '') {
                        return val;
                    }
                });
            }
            return words;
        },

        selectTextInRect: function (rect, clickHandler, pageNumber, selectionCounter, color, hoverHandlers) {
            if (this._dvselectable) {
                return $(this._dvselectable).dvselectable('highlightPredefinedArea', rect, clickHandler, pageNumber, selectionCounter, color, hoverHandlers);
            }
            return null;
        },

        deselectTextInRect: function (rect, deleteStatic, pageNumber, selectionCounter) {
            if (this._dvselectable) {
                $(this._dvselectable).dvselectable('unhighlightPredefinedArea', rect, deleteStatic, pageNumber, selectionCounter);
            }
        },

        recalculatePageLeft: function () {
            if (this._firstPage != null && this.pagesContainerElement != null && !this.useVirtualScrolling) {
                var pageLeft = this._firstPage.offset().left - this.pagesContainerElement.offset().left;
                this.pageLeft(pageLeft);
            }
        },

        reInitSelectable: function () {
            var visiblePagesNumbers = this.getVisiblePagesNumbers();
            if (this._dvselectable != null) {
                this._dvselectable.dvselectable("reInitPages", this.scale(), visiblePagesNumbers,
                    this.scrollPosition, this.getPageHeight(), this.pages());
            }
        },

        reInitCanvasOffset: function () {
            var selectable = this.getSelectableInstance();
            selectable.initCanvasOffset();
        },

        openCurrentPage: function () {
            this.setPage(this.pageInd());
        },

        setPageNumerInUrlHash: function (pageIndex) {
            if (this.usePageNumberInUrlHash === undefined || this.usePageNumberInUrlHash == true) {
                if (location.hash != "" || pageIndex > 1) {
                    this.changedUrlHash = true;
                    location.hash = this.hashPagePrefix + pageIndex.toString();
                    this.changedUrlHash = false;
                }
            }
        },

        isScrollViewerVisible: function () {
            var isVisible = this.documentSpace.is(":visible");
            return isVisible;
        },

        getSelectableInstance: function () {
            if (this._dvselectable == null)
                return null;
            var selectable = this._dvselectable.data("ui-dvselectable"); // jQueryUI 1.9+
            if (!selectable)
                selectable = this._dvselectable.data("dvselectable"); // jQueryUI 1.8
            return selectable;
        },

        shouldMinimumWidthBeUsed: function (width, checkOriginalDocumentWidth) {
            var originalDocumentWidth = null;
            if (this.use_pdf != 'false' && checkOriginalDocumentWidth) {
                var pageSize = this._pdf2XmlWrapper.getPageSize();
                originalDocumentWidth = pageSize.width;
            }
            return this.minimumImageWidth != null &&
                (width <= this.minimumImageWidth || (originalDocumentWidth !== null && originalDocumentWidth < this.minimumImageWidth));
        },

        resizeViewerElement: function (viewerLeft) {
            var parent = this.documentSpace.parent();
            var parentWidth = this.getScreenWidth(parent.get(0));
            if (typeof viewerLeft == "undefined")
                viewerLeft = 0;
            else
                this.viewerLeft = viewerLeft;
            this.documentSpace.width(Math.floor(parentWidth - viewerLeft));
            this.reInitSelectable();
            this.loadImagesForVisiblePages();
        },

        onPageReordered: function (oldPosition, newPosition) {
            this._model.reorderPage(this.fileId, oldPosition, newPosition,
                this.instanceIdToken,
                function (response) {
                    if (this.pageContentType == "image") {
                        var pages = this.pages();
                        //var page = pages()[oldPosition];
                        //pages.remove(page);
                        //pages.splice(newPosition, 0, page);
                        var pageImageUrl;
                        var minPosition = Math.min(oldPosition, newPosition);
                        var maxPosition = Math.max(oldPosition, newPosition);
                        for (var i = minPosition; i <= maxPosition; i++) {
                            //pages[i].visible(false);
                            pageImageUrl = pages[i].url();
                            pages[i].url(pageImageUrl + "#0"); // to avoid caching
                            pages[i].visible(true);
                            //pages[i].url(pageImageUrl);
                            //pages[i].visible(true);
                        }
                    }
                    if (this._pdf2XmlWrapper)
                        this._pdf2XmlWrapper.reorderPage(oldPosition, newPosition);
                    this.reInitSelectable();
                    this.loadImagesForVisiblePages();
                }.bind(this),
                function (error) {
                    this._onError(error);
                }.bind(this)
            );
        },

        rotatePage: function (rotationAmount) {
            var pageNumber = this.pageInd() - 1;
            this._model.rotatePage(this.fileId, pageNumber, rotationAmount,
                this.instanceIdToken,
                function (response) {
                    var page = this.pages()[pageNumber];
                    this.applyPageRotationInBrowser(pageNumber, page, response.resultAngle);
                    this.reflowPagesInChrome();
                    this.setPage(pageNumber + 1);
                    this.loadImagesForVisiblePages(true);
                }.bind(this),
                function (error) {
                    this._onError(error);
                }.bind(this));
        },

        applyPageRotationInBrowser: function (pageNumber, page, angle) {
            if (!this.supportPageRotation)
                return;
            var oldRotation = page.rotation();
            if (oldRotation == 0 && angle == 0)
                return;

            if (this.pageContentType == "image" && oldRotation != angle) {
                page.visible(false);
                this.addSuffixToImageUrl(page);
                page.visible(true);
            }

            page.rotation(angle);
            var newAngle = page.rotation() % 180;

            var pagesFromServer = this._pdf2XmlWrapper.documentDescription.pages;
            var pageSize, pageFromServer;

            var pageWidth, pageHeight, maxPageHeight;
            if (this.useTabsForPages()) {
                var htmlPageContents = this.documentSpace.find(".html_page_contents:first");
                var pageElement = htmlPageContents.children("div,table");
                pageWidth = pageElement.width();
                pageHeight = pageElement.height();
                this.initialWidth = pageWidth;

                if (newAngle > 0) {
                    maxPageHeight = pageWidth;
                    //this.pageWidth(pageHeight * this.zoom() / 100);
                }
                else {
                    maxPageHeight = pageHeight;
                    //this.pageWidth(pageWidth * this.zoom() / 100);
                }
                this.pageWidth(pageWidth * this.zoom() / 100);
                return;
            }
            else {
                if (pagesFromServer) {
                    pageSize = this.getPageSize();
                    pageFromServer = pagesFromServer[pageNumber];
                    pageFromServer.rotation = angle;
                    pageWidth = pageFromServer.w;
                    pageHeight = pageFromServer.h;
                    maxPageHeight = pageSize.height;
                }
                else
                    return;
            }

            var scaleRatio;

            if (newAngle > 0) {
                page.prop(pageWidth / pageHeight);
                if (this.pageContentType == "html") {
                    scaleRatio = this.getScaleRatioForPage(pageSize.width, pageSize.height, pageHeight, pageWidth);
                    page.heightRatio(scaleRatio);
                }
            }
            else {
                page.prop(pageHeight / pageWidth);
                if (this.pageContentType == "html") {
                    scaleRatio = this.getScaleRatioForPage(pageSize.width, pageSize.height, pageWidth, pageHeight);
                    page.heightRatio(scaleRatio);
                }
            }
            this.calculatePagePositionsForVirtualMode();
            this.reInitSelectable();
            var selectable = this.getSelectableInstance();
            if (selectable != null)
                selectable.clearSelectionOnPage(pageNumber);
            this.loadImagesForVisiblePages(true);
        },

        _calculatePageSizeFromDOM: function () {
            var htmlPageContents = this.documentSpace.find(".html_page_contents:first");
            var pageElement = htmlPageContents.children("div,table,img");
            if (this.autoHeight()) {
                var pageWidth = pageElement.width();
                this.initialWidth = pageWidth;
            }
            this.pageWidth(this.initialWidth * this.zoom() / 100);

            var dimensions = pageElement[0].getBoundingClientRect();
            var reserveHeight = 0;
            this.autoHeight(true);
            var page = this.pages()[0];
            var screenWidth;
            var screenHeight;
            if (typeof dimensions.width == "undefined") // IE8
                screenWidth = dimensions.right - dimensions.left;
            else
                screenWidth = dimensions.width;

            if (typeof dimensions.height == "undefined") // IE8
                screenHeight = dimensions.bottom - dimensions.top;
            else
                screenHeight = dimensions.height;

            if (page && page.rotation && page.rotation() % 180 > 0) {
                var t = screenWidth;
                screenWidth = screenHeight;
                screenHeight = t;
            }
            screenHeight += reserveHeight;
            page.prop(screenHeight / screenWidth);
            this.autoHeight(false);
        },

        reflowPagesInChrome: function (async) {
            /* a hack to make Chrome reflow pages after changing their size 
            when SVG watermarks are enabled */
            if (this.browserIsChrome() && this.watermarkText && !this.useVirtualScrolling) {
                var self = this;
                var internalReflow = function () {
                    self.pagesContainerElement.children().each(function () {
                        $(this).css("top", 0).css("left", 0);
                    });
                };

                if (async)
                    window.setTimeout(internalReflow, 10);
                else
                    internalReflow();
            }
        },

        getHtmlElements: function (pageHtml, tagName) {
            var contentsRegex = new RegExp("<" + tagName + "[^>]*>(?:.|\\r?\\n)*?<\\/" + tagName + ">", "gi");
            var contentsFromHtml = pageHtml.match(contentsRegex);
            return contentsFromHtml;
        },

        getHtmlElementContents: function (pageHtml, tagName) {
            var contentsRegex = new RegExp("<" + tagName + "[^>]*>((?:.|\\r?\\n)*?)<\\/" + tagName + ">", "i");
            var match = pageHtml.match(contentsRegex);
            var contentsFromHtml = null;
            if (match)
                contentsFromHtml = match[1];
            return contentsFromHtml;
        },

        getHtmlElementAttributess: function (pageHtml, tagName) {
            var contentsRegex = new RegExp("<" + tagName + "[^>]*/?>", "gi");
            var contentsFromHtml = pageHtml.match(contentsRegex);
            return contentsFromHtml;
        },

        getPageBodyContents: function (pageHtml) {
            var bodyContentsFromHtml = pageHtml.match(/<body[^>]*>((?:.|\r?\n)*?)<\/body>/)[1];
            return bodyContentsFromHtml;
        },

        getPageBodyContentsWithReplace: function (pageHtml) {
            //var matches = pageHtml.match(/(<body)([^>]*>)((?:.|\r?\n)*?)(<\/body>)/);
            //var bodyContentsFromHtml = "<div" + matches[2] + matches[3] + "</div>";
            var bodStartTag = "<body";
            var bodyTagStartPos = pageHtml.indexOf(bodStartTag);
            var bodyStartPos = bodyTagStartPos + bodStartTag.length;
            var bodyEndPos = pageHtml.indexOf("/body>");
            var bodyContentsFromHtml = "<div" + pageHtml.substr(bodyStartPos, bodyEndPos - bodyStartPos) + "/div>";
            return bodyContentsFromHtml;
        },

        isPageVisible: function (pageNumber) {
            return this.pages()[pageNumber].visible();
        },

        isFirstPageVisible: function () {
            var pages = this.pages();
            if (this.useVirtualScrolling) {
                var firstVisiblePageNum = this.firstVisiblePageForVirtualMode();
                var lastVisiblePageNum = this.lastVisiblePageForVirtualMode();
                return firstVisiblePageNum <= 0 && lastVisiblePageNum >= 0;
            }
            return pages[0].visible();
        },

        isLastPageVisible: function () {
            var pages = this.pages();
            var lastPageNum = pages.length - 1;
            if (this.useVirtualScrolling) {
                var firstVisiblePageNum = this.firstVisiblePageForVirtualMode();
                var lastVisiblePageNum = this.lastVisiblePageForVirtualMode();
                return firstVisiblePageNum <= lastPageNum && lastVisiblePageNum >= lastPageNum;
            }
            return pages[lastPageNum].visible();
        },

        getPageLocations: function () {
            return this.getSelectableInstance().pageLocations;
        },

        getPageSize: function () {
            var pageSize = this._pdf2XmlWrapper.getPageSize();
            return pageSize;
        },

        fixImageReferencesInHtml: function (pageHtml) {
            var bodyContentsFromHtml = this.getPageBodyContents(pageHtml);
            return bodyContentsFromHtml;
        },

        calculatePointToPixelRatio: function () {
            var pointWidth = 100;
            var testElement = $("<div/>").css("width", pointWidth + "pt").css("height", "0");
            testElement.appendTo(this.documentSpace);
            var pixelWidth = testElement.width();
            this.pointToPixelRatio = pixelWidth / pointWidth;
            testElement.remove();
        },

        activateTab: function (number) {
            var tab = this.tabs()[number];
            var self = this;

            function activateLoadedTab() {
                var pages = self.pages();
                var page = pages[0];
                page.htmlContent(tab.htmlContent());
                var htmlPageContents = self.documentSpace.find(".html_page_contents:first");
                var pageElement = htmlPageContents.children("div,table");
                var pageWidth = pageElement.width();
                self.initialWidth = pageWidth;
                page.prop(pageElement.height() / pageWidth);
                self.pageWidth(pageWidth * self.zoom() / 100);
                
                self.activeTab(number);
                if (self.supportPageRotation)
                    self.applyPageRotationInBrowser(0, page, page.rotation());
            }

            if (tab.visible()) {
                activateLoadedTab();
            }
            else {
                this.getDocumentPageHtml(number, function () {
                    activateLoadedTab();
                });
            }
        },

        adjustInitialZoom: function () {
            var zoomIsSet = false;
            if (this.zoomToFitHeight) {
                zoomIsSet = true;
                this.setZoom(this.getFitHeightZoom());
            }
            else if (this.pageContentType == "html" && this.zoomToFitWidth) {
                //this.initialWidth = this.pageImageWidth = this.getFitWidth();
                var fittingWidth = this.getFitWidth();
                var originalPageWidth = this.pageWidth();
                if (!this.onlyShrinkLargePages || originalPageWidth > fittingWidth) {
                    var zoom = fittingWidth / originalPageWidth * 100;
                    zoomIsSet = true;
                    this.setZoom(zoom);
                }
            }

            if (!zoomIsSet && this.useTabsForPages()) {
                this._calculatePageSizeFromDOM();
            }
        },

        intToColor: function (num) {
            if (num === null)
                num = 0xFFFF0000; // default is red
            else
                num >>>= 0;

            var b = num & 0xFF,
                g = (num & 0xFF00) >>> 8,
                r = (num & 0xFF0000) >>> 16,
                a = ((num & 0xFF000000) >>> 24) / 255;
            return "rgba(" + [r, g, b, a].join(",") + ")";
        },

        watermarkTransform: function (page, element) {
            var rotation = 0;
            if (page.rotation)
                rotation = page.rotation();

            var pageProportion = page.prop();
            var top = "Top", bottom = "Bottom", diagonal = "Diagonal";
            var left = "Left", center = "Center", right = "Right";
            var vertical = "", horizontal = center;
            if (this.watermarkPosition.indexOf(top) == 0)
                vertical = top;
            else if (this.watermarkPosition.indexOf(bottom) == 0)
                vertical = bottom;
            else if (this.watermarkPosition.indexOf(diagonal) == 0) {
                vertical = diagonal;
                horizontal = center;
            }

            if (vertical != diagonal) {
                if (this.watermarkPosition.indexOf(left) != -1)
                    horizontal = left;
                else if (this.watermarkPosition.indexOf(center) != -1)
                    horizontal = center;
                else if (this.watermarkPosition.indexOf(right) != -1)
                    horizontal = right;
            }
            var returnValue = "translate";
            //var widthWithoutMargin = this.pageWidth();
            //var pageWidth = widthWithoutMargin + this.imageHorizontalMargin;
            //var pageHeight = widthWithoutMargin * pageProportion;
            var fontHeight = 10;
            var pageWidth = 100;
            var pageHeight = pageWidth * pageProportion;
            var textWidth;
            if (this.watermarkScreenWidth == null) {
                var textSize = element.getBBox();
                this.watermarkScreenWidth = textSize.width;
            }
            textWidth = this.watermarkScreenWidth;

            var scale;
            if (this.watermarkWidth == 0)
                scale = 1;
            else
                scale = this.watermarkWidth / 100.;

            var smallerSide = pageWidth;
            if (vertical == diagonal && pageHeight < pageWidth) {
                smallerSide = pageHeight;
            }
            var watermarkWidth = smallerSide * scale;
            var scaleToFitIntoPageWidth = smallerSide / textWidth;
            if (rotation % 180 != 0 && vertical != diagonal) {
                watermarkWidth = pageHeight * scale;
                scaleToFitIntoPageWidth = pageHeight / textWidth;
            }
            scale *= scaleToFitIntoPageWidth;
            var horizontalCenter = pageWidth / 2;
            var verticalCenter = pageHeight / 2;

            var horizontalShift = 0;
            switch (horizontal) {
                case center:
                    horizontalShift = ((pageWidth - watermarkWidth) / 2);
                    break;
                case left:
                    horizontalShift = 0;
                    break;
                case right:
                    horizontalShift = pageWidth - watermarkWidth;
                    break;
            }
            //Adjust vertical shift in order to eliminate text cropping
            var verticalShift;
            if (vertical === bottom) {
                verticalShift = (pageHeight - pageHeight * scale - 8);
            }
            else if (vertical === diagonal) {
                verticalShift = (pageHeight - pageHeight * scale);
            }
            else {//(vertical == top)
                verticalShift = 0;
            }
            returnValue += '(' + horizontalShift + "," + verticalShift + ')' +
                'scale(' + scale + ')';

            if (vertical == diagonal)
                returnValue += 'translate(0,' + (-verticalCenter / scale) + ') rotate(' + (-50 + rotation) + ',' + (horizontalCenter - horizontalShift) / scale + ',' + pageHeight + ') ';

            if (!page.rotation || vertical == diagonal)
                return returnValue;

            //var screenCenterMinusFontHeight = screenCenter - 10;
            var firstShift = 0, secondShift = 0, secondHorizontalShift = 0;
            var rotationCenterX, rotationCenterY = 0;
            if (horizontal == center) {
                rotationCenterX = (horizontalCenter - horizontalShift) / scale;
                if (vertical == top) {
                    rotationCenterY = 0;
                }
                else {
                    rotationCenterY = pageHeight;
                }
            }
            else if (horizontal == left) {
                rotationCenterX = horizontalCenter / scale;
                if (rotation % 180 != 0)
                    secondHorizontalShift = (horizontalCenter - verticalCenter) / scale;
                if (vertical == top) {
                    rotationCenterY = 0;
                }
                else {
                    rotationCenterY = pageHeight;
                }
            }
            else if (horizontal == right) {
                rotationCenterX = -(horizontalShift - horizontalCenter) / scale;
                if (rotation % 180 != 0)
                    secondHorizontalShift = -(horizontalCenter - verticalCenter) / scale;

                if (vertical == top) {
                    rotationCenterY = 0;
                }
                else {
                    rotationCenterY = pageHeight;
                }
            }

            switch (rotation) {
                case 90:
                    if (vertical == top) {
                        firstShift = verticalCenter / scale;
                        secondShift = -horizontalCenter / scale;
                    }
                    else {
                        firstShift = -verticalCenter / scale;
                        secondShift = horizontalCenter / scale;
                    }
                    break;
                case 180:
                    if (vertical == top) {
                        firstShift = verticalCenter / scale;
                        secondShift = -verticalCenter / scale;
                    }
                    else {
                        firstShift = -verticalCenter / scale;
                        secondShift = verticalCenter / scale;
                    }
                    break;
                case 270:
                    if (vertical == top) {
                        firstShift = verticalCenter / scale;
                        secondShift = -horizontalCenter / scale;
                    }
                    else {
                        firstShift = -verticalCenter / scale;
                        secondShift = horizontalCenter / scale;
                    }
                    break;
            }
            if (vertical == top || vertical == bottom)
                returnValue += 'translate(0,' + firstShift + ') rotate(' + rotation + ',' + rotationCenterX + ',' + rotationCenterY + ') translate(' + secondHorizontalShift + ',' + secondShift + ')';
            return returnValue;
        },

        addSuffixToImageUrl: function (page) {
            var src = page.url();
            var prefixChar = "?";
            var dummyIndex = src.indexOf('dummy=');
            if (dummyIndex != -1) {
                src = src.substring(0, dummyIndex - 1);
            }

            var paramsIndex = src.indexOf('?');
            if (paramsIndex != -1)
                prefixChar = "&";
            page.url(src + prefixChar + 'dummy=' + new Date().getTime());
        },

        isRTL: function (s) {
            return false; // Aspose.Words 15.3 fixes RTL text
            var ltrChars = 'A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02B8\u0300-\u0590\u0800-\u1FFF' + '\u2C00-\uFB1C\uFDFE-\uFE6F\uFEFD-\uFFFF',
                rtlChars = '\u0591-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC',
                rtlDirCheck = new RegExp('^[^' + ltrChars + ']*[' + rtlChars + ']');

            return rtlDirCheck.test(s);
        },

        setLoadingState: function (set) {
            this.inprogress(set);
        },

        getScaleRatioForPage: function (widthForMaxHeight, maxPageHiegt, pageWidth, pageHeight) {
            var widthRatio, scaleRatio;
            if (widthForMaxHeight === undefined)
                widthRatio = 1;
            else
                widthRatio = widthForMaxHeight / pageWidth;
            scaleRatio = widthRatio;
            return scaleRatio;
        },

        pageElementStyle: function (index) {
            var result = {};
            var pages = this.pages();
            if (this.useVirtualScrolling) {
                var firstVisiblePageNum = this.firstVisiblePageForVirtualMode();
                index += firstVisiblePageNum;
                if (firstVisiblePageNum < pages.length)
                    result.top = pages[firstVisiblePageNum].top() + 'px';
            }
            else
                result.top = '';

            if (this.layout() == this.Layouts.OnePageInRow) {
                result.display = 'block';
                result.marginLeft = 'auto';
                result.marginRight = 'auto';
            }
            else {
                result.display = '';
                result.marginLeft = '';
                result.marginRight = '';
            }

            var pageWidth = this.pageWidth();

            if (this.options.useEmScaling) {
                result.width = this.serverPages[index].w * this.pointToPixelRatio / 16. + 'em';
                result.height = this.serverPages[index].h * this.pointToPixelRatio / 16. + 'em';
            }
            else {
                result.width = pageWidth + (this.useHtmlBasedEngine ? this.imageHorizontalMargin : 0) + 'px';
                if (this.autoHeight()) {
                    result.width = 'auto';
                    result.height = 'auto';
                    result.overflow = 'visible';
                }
                else {
                    if (index < pages.length)
                        result.height = pageWidth * pages[index].prop() + 'px';
                    result.overflow = 'hidden';
                }
            }

            return result;
        },

        setLayout: function (layout) {
            this.layout(layout);
            this.calculatePagePositionsForVirtualMode();
            this.loadImagesForVisiblePages();
            this.documentSpace.trigger("layoutChanged.groupdocs");
        },

        calculatePagePositionsForVirtualMode: function () {
            if (this.useVirtualScrolling) {
                var pageVerticalMargin = 15; // pixels
                var pageHorizontalMargin = this.pageWrapperHorizontalMargin; // pixels from left
                var pages = this.pages();
                var width = this.pageWidth();
                var documentHeight = 0;
                var page, proportion, pageHeight;
                var pageLeft, pageTop;
                var rowHeight = 0;
                var pagesInRow;
                var scrollbarWidth = 0;
                var documentSpaceRect = this.documentSpace.get(0).getBoundingClientRect();
                var documentSpaceWidth = documentSpaceRect.width;
                var layout = this.layout();
                for (var pass = 0; pass <= 1; pass++) {
                    pageLeft = pageHorizontalMargin;
                    pageTop = 0;
                    switch (layout) {
                        case this.Layouts.ScrollMode:
                            var widthWithMargin = width + pageHorizontalMargin;
                            var pagesContainerWidth = documentSpaceWidth - scrollbarWidth;
                            pagesInRow = Math.floor(pagesContainerWidth / widthWithMargin);
                            if (pagesInRow == 0)
                                pagesInRow = 1;
                            break;
                        case this.Layouts.OnePageInRow:
                            pagesInRow = 1;
                            break;
                        case this.Layouts.TwoPagesInRow:
                        case this.Layouts.CoverThenTwoPagesInRow:
                            pagesInRow = 2;
                            break;
                    }

                    var isFirstPageInRow, isLastPageInRow;
                    var i;
                    for (i = 0; i < pages.length; i++) {
                        page = pages[i];
                        proportion = page.prop();
                        pageHeight = width * proportion;
                        page.left = pageLeft;
                        page.top(pageTop);
                        isFirstPageInRow = (layout != this.Layouts.CoverThenTwoPagesInRow && i % pagesInRow == 0)
                        || (layout == this.Layouts.CoverThenTwoPagesInRow && (i == 0 || i % pagesInRow == 1));

                        isLastPageInRow = layout == this.Layouts.OnePageInRow
                        || (layout == this.Layouts.TwoPagesInRow && i % pagesInRow == 1)
                        || (layout == this.Layouts.CoverThenTwoPagesInRow && (i == 0 || i % pagesInRow == 0))
                        || (layout == this.Layouts.ScrollMode && i % pagesInRow == pagesInRow - 1);

                        if (isFirstPageInRow || (!isFirstPageInRow && pageHeight > rowHeight))
                            rowHeight = pageHeight;
                        documentHeight = pageTop + rowHeight + pageVerticalMargin;

                        if (isLastPageInRow) {
                            pageTop += rowHeight + pageVerticalMargin;
                            if (layout != this.Layouts.OnePageInRow)
                                pageLeft = pageHorizontalMargin;
                        }
                        else {
                            if (layout != this.Layouts.OnePageInRow)
                                pageLeft += width + pageHorizontalMargin;
                        }
                    }
                    this.documentHeight(documentHeight);

                    var isScrollbarPresent = false;
                    if (layout == this.Layouts.OnePageInRow || layout == this.Layouts.ScrollMode) {
                        isScrollbarPresent = documentHeight > documentSpaceRect.height;
                        if (isScrollbarPresent)
                            scrollbarWidth = this.getScrollbarWidth();
                    }
                    if (layout != this.Layouts.ScrollMode || !isScrollbarPresent)
                        break;
                }

                if (layout == this.Layouts.OnePageInRow) {
                    pageLeft = (documentSpaceWidth - width - scrollbarWidth) / 2;
                    for (i = 0; i < pages.length; i++) {
                        page = pages[i];
                        page.left = pageLeft;
                    }
                }
            }
        },

        triggerEvent: function (name, params) {
            this.documentSpace.trigger(name, params);
        },

        clearContentControls: function () {
            if (!this.supportListOfContentControls || !this.contentControlsFromHtml)
                return;
            var contentControlFromHtml;
            for (var i = 0; i < this.contentControlsFromHtml.length; i++) {
                contentControlFromHtml = this.contentControlsFromHtml[i];
                if (typeof contentControlFromHtml != "undefined" && contentControlFromHtml.visualWrapper) {
                    contentControlFromHtml.visualWrapper.remove();
                }
            }
            this.contentControlsFromHtml.length = 0;
        },

        markContentControls: function (pageNumber) {
            if (!this.supportListOfContentControls || !this.contentControls)
                return;

            var i, contentControlFromHtml;
            for (i = 0; i < this.contentControlsFromHtml.length; i++) {
                contentControlFromHtml = this.contentControlsFromHtml[i];
                if (typeof contentControlFromHtml != "undefined" && contentControlFromHtml.pageNumber == pageNumber) {
                    return;
                }
            }
            //"2D5FABC2_1start1=Document_-_Document_"
            var contentControlGuid = "2D5FABC2";
            var startType = "start";
            var endType = "end";
            var separator = "=";

            var spaceToSearchIn = this.documentSpace;
            if (typeof pageNumber != "undefined")
                spaceToSearchIn = this.documentSpace.find("#" + this.pagePrefix + (pageNumber + 1).toString());

            spaceToSearchIn.find(".content_control_visual_wrapper").remove();

            var contentControlMarkers = spaceToSearchIn.find("a[name^='" + contentControlGuid + "']");
            var contentControlsFromHtml = new Array();
            var wrappersRemain = 0;
            var contentControlNumber;
            var self = this;
            contentControlMarkers.each(function () {
                var that = $(this);
                var name = that.attr("name");
                var typePositionRegex = new RegExp("(" + startType + ")|(" + endType + ")");
                var typePosition = name.search(typePositionRegex);

                var contentControlNumberText = name.substring(contentControlGuid.length + 1, typePosition);
                contentControlNumber = parseInt(contentControlNumberText);

                if (pageNumber >= self.contentControls[contentControlNumber].startPage
                       && pageNumber <= self.contentControls[contentControlNumber].endPage) {

                    if (name.indexOf(startType) == typePosition) {
                        var contentControlTitlePosition = name.indexOf(separator, typePosition) + 1;
                        var contentControlTitle = name.substring(contentControlTitlePosition, name.length);
                        var moveUpInDom = name[typePosition + startType.length] == "1";
                        var startElement = that;
                        if (typeof contentControlsFromHtml[contentControlNumber] == "undefined") {
                            if (moveUpInDom || startElement.parent().children(":not([name^='" + contentControlGuid + "'])").length == 0)
                                startElement = startElement.parent();
                            contentControlsFromHtml[contentControlNumber] = {
                                title: contentControlTitle,
                                number: contentControlNumber
                            };
                        }
                        contentControlsFromHtml[contentControlNumber].startElement = startElement;
                        contentControlsFromHtml[contentControlNumber].moveUpInDom = moveUpInDom;
                    }
                    else {
                        if (that.parent().children(":not([name^='" + contentControlGuid + "'])").length == 0)
                            that = that.parent();

                        if (typeof contentControlsFromHtml[contentControlNumber] == "undefined") {
                            contentControlsFromHtml[contentControlNumber] = { endElement: that, number: contentControlNumber };
                        }
                        contentControlsFromHtml[contentControlNumber].endElement = that;
                    }
                }
            });

            for (i = 0; i < this.contentControls.length; i++) {
                if (pageNumber >= this.contentControls[i].startPage
                    && pageNumber <= this.contentControls[i].endPage) {
                    if (!contentControlsFromHtml[i]) {
                        contentControlsFromHtml[i] = {
                            number: i, title: this.contentControls[i].title
                        };
                    }
                }
            }

            for (i = 0; i < contentControlsFromHtml.length; i++) {
                contentControlFromHtml = contentControlsFromHtml[i];
                if (contentControlFromHtml) {
                    if (!contentControlFromHtml.startElement) {
                        contentControlFromHtml.startElement = spaceToSearchIn
                            .children(".html_page_contents").children(".pageWordToHtml").children(":first");
                    }

                    if (!contentControlFromHtml.endElement) {
                        contentControlFromHtml.endElement = spaceToSearchIn
                            .children(".html_page_contents").children(".pageWordToHtml").children(":last");
                    }

                    contentControlFromHtml.title = this.contentControls[i].title;
                    contentControlFromHtml.pageNumber = pageNumber;

                    wrappersRemain++;

                    (function (contentControlNumberInner) {
                        window.setTimeout(function () {
                            wrappersRemain--;
                            self.createContentControlWrappers(spaceToSearchIn, contentControlsFromHtml, contentControlNumberInner, contentControlGuid, wrappersRemain);
                        }, 2000);
                    })(i);
                }
            }
        },


        createContentControlWrappers: function (spaceToSearchIn, contentControlsFromHtml, contentControlNumber, contentControlGuid, wrappersRemain) {
            var contentControlFromHtml = contentControlsFromHtml[contentControlNumber];
            var startElement = contentControlFromHtml.startElement;
            var endElement = contentControlFromHtml.endElement;

            var top = startElement.offset().top;
            top -= this.pagesContainerElement.offset().top;
            var contentControlVisualWrapper = $("<div/>").appendTo(spaceToSearchIn);
            contentControlFromHtml.visualWrapper = contentControlVisualWrapper;
            contentControlVisualWrapper.addClass("content_control_visual_wrapper");

            var elementsBetween = startElement.nextUntil(endElement, ":not([name^='" + contentControlGuid + "'])").add(endElement);
            if (contentControlFromHtml.moveUpInDom)
                elementsBetween = elementsBetween.add(startElement);
            var childrenBetween = elementsBetween.find("*");
            elementsBetween = elementsBetween.add(childrenBetween);
            var minLeft = null, maxRight = null, minTop = null, maxBottom = null;
            var innerElementLeft, innerElementWidth, innerElementTop, innerElementHeight;
            var currentZoom = this.zoom() / 100;
            elementsBetween.each(function () {
                var innerElement = $(this);
                if (innerElement.width() == 0 || innerElement.height() == 0)
                    return;
                innerElementLeft = innerElement.offset().left;

                if (minLeft === null || innerElementLeft < minLeft)
                    minLeft = innerElementLeft;

                innerElementWidth = innerElement.width() * currentZoom;
                if (maxRight === null || innerElementLeft + innerElementWidth > maxRight)
                    maxRight = innerElementLeft + innerElementWidth;

                innerElementTop = innerElement.offset().top;
                if (minTop === null || innerElementTop < minTop)
                    minTop = innerElementTop;

                innerElementHeight = innerElement.height() * currentZoom;
                if (maxBottom === null || innerElementTop + innerElementHeight > maxBottom)
                    maxBottom = innerElementTop + innerElementHeight;
            });
            //var containerOffsetLeft = self.pagesContainerElement.offset().left;
            //var containerOffsetTop = self.pagesContainerElement.offset().top;

            var containerOffsetLeft = spaceToSearchIn.offset().left;
            var containerOffsetTop = spaceToSearchIn.offset().top;

            contentControlVisualWrapper.css("left", (minLeft - containerOffsetLeft) + "px");
            contentControlVisualWrapper.css("width", maxRight - minLeft + "px");
            contentControlVisualWrapper.css("top", (minTop - containerOffsetTop) + "px");
            contentControlVisualWrapper.css("height", maxBottom - minTop + "px");

            contentControlVisualWrapper.attr("data-title", contentControlFromHtml.title);
            if (wrappersRemain == 0) {
                contentControlsFromHtml.sort(function (a, b) {
                    if (a.visualWrapper && b.visualWrapper)
                        return b.visualWrapper.width() * b.visualWrapper.height() - a.visualWrapper.width() * a.visualWrapper.height();
                    else
                        return 0;
                });
                var startZIndex = 1;
                for (var i = 0; i < contentControlsFromHtml.length; i++) {
                    contentControlFromHtml = contentControlsFromHtml[i];
                    if (typeof contentControlFromHtml != "undefined" && contentControlFromHtml.visualWrapper) {
                        contentControlFromHtml.visualWrapper.css("z-index", i + startZIndex);
                        if (this.contentControlToBeOpened !== null && this.contentControlToBeOpened == contentControlFromHtml.number) {
                            this.visuallySelectContentControl(contentControlFromHtml);
                            this.contentControlToBeOpened = null;
                        }
                    }
                    this.contentControlsFromHtml.push(contentControlsFromHtml[i]);
                }
            }
        },

        getContentControlDescriptions: function () {
            return this.contentControls;
        },

        navigateToContentControl: function (number) {
            number = parseInt(number);
            var pageNumber = this.contentControls[number].startPage;
            var found = false;
            if (this.pages()[pageNumber].visible()) {
                var contentControlFromHtml;
                for (var i = 0; i < this.contentControlsFromHtml.length; i++) {
                    contentControlFromHtml = this.contentControlsFromHtml[i];
                    if (typeof contentControlFromHtml != "undefined" && contentControlFromHtml.number == number) {
                        this.visuallySelectContentControl(contentControlFromHtml);
                        found = true;
                        break;
                    }
                }
            }

            if (!found) {
                this.contentControlToBeOpened = number;
                this.setPage(pageNumber + 1);
            }
        },

        visuallySelectContentControl: function (contentControlFromHtml) {
            var contentControlHeaderHeight = 20;
            this.documentSpace[0].scrollTop = contentControlFromHtml.visualWrapper.offset().top -
                 this.pagesContainerElement.offset().top -
                 contentControlHeaderHeight;

            var hoverClass = "hover";
            var allWrappers = this.documentSpace.find(".doc-page .content_control_visual_wrapper");
            allWrappers.removeClass(hoverClass);
            allWrappers.unbind("mouseleave");
            contentControlFromHtml.visualWrapper.addClass(hoverClass);
            allWrappers.bind("mouseleave", function () {
                contentControlFromHtml.visualWrapper.removeClass(hoverClass);
                allWrappers.unbind("mouseleave");
            });
            this.documentSpace.trigger("ScrollDocView", [null, { target: this.documentSpace[0] }]);
            this.documentSpace.trigger("ScrollDocViewEnd", [null, { target: this.documentSpace[0] }]);
        },

        initCustomBindings: function () {
            if (!ko.bindingHandlers.searchText) {
                ko.bindingHandlers.searchText = {
                    update: function (element, valueAccessor, allBindings, viewModelParam, bindingContext) {
                        var viewModel = bindingContext.$root;
                        var page = bindingContext.$data;
                        if (!page.searched) {
                            var value = ko.utils.unwrapObservable(valueAccessor());
                            viewModel.parseSearchParameters(element, value);
                        }
                        page.searched = false;
                    }
                };
            }

            if (!ko.bindingHandlers.parsedHtml) {
                ko.bindingHandlers.parsedHtml = {
                    init: function (element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
                        var modelValue = valueAccessor();
                        var jqueryElement = $(element);
                        var elementValue = jqueryElement.html();

                        if (ko.isWriteableObservable(modelValue)) {
                            modelValue(elementValue);
                        }
                        else { //handle non-observable one-way binding
                            var allBindings = allBindingsAccessor();
                            if (allBindings['_ko_property_writers'] && allBindings['_ko_property_writers'].parsedHtml)
                                allBindings['_ko_property_writers'].parsedHtml(elementValue);
                        }
                    },
                    update: function (element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
                        var value = ko.unwrap(valueAccessor()) || "";
                        var page = bindingContext.$data;
                        var jqueryElement = $(element);
                        jqueryElement.empty();
                        if (value) {
                            if (typeof page.currentValue == "undefined"
                                || page.currentValue === null
                                || page.currentValue != value) {
                                var trimmedValue = value.replace(/^[\r\n\s]+|[\r\n\s]+$/g, "");
                                page.parsedHtmlElement = $(trimmedValue);
                                page.currentValue = value;
                            }
                            jqueryElement.append(page.parsedHtmlElement);
                        }
                        else {
                            page.parsedHtmlElement = null;
                            page.currentValue = null;
                        }
                    }
                };
            }
        },

        parseSearchParameters: function (element, value) {
            var viewModel = this;
            viewModel.removeSearchHighlight(element);
            if (value) {
                var text = value.text;
                if (text) {
                    var words;
                    var isCaseSensitive = value.isCaseSensitive;
                    var treatTextAsExact = false;
                    if (value.treatPhrasesInDoubleQuotesAsExact) {
                        var trimmedText = text.replace(/^[\r\n\s]+|[\r\n\s]+$/g, "");
                        if (trimmedText.length >= 2 && trimmedText[0] == '"' && trimmedText[trimmedText.length - 1] == '"') {
                            text = text.substr(1, trimmedText.length - 2);
                            text = text.replace(/^[\r\n\s]+|[\r\n\s]+$/g, "");

                            viewModel.currentWordCounter = 0;
                            viewModel.matchedNods = [];
                            viewModel.searchMatches = [];
                            viewModel.matchedNodsCount = 0;
                            treatTextAsExact = true;
                        }
                    }
                    var reservedSymbolsRegExp = /[-[\]{}()*+?.,\\^$|#\s]/g;

                    words = viewModel.getWords(text);
                    if (words == null)
                        return;
                    words = jQuery.map(words, function (word, i) {
                        return word.replace(reservedSymbolsRegExp, "\\$&");
                    });

                    var wordsWithAccentedChars = words;
                    var processedWord;
                    if (viewModel.useAccentInsensitiveSearch || viewModel.useRtl) {
                        wordsWithAccentedChars = new Array();

                        for (wordNum = 0; wordNum < words.length; wordNum++) {
                            processedWord = words[wordNum];
                            if (viewModel.useAccentInsensitiveSearch)
                                processedWord = window.jGroupdocs.stringExtensions.getAccentInsensitiveRegexFromString(processedWord);
                            //if (viewModel.useRtl)
                            //    processedWord = window.jGroupdocs.stringExtensions.unicodeEscape(processedWord);

                            wordsWithAccentedChars.push(processedWord);
                        }
                    }

                    viewModel.searchHtmlElement(element, null, null, words, wordsWithAccentedChars,
                                                value.searchForSeparateWords, isCaseSensitive, treatTextAsExact, value.pageNumber);
                    return;
                }
            }
        },

        highlightSearch: function () {
            if (this.pageContentType == "image" && this.useVirtualScrolling) {
                var selectable = this.getSelectableInstance();
                if (selectable) {
                    selectable.highlightSearch(
                        this.firstVisiblePageForVirtualMode(),
                        this.lastVisiblePageForVirtualMode());
                }
            }
        },

        firePageImageLoadedEvent: function (pageNumber, event) {
            this.firePageImageEvent(pageNumber, event, false);
        },

        firePageImageLoadErrorEvent: function (pageNumber, event) {
            this.firePageImageEvent(pageNumber, event, true);
        },

        firePageImageEvent: function (pageNumber, event, isErrorEvent) {
            var domElement = event.target;

            if (this.useFullSizeImages || isErrorEvent) {
                var pages = this.pages();
                var page = null;
                if (pageNumber < pages.length)
                    page = pages[pageNumber];

                if (page) {
                    if (page.visible()) {
                        page.domElement = domElement;
                        if (isErrorEvent) {
                            this.triggerEvent("pageImageLoadError.groupdocs", [pageNumber, domElement]);
                            this._onError({ Reason: "The page " + pageNumber + " can't be loaded" });
                        }
                        else
                            this.triggerEvent("pageImageLoaded.groupdocs", [pageNumber, domElement]);
                    }
                }
            }
        },

        raiseDocumentLoadCompletedEvent: function () {
            this.documentSpace.trigger("documentLoadCompleted.groupdocs");
        },

        _setTextPositionsCalculationFinished: function (value) {
            if (!this._isTextPositionsCalculationFinished) {
                this._isTextPositionsCalculationFinished = value;
                if (value)
                    this.raiseDocumentLoadCompletedEvent();
            }
        },

        getScreenWidth: function (domElement) {
            var dimensions = domElement.getBoundingClientRect();
            var screenWidth;

            if (typeof dimensions.width == "undefined") // IE8
                screenWidth = dimensions.right - dimensions.left;
            else
                screenWidth = dimensions.width;
            return screenWidth;
        },

        visiblePagesChangedHandler: function () {
            this.highlightSearch();
            this.triggerEvent("visiblePagesChanged.groupdocs");
        }
    });
})(jQuery);
(function ($, undefined) {
    $.widget('ui.navigation', {
        _viewModel: null,
        _pageCount: 0,

        _create: function () {
            if (this.options.createHtml) {
                this._createHtml();
            }
            else if (this.options.createEmbeddedHtml) {
                this._createEmbeddedHtml();
            }
            this._viewModel = this.getViewModel();
            ko.applyBindings(this._viewModel, this.element.get(0));
        },
        _createViewModel: function () {
            var viewModel = {
                pageInd: ko.observable(1),
                pageCount: ko.observable(0)
            };

            viewModel.up = function () {
                this.up();
            }.bind(this);

            viewModel.down = function () {
                this.down();
            }.bind(this);

            viewModel.selectPage = function (pageIndex) {
                this.set(pageIndex);
            }.bind(this);

            viewModel.onKeyPress = function (viewModelObject, e) {
                this.onKeyPress(e);
                return true;
            }.bind(this);

            viewModel.setPageIndex = function (index) {
                this.setPageIndex(index);
            }.bind(this);

            viewModel.openFirstPage = function () {
                this.set(1);
            }.bind(this);

            viewModel.openLastPage = function () {
                this.set(this._viewModel.pageCount());
            }.bind(this);

            viewModel.setPagesCount = function (pagesCount) {
                this.setPagesCount(pagesCount);
            }.bind(this);

            return viewModel;
        },
        getViewModel: function () {
            if (!this._viewModel) {
                this._viewModel = this._createViewModel();
            }
            return this._viewModel;
        },
        up: function () {
            var ci = this._viewModel.pageInd();
            var pc = this._viewModel.pageCount();
            var ni;
            if (ci <= 0)
                ni = 1;
            else {
                if (ci > pc)
                    ni = pc;
                else
                    ni = ci != 1 ? ci - 1 : 1;
            }
            this._viewModel.pageInd(ni);
            $(this.element).trigger('onUpNavigate', ni);
        },
        down: function () {
            var ci = this._viewModel.pageInd();
            var pc = this._viewModel.pageCount();
            var ni;
            if (ci <= 0)
                ni = 1;
            else {
                if (ci > pc)
                    ni = pc;
                else
                    ni = ci != pc ? (parseInt(ci) + 1) : ci;
            }
            this._viewModel.pageInd(ni);
            $(this.element).trigger('onDownNavigate', ni);
        },

        set: function (index) {
            var oldPageIndex = this._viewModel.pageInd();
            var newPageIndex = this.setPageIndex(index);

            var direction = 'up';
            if (oldPageIndex > newPageIndex)
                direction = 'down';
            $(this.element).trigger('onSetNavigate', { pageIndex: newPageIndex, direction: direction });
        },

        setPageIndex: function (index) {
            var newPageIndex = Number(index);

            var pc = this._viewModel.pageCount();
            if (isNaN(newPageIndex))
                newPageIndex = 1;
            else if (newPageIndex <= 0)
                newPageIndex = 1;
            else if (newPageIndex > pc)
                newPageIndex = pc;

            this._viewModel.pageInd(newPageIndex);
            return newPageIndex;
        },

        openFirstPage: function () {
            this.selectPage(1);
        },

        openLastPage: function () {
            this.selectPage(this.pageCount());
        },

        onKeyPress: function (e) {
            if (e.keyCode == 13) {
                this.set(this._viewModel.pageInd());
            }
        },
        setPagesCount: function (pagesCount) {
            this._pageCount = pagesCount;
            this._viewModel.pageCount(pagesCount);
        },

        _createHtml: function () {
            var root = this.element;
            root.addClass('left');

            $('<span class="new_head_tools_btn h_t_i_nav1" data-bind="click: function() { selectPage(1); }, css: {disabled: pageInd() <= 1}" data-tooltip="First Page" data-localize-tooltip="FirstPage"></span>' +
              '<span class="new_head_tools_btn h_t_i_nav2" data-bind="click: up, css: {disabled: pageInd() <= 1}" data-tooltip="Previous Page" data-localize-tooltip="PreviousPage"></span>' +
              '<input class="new_head_input" type="text" style="width: 17px;" data-bind="value: pageInd, valueUpdate: [\'afterkeydown\'], event: { keyup: onKeyPress }" />' +
              '<p class="new_head_of" data-localize="Of">of</p>' +
              '<p class="new_head_of" data-bind="text: pageCount()"></p>' +
            //'<p class="new_head_of" data-bind="text: \'of \' + pageCount()"></p>' +
              '<span class="new_head_tools_btn h_t_i_nav3" data-bind="click: down, css: {disabled: pageInd() >= pageCount()}" data-tooltip="Next Page" data-localize-tooltip="NextPage"></span>' +
              '<span class="new_head_tools_btn h_t_i_nav4" data-bind="click: function() { selectPage(this.pageCount()); }, css: {disabled: pageInd() >= pageCount()}" data-tooltip="Last Page" data-localize-tooltip="LastPage"></span>').appendTo(root);
            root.trigger("onHtmlCreated");
        },

        _createEmbeddedHtml: function () {
            var root = this.element;
            root.addClass('left');

            $('<span class="embed_viewer_icons icon1" data-bind="click: function() { selectPage(1); }"></span>' +
              '<span class="embed_viewer_icons icon2" data-bind="click: up"></span>' +
              '<p>Page</p>' +
              '<input type="text" name="textfield" class="page_nmbr" data-bind="value: pageInd, valueUpdate: [\'afterkeydown\'],  event: { keyup: onKeyPress }"/>' +
              '<p>of <span data-bind="text: pageCount()" ></span></p>' +
              '<span class="embed_viewer_icons icon3" data-bind="click: down"></span>' +
              '<span class="embed_viewer_icons icon4" data-bind="click: function() { selectPage(this.pageCount()); }"></span>'
                ).appendTo(root);
            root.trigger("onHtmlCreated");
        }

    });
})(jQuery);
(function ($, undefined) {
    $.widget('ui.zooming', {
        options: {
            zoomValues: [5, 15, 25, 50, 75, 100, 125, 150, 175, 200, 300, 400, 600]
        },
        _viewModel: null,
        _create: function () {
            if (this.options.createHtml) {
                this._createHtml();
            }
            this._viewModel = this.getViewModel();
            ko.applyBindings(this._viewModel, this.element.get(0));

            $(this._viewModel).bind('onSetZoom', function (e, value) {
                $(this.element).trigger('onSetZoom', [value]);
            } .bind(this));

            $(this._viewModel).bind("zoomSet.groupdocs", function (e, value) {
                this.element.trigger("zoomSet.groupdocs", [value]);
            } .bind(this));
        },
        getViewModel: function () {
            if (this._viewModel) {
                return this._viewModel;
            }
            var options = $.extend({ element: this.element }, this.options);
            var vm = new zoomingViewModel(options);
            return vm;
        },

        _createHtml: function () {
            var root = this.element;
            this.element = $(
'<div class="left">' +
'    <a class="new_head_tools_btn h_t_i_zoomin" href="#" data-bind="click: zoomIn" data-tooltip="Zoom In" data-localize-tooltip="ZoomIn"> </a>' +
'    <a class="new_head_tools_btn h_t_i_zoomout" href="#" data-bind="click: zoomOut" data-tooltip="Zoom Out" data-localize-tooltip="ZoomOut"> </a>' +
'    <div class="new_head_tools_dropdown_wrapper">' +
'        <a class="new_head_tools_btn head_tool_dropdown_btn h_t_i_zoom" href="#" data-bind="click: toggleDropDownMenu" data-tooltip="Zoom Level" data-localize-tooltip="ZoomLevel">' +
'        </a>' +
'        <ul class="dropdown-menu head_tool_dropdown" style="display: none;" data-bind="style: {display: (dropDownMenuIsVisible() ? \'block\' : \'none\')}, foreach: zooms">' +
'            <li>' +
'                <a href="#" data-bind="text: name, event: { mousedown: function(item, e) { $parent.setZoom(item, e); } }, attr: {\'data-localize\': $data.localizationKey }"></a>' +
'            </li>' +
'        </ul>' +
'    </div>' +
'</div>'

            ).appendTo(root);
            root.trigger("onHtmlCreated");
        }
    });

    // Zooming Model
    zoomingModel = function () {
    };

    // Zooming ViewModel
    zoomingViewModel = function (options) {
        $.extend(this, options);
        this._init(options);
    };

    $.extend(zoomingViewModel.prototype, {
        _model: null,
        zooms: null,
        _currentZoom: null,
        _currentZoomIndex: 0,
        dropDownMenuIsVisible: null,
        dropDownMenuClicked: false,

        _init: function (options) {
            this._currentZoom = ko.observable(100);
            this.zooms = ko.observableArray([]);
            this.dropDownMenuIsVisible = ko.observable(false);

            var zoomValue;
            for (var i = options.zoomValues.length - 1; i >= 0; i--) {
                zoomValue = options.zoomValues[i];
                this.zooms.push({ name: zoomValue.toString() + "%", value: zoomValue });

                if (zoomValue == this._currentZoom()) {
                    this._currentZoomIndex = this.zooms().length - 1;
                }
            }
            this.setFitWidthZoom(100);
            this.setFitHeightZoom(100);
        },

        setFitWidthZoom: function (fitWidthZoom) {
            var fitWidthItem = { name: "Fit Width", value: fitWidthZoom, localizationKey: "FitWidth", fitWidth: true };
            var found = false;
            for (var i = 0; i < this.zooms().length; i++) {
                if (this.zooms()[i].fitWidth) {
                    //this.zooms.splice(i, 1, fitWidthItem);
                    this.zooms()[i].value = fitWidthZoom;
                    found = true;
                    break;
                }
            }

            if (!found)
                this.zooms.push(fitWidthItem);
        },

        setFitHeightZoom: function (fitHeightZoom) {
            var fitHeightItem = { name: "Fit Height", value: fitHeightZoom, localizationKey: "FitHeight", fitHeight: true };
            var found = false;
            for (var i = 0; i < this.zooms().length; i++) {
                if (this.zooms()[i].fitHeight) {
                    //this.zooms.splice(i, 1, fitHeightItem);
                    this.zooms()[i].value = fitHeightZoom;
                    found = true;
                    break;
                }
            }

            if (!found)
                this.zooms.push(fitHeightItem);
        },

        getZoom: function () {
            return this._currentZoom();
        },

        getFitWidthZoomValue: function () {
            var zoomItem;
            for (var i = 0; i < this.zooms().length; i++) {
                zoomItem = this.zooms()[i];
                if (zoomItem.fitWidth) {
                    return zoomItem.value;
                }
            }
        },

        getFitHeightZoomValue: function () {
            var zoomItem;
            for (var i = 0; i < this.zooms().length; i++) {
                zoomItem = this.zooms()[i];
                if (zoomItem.fitHeight) {
                    return zoomItem.value;
                }
            }
        },

        setZoom: function (item, e) {
            var zoom = item.value;
            var index = this._indexOfZoom(zoom);

            this._currentZoom(zoom);
            if (index >= 0) {
                this._currentZoomIndex = index;
            }
            else {
                this._currentZoomIndex = this._indexOfNearestZoom(zoom, false);
            }
            $(this).trigger('onSetZoom', zoom);
            $(this).trigger("zoomSet.groupdocs", zoom);
        },

        setZoomWithoutEvent: function (zoom) {
            var index = this._indexOfZoom(zoom);
            if (index >= 0) {
                this._currentZoom(zoom);
                this._currentZoomIndex = index;
            }
        },

        zoomIn: function () {
            var changed = false;
            var currentZoomIndex = this._currentZoomIndex;

            if (this._isFitToBounds()) {
                currentZoomIndex = this._indexOfNearestZoom(this.zooms()[this._currentZoomIndex].value, true);
                changed = (currentZoomIndex >= 0);
            }
            else
                if (this._currentZoomIndex > 0) {
                    currentZoomIndex = this._currentZoomIndex - 1;
                    changed = true;
                }

            if (changed) {
                this._currentZoomIndex = currentZoomIndex;
                this._currentZoom(this.zooms()[this._currentZoomIndex].value);
                $(this).trigger('onSetZoom', this._currentZoom());
                $(this).trigger("zoomSet.groupdocs", this._currentZoom());
            }
        },

        zoomOut: function () {
            var changed = false;
            var currentZoomIndex = this._currentZoomIndex;

            if (this._isFitToBounds()) {
                currentZoomIndex = this._indexOfNearestZoom(this.zooms()[this._currentZoomIndex].value, false);
                changed = (currentZoomIndex >= 0);
            }
            else
                if (this._currentZoomIndex < this.zooms().length - 1 &&
                    !(this.zooms()[this._currentZoomIndex + 1].fitWidth || this.zooms()[this._currentZoomIndex + 1].fitHeight)) {
                    currentZoomIndex = this._currentZoomIndex + 1;
                    changed = true;
                }

            if (changed) {
                this._currentZoomIndex = currentZoomIndex;
                this._currentZoom(this.zooms()[this._currentZoomIndex].value);
                $(this).trigger('onSetZoom', this._currentZoom());
                $(this).trigger("zoomSet.groupdocs", this._currentZoom());
            }
        },

        _indexOfZoom: function (value) {
            for (i = 0; i < this.zooms().length; i++) {
                if (this.zooms()[i].value == value) {
                    return i;
                }
            }

            return -1;
        },

        _indexOfNearestZoom: function (value, greater) {
            var startIndex = this.zooms().length - 1;
            var nearestGreaterValue = null, nearestGreaterValueIndex = null,
                nearestSmallerValue = null, nearestSmallerValueIndex = null;
            var current, currentElement;

            for (i = startIndex; i >= 0; i--) {
                currentElement = this.zooms()[i];
                current = currentElement.value;
                if (!currentElement.fitWidth && !currentElement.fitHeight) {
                    if (current > value && (nearestGreaterValue === null || current < nearestGreaterValue)) {
                        nearestGreaterValue = current;
                        nearestGreaterValueIndex = i;
                    }
                    else if (current < value && (nearestSmallerValue === null || current > nearestSmallerValue)) {
                        nearestSmallerValue = current;
                        nearestSmallerValueIndex = i;
                    }
                }
            }

            if (greater) {
                if (nearestGreaterValueIndex === null)
                    return -1;
                else
                    return nearestGreaterValueIndex;
            }
            else {
                if (nearestSmallerValueIndex === null)
                    return -1;
                else
                    return nearestSmallerValueIndex;
            }
        },

        _isFitToBounds: function () {
            return (this.zooms()[this._currentZoomIndex].fitWidth || this.zooms()[this._currentZoomIndex].fitHeight);
        },

        showDropDownMenu: function (show) {
            this.dropDownMenuIsVisible(show);
        },

        toggleDropDownMenu: function (viewModel, event) {
            this.dropDownMenuIsVisible(!this.dropDownMenuIsVisible());
            this.dropDownMenuClicked = true;
            this.element.trigger("onMenuClicked");
            event.stopPropagation();
        }

        //isDropDownMenuClicked: function () {
        //    var dropDownMenuClicked = this.dropDownMenuClicked;
        //    this.dropDownMenuClicked = false;
        //    return dropDownMenuClicked;
        //}
    });
})(jQuery);

(function ($, undefined) {
    $.widget('ui.thumbnails', {
        _viewModel: null,
        _pageCount: 0,
        _sessionToken: '',
        _docGuid: '',
        _docVersion: 1,
        _pagesWidth: '150',
        _heightWidthRatio: 0,
        _thumbsSelected: 0,
        _thumbnailWidth: 150,
        _portalService: Container.Resolve("PortalService"),
        options: {
            quality: null,
            use_pdf: "false",
            baseUrl: null,
            userId: 0,
            userKey: null,
            supportPageRotation: false
        },
        _create: function () {
            this.useHtmlThumbnails = this.options.useHtmlThumbnails;
            this.useHtmlBasedEngine = this.options.useHtmlBasedEngine;
            this.emptyImageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";
            if (this.options.supportPageReordering) {
                var self = this;
                ko.bindingHandlers.sortableArray = {
                    init: function (element, valueAccessor) {
                        var thumbnails = valueAccessor();
                        $(element).sortable({
                            axis: "y",
                            update: function (event, ui) {
                                var movedElement = ui.item[0];
                                //retrieve our actual data item
                                var dataItem = ko.dataFor(movedElement);
                                //var item = ui.item.tmplItem().data;
                                //figure out its new position
                                var oldPosition = thumbnails.indexOf(dataItem);
                                var newPosition = ko.utils.arrayIndexOf(ui.item.parent().children(), movedElement);
                                ui.item.remove();
                                //remove the item and add it back in the right spot
                                if (newPosition >= 0) {
                                    thumbnails.remove(dataItem);
                                    thumbnails.splice(newPosition, 0, dataItem);
                                }
                                self.rootElement.trigger("onPageReordered", [oldPosition, newPosition]);
                            }
                        });
                    }
                };
            }

            if (this.options.createHtml) {
                this._createHtml();
            }
            if (this.options.thumbnailWidth)
                this._thumbnailWidth = this.options.thumbnailWidth;

            this._viewModel = this.getViewModel();
            ko.applyBindings(this._viewModel, this.element.get(0));
            if (this.options.useInnerThumbnails)
                ko.applyBindings(this._viewModel, this.toggleThuumbnailsButton[0]);
        },

        _createViewModel: function () {
            var viewModel =
            {
                thumbnails: ko.observableArray([]),
                pageInd: ko.observable(1),
                pageCount: ko.observable(0),
                busy: ko.observable(true)
            };
            viewModel._thumbnailHeight = ko.observable(201);
            viewModel.useInnerThumbnails = this.options.useInnerThumbnails;
            viewModel.openThumbnails = ko.observable(this.options.openThumbnails);
            viewModel.element = this.element;
            viewModel.rootElement = this.rootElement;
            viewModel.thumbnailPanelElement = this.thumbnailPanelElement;
            viewModel.emptyImageUrl = this.emptyImageUrl;
            if (this.useHtmlThumbnails)
                viewModel.scale = ko.observable(0);

            viewModel.scrollThumbnailsPanel = function (e) {
                this._onScrollLeftPanel(e);
            }.bind(this);

            viewModel.selectPage = function (pageIndex) {
                this.set(pageIndex);
            }.bind(this);

            viewModel.showThumbnails = function (show) {
                var thumbnail;
                for (var i = 0; i < this.thumbnails().length; i++) {
                    thumbnail = this.thumbnails()[i];
                    thumbnail.visible(show);
                }
            };

            viewModel.hideThumbnails = function () {
                this.showThumbnails(false);
            };

            viewModel.onProcessPages = function (data, pages, getDocumentPageHtmlCallback, viewerViewModel, pointToPixelRatio, docViewerId) {
                this.onProcessPages(data, pages, getDocumentPageHtmlCallback, viewerViewModel, pointToPixelRatio, docViewerId);
            }.bind(this);

            viewModel.setThumbnailsScroll = function (data) {
                this.setThumbnailsScroll(data);
            }.bind(this);

            viewModel.set = function (index) {
                this.set(index);
            }.bind(this);

            viewModel.setPageWithoutEvent = function (index) {
                this.setPageWithoutEvent(index);
            }.bind(this);

            viewModel.getThumbnailsPanelWidth = function () {
                var thumbnailsPanelWidth = 0;
                if (this.useInnerThumbnails)
                    thumbnailsPanelWidth = this.element.parent().width();
                return thumbnailsPanelWidth;
            };

            viewModel.toggleThumbnails = function () {
                this.openThumbnails(!this.openThumbnails());
                var thumbnailPanelWidth = this.getScreenWidth(this.thumbnailPanelElement.get(0));
                this.rootElement.trigger("onResizeThumbnails", thumbnailPanelWidth);
            };

            viewModel.getScreenWidth = function (domElement) {
                var dimensions = domElement.getBoundingClientRect();
                var screenWidth;
                if (typeof dimensions.width == "undefined") // IE8
                    screenWidth = dimensions.right - dimensions.left;
                else
                    screenWidth = dimensions.width;
                return screenWidth;
            }
            return viewModel;
        },
        getViewModel: function () {
            if (!this._viewModel) {
                this._viewModel = this._createViewModel();
            }
            return this._viewModel;
        },
        onProcessPages: function (data, pages, getDocumentPageHtmlCallback, viewerViewModel, pointToPixelRatio, docViewerId) {
            this._sessionToken = data.token;
            this._docGuid = data.guid;
            this._docVersion = data.version;
            this._viewModel.pageCount(data.page_count);

            if (!data.lic && this._viewModel.pageCount() > 3)
                this._viewModel.pageCount(3);

            this._heightWidthRatio = parseFloat(data.page_size.Height / data.page_size.Width);
            var width = this._thumbnailWidth;
            var variablePageSizeSupport = false, pageDescriptions = null, maxPageHeight, widthForMaxHeight;
            var thumbnailWrapperHeight = null;
            var baseScale;
            if (data.documentDescription && data.documentDescription.pages) {
                variablePageSizeSupport = true;
                pageDescriptions = data.documentDescription.pages;
                maxPageHeight = data.documentDescription.maxPageHeight;
                widthForMaxHeight = data.documentDescription.widthForMaxHeight;
                thumbnailWrapperHeight = maxPageHeight / widthForMaxHeight * this._thumbnailWidth;
                baseScale = (thumbnailWrapperHeight / maxPageHeight) / pointToPixelRatio;
                if (this.useHtmlThumbnails) {
                    this.getDocumentPageHtmlCallback = getDocumentPageHtmlCallback;
                    this.viewerViewModel = viewerViewModel;
                    this._viewModel.docViewerId = docViewerId;
                    var thumbnailContainerWidth = this.element.width();
                    //this._viewModel.thumbLeftCoord = (thumbnailContainerWidth - width) / 2;
                }
            }

            //this._viewModel.thumbnails.removeAll();
            var notObservableThumbnails = [];
            var thumbnailDescription, verticalPadding, thumbnailWidth, thumbnailHeight, backgroundColor;
            var spinnerHeight = 47;
            var pageCount = this._viewModel.pageCount();
            var pageWidth, pageHeight, scaleRatio;
            var thumbLeftCoord;
            for (var i = 0; i < pageCount; i++) {
                thumbnailDescription = {
                    number: i + 1,
                    busy: ko.observable(true),
                    visible: ko.observable(false),
                    url: ko.observable(this.emptyImageUrl)
                };
                if (variablePageSizeSupport) {
                    if (i < pageDescriptions.length) {
                        pageWidth = pageDescriptions[i].w;
                        pageHeight = pageDescriptions[i].h;
                        var prop = pageHeight / pageWidth;
                        var rotation = pageDescriptions[i].rotation;
                        if (typeof rotation == "undefined")
                            rotation = 0;
                        if (rotation % 180 != 0)
                            prop = 1 / prop;
                        thumbnailWidth = this._thumbnailWidth;
                        thumbnailHeight = this._thumbnailWidth * prop;
                        if (thumbnailHeight > thumbnailWrapperHeight) {
                            scaleRatio = thumbnailWrapperHeight / thumbnailHeight;
                            thumbnailHeight = thumbnailWrapperHeight;
                            thumbnailWidth = this._thumbnailWidth * scaleRatio;
                        }
                    }
                    else {
                        thumbnailWidth = this._thumbnailWidth;
                        thumbnailHeight = 215;
                    }
                    thumbnailDescription.width = ko.observable(thumbnailWidth);
                    thumbnailDescription.height = ko.observable(thumbnailHeight);
                    verticalPadding = 0;
                    backgroundColor = "";
                    if (thumbnailHeight < spinnerHeight) {
                        verticalPadding = ((spinnerHeight - thumbnailHeight) / 2).toString();
                        backgroundColor = "white";
                    }
                    thumbnailDescription.verticalPadding = ko.observable(verticalPadding);
                    thumbnailDescription.backgroundColor = ko.observable(backgroundColor);
                    thumbnailDescription.wrapperHeight = thumbnailWrapperHeight;
                    //thumbnailDescription.scale = ko.observable(baseScale * pageDescriptions[i].h / maxPageHeight);
                    thumbnailDescription.scale = ko.observable((thumbnailHeight / pageDescriptions[i].h) / pointToPixelRatio);
                    thumbLeftCoord = (thumbnailContainerWidth - thumbnailWidth) / 2;
                    thumbnailDescription.thumbLeftCoord = ko.observable(thumbLeftCoord);

                    if (this.useHtmlThumbnails) {
                        thumbnailDescription.htmlContent = pages[i].htmlContent;
                    }
                }

                notObservableThumbnails.push(thumbnailDescription);
            }
            this._viewModel.thumbnails(notObservableThumbnails);
            var height = parseInt(this._heightWidthRatio * width);
            var thumbCss = "";
            if (variablePageSizeSupport) {
                //thumbCss = "div.thumbnailsContainer ul li img{background-color:white}";
            }
            else {
                thumbCss = ".grpdx .thumbnailsContainer .thumb-page{min-height:" + height.toString() + "px}";
            }

            this.loadThumbnails();
        },

        loadThumbnails: function () {
            // var countToShow = Math.ceil($('#thumbnails-container').height() / $('#thumb-1').height()); // count of visible thumbs
            var countToShow = Math.ceil(this.element.height() / parseInt(this._heightWidthRatio * 150)); // count of visible thumbs

            this._countToShowOnThumbDiv = countToShow;
            this._thumbsCountToShow = Number(countToShow) + Math.ceil(Number(Number(countToShow) / 2)); // count thumbs for show
            this._thumbsSelected = this._thumbsCountToShow; //_thumbsSelected = _thumbsCountToShow on start

            this.retrieveImageUrls(this._viewModel.pageCount());
        },

        retrieveImageUrls: function (imageCount) {
            this._portalService.getImageUrlsAsync(this.options.userId, this.options.userKey, this._docGuid,
                    (this.options._mode == 'webComponent' ? this._thumbnailWidth : this._thumbnailWidth.toString() + "x"), this._sessionToken, 0, imageCount,
                    this.options.quality, this.options.use_pdf, this._docVersion, null, null, null, null,
                    this.options.ignoreDocumentAbsence,
                    this.options.useHtmlBasedEngine, this.options.supportPageRotation,
                    function (response) {
                        response = response.data;
                        var imageUrls;
                        if (response.imageUrls && typeof response.image_urls == "undefined")
                            imageUrls = response.imageUrls;
                        else
                            imageUrls = response.image_urls; ;

                        for (var i = 0; i < imageCount; i++) {
                            this._viewModel.thumbnails()[i].url(imageUrls[i]);
                        }
                        this._onScrollLeftPanel();

                    }.bind(this),
                    function (error) {
                        for (var i = 0; i < imageCount; i++) {
                            this.makeThumbnailNotBusy(i);
                        }
                    }.bind(this),
                this.options.instanceIdToken,
                this.options.locale
            );
        },

        makeThumbnailNotBusy: function (thumbnailIndex) {
            var currentThumbnail = this._viewModel.thumbnails()[thumbnailIndex];
            currentThumbnail.busy(false);
        },

        _onScrollLeftPanel: function () {
            var pageCount = this._viewModel.pageCount();
            var width = this._thumbnailWidth;
            var thumbContainer = this.element;
            var thumbnailHeight = thumbContainer.find(".thumb-page:first").outerHeight(false); // div height

            var scrollTop = thumbContainer.scrollTop();
            var th = thumbContainer.height(); // thumbnails height
            var startIndex = Math.floor(scrollTop / thumbnailHeight);
            var endIndex = Math.floor((scrollTop + th) / thumbnailHeight) + 1;
            var end = (endIndex < pageCount - 2) ? endIndex + 2 : pageCount;

            for (var i = startIndex; i < end; i++) {
                if (this.useHtmlThumbnails) {
                    this.getDocumentPageHtmlCallback.call(this.viewerViewModel, i);
                }
                this._viewModel.thumbnails()[i].visible(true);
            }

            this._thumbsSelected = endIndex;
        },
        setThumbnailsScroll: function (data) {
            var index = data.pi;
            if (this._viewModel.pageInd() != index) {
                this._viewModel.pageInd(index);
                if (!data.eventAlreadyRaised)
                    this.element.trigger('onSetThumbnailsScroll', index);
            }

            var thumbnailsContainerTop = this.element.offset().top;

            var thumbWrapper = this.element.children("ul").children("li:nth-child(" + this._viewModel.pageInd() + ")");
            if (thumbWrapper.length == 0)
                return;
            var thumbPageTop = thumbWrapper.offset().top;
            var divBottomPos = thumbPageTop - $(window).height();
            var divTopPos = thumbPageTop + thumbWrapper.height() - thumbnailsContainerTop;
            var leftScrollPos = this.element.scrollTop();
            var dif = thumbPageTop - thumbnailsContainerTop;
            if (divBottomPos > 0 || divTopPos < 0) {
                this.element.scrollTop(leftScrollPos + dif);
            }
        },

        set: function (index) {
            this._viewModel.pageInd(index);
            $(this.element).trigger('onSetThumbnails', index);
        },
        setPageWithoutEvent: function (index) {
            this._viewModel.pageInd(index);
        },
        setPagesCount: function (pagesCount) {
            this._pageCount = pagesCount;
            this._viewModel.pageCount(pagesCount);
        },

        _createHtml: function () {
            var root = this.element;
            var foreachOperator;

            if (this.options.supportPageReordering) {
                //foreachOperator = "sortable: {data: thumbnails, afterMove: function(arg){console.log('arg.sourceIndex:',arg.sourceIndex)}}";
                foreachOperator = "foreach: thumbnails, sortableArray: thumbnails";
            }
            else {
                foreachOperator = "foreach: thumbnails";
            }

            this.element = $(
'<div class="thumbnailsContainer" data-bind="event: { scroll: function(e) { scrollThumbnailsPanel(e); } }, visible:!useInnerThumbnails || openThumbnails">' +
'    <ul class="vertical-list2 ui-selectable" data-bind="' + foreachOperator + '">' +
'        <li class="thumb-page ui-selectee" data-bind="style: {height: $data.wrapperHeight + \'px\'}, css: { \'ui-selected\': ($index() + 1) == $root.pageInd() }, click: function() { $root.selectPage($index() + 1); }">' +
//'                <div class="thumbnail_wrapper" data-bind="style: {height: $data.height() + 2 * $data.verticalPadding() + \'px\'}">' +

(this.useHtmlThumbnails ?
(
'        <div class="thumbnail_wrapper" data-bind="style: {width:$data.width() + \'px\',height: $data.height() + 2 * $data.verticalPadding() + \'px\'}">' +
'           <div class="html_page_contents"' +
'                 data-bind="html: htmlContent, ' +
'                        visible: visible(),' +
'                        attr: {id: $root.docViewerId + \'pageHtml-\' + ($index() + 1) },' +
'                        style: { padding: $data.verticalPadding() + \'px 0\', ' +
'                                   MozTransform: \'scale(\' + $data.scale() + \')\', ' +
'                                    \'-webkit-transform\': \'scale(\' + $data.scale() + \')\',' +
'                                    \'-ms-transform\': \'scale(\' + $data.scale() + \')\' }">' +
'            </div>' +

'           <div class="html_page_contents mouse_intercept_overlay">' +
'            </div>'
)
:
(
'                <div class="thumbnail_wrapper" data-bind="style: {height: $data.height() + 2 * $data.verticalPadding() + \'px\'}">' +
'                    <img class="ui-selectee thumb_image" src="' + this.emptyImageUrl + '" data-bind="attr: {src: visible() ? url() : $root.emptyImageUrl}, style: {width: (visible() ? $data.width() : 0) + \'px\', height: (visible() ? $data.height() : 0) + \'px\', padding: $data.verticalPadding() + \'px 0\', backgroundColor: $data.backgroundColor()}" />'
)) +

'                </div>' +
'                <span class="progresspin thumb_progress"></span>' +
'        </li>' +
'    </ul>' +
'</div>');

            if (this.options.useInnerThumbnails) {
                this.thumbnailPanelElement = $('<div class="thumbnail_panel"></div>');
                this.element.appendTo(this.thumbnailPanelElement);
                this.toggleThuumbnailsButton = $('<div class="thumbnail_stripe">' +
                    '   <a class="thumbnail_open" data-bind="click:function(){toggleThumbnails();}"></a>' +
                    '</div>');
                this.toggleThuumbnailsButton.appendTo(this.thumbnailPanelElement);
                this.thumbnailPanelElement.prependTo(root);
            }
            else {
                this.element.appendTo(root);
            }
            this.rootElement = root;
        }

    });
})(jQuery);
DocViewerAdapter = function (options) {
    $.extend(this, options);
    this.init();
};
$.extend(DocViewerAdapter.prototype, {
    docViewerWidget: null,
    docViewerViewModel: null,
    navigationWidget: null,
    navigationViewModel: null,
    thumbnailsWidget: null,
    thumbnailsViewModel: null,
    zoomViewModel: null,

    init: function () {
        var docViewer = null;
        var navigation = null;
        var thumbnails = null;
        var zooming = null;
        var search = null;
        var embedSource = null;
        var viewTypeMenu = null;

        var docViewerViewModel = null;
        var navigationViewModel = null;
        var thumbnailsViewModel = null;
        var zoomViewModel = null;
        var searchViewModel = null;
        var embedSourceViewModel = null;
        var viewTypeViewModel = null;

        var menuClickedEvent = "onMenuClicked";

        if (this.thumbnails) {
            thumbnails = this.thumbnails.thumbnails(this.thumbnailsOptions || { baseUrl: this.baseUrl,
                quality: this.quality,
                use_pdf: this.use_pdf
            });
            thumbnailsViewModel = this.thumbnails.thumbnails('getViewModel');
        }
        else {
            thumbnails = this.thumbnailsCreator();
            thumbnailsViewModel = this.thumbnailsViewModelCreator();
        }

        var thumbnailsPanelWidth = 0;
        if (this.thumbnails)
            thumbnailsPanelWidth = thumbnailsViewModel.getThumbnailsPanelWidth();

        if (this.docSpace) {
            var viewerOptions = $.extend(
            {
                userId: this.userId,
                userKey: this.userKey,
                baseUrl: this.baseUrl,
                fileId: this.fileId,
                fileVersion: this.fileVersion,
                quality: this.quality,
                use_pdf: this.use_pdf,
                pageImageWidth: this.pageImageWidth,
                _mode: this._mode,
                docViewerId: this.docViewerId,
                createHtml: this.createHtml,
                initialZoom: this.initialZoom,
                alwaysOnePageInRow: this.alwaysOnePageInRow,
                zoomToFitWidth: this.zoomToFitWidth,
                zoomToFitHeight: this.zoomToFitHeight,
                viewerLeft: thumbnailsPanelWidth,
                viewerWidth: this.viewerWidth,
                viewerHeight: this.viewerHeight,
                preloadPagesCount: this.preloadPagesCount,
                selectionContent: this.selectionContent,
                usePageNumberInUrlHash: this.usePageNumberInUrlHash,
                pageContentType: this.pageContentType,
                imageHorizontalMargin: this.imageHorizontalMargin,
                imageVerticalMargin: this.imageVerticalMargin,
                useJavaScriptDocumentDescription: this.useJavaScriptDocumentDescription,
                searchPartialWords: this.searchPartialWords,
                variableHeightPageSupport: this.variableHeightPageSupport,
                textSelectionSynchronousCalculation: this.textSelectionSynchronousCalculation,
                minimumImageWidth: this.minimumImageWidth,
                fileDisplayName: this.fileDisplayName,
                preventTouchEventsBubbling: this.preventTouchEventsBubbling,
                watermarkText: this.watermarkText,
                instanceId: this.instanceId
            }, this.viewerOptions);

            docViewer = this.docSpace.docViewer(viewerOptions);
            docViewerViewModel = this.docSpace.docViewer('getViewModel');
        }
        else {
            docViewer = this.docSpaceCreator();
            docViewerViewModel = this.docSpaceViewModel();
        }

        var docViewerPageFlip = null;
        var docViewerPageFlipViewModel = null;

        if (this.docSpacePageFlip) {
            docViewerPageFlip = this.docSpacePageFlip.docViewerPageFlip({
                userId: this.userId,
                userKey: this.userKey,
                baseUrl: this.baseUrl,
                fileId: this.fileId,
                fileVersion: this.fileVersion,
                quality: this.quality,
                use_pdf: this.use_pdf,
                pageImageWidth: this.pageImageWidth,
                _mode: this._mode,
                docViewerId: this.docViewerId,
                createHtml: this.createHtml,
                initialZoom: this.initialZoom,
                alwaysOnePageInRow: this.alwaysOnePageInRow,
                zoomToFitWidth: this.zoomToFitWidth,
                zoomToFitHeight: this.zoomToFitHeight,
                viewerWidth: this.viewerWidth,
                viewerHeight: this.viewerHeight,
                selectionContent: this.selectionContent,
                minimumImageWidth: this.minimumImageWidth
            });
            docViewerPageFlipViewModel = this.docSpacePageFlip.docViewerPageFlip('getViewModel');
        }

        if (this.navigation) {
            navigation = this.navigation.navigation(this.navigationOptions);
            navigationViewModel = this.navigation.navigation('getViewModel');
        }

        if (this.search) {
            search = this.search.search($.extend(this.searchOptions, { viewerViewModel: docViewerViewModel }));
            searchViewModel = this.search.search('getViewModel');
        }

        if (this.zooming) {
            zooming = this.zooming.zooming(this.zoomingOptions || {});
            zoomViewModel = this.zooming.zooming('getViewModel');
        }

        if (this.embedSource) {
            embedSource = this.embedSource.embedSource();
            embedSourceViewModel = this.embedSource.embedSource('getViewModel');
        }

        if (this.viewTypeMenu) {
            viewTypeMenu = this.viewTypeMenu;
            viewTypeViewModel = this.viewTypeViewModel;
        }

        this.docViewerViewModel = docViewerViewModel;
        this.docViewerPageFlipViewModel = docViewerPageFlipViewModel;
        this.navigationViewModel = navigationViewModel;
        this.thumbnailsViewModel = thumbnailsViewModel;
        this.zoomViewModel = zoomViewModel;
        this.searchViewModel = searchViewModel;
        this.embedSourceViewModel = embedSourceViewModel;

        docViewer.bind('getPagesCount', function (e, pagesCount) {
            if (navigation) {
                navigationViewModel.setPagesCount(pagesCount);
            }
        } .bind(this));

        docViewer.bind("onDocumentloadingStarted", function (e) {
            if (thumbnails) {
                thumbnailsViewModel.hideThumbnails();
            }
        } .bind(this));

        docViewer.bind("documentLoadFailed.groupdocs", function (e) {
            if (thumbnails) {
                thumbnailsViewModel.showThumbnails(true);
            }
        } .bind(this));
        

        docViewer.bind('_onProcessPages', function (e, data, pages, getDocumentPageHtmlCallback, viewerViewModel, pointToPixelRatio, docViewerId) {
            if (thumbnails) {
                thumbnailsViewModel.onProcessPages(data, pages, getDocumentPageHtmlCallback, viewerViewModel, pointToPixelRatio, docViewerId);
            }
        } .bind(this));
        docViewer.bind('onScrollDocView', function (e, data) {
            if (thumbnails) {
                thumbnailsViewModel.setThumbnailsScroll(data);
            }
            if (navigation) {
                navigationViewModel.setPageIndex(data.pi);
            }
            if (search) {
                searchViewModel.scrollPositionChanged(data.position);
            }
        } .bind(this));

        docViewer.bind('onDocumentPageSet', function (e, newPageIndex) {
            if (docViewerPageFlipViewModel)
                docViewerPageFlipViewModel.onDocumentPageSet(newPageIndex);

            if (search)
                searchViewModel.documentPageSetHandler();
        });

        docViewer.bind('onDocumentLoadComplete', function (e, data, pdf2XmlWrapper) {
            if (docViewerPageFlipViewModel)
                docViewerPageFlipViewModel._onDocumentLoaded(data, pdf2XmlWrapper);

            var url = data.url;
            $("#btnDownload,#btnDownload2").bind({
                click: function () {
                    window.location.href = url;
                    return false;
                }
            });
            if (embedSource) {
                embedSourceViewModel.setGuid(data.guid);
                embedSourceViewModel.setFileId(docViewerViewModel.getFileId());
                embedSourceViewModel.password(docViewerViewModel.password());
            }

            if (zooming) {
                if (docViewerViewModel.isScrollViewerVisible()) {
                    zoomViewModel.setFitWidthZoom(docViewerViewModel.getFitWidthZoom());
                    zoomViewModel.setFitHeightZoom(docViewerViewModel.getFitHeightZoom());
                    zoomViewModel.setZoomWithoutEvent(docViewerViewModel.zoom());
                }
                else {
                    if (docViewerPageFlipViewModel) {
                        zoomViewModel.setFitWidthZoom(docViewerPageFlipViewModel.getFitWidthZoom());
                        zoomViewModel.setFitHeightZoom(docViewerPageFlipViewModel.getFitHeightZoom());
                        zoomViewModel.setZoomWithoutEvent(docViewerPageFlipViewModel.zoom());
                    }
                }
            }

            if (search) {
                searchViewModel.documentLoaded();
            }
        } .bind(this));

        docViewer.bind("layoutChanged.groupdocs", function (e) {
            if (zooming) {
                if (docViewerViewModel.isScrollViewerVisible()) {
                    zoomViewModel.setFitWidthZoom(docViewerViewModel.getFitWidthZoom());
                    zoomViewModel.setFitHeightZoom(docViewerViewModel.getFitHeightZoom());
                }
            }

            if (search) {
                searchViewModel.zoomHandler();
            }
        });

        docViewer.bind("visiblePagesChanged.groupdocs", function (e) {
            if (search) {
                searchViewModel.visiblePagesChangedHandler();
            }
        } .bind(this));

        docViewer.bind("searchAreasPositions.groupdocs", function (e, data) {
            if (search) {
                searchViewModel.searchAreasPositionsChangedHandler(data);
            }
        } .bind(this));
        
        if (docViewerPageFlip) {
            docViewerPageFlip.bind('onPageTurned', function (e, pageIndex) {
                if (navigation) {
                    navigationViewModel.setPageIndex(pageIndex);
                }
                if (thumbnails) {
                    thumbnailsViewModel.pageInd(pageIndex);
                }
                docViewerViewModel.pageInd(pageIndex);
                docViewerViewModel.setPageNumerInUrlHash(pageIndex);
            });
        }

        if (search) {
            search.bind('onPerformSearch', function (e, value, isCaseSensitive, searchForSeparateWords, treatPhrasesInDoubleQuotesAsExact, useAccentInsensitiveSearch) {
                docViewerViewModel.performSearch(value, isCaseSensitive, searchForSeparateWords, treatPhrasesInDoubleQuotesAsExact, useAccentInsensitiveSearch);
            });
        }

        if (navigation) {
            navigation.bind('onUpNavigate', function (e, pageIndex) {
                if (docViewerPageFlipViewModel)
                    docViewerPageFlipViewModel.setPage(pageIndex);

                docViewerViewModel.setPage(pageIndex);
                if (thumbnails) {
                    thumbnailsViewModel.setPageWithoutEvent(pageIndex);
                    thumbnailsViewModel.setThumbnailsScroll({ pi: pageIndex, direction: 'up' });
                }
            } .bind(this));
            navigation.bind('onDownNavigate', function (e, pageIndex) {
                if (docViewerPageFlipViewModel)
                    docViewerPageFlipViewModel.setPage(pageIndex);

                docViewerViewModel.setPage(pageIndex);
                if (thumbnails) {
                    thumbnailsViewModel.setPageWithoutEvent(pageIndex);
                    thumbnailsViewModel.setThumbnailsScroll({ pi: pageIndex, direction: 'down' });
                }
            } .bind(this));
            navigation.bind('onSetNavigate', function (e, data) {
                if (docViewerPageFlipViewModel)
                    docViewerPageFlipViewModel.setPage(data.pageIndex);

                docViewerViewModel.setPage(data.pageIndex);
                if (thumbnails) {
                    thumbnailsViewModel.setPageWithoutEvent(data.pageIndex);
                    thumbnailsViewModel.setThumbnailsScroll({ pi: data.pageIndex, direction: data.direction, eventAlreadyRaised: true });
                }
            } .bind(this));
        }

        if (zooming) {
            zooming.bind('onSetZoom', function (e, value) {
                if (docViewerPageFlipViewModel)
                    docViewerPageFlipViewModel.setZoom(value);
                docViewerViewModel.setZoom(value);
                if (search) {
                    searchViewModel.zoomHandler();
                }
            } .bind(this));

            zooming.bind(menuClickedEvent, function () {
                if (viewTypeMenu)
                    viewTypeViewModel.showDropDownMenu(false);
            });
        }

        if (thumbnails) {
            thumbnails.bind('onSetThumbnails', function (e, index) {
                docViewerViewModel.setPage(index);
                if (docViewerPageFlipViewModel)
                    docViewerPageFlipViewModel.setPage(index);
                if (navigation) {
                    navigationViewModel.setPageIndex(index);
                }
            } .bind(this));
            thumbnails.bind('onSetThumbnailsScroll', function (e, index) {
                if (navigation) {
                    navigationViewModel.setPageIndex(index);
                }
            } .bind(this));
            thumbnails.bind('onResizeThumbnails', function (e, viewerLeft) {
                docViewerViewModel.resizeViewerElement(viewerLeft);
                if (docViewerPageFlipViewModel)
                    docViewerPageFlipViewModel.resizeViewerElement(viewerLeft);
            });
            thumbnails.bind('onPageReordered', function (e, oldPosition, newPosition) {
                docViewerViewModel.onPageReordered(oldPosition, newPosition);
            });
        }

        if (viewTypeMenu) {
            viewTypeMenu.bind(menuClickedEvent, function () {
                if (zoomViewModel)
                    zoomViewModel.showDropDownMenu(false);
            });
        }
    },

    thumbnailsCreator: function () {
    },

    thumbnailsViewModelCreator: function () {
        return { set: function () { },
            setThumbnailsScroll: function () { },
            onProcessPages: function () { },
            getThumbnailsPanelWidth: function () { return 0; } 
        };
    }
});
define('core/binder',
    ['jquery', 'ko'],
    function ($, ko) {
        var
            bind = function (viewId, vmodel) {
                ko.applyBindings(vmodel, getView(viewId));
            },
            
            getView = function (viewName) {
                return $(viewName).get(0);
            };
            
        return {
            bind: bind
        };
    });
define('core/config',
    ['jquery', 'ko', "core/routes"],
    function ($, ko, routes) {
        var userId = ko.observable(),
            privateKey = ko.observable(),
            userEmail = ko.observable(),
            userName = ko.observable(),
            appPath = ko.observable(),
            uploaderProxy = ko.observable(),
            serviceAddress = ko.observable(),
            isDownloadable = false,
            useHttpHandlers = false,
            downloadableSignaturePrefix = "",
            downloadableHostUrl = "",
            useJsonp = $.browser.msie && $.browser.version < 9 && ((typeof (gdSignaturePrefix) != "undefined") && gdSignaturePrefix),
            msie11 = !!navigator.userAgent.match(/Trident\/7\./),
            templateUrl = '/scripts/signature2/views',
            viewerContainer = null,
            downloadablePrefix = "",
            initInfUser = function () {
                if (isDownloadable)
                    downloadablePrefix = downloadableSignaturePrefix + (useHttpHandlers ? "-handler" : "/embedded");
                infuser.defaults.templateUrl = downloadablePrefix+templateUrl;
                infuser.defaults.ajax.async = false;
            },
            signatureColors = ['#0036D9', '#5F5F5F', '#E15F5F', '#2DB200'],
            init = function () {
                if ((typeof (gdSignaturePrefix) != "undefined") && gdSignaturePrefix) {
                    isDownloadable = true;
                    useHttpHandlers = (typeof (gdUseHttpHandlers) != "undefined" && gdUseHttpHandlers);
                    downloadableSignaturePrefix = "/" + gdSignaturePrefix;
                    downloadableHostUrl = gdSignatureHostUrl;
                } else downloadableSignaturePrefix = "";
                initInfUser();
                userId(ViewContext.Credentials.userId);
                privateKey(ViewContext.Credentials.privateKey);
                userEmail(ViewContext.Credentials.primaryEmail);
                appPath(ViewContext.AppPath);
                uploaderProxy('Uploader.aspx');
                serviceAddress(ViewContext.Credentials.serviceAddress);
                userName(ViewContext.Credentials.userName);
            },
            alert = function (type, message) {
                if (typeof (type) == "string") {
                    //jerror(message);
                    $.confirm({
                        title: "Information",
                        message: message,
                        buttons: {
                            'OK': {
                                'class': 'red_button right'
                            }
                        }
                    });
                } else if (typeof (type) == "object") {
                    //jerror(type.message, type.handler, type.title);
                    $.confirm({
                        title: type.title,
                        message: type.message,
                        buttons: {
                            'OK': {
                                'class': 'red_button right'
                            }
                        },
                        onclose: type.closeCallback
                    });
                }
            },
            validationMessages = {
                required: "* Required",
                requiredNoStar: "Required",
                invalidEmail: "Invalid email address",
                invalidValue: "Invalid value"
            },
            signatureFieldType = { Signature: 1, SingleLine: 2, MultiLine: 3, Date: 4, Dropdown: 5, Checkbox: 6, File: 7, Stamp: 8 },
            fontSizes = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
            fontNames = ["Arial", "Times-Roman", "Helvetica", "Courier", "Courier New", "Comic Sans MS", "Impact", "Tahoma"],
            fontColors = ["#000000", "#f0f8ff", "#faebd7", "#00ffff", "#7fffd4", "#f0ffff", "#f5f5dc", "#ffe4c4", "#ffebcd", "#0000ff", "#8a2be2", "#a52a2a", "#deb887", "#5f9ea0", "#7fff00", "#d2691e", "#ff7f50", "#6495ed", "#fff8dc", "#00ffff", "#00008b", "#008b8b", "#b8860b", "#a9a9a9", "#006400", "#bdb76b", "#8b008b", "#556b2f", "#ff8c00", "#9932cc", "#8b0000", "#e9967a", "#8fbc8f", "#483d8b", "#2f4f4f", "#00ced1", "#9400d3", "#ff1493", "#00bfff", "#696969", "#1e90ff", "#b22222", "#fffaf0", "#228b22", "#ff00ff", "#dcdcdc", "#f8f8ff", "#ffd700", "#daa520", "#808080", "#008000", "#adff2f", "#f0fff0", "#ff69b4", "#cd5c5c", "#fffff0", "#f0e68c", "#e6e6fa", "#fff0f5", "#7cfc00", "#fffacd", "#add8e6", "#f08080", "#e0ffff", "#eedd82", "#fafad2", "#d3d3d3", "#90ee90", "#ffb6c1", "#ffa07a", "#20b2aa", "#87cefa", "#8470ff", "#778899", "#b0c4de", "#ffffe0", "#00ff00", "#32cd32", "#faf0e6", "#ff00ff", "#800000", "#66cdaa", "#0000cd", "#ba55d3", "#9370db", "#3cb371", "#7b68ee", "#00fa9a", "#48d1cc", "#c71585", "#191970", "#f5fffa", "#e1e4e1", "#ffe4b5", "#ffdead", "#000080", "#fdf5e6", "#808000", "#6b8e23", "#ffa500", "#ff4500", "#da70d6", "#eee8aa", "#98fb98", "#afeeee", "#db7093", "#ffefd5", "#ffdab9", "#cd853f", "#ffc0cb", "#dda0dd", "#b0e0e6", "#800080", "#ff0000", "#bc8f8f", "#4169e1", "#8b4513", "#fa8072", "#f4a460", "#2e8b57", "#fff5ee", "#a0522d", "#c0c0c0", "#87ceeb", "#6a5acd", "#708090", "#fffafa", "#00ff7f", "#4682b4", "#d2b48c", "#008080", "#d8bfd8", "#ff6347", "#40e0d0", "#ee82ee", "#d02090", "#f5deb3", "#ffffff", "#f5f5f5", "#ffff00", "#9acd32"],
            fieldValidations = [
                { name: 'Address ZIP code US', expression: '^[0-9]{5}(?:-[0-9]{4})?$', fieldType: '2,3', errorMessage: 'Please enter valid ZIP code US. For example 12345 or 12345-6789' },
                { name: 'Credit card: All major credit cards bare', expression: '^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\\d{3})\\d{11})$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: All major credit cards (bare, named)', expression: '"^(?:(?<visa>4[0-9]{12}(?:[0-9]{3})?)|(?<mastercard>5[1-5][0-9]{14})|(?<discover>6(?:011|5[0-9][0-9])[0-9]{12})|(?<amex>3[47][0-9]{13})|(?<diners>3(?:0[0-5]|[68][0-9])[0-9]{11})|(?<jcb>(?:2131|1800|35\\d{3})\\d{11}))$"', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: All major credit cards (grouped)', expression: '^(?:4\\d{3}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d(?:\\d{3})?|5[1-5]\\d{2}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}|6(?:011|5[0-9]{2})[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}|3[47]\\d{2}[ -]*\\d{6}[ -]*\\d{5}|3(?:0[0-5]|[68][0-9])\\d[ -]*\\d{6}[ -]*\\d{4}|(?:2131|1800)[ -]*\\d{6}[ -]*\\d{5}|35\\d{2}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4})$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: All major credit cards (grouped, named)', expression: '"^(?:(?<visa>4\\d{3}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d(?:\\d{3})?) |(?<mastercard>5[1-5]\\d{2}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}) |(?<discover>6(?:011|5[0-9]{2})[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}) |(?<amex>3[47]\\d{2}[ -]*\\d{6}[ -]*\\d{5}) |(?<diners>3(?:0[0-5]|[68][0-9])\\d[ -]*\\d{6}[ -]*\\d{4}) |(?<jcb>(?:2131|1800)[ -]*\\d{6}[ -]*\\d{5}|35\\d{2}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}))$"', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: All major credit cards (spaces/dashes)', expression: '^[ -]*(?:4[ -]*(?:\\d[ -]*){11}(?:(?:\\d[ -]*){3})?\\d|5[ -]*[1-5](?:[ -]*[0-9]){14}|6[ -]*(?:0[ -]*1[ -]*1|5[ -]*\\d[ -]*\\d)(?:[ -]*[0-9]){12}|3[ -]*[47](?:[ -]*[0-9]){13}|3[ -]*(?:0[ -]*[0-5]|[68][ -]*[0-9])(?:[ -]*[0-9]){11}|(?:2[ -]*1[ -]*3[ -]*1|1[ -]*8[ -]*0[ -]*0|3[ -]*5(?:[ -]*[0-9]){3})(?:[ -]*[0-9]){11})[ -]*$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: All major credit cards (spaces/dashes, named)', expression: '"^[ -]*(?:(?<visa>4[ -]*(?:\\d[ -]*){11}(?:(?:\\d[ -]*){3})?\\d) |(?<mastercard>5[ -]*[1-5](?:[ -]*[0-9]){14}) |(?<discover>6[ -]*(?:0[ -]*1[ -]*1|5[ -]*\\d[ -]*\\d)(?:[ -]*[0-9]){12}) |(?<amex>3[ -]*[47](?:[ -]*[0-9]){13}) |(?<diners>3[ -]*(?:0[ -]*[0-5]|[68][ -]*[0-9])(?:[ -]*[0-9]){11}) |(?<jcb>(?:2[ -]*1[ -]*3[ -]*1|1[ -]*8[ -]*0[ -]*0|3[ -]*5(?:[ -]*[0-9]){3})(?:[ -]*[0-9]){11}))[ -]*$"', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: American Express (bare)', expression: '^3[47][0-9]{13}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: American Express (grouped)', expression: '^3[47]\\d{2}[ -]*\\d{6}[ -]*\\d{5}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: American Express (spaces/dashes)', expression: '^[ -]*3[ -]*[47][ -]*(?:\\d[ -]*){13}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Diners Club (bare)', expression: '^3(?:0[0-5]|[68][0-9])[0-9]{11}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Diners Club (grouped)', expression: '^3(?:0[0-5]|[68][0-9])\\d[ -]*\\d{6}[ -]*\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Diners Club (spaces/dashes)', expression: '^[ -]*3[ -]*(?:0[ -]*[0-5]|[68][ -]*[0-9])[ -]*(?:\\d[ -]*){11}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Discover (bare)', expression: '^6(?:011|5[0-9]{2})[0-9]{12}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Discover (grouped)', expression: '^6(?:011|5[0-9]{2})[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Discover (spaces/dashes)', expression: '^[ -]*6[ -]*(?:0[ -]*1[ -]*1|5[ -]*\\d[ -]*\\d)[ -]*(?:\\d[ -]*){12}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: JCB (bare)', expression: '^(?:2131|1800|35\\d{3})\\d{11}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: JCB (grouped)', expression: '^(?:(?:2131|1800)[ -]*\\d{6}[ -]*\\d{5}|35\\d{2}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4})$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: JCB (spaces/dashes)', expression: '^[ -]*(?:2[ -]*1[ -]*3[ -]*1|1[ -]*8[ -]*0[ -]*0|3[ -]*5(?:[ -]*\\d){3})[ -]*(?:\\d[ -]*){11}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: MasterCard (bare)', expression: '^5[1-5][0-9]{14}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: MasterCard (grouped)', expression: '^5[1-5]\\d{2}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: MasterCard (spaces/dashes)', expression: '^[ -]*5[ -]*[1-5][ -]*(?:[0-9][ -]*){14}$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Visa (bare)', expression: '^4[0-9]{12}(?:[0-9]{3})?$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Visa (grouped)', expression: '^4\\d{3}[ -]*\\d{4}[ -]*\\d{4}[ -]*\\d(?:\\d{3})?$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Credit card: Visa (spaces/dashes)', expression: '^[ -]*4[ -]*(?:\\d[ -]*){12}(?:(?:\\d[ -]*){3})?$', fieldType: '2,3', errorMessage: 'Please enter valid credit card number' },
                { name: 'Date: dd/mm/yyyy', expression: '(0[1-9]|[12][0-9]|3[01])[/](0[1-9]|1[012])[/](19|20)[0-9]{2}', fieldType: '4', errorMessage: 'Please enter valid date in format dd/mm/yyyy' },
                { name: 'Date: dd.mm.yyyy', expression: '(0[1-9]|[12][0-9]|3[01])[.](0[1-9]|1[012])[.](19|20)[0-9]{2}', fieldType: '4', errorMessage: 'Please enter valid date in format dd.mm.yyyy' },
                { name: 'Date: d/m/yy', expression: '^(0?[1-9]|[12][0-9]|3[01])[/](0?[1-9]|1[012])[/][0-9]{2}$', fieldType: '4', errorMessage: 'Please enter valid date in format d/m/yy' },
                { name: 'Date: d.m.yy', expression: '^(0?[1-9]|[12][0-9]|3[01])[-](0?[1-9]|1[012])[-][0-9]{2}$', fieldType: '4', errorMessage: 'Please enter valid date in format d.m.yy' },
                { name: 'Date: m/d/yy', expression: '^(0?[1-9]|1[012])[/](0?[1-9]|[12][0-9]|3[01])[/][0-9]{2}$', fieldType: '4', errorMessage: 'Please enter valid date in format m/d/yy' },
                { name: 'Date: m.d.yy', expression: '^(0?[1-9]|1[012])[.](0?[1-9]|[12][0-9]|3[01])[.][0-9]{2}$', fieldType: '4', errorMessage: 'Please enter valid date in format m.d.yy' },
                { name: 'Date: mm/dd/yyyy', expression: '(0[1-9]|1[012])[/](0[1-9]|[12][0-9]|3[01])[/](19|20)[0-9]{2}', fieldType: '4', errorMessage: 'Please enter valid date in format mm/dd/yyyy' },
                { name: 'Date: mm.dd.yyyy', expression: '(0[1-9]|1[012])[.](0[1-9]|[12][0-9]|3[01])[.](19|20)[0-9]{2}', fieldType: '4', errorMessage: 'Please enter valid date in format mm.dd.yyyy' },
                { name: 'Date: yy-m-d', expression: '^[0-9]{2}[-](0?[1-9]|1[012])[-](0?[1-9]|[12][0-9]|3[01])$', fieldType: '4', errorMessage: 'Please enter valid date in format yy-m-d' },
                { name: 'Date: yyyy/mm/dd', expression: '(19|20)[0-9]{2}[/](0[1-9]|1[012])[/](0[1-9]|[12][0-9]|3[01])', fieldType: '4', errorMessage: 'Please enter valid date in format yyyy/mm/dd' },
                { name: 'Date: yyyy-mm-dd', expression: '(19|20)[0-9]{2}[-](0[1-9]|1[012])[-](0[1-9]|[12][0-9]|3[01])', fieldType: '4', errorMessage: 'Please enter valid date in format yyyy-mm-dd' },
                { name: 'Domain name', expression: '^([a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2},$', fieldType: '2,3', errorMessage: 'Please enter valid domain name' },
                { name: 'Domain name (anchored)', expression: '^([a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2},$', fieldType: '2,3', errorMessage: 'Please enter valid domain name' },
                { name: 'Email address', expression: '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}$', fieldType: '2,3', errorMessage: 'Please enter valid email address' },
                { name: 'Email address (anchored)', expression: '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}$', fieldType: '2,3', errorMessage: 'Please enter valid email address' },
                { name: 'Email address (anchored, no consecutive dots)', expression: '^[A-Za-z0-9._%+-]+@(?:[A-Za-z0-9-]+\\.)+[A-Za-z]{2,6}$', fieldType: '2,3', errorMessage: 'Please enter valid email address' },
                { name: 'Email address (no consecutive dots)', expression: '^[A-Za-z0-9._%+-]+@(?:[A-Za-z0-9-]+\\.)+[A-Za-z]{2,6}$', fieldType: '2,3', errorMessage: 'Please enter valid email address' },
                { name: 'IPv4 address (accurate)', expression: '^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$', fieldType: '2,3', errorMessage: 'Please enter valid IPv4 address' },
                { name: 'IPv4 address (accurate, anchored)', expression: '^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$', fieldType: '2,3', errorMessage: 'Please enter valid IPv4 address' },
                { name: 'IPv4 address (accurate capture)', expression: '^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$', fieldType: '2,3', errorMessage: 'Please enter valid IPv4 address' },
                { name: 'IPv4 address (simple)', expression: '^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$', fieldType: '2,3', errorMessage: 'Please enter valid IPv4 address' },
                { name: 'IPv6 address (standard)', expression: '(?<![:.\\w])(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}(?![:.\\w])', fieldType: '2,3', errorMessage: 'Please enter valid IPv6 address' },
                { name: 'IPv6 address (standard, anchored)', expression: '\\A(?:[A-F0-9]{1,4}:){7}[A-F0-9]{1,4}\\z', fieldType: '2,3', errorMessage: 'Please enter valid IPv6 address' },
                { name: 'National ID: Austrian social security number (Sozialversicherungsnummer)', expression: '^\\d{4}(?:0[1-9]|[12]\\d|3[01])(?:0[1-9]|1[0-5])\\d{2}$', fieldType: '2,3', errorMessage: 'Please enter valid Austrian social security number' },
                { name: 'National ID: Bulgarian Uniform Civil Number (Единен граждански номер)', expression: '^\\d{2}(?:[024][1-9]|[135][0-2])(?:0[1-9]|[12]\\d|3[01])[-+]?\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid Bulgarian Uniform Civil Number' },
                { name: 'National ID: Canadian Social Insurance Number', expression: '^[1-9]\\d{2}[- ]?\\d{3}[- ]?\\d{3}$', fieldType: '2,3', errorMessage: 'Please enter valid Canadian Social Insurance Number' },
                { name: 'National ID: Chinese National Identification Card Number (身份证)', expression: '^\\d{6}(?:19|20)\\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\\d|3[01])\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid Chinese National Identification Card Number' },
                { name: 'National ID: Croatian Master Citizen Number (Matični broj građana)', expression: '^(?:0[1-9]|[12]\\d|3[01])(?:0[1-9]|1[0-2])(?:9\\d{2}|0[01]\\d)\\d{6}$', fieldType: '2,3', errorMessage: 'Please enter valid Croatian Master Citizen Number' },
                { name: 'National ID: Danish Civil Registration Number (Personnummer, CPR Nummer)', expression: '^(?:0[1-9]|[12]\\d|3[01])(?:0[1-9]|1[0-2])\\d{2}[-+]?\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid Danish Civil Registration Number' },
                { name: 'National ID: Finnish Social Security Number (Henkilötunnus)', expression: '^(?:0[1-9]|[12]\\d|3[01])(?:0[1-9]|1[0-2])\\d{2}[-+a]\\d{3}[a-z0-9]$', fieldType: '2,3', errorMessage: 'Please enter valid Finnish Social Security Number' },
                { name: 'National ID: Indian Permanent Account Number', expression: '^[a-z]{3}[abcfghjlpt][a-z]\\d{4}[a-z]$', fieldType: '2,3', errorMessage: 'Please enter valid Indian Permanent Account Number' },
                { name: 'National ID: Indian Vehicle License Plate Number', expression: '^(?:dl ?[1-9]?\\d ?[cprstvy]|[a-z]{2} ?\\d{1,2}) ?[a-z]{0,2} ?\\d{1,4}$', fieldType: '2,3', errorMessage: 'Please enter valid Indian Vehicle License Plate Number' },
                { name: 'National ID: Italian Fiscal Code (Codice fiscale)', expression: '^(?:[bcdfghj-np-tv-z][a-z]{2}){2}\\d{2}[a-ehlmprst](?:[04][1-9]|[1256]\\d|[37][01])(?:\\d[a-z]{3}|z\\d{3})[a-z]$', fieldType: '2,3', errorMessage: 'Please enter valid Italian Fiscal Code' },
                { name: 'National ID: Norwegian Social Security Number (Personnummer, Fødselsnummer, SSNR)', expression: '^(?:0[1-9]|[12]\\d|3[01])(?:[04][1-9]|[15][0-2])\\d{7}$', fieldType: '2,3', errorMessage: 'Please enter valid Norwegian Social Security Number' },
                { name: 'National ID: Romanian Personal Numeric Code (Cod Numeric Personal)', expression: '^[1-8]\\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\\d|3[01])(?:0[1-9]|[1-4]\\d|5[0-2]|99)\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid Romanian Personal Numeric Code' },
                { name: 'National ID: South Korean Resident Registration Number (주민등록번호)', expression: '^\\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\\d|3[01])-[0-49]\\d{6}$', fieldType: '2,3', errorMessage: 'Please enter valid South Korean Resident Registration Number' },
                { name: 'National ID: Swedish Personal Identification Number (Personnummer)', expression: '^(?:19|20)?\\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\\d|3[01])[-+]?\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid Swedish Personal Identification Number' },
                { name: 'National ID: Taiwanese National Identification Card Number', expression: '^[a-z][12]\\d{8}$', fieldType: '2,3', errorMessage: 'Please enter valid Taiwanese National Identification Card Number' },
                { name: 'National ID: United Kingdom National Insurance Number', expression: '^[abceghj-prstw-z][abceghj-nprstw-z] ?\\d{2} ?\\d{2} ?\\d{2} ?[a-dfm]?$', fieldType: '2,3', errorMessage: 'Please enter valid United Kingdom National Insurance Number' },
                { name: 'National ID: US social security number (exact)', expression: '^(?!000)(?!666)[0-8]\\d{2}[- ](?!00)\\d{2}[- ](?!0000)\\d{4}$', fieldType: '2,3', errorMessage: 'Please enter valid US social security number (exact)' },
                { name: 'National ID: US social security number (quick)', expression: '^[0-9]{3}-[0-9]{2}-[0-9]{4}$', fieldType: '2,3', errorMessage: 'Please enter valid US social security number (quick)' },
                { name: 'Number: Currency amount (cents mandatory)', expression: '^[+-]?[0-9]{1,3}(?:,?[0-9]{3})*\\.[0-9]{2}$', fieldType: '2,3', errorMessage: 'Please enter valid currency amount (cents mandatory)' },
                { name: 'Number: Currency amount (cents optional)', expression: '^[+-]?[0-9]{1,3}(?:,?[0-9]{3})*(?:\\.[0-9]{2})?$', fieldType: '2,3', errorMessage: 'Please enter valid currency amount (cents optional)' },
                { name: 'Number: Currency amount US & EU (cents optional)', expression: '^[+-]?[0-9]{1,3}(?:[0-9]*(?:[.,][0-9]{2})?|(?:,[0-9]{3})*(?:\\.[0-9]{2})?|(?:\\.[0-9]{3})*(?:,[0-9]{2})?)$', fieldType: '2,3', errorMessage: 'Please enter valid currency amount US & EU (cents optional)' },
                { name: 'Number: floating point', expression: '^[-+]?\\b[0-9]*\\.?[0-9]+$', fieldType: '2,3', errorMessage: 'Please enter valid floating point value' },
                { name: 'Number: integer', expression: '^([0-9]+)$', fieldType: '2,3', errorMessage: 'Please enter valid integer value' },
                { name: 'Number: integer with optional sign', expression: '^[-+]?\\b\\d+$', fieldType: '2,3', errorMessage: 'Please enter valid integer value with optional sign' },
                { name: 'Numeric range: 0..255', expression: '^([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$', fieldType: '2,3', errorMessage: 'Please enter valid integer value in range 0 to 255' },
                { name: 'Numeric range: 0..999', expression: '^([0-9]|[1-9][0-9]|[1-9][0-9][0-9])$', fieldType: '2,3', errorMessage: 'Please enter valid integer value in range 0 to 999' },
                { name: 'Numeric range: 1..999', expression: '^([1-9]|[1-9][0-9]|[1-9][0-9][0-9])$', fieldType: '2,3', errorMessage: 'Please enter valid integer value in range 1 to 999' },
                { name: 'Numeric range: 0 or 000..127', expression: '^(0?[0-9]?[0-9]|1[0-1][0-9]|12[0-7])$', fieldType: '2,3', errorMessage: 'Please enter valid integer value in range 000 to 127' },
                { name: 'Numeric range: 0 or 000..255', expression: '^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$', fieldType: '2,3', errorMessage: 'Please enter valid  integer value in range 000 to 255' },
                { name: 'Numeric range: 0 or 000..366', expression: '^(0?[0-9]?[0-9]|[1-2][0-9][0-9]|3[0-6][0-9]|36[0-6])$', fieldType: '2,3', errorMessage: 'Please enter valid integer value in range 000 to 366' },
                { name: 'Numeric range: 0 or 000..999', expression: '^[0-9]{1,3}$', fieldType: '2,3', errorMessage: 'Please enter valid  integer value in range 000 to 999' },
                { name: 'Numeric range: 0 or 00..59', expression: '^[0-5]?[0-9]$', fieldType: '2,3', errorMessage: 'Please enter valid  integer value in range 00 to 59' },
                { name: 'Numeric range: 1 or 001..999', expression: '^(0{0,2}[1-9]|0?[1-9][0-9]|[1-9][0-9][0-9])$', fieldType: '2,3', errorMessage: 'Please enter valid integer value in range 001 to 999' },
                { name: 'Phone Number (North America)', expression: '^(?\\b[0-9]{3}\\)?[-. ]?[0-9]{3}[-. ]?[0-9]{4}$', fieldType: '2,3', errorMessage: 'Please enter valid North America phone number' },
                { name: 'Postal code (Canada)', expression: '^[ABCEGHJKLMNPRSTVXY][0-9][A-Z] [0-9][A-Z][0-9]$', fieldType: '2,3', errorMessage: 'Please enter valid postal code (Canada)' },
                { name: 'Postal code (UK)', expression: '^[A-Z]{1,2}[0-9][A-Z0-9]? [0-9][ABD-HJLNP-UW-Z]{2}$', fieldType: '2,3', errorMessage: 'Please enter valid postal code (UK)' },
                { name: 'URL: Different URL parts', expression: '"\\b((?#protocol)https?|ftp)://((?#domain)[-A-Z0-9.]+)((?#file)/[-A-Z0-9+&@#/%=~_|!:,.\': \']*)?((?#parameters)\\?[A-Z0-9+&@#/%=~_|!:,.\': \']*)?"', fieldType: '2,3', errorMessage: 'Please enter valid URL' },
                { name: 'VAT number: Austria', expression: '^(AT)?U[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Austria)' },
                { name: 'VAT number: Belgium', expression: '^(BE)?0[0-9]{9}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Belgium)' },
                { name: 'VAT number: Bulgaria', expression: '^(BG)?[0-9]{9,10}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Bulgaria)' },
                { name: 'VAT number: Cyprus', expression: '^(CY)?[0-9]{8}L$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Cyprus)' },
                { name: 'VAT number: Czech Republic', expression: '^(CZ)?[0-9]{8,10}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Czech Republic)' },
                { name: 'VAT number: Denmark', expression: '^(DK)?[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Denmark)' },
                { name: 'VAT number: Estonia', expression: '^(EE)?[0-9]{9}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Estonia)' },
                { name: 'VAT number: Finland', expression: '^(FI)?[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Finland)' },
                { name: 'VAT number: France', expression: '^(FR)?[0-9A-Z]{2}[0-9]{9}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (France)' },
                { name: 'VAT number: Germany', expression: '^(DE)?[0-9]{9}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Germany)' },
                { name: 'VAT number: Greece', expression: '^(EL|GR)?[0-9]{9}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Greece)' },
                { name: 'VAT number: Hungary', expression: '^(HU)?[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Hungary)' },
                { name: 'VAT number: Ireland', expression: '^(IE)?[0-9]S[0-9]{5}L$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Ireland)' },
                { name: 'VAT number: Italy', expression: '^(IT)?[0-9]{11}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Italy)' },
                { name: 'VAT number: Latvia', expression: '^(LV)?[0-9]{11}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Latvia)' },
                { name: 'VAT number: Lithuania', expression: '^(LT)?([0-9]{9}|[0-9]{12})$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Lithuania)' },
                { name: 'VAT number: Luxembourg', expression: '^(LU)?[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Luxembourg)' },
                { name: 'VAT number: Malta', expression: '^(MT)?[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Malta)' },
                { name: 'VAT number: Netherlands', expression: '^(NL)?[0-9]{9}B[0-9]{2}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Netherlands)' },
                { name: 'VAT number: Poland', expression: '^(PL)?[0-9]{10}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Poland)' },
                { name: 'VAT number: Portugal', expression: '^(PT)?[0-9]{9}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Portugal)' },
                { name: 'VAT number: Romania', expression: '^(RO)?[0-9]{2,10}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Romania)' },
                { name: 'VAT number: Slovakia', expression: '^(SK)?[0-9]{10}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Slovakia)' },
                { name: 'VAT number: Slovenia', expression: '^(SI)?[0-9]{8}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Slovenia)' },
                { name: 'VAT number: Spain', expression: '^(ES)?[0-9A-Z][0-9]{7}[0-9A-Z]$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Spain)' },
                { name: 'VAT number: Sweden', expression: '^(SE)?[0-9]{12}$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (Sweden)' },
                { name: 'VAT number: United Kingdom', expression: '^(GB)?([0-9]{9}([0-9]{3})?|[A-Z]{2}[0-9]{3})$', fieldType: '2,3', errorMessage: 'Please enter valid VAT number (United Kingdom)' }
            ],
            signaturePadDefaultFont = 'Herr Von Muellerhoff',
            verifyDocumentProxy = ko.observable('/signature2/service/UploadFileToVerify'),
            fontsArray = ['Herr Von Muellerhoff', 'Tangerine', 'Allan', 'Calligraffitti', 'Cherry Cream Soda', 'Chewy', 'Coda', 'Coming Soon', 'Covered By Your Grace', 'Crafty Girls', 'Crushed', 'Fontdiner Swanky', 'Homemade Apple', 'Irish Growler', 'Just Another Hand', 'Just Me Again Down Here', 'Kenia', 'Kranky', 'Kristi', 'Lobster', 'Luckiest Guy', 'Mountains of Christmas', 'Neucha', 'Permanent Marker', 'Philosopher', 'Reenie Beanie', 'Rock Salt', 'Schoolbell', 'Slackey', 'Sunshiney', 'Syncopate', 'UnifrakturMaguntia', 'Unkempt', 'Vibur', 'Walter Turncoat', 'Yanone Kaffeesatz'],
            checkBrowserForSvgSupport = function() {
                return !!document.createElementNS && !!document.createElementNS('http://www.w3.org/2000/svg', "svg").createSVGRect;
            },
            envelopeRecipientStatus = [{ name: 'Expired', id: -2 }, { name: 'None', id: -1}, { name: 'Waiting', id: 0 }, { name: 'Notified', id: 1 }, { name: 'Delegated', id: 2 }, { name: 'Rejected', id: 3 }, { name: 'Signed', id: 4 }],
            signatureFieldAlign = { Left: 0, Center: 1, Right: 2 },
            checkFileApiSupport = function () {
                return (typeof (window.File) != "undefined" &&
                    typeof (window.FileReader) != "undefined" &&
                    typeof (window.FileList) != "undefined" &&
                    typeof (window.Blob) != "undefined");
            },
            checkHtml5StorageSupport = function() {
                try {
                    return 'localStorage' in window && window['localStorage'] !== null;
                } catch (e) {
                    return false;
                }
            },
            dateFormats = [
                'dd.mm.yy',
                'dd/mm/yy',
                'd/m/yy',
                'd.m.yy',
                'm/d/yy',
                'm.d.yy',
                'mm/dd/yy',
                'mm.dd.yy',
                'yy-m-d',
                'yy/mm/dd',
                'yy-mm-dd'
            ];
        init();

        return {
            userId: userId,
            privateKey: privateKey,
            userEmail: userEmail,
            appPath: appPath,
            uploaderProxy: uploaderProxy,
            userName: userName,
            alert: alert,
            validationMessages: validationMessages,
            routes: routes,
            serviceAddress: serviceAddress,
            signatureFieldType: signatureFieldType,
            fontSizes: fontSizes,
            fontNames: fontNames,
            fontColors: fontColors,
            fieldValidations: fieldValidations,
            signaturePadDefaultFont: signaturePadDefaultFont,
            verifyDocumentProxy: verifyDocumentProxy,
            fontsArray: fontsArray,
            checkBrowserForSvgSupport: checkBrowserForSvgSupport,
            envelopeRecipientStatus: envelopeRecipientStatus,
            signatureFieldAlign: signatureFieldAlign,
            templateUrl: templateUrl,
            downloadableSignaturePrefix: downloadableSignaturePrefix,
            isDownloadable: isDownloadable,
            downloadableHostUrl: downloadableHostUrl,
            signatureColors: signatureColors,
            useJsonp: useJsonp,
            viewerContainer: viewerContainer,
            msie11: msie11,
            checkFileApiSupport: checkFileApiSupport,
            checkHtml5StorageSupport: checkHtml5StorageSupport,
            dateFormats: dateFormats,
            downloadablePrefix: downloadablePrefix
        };
    });
define('core/dataservice/dataservice.contact',
    ['lib/amplify'],
    function (amplify) {
        var
            init = function () {

                amplify.request.define('getContacts', 'ajax', {
                    url: '/signature2/service/GetContacts',
                    dataType: 'json',
                    type: 'POST',
                    cache: 50
                });
                amplify.request.define('addContact', 'ajax', {
                    url: '/signature2/service/AddContact',
                    dataType: 'json',
                    type: 'POST'
                    //cache: true
                });
                amplify.request.define('deleteContacts', 'ajax', {
                    url: '/signature2/service/DeleteContacts',
                    dataType: 'json',
                    contentType: 'application/json',
                    type: 'POST',
                    decoder: function (data, status, xhr, success, error) 
                    { 
                        if (status === "success") { 
                            success(data, status, xhr); 
                        } 
                        else { 
                            error(data, status, xhr); 
                        } 
                    }, 
                    dataMap: function(data) { 
                        if(typeof data === 'object') { 
                            return JSON.stringify(data); 
                        } 
                        return data; 
                    }                     
                    //cache: true
                });
                amplify.request.define('updateContact', 'ajax', {
                    url: '/signature2/service/UpdateContact',
                    dataType: 'json',
                    type: 'POST'
                    //cache: true
                });
                amplify.request.define('importContacts', 'ajax', {
                    url: '/signature2/service/ImportContacts',
                    dataType: 'json',
                    contentType: 'application/json',
                    type: 'POST',
                    decoder: function (data, status, xhr, success, error) {
                        if (status === "success") {
                            success(data, status, xhr);
                        }
                        else {
                            error(data, status, xhr);
                        }
                    },
                    dataMap: function (data) {
                        if (typeof data === 'object') {
                            return JSON.stringify(data);
                        }
                        return data;
                    }
                    //cache: true
                });

            },

            getContacts = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'getContacts',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            addContact = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'addContact',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            deleteContacts = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'deleteContacts',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            updateContact = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'updateContact',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            importContacts = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'importContacts',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            };


        init();

        return {
            getContacts: getContacts,
            addContact: addContact,
            deleteContacts: deleteContacts,
            updateContact: updateContact,
            importContacts: importContacts
        };
    });
define('core/dataservice/dataservice.document',
    ['lib/amplify', 'core/config'],
    function (amplify, config) {
        var init = function() {

                amplify.request.define('publicSignDocument', 'ajax', {
                    url: config.downloadableHostUrl + config.downloadableSignaturePrefix + '/signature2/service/PublicSignDocument',
                    contentType: 'application/json; charset=utf-8',
                    dataType: config.useJsonp ? 'jsonp' : 'json',
                    type: config.useJsonp ? 'GET' : 'POST'
                    //cache: true
                });
                amplify.request.define('publicGetDocumentStatus', 'ajax', {
                    url: '/signature2/service/PublicGetSignDocumentStatus',
                    dataType: 'json',
                    type: 'POST'
                    //cache: true
                });
                amplify.request.define('publicGetDocumentFields', 'ajax', {
                    url: config.downloadableHostUrl + config.downloadableSignaturePrefix + '/signature2/service/PublicGetDocumentFields',
                    contentType: 'application/json; charset=utf-8',
                    dataType: config.useJsonp ? 'jsonp' : 'json',
                    type: config.useJsonp ? 'GET' : 'POST'
                    //cache: true
                });
                amplify.request.define('publicGetDocument', 'ajax', {
                    url: config.downloadableHostUrl + config.downloadableSignaturePrefix + '/signature2/service/PublicGetDocument',
                    contentType: 'application/json; charset=utf-8',
                    dataType: config.useJsonp ? 'jsonp' : 'json',
                    type: config.useJsonp ? 'GET' : 'POST'
                    //cache: true
                });
                amplify.request.define('publicSaveDocumentFields', 'ajax', {
                    url: config.downloadableHostUrl + config.downloadableSignaturePrefix + '/signature2/service/PublicSaveDocumentFields',
                    contentType: 'application/json; charset=utf-8',
                    dataType: config.useJsonp ? 'jsonp' : 'json',
                    type: config.useJsonp ? 'GET' : 'POST'
                    //cache: true
                });
            },
            publicSignDocument = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicSignDocument',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: config.useJsonp ? { data: JSON.stringify(data) } : JSON.stringify(data)
                    //data: data
                });
            },
            publicGetDocumentStatus = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicGetDocumentStatus',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            publicGetDocumentFields = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicGetDocumentFields',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: config.useJsonp ? { data: JSON.stringify(data) } : JSON.stringify(data)
                });
            },
            publicGetDocument = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicGetDocument',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: config.useJsonp ? { data: JSON.stringify(data) } : JSON.stringify(data)
                });
            },
            publicSaveDocumentFields = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicSaveDocumentFields',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: config.useJsonp ? { data: JSON.stringify(data) } : JSON.stringify(data)
                });
            };

        init();

        return {
            publicSignDocument: publicSignDocument,
            publicGetDocumentStatus: publicGetDocumentStatus,
            publicGetDocumentFields: publicGetDocumentFields,
            publicGetDocument: publicGetDocument,
            publicSaveDocumentFields: publicSaveDocumentFields
        };
    });



define('core/dataservice/dataservice.envelope.document',
    ['lib/amplify'],
    function(amplify) {
        var init = function() {
            amplify.request.define('addDocument', 'ajax', {
                url: '/signature2/service/AddEnvelopeDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('getDocuments', 'ajax', {
                url: '/signature2/service/GetEnvelopeDocumentsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('removeDocument', 'ajax', {
                url: '/signature2/service/DeleteEnvelopeDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('publicGetDocuments', 'ajax', {
                url: '/signature2/service/PublicGetEnvelopeDocumentsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('renameDocument', 'ajax', {
                url: '/signature2/service/RenameEnvelopeDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        addDocument = function(callbacks, data) {
            return amplify.request({
                resourceId: 'addDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getDocuments = function(callbacks, data) {
            return amplify.request({
                resourceId: 'getDocuments',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        removeDocument = function(callbacks, data) {
            return amplify.request({
                resourceId: 'removeDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicGetDocuments = function(callbacks, data) {
            return amplify.request({
                resourceId: 'publicGetDocuments',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        renameDocument = function (callbacks, data) {
            return amplify.request({
                resourceId: 'renameDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };

        init();

        return {
            addDocument: addDocument,
            getDocuments: getDocuments,
            removeDocument: removeDocument,
            publicGetDocuments: publicGetDocuments,
            renameDocument: renameDocument
        };
    });



define('core/dataservice/dataservice.envelope.field',
    ['lib/amplify', 'core/config'],
    function (amplify, config) {
        var init = function() {

            amplify.request.define('getEnvelopeFields', 'ajax', {
                url: '/signature2/service/GetEnvelopeFields',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('addEnvelopeField', 'ajax', {
                url: '/signature2/service/AddField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteEnvelopeFieldLocation', 'ajax', {
                url: '/signature2/service/DeleteFieldLocation',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateEnvelopeFieldLocation', 'ajax', {
                url: '/signature2/service/ModifyFieldLocation',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });

            amplify.request.define('publicUpdateEnvelopeFieldLocation', 'ajax', {
                url: '/signature2/service/PublicModifyFieldLocation',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });

            amplify.request.define('updateEnvelopeField', 'ajax', {
                url: '/signature2/service/UpdateField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteEnvelopeFields', 'ajax', {
                url: '/signature2/service/DeleteFields',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('fillEnvelopeField', 'ajax', {
                url: '/signature2/service/FillField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                beforeSend: function (xhrSettings, ajaxSettings) {
                    if (config.checkFileApiSupport()) {
                        ajaxSettings.xhr = function() {
                            var xhr = new window.XMLHttpRequest();
                            //Upload progress
                            xhr.upload.addEventListener("progress", function(evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round(evt.loaded / evt.total * 100);
                                    amplify.publish("envelopeFillFieldProgress", { percent: percentComplete, data: ajaxSettings.data });
                                }
                            }, false);
                            //Download progress
                            /*
                            xhr.addEventListener("progress", function(evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = evt.loaded / evt.total;
                                }
                            }, false);
                            */
                            return xhr;
                        }
                    }
                    return true;
                }
                //cache: true
            });
            amplify.request.define('publicGetEnvelopeFields', 'ajax', {
                url: '/signature2/service/PublicGetEnvelopeFields',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('publicFillEnvelopeField', 'ajax', {
                url: '/signature2/service/PublicFillField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                beforeSend: function (xhrSettings, ajaxSettings) {
                    if (config.checkFileApiSupport()) {
                        ajaxSettings.xhr = function() {
                            var xhr = new window.XMLHttpRequest();
                            //Upload progress
                            xhr.upload.addEventListener("progress", function(evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round(evt.loaded / evt.total * 100);
                                    amplify.publish("envelopeFillFieldProgress", { percent: percentComplete, data: ajaxSettings.data });
                                }
                            }, false);
                            //Download progress
                            /*
                            xhr.addEventListener("progress", function(evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = evt.loaded / evt.total;
                                }
                            }, false);
                            */
                            return xhr;
                        }
                    }
                    return true;
                }
                //cache: true,
            });
            amplify.request.define('assignEnvelopeField', 'ajax', {
                url: '/signature2/service/AssignField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateEnvelopeFieldLocationOrder', 'ajax', {
                url: '/signature2/service/ModifyFieldLocationOrder',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });

        },
            getFields = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getEnvelopeFields',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: JSON.stringify(data)
                });
            },
        addField = function(callbacks, data) {
            return amplify.request({
                resourceId: 'addEnvelopeField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        deleteFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteEnvelopeFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        updateFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateEnvelopeFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },

        publicUpdateFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicUpdateEnvelopeFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },

        updateField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateEnvelopeField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        deleteFields = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteEnvelopeFields',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        fillField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'fillEnvelopeField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        publicGetFields = function(callbacks, data) {
            return amplify.request({
                resourceId: 'publicGetEnvelopeFields',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        publicFillField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicFillEnvelopeField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        assignField = function(callbacks, data) {
            return amplify.request({
                resourceId: 'assignEnvelopeField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        updateFieldLocationOrder = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateEnvelopeFieldLocationOrder',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        }
        ;
        
        init();
        return {
            getFields: getFields,
            addField: addField,
            deleteFieldLocation: deleteFieldLocation,
            updateFieldLocation: updateFieldLocation,
            publicUpdateFieldLocation: publicUpdateFieldLocation,
            updateField: updateField,
            deleteFields: deleteFields,
            fillField: fillField,
            publicGetFields: publicGetFields,
            publicFillField: publicFillField,
            assignField: assignField,
            updateFieldLocationOrder: updateFieldLocationOrder
        };
    });

define('core/dataservice/dataservice.envelope',
    ['lib/amplify'],
    function (amplify) {
        var init = function() {

            amplify.request.define('envelopes', 'ajax', {
                url: '/signature2/service/GetEnvelopesInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('envelopesResources', 'ajax', {
                url: '/signature2/service/GetEnvelopeResources',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('envelopeRecipientSigned', 'ajax', {
                url: '/signature2/service/EnvelopeRecipientSigned',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('getEnvelopeCurrentRecipientId', 'ajax', {
                url: '/signature2/service/GetCurrentEnvelopeRecipientId',
                dataType: 'html',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('restartEnvelope', 'ajax', {
                url: '/signature2/service/RestartExpiredEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('archiveEnvelopes', 'ajax', {
                url: '/signature2/service/ArchiveEnvelopes',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('createEnvelope', 'ajax', {
                url: '/signature2/service/CreateEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('getEnvelope', 'ajax', {
                url: '/signature2/service/GetEnvelopeDetails',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateEnvelope', 'ajax', {
                url: '/signature2/service/ModifyEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('renameEnvelope', 'ajax', {
                url: '/signature2/service/RenameEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('sendEnvelope', 'ajax', {
                url: '/signature2/service/SendEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteEnvelopes', 'ajax', {
                url: '/signature2/service/DeleteEnvelopes',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('getEnvelopeAuditLog', 'ajax', {
                url: '/signature2/service/GetEnvelopeAuditLogs',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('signEnvelope', 'ajax', {
                url: '/signature2/service/SignEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('publicGetEnvelope', 'ajax', {
                url: '/signature2/service/PublicGetEnvelopeDetails',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('publicSignEnvelope', 'ajax', {
                url: '/signature2/service/PublicSignEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('publicGetEnvelopeStatus', 'ajax', {
                url: '/signature2/service/PublicGetEnvelopeStatus',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('cancelEnvelope', 'ajax', {
                url: '/signature2/service/CancelEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('retrySignEnvelope', 'ajax', {
                url: '/signature2/service/RetrySignEnvelope',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateEnvelopeFromTemplate', 'ajax', {
                url: '/signature2/service/UpdateEnvelopeFromTemplate',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('resendEmailNotification', 'ajax', {
                url: '/signature2/service/ResendEnvelopeEmailNotification',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
            getEnvelopes = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'envelopes',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            getEnvelopesResources = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'envelopesResources',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: JSON.stringify(data)
                });
            },
            envelopeRecipientSigned = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'envelopeRecipientSigned',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            getEnvelopeCurrentRecipientId = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getEnvelopeCurrentRecipientId',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            restartEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'restartEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            archiveEnvelopes = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'archiveEnvelopes',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: JSON.stringify(data)
                });
            },
            createEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'createEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            getEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            updateEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'updateEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            renameEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'renameEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            sendEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'sendEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            deleteEnvelopes = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'deleteEnvelopes',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: JSON.stringify(data)
                });
            },
            getEnvelopeAuditLog = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getEnvelopeAuditLog',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            signEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'signEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            publicGetEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicGetEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            publicSignEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicSignEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            publicEnvelopeStatus = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'publicGetEnvelopeStatus',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            cancelEnvelope = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'cancelEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            retrySignEnvelope = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'retrySignEnvelope',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            updateEnvelopeFromTemplate = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'updateEnvelopeFromTemplate',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            resendEmailNotification = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'resendEmailNotification',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            };


        init();
  
    return {
        getEnvelopes: getEnvelopes,
        getEnvelopesResources: getEnvelopesResources,
        envelopeRecipientSigned: envelopeRecipientSigned,
        getEnvelopeCurrentRecipientId: getEnvelopeCurrentRecipientId,
        restartEnvelope: restartEnvelope,
        archiveEnvelopes: archiveEnvelopes,
        createEnvelope: createEnvelope,
        getEnvelope: getEnvelope,
        updateEnvelope: updateEnvelope,
        renameEnvelope: renameEnvelope,
        sendEnvelope: sendEnvelope,
        deleteEnvelopes: deleteEnvelopes,
        getEnvelopeAuditLog: getEnvelopeAuditLog,
        signEnvelope: signEnvelope,
        publicGetEnvelope: publicGetEnvelope,
        publicSignEnvelope: publicSignEnvelope,
        publicEnvelopeStatus: publicEnvelopeStatus,
        cancelEnvelope: cancelEnvelope,
        retrySignEnvelope: retrySignEnvelope,
        updateEnvelopeFromTemplate: updateEnvelopeFromTemplate,
        resendEmailNotification: resendEmailNotification
    };
});



define('core/dataservice/dataservice.envelope.recipient',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {
            amplify.request.define('addRecipient', 'ajax', {
                url: '/signature2/service/AddEnvelopeRecipient',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('removeRecipient', 'ajax', {
                url: '/signature2/service/DeleteEnvelopeRecipient',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateRecipient', 'ajax', {
                url: '/signature2/service/ModifyEnvelopeRecipient',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        addRecipient = function (callbacks, data) {
            return amplify.request({
                resourceId: 'addRecipient',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        removeRecipient = function (callbacks, data) {
            return amplify.request({
                resourceId: 'removeRecipient',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        updateRecipient = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateRecipient',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        init();

        return {
            addRecipient: addRecipient,
            removeRecipient: removeRecipient,
            updateRecipient: updateRecipient
        };
    });



define('core/dataservice/dataservice.field',
    ['lib/amplify', 'core/config'],
    function(amplify, config) {
        var init = function() {

                amplify.request.define('getFields', 'ajax', {
                    url: config.downloadableHostUrl + config.downloadableSignaturePrefix + '/signature2/service/GetSignatureFields',
                    dataType: 'json',
                    type: 'POST'
                    //cache: true
                });

                amplify.request.define('publicGetFields', 'ajax', {
                    url: config.downloadableHostUrl + config.downloadableSignaturePrefix + '/signature2/service/PublicGetSignatureFields',
                    dataType: 'json',
                    type: 'POST'
                    //cache: true
                });
            },


            getFields = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getFields',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },


            publicGetFields = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicGetFields',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            };
        init();
        return {
            getFields: getFields,
            publicGetFields: publicGetFields
        };
    });

define('core/dataservice/dataservice.form.document',
    ['lib/amplify'],
    function(amplify) {
        var init = function() {
            amplify.request.define('addFormDocument', 'ajax', {
                url: '/signature2/service/AddFormDocument',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('getFormDocuments', 'ajax', {
                url: '/signature2/service/GetFormDocumentsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('removeFormDocument', 'ajax', {
                url: '/signature2/service/DeleteFormDocument',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('publicGetFormDocuments', 'ajax', {
                url: '/signature2/service/PublicGetFormDocumentsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('renameFormDocument', 'ajax', {
                url: '/signature2/service/RenameFormDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('modifyFormDocument', 'ajax', {
                url: '/signature2/service/ModifyFormDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        addDocument = function(callbacks, data) {
            return amplify.request({
                resourceId: 'addFormDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getDocuments = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getFormDocuments',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        removeDocument = function (callbacks, data) {
            return amplify.request({
                resourceId: 'removeFormDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicGetDocuments = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicGetFormDocuments',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        renameDocument = function(callbacks, data) {
            return amplify.request({
                resourceId: 'renameFormDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        modifyDocument = function (callbacks, data) {
            return amplify.request({
                resourceId: 'modifyFormDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        init();

        return {
            addDocument: addDocument,
            getDocuments: getDocuments,
            removeDocument: removeDocument,
            publicGetDocuments: publicGetDocuments,
            renameDocument: renameDocument,
            modifyDocument:modifyDocument
        };
    });



define('core/dataservice/dataservice.form.field',
    ['lib/amplify','core/config'],
    function (amplify, config) {
        var init = function() {

            amplify.request.define('getFormFields', 'ajax', {
                url: '/signature2/service/GetFormFields',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('addFormField', 'ajax', {
                url: '/signature2/service/AddFormField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteFormFieldLocation', 'ajax', {
                url: '/signature2/service/DeleteFormFieldLocation',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateFormFieldLocation', 'ajax', {
                url: '/signature2/service/ModifyFormFieldLocation',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateFormField', 'ajax', {
                url: '/signature2/service/UpdateFormField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteFormFields', 'ajax', {
                url: '/signature2/service/DeleteFormFields',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('publicGetFormFields', 'ajax', {
                url: '/signature2/service/PublicGetFormFields',
                dataType: 'json',
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
               
            });
            amplify.request.define('publicFillFormField', 'ajax', {
                url: '/signature2/service/PublicFillFormField',
                dataType: 'json',
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                beforeSend: function (xhrSettings, ajaxSettings) {
                    if (config.checkFileApiSupport()) {
                        ajaxSettings.xhr = function() {
                            var xhr = new window.XMLHttpRequest();
                            //Upload progress
                            xhr.upload.addEventListener("progress", function(evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = Math.round(evt.loaded / evt.total * 100);
                                    amplify.publish("formFillFieldProgress", { percent: percentComplete, data: ajaxSettings.data });
                                }
                            }, false);
                            //Download progress
                            /*
                        xhr.addEventListener("progress", function(evt) {
                            if (evt.lengthComputable) {
                                var percentComplete = evt.loaded / evt.total;
                            }
                        }, false);
                        */
                            return xhr;
                        }
                    }
                    return true;
                }
            });
        },
        getFields = function(callbacks, data) {
            return amplify.request({
                resourceId: 'getFormFields',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        addField = function(callbacks, data) {
            return amplify.request({
                resourceId: 'addFormField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        deleteFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteFormFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        updateFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateFormFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        updateField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateFormField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        deleteFields = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteFormFields',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        publicGetFields = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicGetFormFields',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        publicFillField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicFillFormField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        };
        init();
        return {
            getFields: getFields,
            addField: addField,
            deleteFieldLocation: deleteFieldLocation,
            updateFieldLocation: updateFieldLocation,
            updateField: updateField,
            deleteFields: deleteFields,
            publicGetFields: publicGetFields,
            publicFillField: publicFillField
        };
    });

define('core/dataservice/dataservice.form',
    ['lib/amplify'],
    function (amplify) {
        var init = function() {

            amplify.request.define('forms', 'ajax', {
                url: '/signature2/service/GetFormsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('form', 'ajax', {
                url: '/signature2/service/GetFormInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('formsResources', 'ajax', {
                url: '/signature2/service/GetFormResources',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('createForm', 'ajax', {
                url: '/signature2/service/CreateForm',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('completeForm', 'ajax', {
                url: '/signature2/service/CompleteForm',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteForms', 'ajax', {
                url: '/signature2/service/DeleteForms',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('archiveForm', 'ajax', {
                url: '/signature2/service/ArchiveForm',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateFormFromTemplate', 'ajax', {
                url: '/signature2/service/UpdateFormFromTemplate',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('modifyForm', 'ajax', {
                url: '/signature2/service/modifyForm',
                dataType: 'json',
                type: 'POST',
                contentType: 'application/json',
                dataMap: function (data) {
                    if (typeof data === 'object') {
                        return JSON.stringify(data);
                    }
                    return data;
                }
            });
            amplify.request.define('publishForm', 'ajax', {
                url: '/signature2/service/publishForm',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('archiveForms', 'ajax', {
                url: '/signature2/service/ArchiveForms',
                dataType: 'json',
                type: 'POST',
                contentType: 'application/json',
                dataMap: function (data) {
                    if (typeof data === 'object') {
                        return JSON.stringify(data);
                    }
                    return data;
                }
            });
            amplify.request.define('publicSignForm', 'ajax', {
                url: '/signature2/service/PublicSignForm',
                dataType: 'json',
                type: 'POST'
            });
            
            amplify.request.define('publicGetFormParticipant', 'ajax', {
                url: '/signature2/service/PublicGetFormParticipant',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('getFormAuditLog', 'ajax', {
                url: '/signature2/service/GetFormAuditLogs',
                dataType: 'json',
                type: 'POST'
            });

            amplify.request.define('publicModifyFormParticipant', 'ajax', {
                url: '/signature2/service/PublicModifyFormParticipant',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('publicValidateFormParticipant', 'ajax', {
                url: '/signature2/service/PublicValidateFormParticipant',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('publicFormParticipantResentValidationCode', 'ajax', {
                url: '/signature2/service/PublicFormParticipantResentValidationCode',
                dataType: 'json',
                type: 'POST'
            });
            amplify.request.define('getFormParticipants', 'ajax', {
                url: '/signature2/service/GetFormParticipants',
                dataType: 'json',
                type: 'POST'
            });
        },
        getForms = function(callbacks, data) {
            return amplify.request({
                resourceId: 'forms',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getForm = function (callbacks, data) {
            return amplify.request({
                resourceId: 'form',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getFormsResources = function(callbacks, data) {
            return amplify.request({
                resourceId: 'formsResources',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        createForm = function(callbacks, data) {
            return amplify.request({
                resourceId: 'createForm',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        completeForm = function(callbacks, data) {
            return amplify.request({
                resourceId: 'completeForm',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        deleteForms = function(callbacks, data) {
            return amplify.request({
                resourceId: 'deleteForms',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        archiveForm = function(callbacks, data) {
            return amplify.request({
                resourceId: 'archiveForm',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        updateFormFromTemplate = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'updateFormFromTemplate',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
        },
        modifyForm = function(callbacks, data) {
            return amplify.request({
                resourceId: 'modifyForm',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publishForm = function(callbacks, data) {
            return amplify.request({
                resourceId: 'publishForm',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        archiveForms = function(callbacks, data) {
            return amplify.request({
                resourceId: 'archiveForms',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicSignForm = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicSignForm',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicGetFormParticipant = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicGetFormParticipant',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getFormAuditLog = function(callbacks, data) {
            return amplify.request({
                resourceId: 'getFormAuditLog',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicModifyFormParticipant = function (callbacks, data) {
            return amplify.request({
                resourceId: 'publicModifyFormParticipant',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicValidateFormParticipant = function(callbacks, data) {
            return amplify.request({
                resourceId: 'publicValidateFormParticipant',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        publicFormParticipantResentValidationCode = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'publicFormParticipantResentValidationCode',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
        } ,
        getFormParticipants = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getFormParticipants',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        }
        ;

        init();
        return {
            getForms: getForms,
            getForm: getForm,
            getFormsResources: getFormsResources,
            createForm: createForm,
            completeForm: completeForm,
            deleteForms: deleteForms,
            archiveForm: archiveForm,
            updateFormFromTemplate: updateFormFromTemplate,
            modifyForm: modifyForm,
            publishForm: publishForm,
            archiveForms: archiveForms,
            publicSignForm: publicSignForm,
            publicGetFormParticipant: publicGetFormParticipant,
            getFormAuditLog: getFormAuditLog,
            publicModifyFormParticipant: publicModifyFormParticipant,
            publicValidateFormParticipant: publicValidateFormParticipant,
            publicFormParticipantResentValidationCode: publicFormParticipantResentValidationCode,
            getFormParticipants: getFormParticipants
        };
    });



define('core/dataservice/dataservice.form.participant',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {
            amplify.request.define('getFormParticipants', 'ajax', {
                url: '/signature2/service/GetFormParticipants',
                dataType: 'json',
                type: 'POST'
            });
        },
        getFormParticipants = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getFormParticipants',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        }
        ;

        init();
        return {
            getFormParticipants: getFormParticipants
        };
    });



define('core/dataservice/dataservice.predefinedlist',
    ['lib/amplify'],
    function(amplify) {
        var init = function() {

            amplify.request.define('getPredefinedLists', 'ajax', {
                url: '/signature2/service/GetPredefinedListsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('addPredefinedList', 'ajax', {
                url: '/signature2/service/AddPredefinedList',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deletePredefinedList', 'ajax', {
                url: '/signature2/service/DeletePredefinedList',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
            getPredefinedLists = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getPredefinedLists',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            addList = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'addPredefinedList',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            deleteList = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'deletePredefinedList',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            };
            ;
        init();
        return {
            getPredefinedLists: getPredefinedLists,
            addList: addList,
            deleteList: deleteList
        };
    });

define('core/dataservice/dataservice.resources',
    ['lib/amplify', 'core/config'],
    function(amplify, config) {
        var init = function() {

            amplify.request.define('getSignatureBackgroundSvg', 'ajax', {
                url: config.downloadableSignaturePrefix+'/signature2/resource/GetSignatureBackgroundSvg',
                dataType: 'html',
                type: 'GET',
                cache: true
            });
            amplify.request.define('getStampBackgroundSvg', 'ajax', {
                url: config.downloadableSignaturePrefix + '/signature2/resource/GetStampBackgroundSvg',
                dataType: 'html',
                type: 'GET',
                cache: true
            });
        },
            getSignatureBackgroundSvg = function(callbacks, data) {
                return amplify.request({
                    resourceId: 'getSignatureBackgroundSvg',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            },
            getStampBackgroundSvg = function (callbacks, data) {
                return amplify.request({
                    resourceId: 'getStampBackgroundSvg',
                    success: callbacks.success,
                    error: callbacks.error,
                    data: data
                });
            };
        init();
        return {
            getSignatureBackgroundSvg: getSignatureBackgroundSvg,
            getStampBackgroundSvg: getStampBackgroundSvg
        };
    });

define('core/dataservice/dataservice.signature',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {
            amplify.request.define('getSignatures', 'ajax', {
                url: '/signature2/service/GetSignatures',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('deleteSignatures', 'ajax', {
                url: '/signature2/service/DeleteSignature',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('createSignature', 'ajax', {
                url: '/signature2/service/CreateSignature',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('updateSignature', 'ajax', {
                url: '/signature2/service/ModifySignature',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
        },
        getSignatures = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getSignatures',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        deleteSignatures = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteSignatures',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        createSignature = function (callbacks, data) {
            return amplify.request({
                resourceId: 'createSignature',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        updateSignature = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateSignature',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        }

        ;
        init();

        return {
            getSignatures: getSignatures,
            deleteSignatures: deleteSignatures,
            createSignature: createSignature,
            updateSignature: updateSignature
        };
    });



define('core/dataservice/dataservice.template.document',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {
            amplify.request.define('addTemplateDocument', 'ajax', {
                url: '/signature2/service/AddTemplateDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('getTemplateDocuments', 'ajax', {
                url: '/signature2/service/GetTemplateDocumentsInfo',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('removeTemplateDocument', 'ajax', {
                url: '/signature2/service/DeleteTemplateDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('renameTemplateDocument', 'ajax', {
                url: '/signature2/service/RenameTemplateDocument',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        addDocument = function (callbacks, data) {
            return amplify.request({
                resourceId: 'addTemplateDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getDocuments = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getTemplateDocuments',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        removeDocument = function (callbacks, data) {
            return amplify.request({
                resourceId: 'removeTemplateDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        renameDocument = function (callbacks, data) {
            return amplify.request({
                resourceId: 'renameTemplateDocument',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        init();

        return {
            addDocument: addDocument,
            getDocuments: getDocuments,
            removeDocument: removeDocument,
            renameDocument: renameDocument
        };
    });



define('core/dataservice/dataservice.template.field',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {

            amplify.request.define('getTemplateFields', 'ajax', {
                url: '/signature2/service/GetTemplateFields',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('addTemplateField', 'ajax', {
                url: '/signature2/service/AddTemplateField',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteTemplateFieldLocation', 'ajax', {
                url: '/signature2/service/DeleteTemplateFieldLocation',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateTemplateFieldLocation', 'ajax', {
                url: '/signature2/service/ModifyTemplateFieldLocation',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateTemplateField', 'ajax', {
                url: '/signature2/service/UpdateTemplateField',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteTemplateFields', 'ajax', {
                url: '/signature2/service/DeleteTemplateFields',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            
            amplify.request.define('assignTemplateField', 'ajax', {
                url: '/signature2/service/AssignTemplateField',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        getFields = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getTemplateFields',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        addField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'addTemplateField',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        deleteFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteTemplateFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        updateFieldLocation = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateTemplateFieldLocation',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        updateField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateTemplateField',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        deleteFields = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteTemplateFields',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        assignField = function (callbacks, data) {
            return amplify.request({
                resourceId: 'assignTemplateField',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };

        init();
        return {
            getFields: getFields,
            addField: addField,
            deleteFieldLocation: deleteFieldLocation,
            updateFieldLocation: updateFieldLocation,
            updateField: updateField,
            deleteFields: deleteFields,
            assignField: assignField
        };
    });

define('core/dataservice/dataservice.template',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {

            amplify.request.define('getTemplates', 'ajax', {
                url: '/signature2/service/GetTemplatesInfo',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('templatesResources', 'ajax', {
                url: '/signature2/service/GetTemplateResources',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('deleteTemplates', 'ajax', {
                url: '/signature2/service/DeleteTemplates',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('createTemplate', 'ajax', {
                url: '/signature2/service/CreateTemplate',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('getTemplate', 'ajax', {
                url: '/signature2/service/GetTemplateDetails',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateTemplate', 'ajax', {
                url: '/signature2/service/ModifyTemplate',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('renameTemplate', 'ajax', {
                url: '/signature2/service/RenameTemplate',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        getTemplates = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getTemplates',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getTemplatesResources = function (callbacks, data) {
            return amplify.request({
                resourceId: 'templatesResources',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        deleteTemplates = function (callbacks, data) {
            return amplify.request({
                resourceId: 'deleteTemplates',
                success: callbacks.success,
                error: callbacks.error,
                data: JSON.stringify(data)
            });
        },
        createTemplate = function (callbacks, data) {
            return amplify.request({
                resourceId: 'createTemplate',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        getTemplate = function (callbacks, data) {
            return amplify.request({
                resourceId: 'getTemplate',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        updateTemplate = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateTemplate',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        },
        renameTemplate = function (callbacks, data) {
            return amplify.request({
                resourceId: 'renameTemplate',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        }
        ;

        init();

        return {
            getTemplates: getTemplates,
            getTemplatesResources: getTemplatesResources,
            deleteTemplates: deleteTemplates,
            createTemplate: createTemplate,
            getTemplate: getTemplate,
            updateTemplate: updateTemplate,
            renameTemplate: renameTemplate
        };
    });



define('core/dataservice/dataservice.template.recipient',
    ['lib/amplify'],
    function (amplify) {
        var init = function () {
            amplify.request.define('addTemplateRecipient', 'ajax', {
                url: '/signature2/service/AddTemplateRecipient',
                dataType: 'json',
                type: 'POST',
                //cache: true
            });
            amplify.request.define('removeTemplateRecipient', 'ajax', {
                url: '/signature2/service/DeleteTemplateRecipient',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
            amplify.request.define('updateTemplateRecipient', 'ajax', {
                url: '/signature2/service/UpdateTemplateRecipient',
                dataType: 'json',
                type: 'POST'
                //cache: true
            });
        },
        addRecipient = function (callbacks, data) {
            return amplify.request({
                resourceId: 'addTemplateRecipient',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        removeRecipient = function (callbacks, data) {
            return amplify.request({
                resourceId: 'removeTemplateRecipient',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        updateRecipient = function (callbacks, data) {
            return amplify.request({
                resourceId: 'updateTemplateRecipient',
                success: callbacks.success,
                error: callbacks.error,
                data: data
            });
        };
        init();

        return {
            addRecipient: addRecipient,
            removeRecipient: removeRecipient,
            updateRecipient: updateRecipient
        };
    });



define('core/dataservice',
    [
        'core/dataservice/dataservice.envelope',
        'core/dataservice/dataservice.envelope.document',
        'core/dataservice/dataservice.envelope.recipient',
        'core/dataservice/dataservice.contact',
        'core/dataservice/dataservice.template',
        'core/dataservice/dataservice.template.document',
        'core/dataservice/dataservice.signature',
        'core/dataservice/dataservice.form',
        'core/dataservice/dataservice.field',
        'core/dataservice/dataservice.predefinedlist',
        'core/dataservice/dataservice.form.document',
        'core/dataservice/dataservice.form.field'
    ],
    function (envelope,
        envelopeDocument,
        envelopeRecipient,
        contact,
        template,
        signature,
        form,
        field,
        predefinedList,
        formDocument,
        formField
    ) {
        return {
            envelope: envelope,
            envelopeDocument: envelopeDocument,
            envelopeRecipient: envelopeRecipient,
            contact: contact,
            template: template,
            templateDocument: templateDocument,
            signature: signature,
            form: form,
            field: field,
            predefinedList: predefinedList,
            formDocument: formDocument,
            formField: formField
        };
    });
define('core/eventManager',
    ['jquery',
        'lib/underscore',
        'lib/amplify'],
    function ($, _, amplify) {
        function getInstance(callbacks) {
            var onFormFieldFilled = callbacks.formFieldFilledCallback,
                onEnvelopeFieldFilled = callbacks.envelopeFieldFilledCallback;

            amplify.subscribe("formFillFieldProgress", function(data) {
                if (_.isFunction(onFormFieldFilled)) {
                    onFormFieldFilled(data);
                };
            });
            amplify.subscribe("envelopeFillFieldProgress", function (data) {
                if (_.isFunction(onEnvelopeFieldFilled)) {
                    onEnvelopeFieldFilled(data);
                };
            });
            return {
                onFormFieldFilled: onFormFieldFilled,
                onEnvelopeFieldFilled: onEnvelopeFieldFilled
            };
        }
        return getInstance;
    });
$(function() {
    $.widget("ui.groupdocsSignature", {
        options: {
            previewDocument: '',
            hostUrl: '',
            showHeader: true,
            documentGuid: '',
            recipientGuid: '',
            showTypeItTab: true,
            showUploadTab: true,
            signaturePenColors: []
        },
        signDoc: null,

        on: function(eventName, handler) {
            $(this.element).on(eventName, handler);
        },

        off: function(eventName, handler) {
            $(this.element).off(eventName, handler);
        },

        _addHtml: function () {
            $(this.element).empty();
            $(this.element).html(
        "<div class='loading_overlay embed' style='display: none; top: 60px;'><div class='loading_overlay_message' style=' width: 240px;'><span class='progresspin'></span><p>Signing your document...</p></div></div>\
            <div class='viewer_header header_sidescroll'>\
                <div class='viewer_header_wrapper'>\
                    <!-- ko stopBindings: true -->\
                    <div id='viewer-navigation' data-bind=\"template: 'widgets/document-navigation'\">\
                    </div>\
                    <!-- /ko -->\
                    <div id='viewer-zoom' class='' style='display:inline-block'>\
                    </div>\
                </div>\
            </div>\
            <!-- Main content -->\
            <div id='viewer_mainwrapper' class='embedded_viewer_wrapper embed_signature'>\
                <!-- ko template: 'widgets/document-thumbnails' --><!-- /ko -->\
                <!-- ko stopBindings: true -->\
                <div id='doc_viewer_wrapper' class='document_viewer' style='overflow: auto; bottom: 40px;' data-bind=\"template: 'widgets/sign-document-viewer', event: { scroll: function (item, e) { this.ScrollDocView(item, e); return true; }, scrollstop: function (item, e) { this.ScrollDocViewEnd(item, e); return true; } }\">\
                </div>\
                <!-- /ko -->\
                <!-- ko stopBindings: true -->\
                <div class='embed_signature_footer sign_button_container' style='position: absolute;'>\
                    <button class='red_button sign_document' rel='tooltip' data-bind=\"tooltip: {}, enableSign: { fieldsLeft: fieldsToBeFilled(), recipientStatus: 1, app: 'document' }\" data-placement='top' data-html='true'>Confirm Signature</button>\
                </div>\
                <!-- /ko -->\
            </div>\
            <!-- ko stopBindings: true -->\
            <div id='signature-dialog' class='signature-dialog' data-bind=\"template: 'widgets/create-signature-dialog'\"></div>\
            <!-- /ko -->\
            <!-- ko stopBindings: true -->\
            <div id='errorDialog' class='modal fade modal2 modal800px' data-bind='modal: isVisible,  modalOptions: { beforeShow: onBeforeShow, beforeClose: onBeforeClose }' data-keyboard='false' data-backdrop='false'>\
                <div class='modal_inner_wrapper'>\
	                <div class='modal_header'>\
                        <h3>Error</h3>\
                    </div>\
                    <div class='modal_content'>\
		                <div class='modal_input_wrap_left'>\
                            <div data-bind=\"text: errorText\"></div>\
                        </div>\
                    </div>\
                    <div class='modal_footer'>\
                        <div class='modal_btn_wrapper'>\
                        </div>\
                    </div>\
                </div>\
            </div>\
            <!-- /ko -->\
            <!-- ko stopBindings: true -->\
            <div id='enter-name-dialog' data-bind=\"template: 'widgets/enter-name-dialog'\"></div>\
            <!-- /ko -->\
            <div id='jerror' title='Error' class='modal fade modal2'>\
                <div class='modal_inner_wrapper'>\
                    <a class='popclose' data-dismiss='modal'></a>\
                    <div class='modal_header'>\
                        <h3>Error</h3>\
                    </div>\
                    <div class='modal_content'>\
                        <div class='modal_input_wrap_left'>\
                            <div id='jerrorMsg'></div>\
                        </div>\
                    </div>\
                    <div class='modal_footer'>\
                        <div class='modal_btn_wrapper'>\
                            <a href='#' data-dismiss='modal' class='grey_button right'>Close</a>\
                        </div>\
                    </div>\
                </div>\
            </div>");

        },

        // the constructor
        _create: function () {
            var self = this;
            require(['signDocument'], function (signDocument) {
                self._addHtml();
                self.signDoc = new signDocument();
                self.signDoc.init($(self.element), self.options);
            });
            self.on("onDocumentLoadComplete", function(event, data) {
                if (!data.lic) {
                    var viewerMainWrapper = $(self.element).find(".embedded_viewer_wrapper");
                    $(viewerMainWrapper).css("top", "94px");
                    $(self.element).find(".banner_trial").remove();
                    var licElement = $("<div/>");
                    $(licElement).addClass("banner_trial");
                    $(licElement).html("This viewer has been created using an unlicensed version of " +
                        "<a href='http://groupdocs.com' target='_blank'>GroupDocs.Signature</a> for .NET ");
                    $(licElement).insertBefore(viewerMainWrapper);
                };
            });
        },
        
        sign: function (recipientGuid) {
            this._addHtml();
            this.options.recipientGuid = recipientGuid;
            this.signDoc.init($(this.element), this.options);
        }
    });
});
$(function() {
    $.widget("ui.groupdocsSignaturePrepare", {
        options: {
            previewDocument: '',
            hostUrl: '',
            showHeader: true,
            documentGuid: '',
            recipientGuid: '',
            dateFormats: []
        },
        prepareDoc: null,

        on: function(eventName, handler) {
            $(this.element).on(eventName, handler);
        },

        off: function(eventName, handler) {
            $(this.element).off(eventName, handler);
        },

        _addHtml: function () {
            $(this.element).empty();
            $(this.element).html(
        "\
            <!-- Main content -->\
            <div >\
                <!-- ko template: 'widgets/document-thumbnails' --><!-- /ko -->\
                \
            </div>\
            <!-- ko template: 'widgets/document-prepare' --><!-- /ko -->\
            <div id='viewer-navigation'></div>\
            <div id='viewer-zoom'></div>\
            \
            <!-- ko stopBindings: true -->\
            <div id='errorDialog' class='modal fade modal2 modal800px' data-bind='modal: isVisible,  modalOptions: { beforeShow: onBeforeShow, beforeClose: onBeforeClose }' data-keyboard='false' data-backdrop='false'>\
                <div class='modal_inner_wrapper'>\
	                <div class='modal_header'>\
                        <h3>Error</h3>\
                    </div>\
                    <div class='modal_content'>\
		                <div class='modal_input_wrap_left'>\
                            <div data-bind=\"text: errorText\"></div>\
                        </div>\
                    </div>\
                    <div class='modal_footer'>\
                        <div class='modal_btn_wrapper'>\
                        </div>\
                    </div>\
                </div>\
            </div>\
            <!-- /ko -->\
            <!-- ko stopBindings: true -->\
            \
            <!-- /ko -->\
            <div id='jerror' title='Error' class='modal fade modal2'>\
                <div class='modal_inner_wrapper'>\
                    <a class='popclose' data-dismiss='modal'></a>\
                    <div class='modal_header'>\
                        <h3>Error</h3>\
                    </div>\
                    <div class='modal_content'>\
                        <div class='modal_input_wrap_left'>\
                            <div id='jerrorMsg'></div>\
                        </div>\
                    </div>\
                    <div class='modal_footer'>\
                        <div class='modal_btn_wrapper'>\
                            <a href='#' data-dismiss='modal' class='grey_button right'>Close</a>\
                        </div>\
                    </div>\
                </div>\
            </div>");

        },

        // the constructor
        _create: function () {
            var self = this;
            require(['prepareDocument'], function (prepareDocument) {
                self._addHtml();
                self.prepareDoc = new prepareDocument();
                self.prepareDoc.init($(self.element), self.options);
                var viewerMainWrapper = $(self.element).parent();
                viewerMainWrapper.attr("id", "mainwrapper");
                viewerMainWrapper.addClass("mainwrap_sidescroll");
                viewerMainWrapper.css("padding", "35px 0 15px");
            });
            self.on("onDocumentLoadComplete", function(event, data) {

                if (!data.lic) {
                    var viewerMainWrapper = $(self.element).parent();
                    viewerMainWrapper.find(".banner_trial").remove();
                    viewerMainWrapper.find(".banner_trial").remove();
                    var licElement = $("<div/>");
                    $(licElement).addClass("banner_trial");
                    $(licElement).css("top",0);
                    $(licElement).css("z-index",100000);
                    $(licElement).html("This viewer has been created using an unlicensed version of " +
                        "<a href='http://groupdocs.com' target='_blank'>GroupDocs.Signature</a> for .NET ");
                    $(licElement).insertAfter(viewerMainWrapper);
                };
            });
        }
        
       
    });
});
define('core/model',
    [
        'core/model/model.envelope',
        'core/model/model.envelope.recipient',
        'core/model/model.contact',
        'core/model/model.template',
        'core/model/model.template.recipient',
        'core/model/model.signature',
        'core/model/model.form'
    ],
    function (envelope,
        envelopeRecipient,
        contact,
        template,
        templateRecipient,
        signature,
        form
    ) {
        var
            model = {
                envelope: envelope,
                envelopeRecipient: envelopeRecipient,
                contact: contact,
                template: template,
                templateRecipient: templateRecipient,
                signature: signature,
                form: form
            };
        return model;
    });
define('core/model/model.auditlog',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            log = function () {
                var self = this;
                self.id = ko.observable('');
                self.type = ko.observable(0);
                self.date = ko.observable('');                
                self.userName = ko.observable('');
                self.action = ko.observable('');
                self.remoteAddress = ko.observable('');
                self.details = ko.observable('');
            };

        log.fromDto = function (dto) {
            var item = new log().id(dto.id);

            item.date(dto.date)
                .type(dto.type)
                .userName(dto.userName)
                .action(dto.action)
                .remoteAddress(dto.remoteAddress)
                .details(dto.details);
            return item;
        };
        log.blank = function () {
            var item = new log();
            return item;
        };
        log.getDtoId = function (dto) { return dto.id; };

        return log;
    });
define('core/model/model.contact',
    ['ko',
     'lib/underscore'],
    function (ko, _) {
        var
            contact = function () {
                var self = this;
                self.id = ko.observable();
                self.firstName = ko.observable();
                self.lastName = ko.observable();
                self.email = ko.observable();
                self.provider = ko.observable();
                self.fullName = ko.computed(function () {
                    return self.firstName() + " " + self.lastName();
                }, this);
                self.selected = ko.observable(false);
            };

        contact.fromDto = function(dto) {
            var item = new contact().id(dto.id);

            item.firstName(dto.firstName)
                .lastName(dto.lastName)
                .email(dto.email)
                .provider(dto.provider);
            ko.validation.group(item);
            return item;
        };
        contact.getDtoId = function (dto) { return dto.id; };
        return contact;
    });
define('core/model/model.document.field',
    ['ko',
    'core/config',
    'core/utils',
    'core/model/model.document.fieldlocation'
    ],
    function (ko, config, utils, documentFieldLocation) {
        var
            documentField = function () {
                var self = this;
                self.id = ko.observable('');
                self.documentId = ko.observable('');
                self.recipientId = ko.observable('');
                self.name = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } });
                self.mandatory = ko.observable(false);
                self.order = ko.observable('');
                self.regularExpression = ko.escapedObservable('');
                self.getDataFrom = ko.observable('');
                self.data = ko.observable(null);
                self.fillTimeStamp = ko.observable('');
                self.signatureFieldId = ko.observable('');
                self.locations = ko.observableArray([]);
                self.fieldType = ko.observable('');
                self.fieldType.subscribeChanged(function (newValue, oldValue) {
                    if (oldValue != null && oldValue!=newValue) {
                        self.prepareSettings(newValue);
                    }
                });
                self.acceptableValuesArray = ko.observableArray([]);
                self.defaultValue = ko.escapedObservable(null);
                self.tooltip = ko.escapedObservable('');
                self.guidanceText = ko.escapedObservable('');
                self.groupName = ko.escapedObservable('');
                self.settings = ko.observable();
                self.lockDuringSign = ko.observable(true);
                self.progress = ko.observable(0);
                self.templateName = ko.computed(function() {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "signature-field-template";
                        case config.signatureFieldType.SingleLine:
                            return "singleline-field-template";
                        case config.signatureFieldType.MultiLine:
                            return "multiline-field-template";
                        case config.signatureFieldType.Date:
                            return "date-field-template";
                        case config.signatureFieldType.Dropdown:
                            return "dropdown-field-template";
                        case config.signatureFieldType.Checkbox:
                            return "checkbox-field-template";
                        case config.signatureFieldType.File:
                            return "file-field-template";
                        case config.signatureFieldType.Stamp:
                            return "stamp-field-template";
                    }
                    return "";
                });
                self.fieldTypeText = ko.computed(function () {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "Signature";
                        case config.signatureFieldType.SingleLine:
                            return "Single line text field";
                        case config.signatureFieldType.MultiLine:
                            return "Multi line text field";
                        case config.signatureFieldType.Date:
                            return "Date";
                        case config.signatureFieldType.Dropdown:
                            return "Dropdown";
                        case config.signatureFieldType.Checkbox:
                            return "Checkbox";
                        case config.signatureFieldType.File:
                            return "File";
                        case config.signatureFieldType.Stamp:
                            return "Stamp";
                    }
                    return "";
                });
                self.acceptableValues = ko.computed(function () {
                    return self.acceptableValuesArray().join(";");
                });
                self.isCalcField = ko.computed(function () {
                    return self.settings() != null && self.settings().calculationScript != null;
                });
                //self.dirtyFlag = new ko.DirtyFlag([self.name, self.regularExpression, self.acceptableValuesArray, self.defaultValue, self.tooltip]);
                self.dirtyFlag = new ko.DirtyFlag([self.name, self.defaultValue, self.tooltip, self.acceptableValues, self.guidanceText, self.recipientId, self.groupName, self.mandatory, self.regularExpression, self.settings, self.lockDuringSign]);
                
                self.prepareSettings = function (filedType, settingsJson) {
                    if (settingsJson == undefined)
                        settingsJson = {};
                    switch (filedType) {
                        case config.signatureFieldType.Date:
                            var dateSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                showMonthYearDropdowns: ko.observable(dateSettings != null && dateSettings.showMonthYearDropdowns != null ? dateSettings.showMonthYearDropdowns : true),
                                minYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.minYear : new Date().getFullYear() - 99).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                maxYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.maxYear : new Date().getFullYear() + 30).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                dateFormat: ko.observable(dateSettings != null && dateSettings.dateFormat != null ? dateSettings.dateFormat : "dd.mm.yy")
                            });
                            ko.validation.group(self.settings);
                            break;
                        case config.signatureFieldType.Signature:
                            var signatureSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                matchWidth: ko.observable(signatureSettings != null && signatureSettings.matchWidth != null ? signatureSettings.matchWidth : false),
                                matchHeight: ko.observable(signatureSettings != null && signatureSettings.matchHeight != null ? signatureSettings.matchHeight : true)
                            });

                            break;
                        case config.signatureFieldType.Checkbox:
                            var checkboxSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                checkboxBorder: ko.observable(checkboxSettings != null && checkboxSettings.checkboxBorder != null ? checkboxSettings.checkboxBorder : true),
                            });
                            break;
                        case config.signatureFieldType.SingleLine:
                            var textSettings = ko.utils.parseJson(settingsJson);
                            var minValue = textSettings != null && textSettings.minValue != null ? textSettings.minValue : null;
                            var maxValue = textSettings != null && textSettings.maxValue != null ? textSettings.maxValue : null;
                            var validationScript = textSettings != null && textSettings.validationScript != null ? textSettings.validationScript : null;
                            var calculationScript = textSettings != null && textSettings.calculationScript != null ? textSettings.calculationScript : null;
                            self.settings({
                                maxLength: ko.observable(textSettings != null && textSettings.maxLength != null ? textSettings.maxLength : "").extend({ number: true, min: 1 }),
                                minValue: ko.observable(minValue).extend({ number: true }),
                                maxValue: ko.observable(maxValue).extend({ number: true }),
                                validationScript: validationScript,
                                calculationScript: calculationScript
                            });
                            if (minValue != null || maxValue != null) {
                                self.data.extend({ number: true });
                                if (minValue != null)
                                    self.data.extend({ min: minValue });
                                if (maxValue != null)
                                    self.data.extend({ max: maxValue });
                            }
                            if (validationScript != null) {
                                self.data.extend({
                                        validation: {
                                            validator: function (val) {
                                                var event = {};
                                                event.value = val;
                                                return eval(validationScript);
                                            },
                                            message: 'Invalid value'
                                        }
                                    });
                            }
                            break;
                        default:

                    }
                };
            };

        documentField.fromDto = function (dto) {
            var item = new documentField().id(dto.id);
            item.name(dto.name)
                .documentId(dto.documentId)
                .recipientId(dto.recipientId)
                .order(dto.order)
                .regularExpression(dto.regularExpression)
                .getDataFrom(dto.getDataFrom)
                .data(utils.decodeUtf8(dto.data==null?[]:dto.data))
                .fillTimeStamp(dto.fillTimeStamp)
                .fieldType(dto.fieldType)
                .acceptableValuesArray(dto.acceptableValues!=null ? dto.acceptableValues.split(';') : [])
                .defaultValue(dto.defaultValue)
                .tooltip(dto.tooltip)
                .guidanceText(dto.guidanceText)
                .groupName(dto.groupName)
            ;
            if (dto.mandatory != null) item.mandatory(dto.mandatory);
            if (dto.lockDuringSign != null) item.lockDuringSign(dto.lockDuringSign);

            var locations = _.map(dto.locations, function (dtoLocation) {
                var location = documentFieldLocation.fromDto(dtoLocation);
                utils.ensureValidFieldWidthAndHeight(location, dto.fieldType);
                return location;
            });

            if (dto.fieldType == config.signatureFieldType.SingleLine || item.fieldType() == config.signatureFieldType.MultiLine || item.fieldType() == config.signatureFieldType.Date) {
                //item.data.extend({ defaultIfNull: item.defaultValue() });
                item.data(item.defaultValue());
            }

            ko.validation.group(item);
            item.locations(locations);
            item.prepareSettings(dto.fieldType, dto.settings);
            item.dirtyFlag().reset();
            return item;
        };
        documentField.blank = function () {
            var item = new documentField()
                .fieldType(config.signatureFieldType.Signature)
                .data('')
                .name("Signature")
                .id('')
                .settings({ matchHeight: ko.observable(true) })
                .defaultValue('')
                .mandatory(true);
            item.locations.push(new documentFieldLocation()
                .page(1)
                .locationY(0.300)
                .locationX(0.400)
                .locationWidth(200)
                .locationHeight(66)
                .selected(true)
            );
            var validators = {};
            validators.required = { message: (item.tooltip() != '' ? item.tooltip() : item.name()) + " - " + config.validationMessages.requiredNoStar };
            item.data.extend(validators);
            ko.validation.group(item);
            return item;
        };
        documentField.getDtoId = function (dto) { return dto.id; };
        return documentField;
    });
define('core/model/model.document.fieldlocation',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            documentFieldLocation = function () {
                var self = this;
                self.id = ko.observable('');
                self.documentId = ko.observable('');
                self.fieldId = ko.observable('');
                self.page = ko.observable('');
                self.locationX = ko.observable('');
                self.locationY = ko.observable('');
                self.locationWidth = ko.observable('');
                self.locationHeight = ko.observable('');
                self.fontName = ko.observable('');
                self.fontColor = ko.observable('');
                self.fontSize = ko.observable('');
                self.fontBold = ko.observable(false);
                self.fontItalic = ko.observable(false);
                self.fontUnderline = ko.observable(false);
                self.align = ko.observable(0);
                self.order = ko.observable(0);
                self.selected = ko.observable(false);
                self.dirtyFlag = new ko.DirtyFlag([self.fontName, self.fontColor, self.fontSize, self.fontBold, self.fontItalic, self.fontUnderline, self.align]);
            };

        documentFieldLocation.fromDto = function (dto) {
            var item = new documentFieldLocation().id(dto.id);
            item.documentId(dto.documentId)
                .fieldId(dto.fieldId)
                .page(dto.page)
                .locationX(dto.locationX)
                .locationY(dto.locationY)
                .locationWidth(dto.locationWidth)
                .locationHeight(dto.locationHeight)
                .fontName(dto.fontName)
                .fontColor(dto.fontColor)
                .fontSize(dto.fontSize)
                .fontBold(dto.fontBold)
                .fontItalic(dto.fontItalic)
                .fontUnderline(dto.fontUnderline)
                .align(dto.align)
                .order(dto.order);
            item.dirtyFlag().reset();
            return item;
        };
        documentFieldLocation.blank = function () {
            var item = new documentFieldLocation();
            return item;
        };
        documentFieldLocation.getDtoId = function (dto) { return dto.id; };
        return documentFieldLocation;
    });
define('core/model/model.document.recipient',
    ['ko',
    'core/config',
    'core/utils'
    ],
    function (ko, config,utils) {
        var
            documentRecipient = function () {
                var self = this;
                self.id = ko.observable();
                self.firstName = ko.observable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'First name too long' } });
                self.lastName = ko.observable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'Last name too long' } });
                self.fullName = ko.computed(function () {
                    return self.firstName() + ' ' + self.lastName();
                }, self);
                self.email = ko.observable().extend({ required: { message: config.validationMessages.required }, email: { message: config.validationMessages.invalidEmail }, noSpaces: {} });
                self.userGuid = ko.observable();
                self.order = ko.observable();
                self.roleId = ko.observable();                
                self.status = ko.observable();
                self.statusMessage = ko.observable();                
                self.statusDateTime = ko.observable();
                self.delegatedRecipientId = ko.observable();
                self.signatureFingerprint = ko.observable();
                self.signatureHost = ko.observable();
                self.signatureLocation = ko.observable();
                self.signatureBrowser = ko.observable();
                self.comment = ko.observable();
                self.role = ko.computed(function () {
                    if (self.roleId() == 1)
                        return "Owner";
                    else if (self.roleId() == 2)
                        return "Signer";
                    else
                        return "CC";
                }, self);
                self.statusText = ko.computed(function () {
                    try {
                        var status = '';
                        var statusDate = '';
                        var statusComment = '';
                        if (self.status() != 0) {
                            $.each(config.documentRecipientStatus, function(i, elem) {
                                if (elem.id == self.status())
                                    status = "<p>" + elem.name;
                            });

                            statusDate = ": " + utils.dateFromIso(self.statusDateTime()) + "</p>";
                            if (self.comment() != '') statusComment = "<p>Comment: " + self.comment() + "</p>";
                        }
                        return "<p>" + self.role() + "</p>" + status  + statusDate + statusComment;
                    } catch (ex) {
                        return "";
                    }
                }, self);
                self.statusCss = ko.computed(function() {
                    switch (self.status()) {
                        case -2:
                            return "sig_state_icon expired";
                        case 0:
                            return "sig_state_icon draft";
                        case 1:
                            return "sig_state_icon inprogress";
                        case 2:
                            return "sig_state_icon inprogress";
                        case 3:
                            return "sig_state_icon canceled";
                        case 4:
                            return "sig_state_icon completed";
                    }
                    return "";

                });
                self.dirtyFlag = ko.DirtyFlag([]);
            };

        documentRecipient.fromDto = function (dto) {
            var item = new documentRecipient().id(dto.id);

            item.firstName(dto.firstName)
                .lastName(dto.lastName)
                .email(dto.email)
                .userGuid(dto.userGuid)
                .order(dto.order)
                .roleId(dto.roleId)
                .status(dto.status)
                .statusMessage(dto.statusMessage)
                .statusDateTime(dto.statusDateTime)
                .delegatedRecipientId(dto.delegatedRecipientId)
                .signatureFingerprint(dto.signatureFingerprint)
                .signatureHost(dto.signatureHost)
                .signatureLocation(dto.signatureLocation)
                .signatureBrowser(dto.signatureBrowser)
                .comment(dto.comment);
            ko.validation.group(item);
            return item;
        };
        documentRecipient.blank = function () {
            var item = new documentRecipient();
            ko.validation.group(item);
            return item;
        };
        documentRecipient.getDtoId = function (dto) { return dto.id; };
        
        return documentRecipient;
});
define('core/model/model.envelope.document',
    ['ko', 'core/config'],
    function (ko, config) {
        var
            envelopeDocument = function () {
                var self = this;
                self.documentId = ko.observable();
                self.envelopeId = ko.observable();
                self.order = ko.observable();
                self.name = ko.observable();
                self.originalDocumentMD5 = ko.observable();
                self.finalDocumentMD5 = ko.observable();
                self.originalDocumentPagesCount = ko.observable();
                self.fieldsCount = ko.observable();
                self.originalDocumentImportedFields = ko.observableArray();
                self.totalPages = ko.computed(function () {
                    return "(Total pages: " + self.originalDocumentPagesCount() + ")";
                }, self);
                self.originalDocumentId = ko.observable();
                self.fields = ko.observableArray();
                self.shortName = ko.computed(function () {
                    if (self.name() && self.name().length > 25)
                        return self.name().substring(0, 22) + "...";
                    else
                        return self.name();
                });
                self.viewedOnSign = ko.computed({
                    read: function () {
                        if (!config.checkHtml5StorageSupport() || self.documentId()==null) return true;
                        try {
                            self.name(); // to force re-evaluate when call name.notifySubscribers()
                            return localStorage.getItem("envelope.document." + self.documentId()) != null;
                        } catch (e) {
                            return true;
                        };
                    },
                    write: function (value) {
                        if (config.checkHtml5StorageSupport()) {
                            try {
                                localStorage.setItem("envelope.document." + self.documentId(), value);
                            } catch (e) {
                                localStorage.clear();
                            }
                        }
                    },
                    owner: this
                });
            };

        envelopeDocument.fromDto = function (dto) {
            var item = new envelopeDocument().documentId(dto.documentId);
            item.envelopeId(dto.envelopeId)
                .order(dto.order)
                .name(dto.name)
                .originalDocumentMD5(dto.originalDocumentMD5)
                .finalDocumentMD5(dto.finalDocumentMD5)
                .originalDocumentPagesCount(dto.originalDocumentPagesCount)
                .fieldsCount(dto.fieldsCount)
                .originalDocumentId(dto.originalDocumentId);
            return item;
        };

        envelopeDocument.getDtoId = function (dto) { return dto.documentId; };

        return envelopeDocument;
    });
define('core/model/model.envelope.field',
    ['ko',
    'core/config',
    'core/utils',
    'core/model/model.envelope.fieldlocation'
    ],
    function (ko, config, utils, envelopeFieldLocation) {
        var
            envelopeField = function () {
                var self = this;
                self.id = ko.observable('');
                self.envelopeId = ko.observable('');
                self.recipientId = ko.observable('');
                self.name = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } });
                self.mandatory = ko.observable(false);
                self.order = ko.observable('');
                self.regularExpression = ko.escapedObservable('');
                self.getDataFrom = ko.observable('');
                self.data = ko.observable(null);
                self.fillTimeStamp = ko.observable('');
                self.signatureFieldId = ko.observable('');
                self.locations = ko.observableArray([]);
                self.fieldType = ko.observable('');
                self.acceptableValuesArray = ko.observableArray([]);
                self.defaultValue = ko.escapedObservable(null);
                self.tooltip = ko.escapedObservable('');
                self.guidanceText = ko.escapedObservable('');
                self.groupName = ko.escapedObservable('');
                self.settings = ko.observable();
                self.lockDuringSign = ko.observable(true);
                self.progress = ko.observable(0);
                self.templateName = ko.computed(function() {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "signature-field-template";
                        case config.signatureFieldType.SingleLine:
                            return "singleline-field-template";
                        case config.signatureFieldType.MultiLine:
                            return "multiline-field-template";
                        case config.signatureFieldType.Date:
                            return "date-field-template";
                        case config.signatureFieldType.Dropdown:
                            return "dropdown-field-template";
                        case config.signatureFieldType.Checkbox:
                            return "checkbox-field-template";
                        case config.signatureFieldType.File:
                            return "file-field-template";
                        case config.signatureFieldType.Stamp:
                            return "stamp-field-template";
                    }
                    return "";
                });
                self.fieldTypeText = ko.computed(function () {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "Signature";
                        case config.signatureFieldType.SingleLine:
                            return "Single line text field";
                        case config.signatureFieldType.MultiLine:
                            return "Multi line text field";
                        case config.signatureFieldType.Date:
                            return "Date";
                        case config.signatureFieldType.Dropdown:
                            return "Dropdown";
                        case config.signatureFieldType.Checkbox:
                            return "Checkbox";
                        case config.signatureFieldType.File:
                            return "File";
                        case config.signatureFieldType.Stamp:
                            return "Stamp";
                    }
                    return "";
                });
                self.acceptableValues = ko.computed(function () {
                    return self.acceptableValuesArray().join(";");
                });
                //self.dirtyFlag = new ko.DirtyFlag([self.name, self.regularExpression, self.acceptableValuesArray, self.defaultValue, self.tooltip]);
                self.dirtyFlag = new ko.DirtyFlag([self.name, self.defaultValue, self.tooltip, self.acceptableValues, self.guidanceText, self.recipientId, self.groupName, self.mandatory, self.regularExpression, self.settings, self.lockDuringSign]);
                
                self.prepareSettings = function (filedType, settingsJson) {
                    if (settingsJson == undefined)
                        settingsJson = {};
                    switch (filedType) {
                        case config.signatureFieldType.Date:
                            var dateSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                showMonthYearDropdowns: ko.observable(dateSettings != null && dateSettings.showMonthYearDropdowns != null ? dateSettings.showMonthYearDropdowns : true),
                                minYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.minYear : new Date().getFullYear() - 99).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                maxYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.maxYear : new Date().getFullYear() + 30).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                dateFormat: ko.observable(dateSettings != null && dateSettings.dateFormat != null ? dateSettings.dateFormat : "dd.mm.yy")
                            });
                            ko.validation.group(self.settings);
                            break;
                        case config.signatureFieldType.Signature:
                            var signatureSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                matchWidth: ko.observable(signatureSettings != null && signatureSettings.matchWidth != null ? signatureSettings.matchWidth : false),
                                matchHeight: ko.observable(signatureSettings != null && signatureSettings.matchHeight != null ? signatureSettings.matchHeight : true)
                            });

                            break;
                        case config.signatureFieldType.Checkbox:
                            var checkboxSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                checkboxBorder: ko.observable(checkboxSettings != null && checkboxSettings.checkboxBorder != null ? checkboxSettings.checkboxBorder : true),
                            });
                            break;
                        default:

                    }
                };
            };

        envelopeField.fromDto = function (dto) {
            var item = new envelopeField().id(dto.id);
            item.name(dto.name)
                .envelopeId(dto.envelopeId)
                .recipientId(dto.recipientId)
                .order(dto.order)
                .regularExpression(dto.regularExpression)
                .getDataFrom(dto.getDataFrom)
                .data(utils.decodeUtf8(dto.data==null?[]:dto.data))
                .fillTimeStamp(dto.fillTimeStamp)
                .fieldType(dto.fieldType)
                .acceptableValuesArray(dto.acceptableValues!=null ? dto.acceptableValues.split(';') : [])
                .defaultValue(dto.defaultValue)
                .tooltip(dto.tooltip)
                .guidanceText(dto.guidanceText)
                .groupName(dto.groupName)
            ;
            if (dto.mandatory != null) item.mandatory(dto.mandatory);
            if (dto.lockDuringSign != null) item.lockDuringSign(dto.lockDuringSign);

            var locations = _.map(dto.locations, function (dtoLocation) {
                var location = envelopeFieldLocation.fromDto(dtoLocation);
                utils.ensureValidFieldWidthAndHeight(location, dto.fieldType);
                return location;
            });

            if (dto.fieldType == config.signatureFieldType.SingleLine || item.fieldType() == config.signatureFieldType.MultiLine || item.fieldType() == config.signatureFieldType.Date)
                item.data.extend({ defaultIfNull: item.defaultValue() });
            
            ko.validation.group(item);
            item.locations(locations);
            item.prepareSettings(dto.fieldType, dto.settings);
            item.dirtyFlag().reset();
            item.fieldType.subscribe(function (newValue) {
                item.prepareSettings(newValue);
            });
            return item;
        };
        envelopeField.blank = function () {
            var item = new envelopeField();
            ko.validation.group(item);
            return item;
        };
        envelopeField.getDtoId = function (dto) { return dto.id; };
        return envelopeField;
    });
define('core/model/model.envelope.fieldlocation',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            envelopeFieldLocation = function () {
                var self = this;
                self.id = ko.observable('');
                self.documentId = ko.observable('');
                self.fieldId = ko.observable('');
                self.page = ko.observable('');
                self.locationX = ko.observable('');
                self.locationY = ko.observable('');
                self.locationWidth = ko.observable('');
                self.locationHeight = ko.observable('');
                self.fontName = ko.observable('');
                self.fontColor = ko.observable('');
                self.fontSize = ko.observable('');
                self.fontBold = ko.observable(false);
                self.fontItalic = ko.observable(false);
                self.fontUnderline = ko.observable(false);
                self.align = ko.observable(0);
                self.order = ko.observable(0);
                self.selected = ko.observable(false);
                self.dirtyFlag = new ko.DirtyFlag([self.fontName, self.fontColor, self.fontSize, self.fontBold, self.fontItalic, self.fontUnderline, self.align]);
            };

        envelopeFieldLocation.fromDto = function (dto) {
            var item = new envelopeFieldLocation().id(dto.id);
            item.documentId(dto.documentId)
                .fieldId(dto.fieldId)
                .page(dto.page)
                .locationX(dto.locationX)
                .locationY(dto.locationY)
                .locationWidth(dto.locationWidth)
                .locationHeight(dto.locationHeight)
                .fontName(dto.fontName)
                .fontColor(dto.fontColor)
                .fontSize(dto.fontSize)
                .fontBold(dto.fontBold)
                .fontItalic(dto.fontItalic)
                .fontUnderline(dto.fontUnderline)
                .align(dto.align)
                .order(dto.order);
            item.dirtyFlag().reset();
            return item;
        };
        envelopeFieldLocation.blank = function () {
            var item = new envelopeFieldLocation();
            return item;
        };
        envelopeFieldLocation.getDtoId = function (dto) { return dto.id; };
        return envelopeFieldLocation;
    });
define('core/model/model.envelope',
    ['ko',
     'lib/underscore',
     'core/utils',
     'core/config',
     'core/model/model.envelope.recipient'],
    function (ko, _, utils, config, envelopeRecipient) {
        var
            envelope = function () {
                var self = this;
                self.id = ko.observable();
                self.name = ko.escapedObservable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 255, message: 'Name too long' } });
                self.creationDateTime = ko.observable();
                self.updatedDateTime = ko.observable();
                self.ownerGuid = ko.observable();
                self.status = ko.observable();
                self.statusDateTime = ko.observable();
                self.reminderTime = ko.observable().extend({
                    require: true,
                    pattern: {
                        message: 'Invalid reminder time',
                        params: '^[0-9]$'
                    }
                });
                self.stepExpireTime = ko.observable().extend({
                    require: true,
                    pattern: {
                        message: 'Invalid step expire time',
                        params: '^[0-9]$'
                    }
                });
                self.envelopeExpireTime = ko.observable().extend({
                    require: true,
                    pattern: {
                        message: 'Invalid envelope expire time',
                        params: '^[0-9]$'
                    }
                });
                self.ownerShouldSign = ko.observable();
                self.orderedSignature = ko.observable();
                self.emailSubject = ko.escapedObservable();
                self.emailBody = ko.escapedObservable();
                self.documentsCount = ko.observable();
                self.documentsPages = ko.observable();
                self.recipients = ko.observableArray([]);
                self.waterMarkText = ko.escapedObservable().extend({ maxLength: { params: 255, message: 'Text too long' } });
                self.waterMarkImage = ko.observable();
                self.attachSignedDocument = ko.observable();
                self.includeViewLink = ko.observable();
                self.canBeCommented = ko.observable();
                self.inPersonSign = ko.observable();
                self.selected = ko.observable(false);
                self.ownerName = ko.observable();
                self.enableTypedSignature = ko.observable();
                self.enableUploadedSignature = ko.observable();
                self.requireUserAuthForSign = ko.observable(false);
                self.requestUserAuthByPhoto = ko.observable(false);
                self.showRecipientCommentInSignedDocument = ko.observable(false);
                self.tags = ko.observable("");
                self.documentNames = ko.observable('');
                self.createdOnFormatted = ko.computed(function () {
                    try {
                        return utils.dateFromIso(self.creationDateTime());
                    } catch (ex) {
                        return "---";
                    }
                });
                self.updatedOnFormatted = ko.computed(function () {
                    try {
                        return utils.dateFromIso(self.updatedDateTime());
                    } catch (ex) {
                        return "---";
                    }
                });
                self.statusCss = ko.computed(function () {
                    switch (self.status()) {
                        case -1:
                            return "sig_state_icon draft";
                        case 0:
                            return "sig_state_icon draft";
                        case 1:
                            return "sig_state_icon inprogress";
                        case 2:
                            return "sig_state_icon expired";
                        case 3:
                            return "sig_state_icon canceled";
                        case 4:
                            return "sig_state_icon failed";
                        case 5:
                            return "sig_state_icon completed";
                        case 6:
                            return "sig_state_icon archived";
                        case 99:
                            return "sig_state_icon inprogress";
                    }
                    return "";
                });
                self.statusTextCss = ko.computed(function () {
                    switch (self.status()) {
                        case -1:
                            return "sig_state_text draft";
                        case 0:
                            return "sig_state_text draft";
                        case 1:
                        case 99:
                            return "sig_state_text pending";
                        case 2:
                            return "sig_state_text failed";
                        case 3:
                            return "sig_state_text failed";
                        case 4:
                            return "sig_state_text failed";
                        case 5:
                            return "sig_state_text completed";
                        case 6:
                            return "sig_state_text archived";
                    }
                    return "";
                });
                self.expirationDate = ko.computed(function () {
                    try {
                        var today = new Date();
                        var expiration = new Date(today.getTime() + self.envelopeExpireTime() * 24 * 60 * 60 * 1000);
                        return expiration.format("dd mmm yyyy");
                    } catch(ex) {
                        return "";
                    }
                });
                self.reminderDate = ko.computed(function() {
                    try {
                        var today = new Date();
                        var expiration = new Date(today.getTime() + self.reminderTime() * 24 * 60 * 60 * 1000);
                        return expiration.format("dd mmm yyyy");
                    } catch(ex) {
                        return "";
                    }
                });
                self.stepExpireDate = ko.computed(function() {
                    try {
                        var today = new Date();
                        var expiration = new Date(today.getTime() + self.stepExpireTime() * 24 * 60 * 60 * 1000);
                        return expiration.format("dd mmm yyyy");
                    } catch (ex) {
                        return "";
                    }
                });
                self.isOwner = ko.computed(function() {
                    try {
                        return self.ownerGuid() == config.userId();
                    } catch (ex) {
                        return false;
                    }
                });
                self.dirtyFlagInfo = new ko.DirtyFlag([
                    self.name,
                    self.emailSubject,
                    self.emailBody,
                    self.orderedSignature,
                    self.attachSignedDocument,
                    self.includeViewLink,
                    self.enableTypedSignature,
                    self.enableUploadedSignature,
                    self.requireUserAuthForSign,
                    self.requestUserAuthByPhoto,
                    self.showRecipientCommentInSignedDocument,
                    self.tags
                ]);
                self.dirtyFlagReminders = new ko.DirtyFlag([self.reminderTime, self.stepExpireTime, self.envelopeExpireTime]);
            };

        envelope.fromDto = function(dto) {
            var item = new envelope().id(dto.id);

            item.name(dto.name)
                .creationDateTime(dto.creationDateTime)
                .updatedDateTime(dto.updatedDateTime)
                .ownerGuid(dto.ownerGuid)
                .status(dto.status)
                .statusDateTime(dto.statusDateTime)
                .reminderTime(dto.reminderTime)
                .stepExpireTime(dto.stepExpireTime)
                .envelopeExpireTime(dto.envelopeExpireTime)
                .ownerShouldSign(dto.ownerShouldSign)
                .orderedSignature(dto.orderedSignature)
                .emailSubject(dto.emailSubject)
                .emailBody(dto.emailBody)
                .documentsCount(dto.documentsCount)
                .documentsPages(dto.documentsPages)
                .recipients(dto.recipients)
                .waterMarkText(dto.waterMarkText)
                .waterMarkImage(dto.waterMarkImage)
                .attachSignedDocument(dto.attachSignedDocument)
                .includeViewLink(dto.includeViewLink)
                .canBeCommented(dto.canBeCommented)
                .inPersonSign(dto.inPersonSign)
                .ownerName(dto.ownerName)
                .enableTypedSignature(dto.enableTypedSignature)
                .enableUploadedSignature(dto.enableUploadedSignature)
                .requireUserAuthForSign(dto.requireUserAuthForSign)
                .requestUserAuthByPhoto(dto.requestUserAuthByPhoto)
                .showRecipientCommentInSignedDocument(dto.showRecipientCommentInSignedDocument)
                .tags(dto.tags)
            ;

            var recipients = _.map(dto.recipients, function(dtoRecipient) {
                return envelopeRecipient.fromDto(dtoRecipient);
            });
            item.recipients(recipients);
            ko.validation.group(item);
            item.dirtyFlagInfo().reset();
            item.dirtyFlagReminders().reset();
            return item;
        };

        envelope.getDtoId = function(dto) { return dto.id; };

        return envelope;
    });
define('core/model/model.envelope.recipient',
    ['ko',
    'core/config',
    'core/utils'
    ],
    function (ko, config,utils) {
        var
            envelopeRecipient = function () {
                var self = this;
                self.id = ko.observable();
                self.firstName = ko.observable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'First name too long' } });
                self.lastName = ko.observable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'Last name too long' } });
                self.fullName = ko.computed(function () {
                    return self.firstName() + ' ' + self.lastName();
                }, self);
                self.email = ko.observable().extend({ required: { message: config.validationMessages.required }, email: { message: config.validationMessages.invalidEmail }, noSpaces: {} });
                self.userGuid = ko.observable();
                self.order = ko.observable();
                self.roleId = ko.observable();                
                self.status = ko.observable();
                self.statusMessage = ko.observable();                
                self.statusDateTime = ko.observable();
                self.delegatedRecipientId = ko.observable();
                self.signatureFingerprint = ko.observable();
                self.signatureHost = ko.observable();
                self.signatureLocation = ko.observable();
                self.signatureBrowser = ko.observable();
                self.comment = ko.observable();
                self.role = ko.computed(function () {
                    if (self.roleId() == 1)
                        return "Owner";
                    else if (self.roleId() == 2)
                        return "Signer";
                    else
                        return "CC";
                }, self);
                self.statusText = ko.computed(function () {
                    try {
                        var status = '';
                        var statusDate = '';
                        var statusComment = '';
                        if (self.status() != 0) {
                            $.each(config.envelopeRecipientStatus, function(i, elem) {
                                if (elem.id == self.status())
                                    status = "<p>" + elem.name;
                            });

                            statusDate = ": " + utils.dateFromIso(self.statusDateTime()) + "</p>";
                            if (self.comment() != '' && self.status()==4) statusComment = "<p>Comment: " + self.comment() + "</p>";
                        }
                        return "<p>" + self.role() + "</p>" + status  + statusDate + statusComment;
                    } catch (ex) {
                        return "";
                    }
                }, self);
                self.statusCss = ko.computed(function() {
                    switch (self.status()) {
                        case -2:
                            return "sig_state_icon expired";
                        case 0:
                            return "sig_state_icon draft";
                        case 1:
                            return "sig_state_icon inprogress";
                        case 2:
                            return "sig_state_icon inprogress";
                        case 3:
                            return "sig_state_icon canceled";
                        case 4:
                            return "sig_state_icon completed";
                    }
                    return "";

                });
                self.dirtyFlag = ko.DirtyFlag([]);
            };

        envelopeRecipient.fromDto = function (dto) {
            var item = new envelopeRecipient().id(dto.id);

            item.firstName(dto.firstName)
                .lastName(dto.lastName)
                .email(dto.email)
                .userGuid(dto.userGuid)
                .order(dto.order)
                .roleId(dto.roleId)
                .status(dto.status)
                .statusMessage(dto.statusMessage)
                .statusDateTime(dto.statusDateTime)
                .delegatedRecipientId(dto.delegatedRecipientId)
                .signatureFingerprint(dto.signatureFingerprint)
                .signatureHost(dto.signatureHost)
                .signatureLocation(dto.signatureLocation)
                .signatureBrowser(dto.signatureBrowser)
                .comment(dto.comment);
            ko.validation.group(item);
            return item;
        };
        
        envelopeRecipient.getDtoId = function (dto) { return dto.id; };
        
        return envelopeRecipient;
});
define('core/model/model.envelope.resource',
    ['ko',
     'lib/underscore',
     'core/utils',
     'core/model/model.envelope.recipient',
     'core/model/model.envelope.document'],
    function (ko, _, utils, envelopeRecipient, envelopeDocument) {
        var
            envelopeResource = function () {
                var self = this;
                self.dates = ko.observableArray();
                self.documents = ko.observableArray();
                self.recipients = ko.observableArray();
                self.tags = ko.observableArray();
                self.statuses = ko.observableArray([
                    { name: ko.observable("Show All"), value: "-6" },
                    { name: ko.observable("Draft"), value: "-1" },
                    { name: ko.observable("Pending"), value: "1" },
                    { name: ko.observable("Expired"), value: "2" },
                    { name: ko.observable("Completed"), value: "5" }
                ]);
            };

        envelopeResource.fromDto = function (dto) {
            var item = new envelopeResource();
            var dates = _.map(dto.dates, function (dtoDocument) {
                var dateArray = dtoDocument.substring(0, dtoDocument.indexOf('T')).split('-');
                var date = new Date(dateArray[0], dateArray[1] - 1, dateArray[2]);
                return { name: ko.observable(date.format("mmm dd, yyyy")), value: dtoDocument };
                //return { name: ko.observable(new Date(Date.parse(dtoDocument.substring(0, dtoDocument.indexOf('T')))).format("mmm dd, yyyy")), value: dtoDocument };
            });
            dates.unshift({ name: ko.observable("All Time") });
            item.dates(dates);
            var documents = _.map(dto.documents, function (dtoDocument) {
                return envelopeDocument.fromDto(dtoDocument);
            });
            documents.unshift({ name: ko.observable("Documents"), shortName: ko.observable("Documents") });
            item.documents(documents);
            var recipients = _.map(dto.recipients, function (dtoRecipient) {
                return envelopeRecipient.fromDto(dtoRecipient);
            });
            recipients.unshift({ fullName: ko.observable("Parties") });
            item.recipients(recipients);

            var tags = _.map(dto.tags, function (dtoTag) {
                return { name: ko.observable(dtoTag), value: dtoTag };
            });
            tags.unshift({ name: ko.observable("All Tags") });
            item.tags(tags);
            return item;
        };

        return envelopeResource;
    });
define('core/model/model.field',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            field = function () {
                var self = this;
                self.id = ko.observable('');
                self.name = ko.observable('');
                self.graphSizeW = ko.observable('');
                self.graphSizeH = ko.observable('');
                self.getDataFrom = ko.observable('');
                self.regularExpression = ko.observable('');
                self.fontName = ko.observable('');
                self.fontColor = ko.observable('');
                self.fontSize = ko.observable('');
                self.fontBold = ko.observable('');
                self.fontItalic = ko.observable('');
                self.fontUnderline = ko.observable('');
                self.isSystem = ko.observable('');
                self.fieldType = ko.observable('');
                self.acceptableValues = ko.observable('');
                self.defaultValue = ko.observable('');
                self.align = ko.observable('');
                self.minGraphSizeH = ko.observable(0);
                self.minGraphSizeW = ko.observable(0);
                self.buttonCss = ko.computed(function () {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "field_button sig_field";
                        case config.signatureFieldType.SingleLine:
                            return "field_button singline_field";
                        case config.signatureFieldType.MultiLine:
                            return "field_button multiline_field";
                        case config.signatureFieldType.Date:
                            return "field_button date_field";
                        case config.signatureFieldType.Dropdown:
                            return "field_button dropdown_field";
                        case config.signatureFieldType.Checkbox:
                            return "field_button checkbox_field";
                        case config.signatureFieldType.File:
                            return "field_button file_field";
                        case config.signatureFieldType.Stamp:
                            return "field_button stamp_field";
                    }
                    return "";
                });
                self.dragText = ko.computed(function() {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "Place Signature";
                        case config.signatureFieldType.SingleLine:
                            return "Place Single Line";
                        case config.signatureFieldType.MultiLine:
                            return "Place Multiline Text";
                        case config.signatureFieldType.Date:
                            return "Place Date";
                        case config.signatureFieldType.Dropdown:
                            return "Place Dropdown";
                        case config.signatureFieldType.Checkbox:
                            return "Place Checkbox";
                        case config.signatureFieldType.File:
                            return "Place File";
                        case config.signatureFieldType.Stamp:
                            return "Place Stamp";
                    }
                    return "";
                });
            };

        field.fromDto = function (dto) {
            var item = new field().id(dto.id);

            item.name(dto.name)
                .graphSizeW(dto.graphSizeW)
                .graphSizeH(dto.graphSizeH)
                .getDataFrom(dto.getDataFrom)
                .regularExpression(dto.regularExpression)
                .fontName(dto.fontName)
                .fontColor(dto.fontColor)
                .fontSize(dto.fontSize)
                .fontBold(dto.fontBold)
                .fontItalic(dto.fontItalic)
                .fontUnderline(dto.fontUnderline)
                .isSystem(dto.isSystem)
                .fieldType(dto.fieldType)
                .acceptableValues(dto.acceptableValues)
                .defaultValue(dto.defaultValue)
                .align(dto.align)
                .minGraphSizeW(dto.minGraphSizeW)
                .minGraphSizeH(dto.minGraphSizeH);

            return item;
        };
        field.blank = function () {
            var item = new field();
            return item;
        };
        field.getDtoId = function (dto) { return dto.id; };
        return field;
    });
define('core/model/model.form.document',
    ['ko', 'core/config'],
    function (ko, config) {
        var
            formDocument = function () {
                var self = this;
                self.id = ko.observable();
                self.name = ko.observable();
                self.formGuid = ko.observable();
                self.documentGuid = ko.observable();
                self.originalDocumentGuid = ko.observable();
                self.originalDocumentMD5 = ko.observable();
                self.assignedDateTime = ko.observable();
                self.order = ko.observable();
                self.shortName = ko.computed(function() {
                    if (self.name() && self.name().length > 25)
                        return self.name().substring(0, 22) + "...";
                    else
                        return self.name();
                });
                self.viewedOnSign = ko.computed({
                    read: function () {
                        if (!config.checkHtml5StorageSupport() || self.documentGuid() == null) return true;
                        try {
                            self.name(); // to force re-evaluate when call name.notifySubscribers()
                            return localStorage.getItem("form.document." + self.documentGuid()) != null;
                        } catch (e) {
                            return true;
                        };
                    },
                    write: function (value) {
                        if (config.checkHtml5StorageSupport()) {
                            try {
                                localStorage.setItem("form.document." + self.documentGuid(), value);
                            } catch (e) {
                                localStorage.clear();
                            }
                        }
                    },
                    owner: this
                });
            };

        formDocument.fromDto = function (dto) {
            var item = new formDocument().id(dto.id);

            item.name(dto.name)
                .formGuid(dto.formGuid)
                .name(dto.name)
                .documentGuid(dto.documentGuid)
                .originalDocumentGuid(dto.originalDocumentGuid)
                .originalDocumentMD5(dto.originalDocumentMD5)
                .assignedDateTime(dto.assignedDateTime)
                .order(dto.order);
            return item;
        };

        formDocument.getDtoId = function (dto) { return dto.documentId; };

        return formDocument;
    });
define('core/model/model.form.field',
    ['ko',
    'core/config',
    'core/utils',
    'core/model/model.form.fieldlocation'
    ],
    function (ko, config, utils, formFieldLocation) {
        var
            formField = function () {
                var self = this;
                self.id = ko.observable('');
                self.formGuid = ko.observable('');
                self.participantGuid = ko.observable('');
                self.name = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } });
                self.mandatory = ko.observable('');
                self.regularExpression = ko.observable('');
                self.data = ko.observable('');
                self.fillTimeStamp = ko.observable('');
                self.locations = ko.observableArray([]);
                self.fieldType = ko.observable('');
                self.acceptableValuesArray = ko.observableArray([]);//keep the same as envelope fields, dto name is acceptableValues
                self.defaultValue = ko.escapedObservable('');
                self.tooltip = ko.escapedObservable('');
                self.guidanceText = ko.escapedObservable('');
                self.groupName = ko.escapedObservable('');
                self.settings = ko.observable();
                self.progress = ko.observable(0);
                self.lockDuringSign = ko.observable(true);
                self.templateName = ko.computed(function() {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "signature-field-template";
                        case config.signatureFieldType.SingleLine:
                            return "singleline-field-template";
                        case config.signatureFieldType.MultiLine:
                            return "multiline-field-template";
                        case config.signatureFieldType.Date:
                            return "date-field-template";
                        case config.signatureFieldType.Dropdown:
                            return "dropdown-field-template";
                        case config.signatureFieldType.Checkbox:
                            return "checkbox-field-template";
                        case config.signatureFieldType.File:
                            return "file-field-template";
                        case config.signatureFieldType.Stamp:
                            return "stamp-field-template";
                    }
                    return "";
                });
                self.labelText = ko.computed(function () {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "Signature";
                        case config.signatureFieldType.SingleLine:
                            return "Single line";
                        case config.signatureFieldType.MultiLine:
                            return "Multi line";
                        case config.signatureFieldType.Date:
                            return "Date";
                        case config.signatureFieldType.Dropdown:
                            return "Drop-down";
                        case config.signatureFieldType.Checkbox:
                            return "Checkbox";
                        case config.signatureFieldType.File:
                            return "File";
                        case config.signatureFieldType.Stamp:
                            return "Stamp";
                    }
                    return "";
                });
                self.acceptableValues = ko.computed(function () {
                    return self.acceptableValuesArray().join(";");
                });
                self.dirtyFlag = new ko.DirtyFlag([self.name, self.defaultValue, self.tooltip, self.acceptableValues, self.guidanceText, self.groupName, self.mandatory, self.regularExpression, self.settings]);

                self.prepareSettings = function (filedType, settingsJson) {
                    if (settingsJson == undefined)
                        settingsJson = {};
                    switch (filedType) {
                        case config.signatureFieldType.Date:
                            var dateSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                showMonthYearDropdowns: ko.observable(dateSettings != null && dateSettings.showMonthYearDropdowns != null ? dateSettings.showMonthYearDropdowns : true),
                                minYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.minYear : new Date().getFullYear() - 99).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                maxYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.maxYear : new Date().getFullYear() + 30).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                dateFormat: ko.observable(dateSettings != null && dateSettings.dateFormat != null ? dateSettings.dateFormat : "dd.mm.yy")
                            });
                            ko.validation.group(self.settings);
                            break;
                        case config.signatureFieldType.Signature:
                            var signatureSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                matchWidth: ko.observable(signatureSettings != null && signatureSettings.matchWidth != null ? signatureSettings.matchWidth : false),
                                matchHeight: ko.observable(signatureSettings != null && signatureSettings.matchHeight != null ? signatureSettings.matchHeight : true)
                            });
                        
                            break;
                        case config.signatureFieldType.Checkbox:
                            var checkboxSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                checkboxBorder: ko.observable(checkboxSettings != null && checkboxSettings.checkboxBorder != null ? checkboxSettings.checkboxBorder : true),
                            });
                            break;
                        default:
                      
                    }
                };
                
            };

        formField.fromDto = function (dto) {
            var item = new formField().id(dto.id);

            item.name(dto.name)
                .formGuid(dto.formGuid)
                .participantGuid(dto.participantGuid)
                .mandatory(dto.mandatory)
                .regularExpression(dto.regularExpression)
                .data(utils.decodeUtf8(dto.data==null?[]:dto.data))
                .fillTimeStamp(dto.fillTimeStamp)
                .fieldType(dto.fieldType)
                .acceptableValuesArray(dto.acceptableValues != null ? dto.acceptableValues.split(';') : [])
                .defaultValue(dto.defaultValue)
                .tooltip(dto.tooltip)
                .guidanceText(dto.guidanceText)
                .groupName(dto.groupName);

            var locations = _.map(dto.locations, function (dtoLocation) {
                var location = formFieldLocation.fromDto(dtoLocation);
                utils.ensureValidFieldWidthAndHeight(location, dto.fieldType);
                return location;
            });
            
            item.locations(locations);
            ko.validation.group(item);
            item.prepareSettings(dto.fieldType, dto.settings);
            item.dirtyFlag().reset();
            
            item.fieldType.subscribe(function(newValue) {
                item.prepareSettings(newValue);
            });
            return item;
        };
        formField.blank = function () {
            var item = new formField();
            ko.validation.group(item);
            return item;
        };
        formField.getDtoId = function (dto) { return dto.id; };
        return formField;
    });
define('core/model/model.form.fieldlocation',
    ['ko'],
    function (ko) {
        var
            formFieldLocation = function () {
                var self = this;
                self.id = ko.observable('');
                self.documentGuid = ko.observable('');
                self.fieldGuid = ko.observable('');
                self.page = ko.observable('');
                self.locationX = ko.observable('');
                self.locationY = ko.observable('');
                self.locationWidth = ko.observable('');
                self.locationHeight = ko.observable('');
                self.fontName = ko.observable('');
                self.fontColor = ko.observable('');
                self.fontSize = ko.observable('');
                self.fontBold = ko.observable(false);
                self.fontItalic = ko.observable(false);
                self.fontUnderline = ko.observable(false);
                self.align = ko.observable('');
                self.order = ko.observable(0);
                self.selected = ko.observable(false);
                self.dirtyFlag = new ko.DirtyFlag([self.fontName, self.fontColor, self.fontSize, self.fontBold, self.fontItalic, self.fontUnderline, self.align]);
            };

        formFieldLocation.fromDto = function (dto) {
            var item = new formFieldLocation().id(dto.id);
            item.documentGuid(dto.documentGuid)
                .fieldGuid(dto.fieldGuid)
                .page(dto.page)
                .locationX(dto.locationX)
                .locationY(dto.locationY)
                .locationWidth(dto.locationWidth)
                .locationHeight(dto.locationHeight)
                .fontName(dto.fontName)
                .fontColor(dto.fontColor)
                .fontSize(dto.fontSize)
                .fontBold(dto.fontBold)
                .fontItalic(dto.fontItalic)
                .fontUnderline(dto.fontUnderline)
                .align(dto.align)
                .order(dto.order);
            ;
            item.dirtyFlag().reset();
            return item;
        };
        formFieldLocation.blank = function () {
            var item = new formFieldLocation();
            return item;
        };
        formFieldLocation.getDtoId = function (dto) { return dto.id; };
        return formFieldLocation;
    });
define('core/model/model.form',
    ['ko',
     'lib/underscore',
     'core/config'],
    function (ko, _, config) {
        var
            form = function () {
                var self = this;
                self.id = ko.observable();
                self.name = ko.escapedObservable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 255, message: 'Name too long' } });
                self.createdTimeStamp = ko.observable();
                self.ownerGuid = ko.observable();
                self.templateGuid = ko.observable();
                self.status = ko.observable();
                self.statusDateTime = ko.observable();
                self.documentsCount = ko.observable();
                self.documentsPages = ko.observable();
                self.participantsCount = ko.observable();
                self.fieldsInFinalFileName = ko.observableArray([]);
                self.canParticipantDownloadForm = ko.observable();
                self.canParticipantPrintForm = ko.observable();
                self.waterMarkText = ko.escapedObservable().extend({ maxLength: { params: 255, message: 'Text too long' } });
                self.waterMarkImage = ko.observable();
                self.fieldsCount = ko.observable();
                self.selected = ko.observable(false);
                self.notifyOwnerOnSign = ko.observable(false);
                self.attachSignedDocument = ko.observable(false);
                self.requireUserAuthForSign = ko.observable(false);
                self.requestUserAuthByPhoto = ko.observable(false);
                self.enableTypedSignature = ko.observable();
                self.enableUploadedSignature = ko.observable();
                self.requireUserIdentityValidation = ko.observable();
                self.canBeCommented = ko.observable();
                self.showParticipantCommentInSignedDocument = ko.observable();
                self.tags = ko.observable("");
                self.parseFields = ko.observable(false);

                self.notifyOtherOnSign = ko.observable().extend({ pattern: { message: config.validationMessages.invalidEmail, params: /^(([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5}){1,25})+([;,.](([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5}){1,25})+)*$/ } });
                self.documentNames = ko.observable('');
                self.statusIconCss = ko.computed(function () {
                    switch (self.status()) {
                        case -1:
                            return "sig_state_icon draft";
                        case 1:
                            return "sig_state_icon inprogress";
                        case 2:
                            return "sig_state_icon completed";
                        case 3:
                            return "sig_state_icon archived";
                    }
                    return "";
                });
                self.statusText = ko.computed(function () {
                    switch (self.status()) {
                        case -1:
                            return "Draft";
                        case 1:
                            return "In progress";
                        case 2:
                            return "Completed";
                        case 3:
                            return "Archived";
                    }
                    return "";
                });
                self.statusTextCss = ko.computed(function () {
                    switch (self.status()) {
                        case -1:
                            return "sig_state_text draft";
                        case 1:
                            return "sig_state_text pending";
                        case 2:
                            return "sig_state_text completed";
                        case 3:
                            return "sig_state_text archived";
                    }
                    return "";
                });
                self.participantsSigned = ko.computed(function () {
                    return "Participants signed: " + self.participantsCount();
                });
                self.dirtyFlag = ko.DirtyFlag([
                    self.name, self.canParticipantDownloadForm, self.canParticipantPrintForm, self.waterMarkText,
                    self.notifyOwnerOnSign, self.attachSignedDocument, self.fieldsInFinalFileName, self.notifyOtherOnSign, self.requireUserAuthForSign, self.requestUserAuthByPhoto,
                    self.enableTypedSignature, self.enableUploadedSignature, self.requireUserIdentityValidation, self.showParticipantCommentInSignedDocument,
                    self.canBeCommented,
                    self.tags
                ]);
            };

        form.fromDto = function (dto) {
            var item = new form().id(dto.id);

            item.name(dto.name)
                .createdTimeStamp(dto.creationDateTime)
                .ownerGuid(dto.ownerGuid)
                .status(dto.status)
                .statusDateTime(dto.statusDateTime)
                .templateGuid(dto.templateGuid)
                .documentsCount(dto.documentsCount)
                .documentsPages(dto.documentsPages)
                .participantsCount(dto.participantsCount)
                .fieldsInFinalFileName(dto.fieldsInFinalFileName)
                .canParticipantDownloadForm(dto.canParticipantDownloadForm)
                .canParticipantPrintForm(dto.canParticipantPrintForm)
                .waterMarkText(dto.waterMarkText)
                .waterMarkImage(dto.waterMarkImage)
                .fieldsCount(dto.fieldsCount)
                .notifyOwnerOnSign(dto.notifyOwnerOnSign)
                .attachSignedDocument(dto.attachSignedDocument)
                .notifyOtherOnSign(dto.notifyOtherOnSign)
                .requireUserAuthForSign(dto.requireUserAuthForSign)
                .requestUserAuthByPhoto(dto.requestUserAuthByPhoto)
                .enableTypedSignature(dto.enableTypedSignature)
                .enableUploadedSignature(dto.enableUploadedSignature)
                .requireUserIdentityValidation(dto.requireUserIdentityValidation)
                .showParticipantCommentInSignedDocument(dto.showParticipantCommentInSignedDocument)
                .canBeCommented(dto.canBeCommented)
                .tags(dto.tags)
                .parseFields(dto.parseFields)
            ;

            ko.validation.group(item);
            item.dirtyFlag().reset();
            return item;
        };

        form.getDtoId = function (dto) { return dto.id; };

        return form;
    });
define('core/model/model.form.participant',
    ['ko','core/utils'],
    function (ko, utils) {
        var
            formParticipant = function () {
                var self = this;
                self.id = ko.observable();
                self.name = ko.observable();
                self.email = ko.observable();
                self.comment = ko.observable();
                self.fillDateTime = ko.observable();
                self.status = ko.observable();
                self.signedDocuments = ko.observableArray();
            };
        var formParticipantDocuments = function() {
            var self = this;
            self.documentGuid = ko.observable();
            self.name = ko.observable();
        };

        formParticipant.fromDto = function (dto) {
            var item = new formParticipant().id(dto.id);
            item.name(dto.name)
                .email(dto.email)
                .comment(dto.comment)
                .fillDateTime(dto.fillDateTime!=null ? utils.dateFromIso(dto.fillDateTime): null)
                .status(dto.status)
            ;
            var documents = _.map(dto.signedDocuments, function (dtoDocument) {
                var doc = new formParticipantDocuments();
                doc.documentGuid(dtoDocument.documentGuid)
                    .name(dtoDocument.name);
                return doc;
            });
            item.signedDocuments(documents);
            return item;
        };

        formParticipant.getDtoId = function (dto) { return dto.id; };
        return formParticipant;
    });
define('core/model/model.form.resource',
    ['ko',
     'lib/underscore',
     'core/utils',
     'core/model/model.form.document'],
    function (ko, _, utils, formDocument) {
        var
            formResource = function () {
                var self = this;
                self.dates = ko.observableArray();
                self.documents = ko.observableArray();
                self.tags = ko.observableArray();
                self.statuses = ko.observableArray([
                    { name: ko.observable("Show All"), value: "-6" },
                    { name: ko.observable("Draft"), value: "-1" },
                    { name: ko.observable("In progress"), value: "1" },
                    { name: ko.observable("Completed"), value: "2" }
                ]);
            };

        formResource.fromDto = function (dto) {
            var item = new formResource();
            var dates = _.map(dto.dates, function (dtoDocument) {
                var dateArray = dtoDocument.substring(0, dtoDocument.indexOf('T')).split('-');
                var date = new Date(dateArray[0], dateArray[1]-1, dateArray[2]);
                return { name: ko.observable(date.format("mmm dd, yyyy")), value: dtoDocument };
                //return { name: ko.observable(new Date(Date.parse(dtoDocument.substring(0, dtoDocument.indexOf('T')))).format("mmm dd, yyyy")), value: dtoDocument };
            });
            dates.unshift({ name: ko.observable("All Time") });
            item.dates(dates);
            var documents = _.map(dto.documents, function (dtoDocument) {
                return formDocument.fromDto(dtoDocument);
            });
            documents.unshift({ name: ko.observable("Documents"), shortName: ko.observable("Documents") });
            item.documents(documents);

            var tags = _.map(dto.tags, function (dtoTag) {
                return { name: ko.observable(dtoTag), value: dtoTag };
            });
            tags.unshift({ name: ko.observable("All Tags") });
            item.tags(tags);
            return item;
        };

        return formResource;
    });
define('core/model/model.predefinedlist',
    ['ko',
     'lib/underscore',
     'core/utils'],
    function (ko, _, utils) {
        var
            predefinedList = function () {
                var self = this;
                self.id = ko.observable('');
                self.name = ko.observable('');
                self.values = ko.observableArray([]);
                self.defaultValue = ko.observable('');
            };

        predefinedList.fromDto = function (dto) {
            var item = new predefinedList().id(dto.id);
            item.name(dto.name)
                .values(dto.values.split(';'))
                .defaultValue(dto.defaultValue);

            return item;
        };

        return predefinedList;
    });
define('core/model/model.signature',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            signature = function () {
                var self = this;
                self.id = ko.observable('');
                self.userGuid = ko.observable('');
                self.recipientId = ko.observable('');
                self.name = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, maxLength: { params: 150, message: 'Name too long' } });
                self.companyName = ko.escapedObservable('').extend({ maxLength: { params: 150, message: 'Company too long' } });
                self.position = ko.escapedObservable('').extend({ maxLength: { params: 150, message: 'Position too long' } });;
                self.firstName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, maxLength: { params: 80, message: 'First name too long' }  });
                self.lastName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, maxLength: { params: 80, message: 'Last name too long' } } );
                self.fullName = ko.escapedObservable(function () {
                    return self.firstName() + ' ' + self.lastName();
                }, self);
                self.textInitials = ko.escapedObservable('').extend({ maxLength: { params: 10, message: 'Initials too long' } });
                self.signatureImageFileId = ko.observable('');
                self.initialsImageFileId = ko.observable('');
                self.signatureImageUrl = ko.observable('').extend({ required: { message: config.validationMessages.required } });
                self.initialsImageUrl = ko.observable('');
                self.createdTimeStamp = ko.observable('');
                self.selected = ko.observable(false);
                self.companyAndPosition = ko.computed(function () {
                    if (self.companyName() != '' && self.position() != '')
                        return self.companyName() + ' / ' + self.position();
                    else if (self.companyName() != '')
                        return self.companyName();
                    else return self.position();
                });
            };

        signature.fromDto = function (dto) {
            var item = new signature().id(dto.id);

            item.firstName(dto.firstName)
                .lastName(dto.lastName)
                .userGuid(dto.userGuid)
                .recipientId(dto.recipientId)
                .name(dto.name)
                .companyName($.trim(dto.companyName))
                .position(dto.position)
                .textInitials(dto.textInitials)
                .signatureImageFileId(dto.signatureImageFileId)
                .initialsImageFileId(dto.initialsImageFileId)
                .signatureImageUrl(dto.signatureImageUrl)
                .initialsImageUrl(dto.initialsImageUrl)
                .createdTimeStamp(dto.createdTimeStamp);
            ko.validation.group(item);
            return item;
        };
        signature.blank = function () {
            var item = new signature();
            ko.validation.group(item);
            return item;
        };
        signature.getDtoId = function (dto) { return dto.id; };

        return signature;
    });
define('core/model/model.template.document',
    ['ko'],
    function (ko) {
        var
            templateDocument = function () {
                var self = this;
                self.documentId = ko.observable();
                self.templateId = ko.observable();
                self.order = ko.observable();
                self.name = ko.observable();
                self.originalDocumentMD5 = ko.observable();
                self.finalDocumentMD5 = ko.observable();
                self.originalDocumentPagesCount = ko.observable();
                self.fieldsCount = ko.observable();
                self.originalDocumentImportedFields = ko.observableArray();
                self.totalPages = ko.computed(function () {
                    return "(Total pages: " + self.originalDocumentPagesCount() + ")";
                }, self);
                self.originalDocumentId = ko.observable();
                self.shortName = ko.computed(function () {
                    if (self.name() && self.name().length > 25)
                        return self.name().substring(0, 22) + "...";
                    else
                        return self.name();
                });

            };

        templateDocument.fromDto = function (dto) {
            var item = new templateDocument().documentId(dto.documentId);

            item.templateId(dto.templateId)
                .order(dto.order)
                .name(dto.name)
                .originalDocumentMD5(dto.originalDocumentMD5)
                .finalDocumentMD5(dto.finalDocumentMD5)
                .originalDocumentPagesCount(dto.originalDocumentPagesCount)
                .fieldsCount(dto.fieldsCount)
                .originalDocumentId(dto.originalDocumentId);
            return item;
        };

        templateDocument.getDtoId = function (dto) { return dto.documentId; };

        return templateDocument;
    });
define('core/model/model.template.field',
    ['ko',
    'core/config',
    'core/utils',
    'core/model/model.template.fieldlocation'
    ],
    function (ko, config, utils, templateFieldLocation) {
        var
            templateField = function () {
                var self = this;
                self.id = ko.observable('');
                self.templateId = ko.observable('');
                self.recipientId = ko.observable('');
                self.name = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } });
                self.mandatory = ko.observable('');
                self.order = ko.observable('');
                self.regularExpression = ko.escapedObservable('');
                self.getDataFrom = ko.observable('');
                self.data = ko.observable('');
                self.fillTimeStamp = ko.observable('');
                self.signatureFieldId = ko.observable('');
                self.locations = ko.observableArray([]);
                self.fieldType = ko.observable('');
                self.acceptableValuesArray = ko.observableArray([]);
                self.defaultValue = ko.escapedObservable('');
                self.tooltip = ko.escapedObservable('');
                self.guidanceText = ko.escapedObservable('');
                self.groupName = ko.escapedObservable('');
                self.settings = ko.observable();
                self.lockDuringSign = ko.observable(true);
                self.templateName = ko.computed(function () {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "signature-field-template";
                        case config.signatureFieldType.SingleLine:
                            return "singleline-field-template";
                        case config.signatureFieldType.MultiLine:
                            return "multiline-field-template";
                        case config.signatureFieldType.Date:
                            return "date-field-template";
                        case config.signatureFieldType.Dropdown:
                            return "dropdown-field-template";
                        case config.signatureFieldType.Checkbox:
                            return "checkbox-field-template";
                        case config.signatureFieldType.File:
                            return "file-field-template";
                        case config.signatureFieldType.Stamp:
                            return "stamp-field-template";
                    }
                    return "";
                });
                self.fieldTypeText = ko.computed(function () {
                    switch (self.fieldType()) {
                        case config.signatureFieldType.Signature:
                            return "Signature";
                        case config.signatureFieldType.SingleLine:
                            return "Single line text field";
                        case config.signatureFieldType.MultiLine:
                            return "Multi line text field";
                        case config.signatureFieldType.Date:
                            return "Date";
                        case config.signatureFieldType.Dropdown:
                            return "Dropdown";
                        case config.signatureFieldType.Checkbox:
                            return "Checkbox";
                        case config.signatureFieldType.File:
                            return "File";
                        case config.signatureFieldType.Stamp:
                            return "Stamp";
                    }
                    return "";
                });
                self.acceptableValues = ko.computed(function () {
                    return self.acceptableValuesArray().join(";");
                });
                //self.dirtyFlag = new ko.DirtyFlag([self.name, self.regularExpression, self.acceptableValuesArray, self.defaultValue, self.tooltip]);
                self.dirtyFlag = new ko.DirtyFlag([self.name, self.defaultValue, self.tooltip, self.acceptableValues, self.guidanceText, self.recipientId, self.groupName, self.mandatory, self.regularExpression, self.settings]);
                
                self.prepareSettings = function (filedType, settingsJson) {
                    if (settingsJson == undefined)
                        settingsJson = {};
                    switch (filedType) {
                        case config.signatureFieldType.Date:
                            var dateSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                showMonthYearDropdowns: ko.observable(dateSettings != null && dateSettings.showMonthYearDropdowns != null ? dateSettings.showMonthYearDropdowns : true),
                                minYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.minYear : new Date().getFullYear() - 99).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                maxYear: ko.observable(dateSettings != null && dateSettings.minYear != null ? dateSettings.maxYear : new Date().getFullYear() + 30).extend({ required: { message: config.validationMessages.required }, number: true, min: 1900, max: 9999 }),
                                dateFormat: ko.observable(dateSettings != null && dateSettings.dateFormat != null ? dateSettings.dateFormat : "dd.mm.yy")
                            });
                            ko.validation.group(self.settings);
                            break;
                        case config.signatureFieldType.Signature:
                            var signatureSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                matchWidth: ko.observable(signatureSettings != null && signatureSettings.matchWidth != null ? signatureSettings.matchWidth : false),
                                matchHeight: ko.observable(signatureSettings != null && signatureSettings.matchHeight != null ? signatureSettings.matchHeight : true)
                            });

                            break;
                        case config.signatureFieldType.Checkbox:
                            var checkboxSettings = ko.utils.parseJson(settingsJson);
                            self.settings({
                                checkboxBorder: ko.observable(checkboxSettings != null && checkboxSettings.checkboxBorder != null ? checkboxSettings.checkboxBorder : true),
                            });
                            break;
                        default:

                    }
                };
            };

        templateField.fromDto = function (dto) {
            var item = new templateField().id(dto.id);

            item.name(dto.name)
                .templateId(dto.templateId)
                .recipientId(dto.recipientId)
                .mandatory(dto.mandatory)
                .order(dto.order)
                .regularExpression(dto.regularExpression)
                .getDataFrom(dto.getDataFrom)
                .data(utils.decodeUtf8(String, dto.data))
                .fillTimeStamp(dto.fillTimeStamp)
                .fieldType(dto.fieldType)
                .acceptableValuesArray(dto.acceptableValues != null ? dto.acceptableValues.split(';') : [])
                .defaultValue(dto.defaultValue)
                .tooltip(dto.tooltip)
                .guidanceText(dto.guidanceText)
                .groupName(dto.groupName);

            var locations = _.map(dto.locations, function (dtoLocation) {
                var location = templateFieldLocation.fromDto(dtoLocation);
                utils.ensureValidFieldWidthAndHeight(location, dto.fieldType);
                return location;
            });
            
            
            ko.validation.group(item);
            item.locations(locations);
            item.prepareSettings(dto.fieldType, dto.settings);
            item.dirtyFlag().reset();
            item.fieldType.subscribe(function (newValue) {
                item.prepareSettings(newValue);
            });
            return item;
        };
        templateField.blank = function () {
            var item = new templateField();
            ko.validation.group(item);
            return item;
        };
        templateField.getDtoId = function (dto) { return dto.id; };
        return templateField;
    });
define('core/model/model.template.fieldlocation',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            templateFieldLocation = function () {
                var self = this;
                self.id = ko.observable('');
                self.documentId = ko.observable('');
                self.fieldId = ko.observable('');
                self.page = ko.observable('');
                self.locationX = ko.observable('');
                self.locationY = ko.observable('');
                self.locationWidth = ko.observable('');
                self.locationHeight = ko.observable('');
                self.fontName = ko.observable('');
                self.fontColor = ko.observable('');
                self.fontSize = ko.observable('');
                self.fontBold = ko.observable(false);
                self.fontItalic = ko.observable(false);
                self.fontUnderline = ko.observable(false);
                self.align = ko.observable(0);
                self.selected = ko.observable(false);
                self.dirtyFlag = new ko.DirtyFlag([self.fontName, self.fontColor, self.fontSize, self.fontBold, self.fontItalic, self.fontUnderline, self.align]);
            };

        templateFieldLocation.fromDto = function (dto) {
            var item = new templateFieldLocation().id(dto.id);
            item.documentId(dto.documentId)
                .fieldId(dto.fieldId)
                .page(dto.page)
                .locationX(dto.locationX)
                .locationY(dto.locationY)
                .locationWidth(dto.locationWidth)
                .locationHeight(dto.locationHeight)
                .fontName(dto.fontName)
                .fontColor(dto.fontColor)
                .fontSize(dto.fontSize)
                .fontBold(dto.fontBold)
                .fontItalic(dto.fontItalic)
                .fontUnderline(dto.fontUnderline)
                .align(dto.align);
            item.dirtyFlag().reset();
            return item;
        };
        templateFieldLocation.blank = function () {
            var item = new templateFieldLocation();
            return item;
        };
        templateFieldLocation.getDtoId = function (dto) { return dto.id; };
        return templateFieldLocation;
    });
define('core/model/model.template',
    ['ko',
     'lib/underscore',
     'core/utils',
     'core/model/model.template.recipient'],
    function (ko, _, utils, templateRecipient) {
        var
            template = function () {
                var self = this;
                self.id = ko.observable();
                self.name = ko.escapedObservable().extend({ required: true, maxLength: { params: 255, message: 'Name too long' } });
                self.ownerGuid = ko.observable();
                self.reminderTime = ko.observable().extend({
                    require: true,
                    pattern: {
                        message: 'Invalid reminder time',
                        params: '^[0-9]$'
                    }
                });
                self.stepExpireTime = ko.observable().extend({
                    require: true,
                    pattern: {
                        message: 'Invalid step expire time',
                        params: '^[0-9]$'
                    }
                });
                self.templateExpireTime = ko.observable().extend({
                    require: true,
                    pattern: {
                        message: 'Invalid template expire time',
                        params: '^[0-9]$'
                    }
                });
                self.ownerShouldSign = ko.observable();
                self.orderedSignature = ko.observable();
                self.emailSubject = ko.escapedObservable();
                self.emailBody = ko.escapedObservable();
                self.documentsCount = ko.observable();
                self.documentsPages = ko.observable();
                self.recipients = ko.observableArray([]);
                self.waterMarkText = ko.escapedObservable().extend({ maxLength: { params: 255, message: 'Text too long' } });
                self.waterMarkImage = ko.observable();
                self.enableTypedSignature = ko.observable();
                self.enableUploadedSignature = ko.observable();
                self.tags = ko.observable("");

                self.expirationDate = ko.computed(function () {
                    try {
                        var today = new Date();
                        var expiration = new Date(today.getTime() + self.templateExpireTime() * 24 * 60 * 60 * 1000);
                        return expiration.format("dd mmm yyyy");
                    } catch (ex) {
                        return "";
                    }
                });
                self.reminderDate = ko.computed(function () {
                    try {
                        var today = new Date();
                        var expiration = new Date(today.getTime() + self.reminderTime() * 24 * 60 * 60 * 1000);
                        return expiration.format("dd mmm yyyy");
                    } catch (ex) {
                        return "";
                    }
                });
                self.stepExpireDate = ko.computed(function () {
                    try {
                        var today = new Date();
                        var expiration = new Date(today.getTime() + self.stepExpireTime() * 24 * 60 * 60 * 1000);
                        return expiration.format("dd mmm yyyy");
                    } catch (ex) {
                        return "";
                    }
                });
                self.fieldsCount = ko.observable();
                self.selected = ko.observable(false);
            };

        template.fromDto = function (dto) {
            var item = new template().id(dto.id);

            item.name(dto.name)
                .ownerGuid(dto.ownerGuid)
                .reminderTime(dto.reminderTime)
                .stepExpireTime(dto.stepExpireTime)
                .templateExpireTime(dto.templateExpireTime)
                .ownerShouldSign(dto.ownerShouldSign)
                .orderedSignature(dto.orderedSignature)
                .emailSubject(dto.emailSubject)
                .emailBody(dto.emailBody)
                .documentsCount(dto.documentsCount)
                .documentsPages(dto.documentsPages)
                .recipients(dto.recipients)
                .waterMarkText(dto.waterMarkText)
                .waterMarkImage(dto.waterMarkImage)
                .fieldsCount(dto.fieldsCount)
                .enableTypedSignature(dto.enableTypedSignature)
                .enableUploadedSignature(dto.enableUploadedSignature)
                .tags(dto.tags)
            ;

            var recipients = _.map(dto.recipients, function (dtoRecipient) {
                return templateRecipient.fromDto(dtoRecipient);
            });
            item.recipients(recipients);

            return item;
        };

        template.getDtoId = function (dto) { return dto.id; };

        return template;
    });
define('core/model/model.template.recipient',
    ['ko',
    'core/config'
    ],
    function (ko, config) {
        var
            templateRecipient = function () {
                var self = this;
                self.id = ko.observable();
                self.nickname = ko.observable().extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'Name too long' } });
                self.order = ko.observable();
                self.roleId = ko.observable();
                self.role = ko.computed(function () {
                    if (self.roleId() == 1)
                        return "Owner";
                    else if (self.roleId() == 2)
                        return "Signer";
                    else
                        return "CC";
                }, self);;
            };

        templateRecipient.fromDto = function (dto) {
            var item = new templateRecipient().id(dto.id);

            item.nickname(dto.nickname)
                .order(dto.order)
                .roleId(dto.roleId);
            ko.validation.group(item);
            return item;
        };

        templateRecipient.getDtoId = function (dto) { return dto.id; };

        return templateRecipient;
    });
define('core/model/model.template.resource',
    ['ko',
     'lib/underscore',
     'core/utils',
     'core/model/model.template.recipient',
     'core/model/model.template.document'],
    function (ko, _, utils, templateRecipient, templateDocument) {
        var
            templateResource = function () {
                var self = this;
                self.documents = ko.observableArray();
                self.recipients = ko.observableArray();
                self.tags = ko.observableArray();
            };

        templateResource.fromDto = function (dto) {
            var item = new templateResource();
            var documents = _.map(dto.documents, function (dtoDocument) {
                return templateDocument.fromDto(dtoDocument);
            });
            documents.unshift({ name: ko.observable("Documents"), shortName: ko.observable("Documents") });
            item.documents(documents);
            var recipients = _.map(dto.recipients, function (dtoRecipient) {
                return templateRecipient.fromDto(dtoRecipient);
            });
            recipients.unshift({ nickname: ko.observable("Parties") });
            item.recipients(recipients);

            var tags = _.map(dto.tags, function (dtoTag) {
                return { name: ko.observable(dtoTag), value: dtoTag };
            });
            tags.unshift({ name: ko.observable("All Tags") });
            item.tags(tags);
            return item;
        };

        return templateResource;
    });
define('core/redirect',
    [
        'core/config'
    ],
    function (config) {
        var routes = config.routes,
            viewDocument = function (documentId) {
                window.location.href = routes.viewDocumentUrl(documentId);
            },
            viewDocumentEmbed = function (documentId) {
                window.location.href = routes.viewDocumentEmbedUrl(documentId);
            },
            envelopeView = function (envelopeId) {
                window.location.href = routes.envelopeViewUrl(envelopeId);
            },
            envelopeSigned = function(envelopeId) {
                window.location.href = routes.envelopeSignedUrl(envelopeId);
            },
            embedEnvelopeSigned = function (envelopeId, recipientId) {
                window.location.href = routes.embedEnvelopeSignedUrl(envelopeId, recipientId);
            },
            envelopeSign = function (envelopeId) {
                window.location.href = routes.envelopeSignUrl(envelopeId);
            },
            embedEnvelopeSign = function (envelopeId, recipientId) {
                //console.log(routes.embedSignEnvelopeUrl(envelopeId, recipientId));
                window.location.href = routes.embedSignEnvelopeUrl(envelopeId, recipientId);
            },
            envelopeFields = function (envelopeId, documentId) {
                window.location.href = routes.envelopeFieldsUrl(envelopeId, documentId);
            },
            envelopeDashboard = function() {
                window.location.href = routes.envelopeDashboardUrl();
            },
            contactDashboard = function() {
                window.location.href = routes.contactDashboardUrl();
            },
            signatureDashboard = function() {
                window.location.href = routes.signatureDashboardUrl();
            },
            templateDashboard = function() {
                window.location.href = routes.templateDashboardUrl();
            },
            formDashboard = function() {
                window.location.href = routes.formDashboardUrl();
            },
            formArchivedDashboard = function() {
                window.location.href = routes.formArchivedDashboardUrl();
            },
            envelopeArchivedDashboard = function() {
                window.location.href = routes.envelopeArchivedDashboardUrl();
            },
            templateView = function(templateId) {
                window.location.href = routes.templateViewUrl(templateId);
            },
            formView = function(formId) {
                window.location.href = routes.formViewUrl(formId);
            },
            downloadFormDocuments = function (userId, privateKey, formId) {
                window.location.href = routes.downloadFormDocumentsUrl(userId, privateKey, formId);
            },
            formSigned = function (formId, participantId) {
                window.location.href = routes.formSignedUrl(formId, participantId);
            },
            embedFormSigned = function (formId, participantId) {
                window.location.href = routes.embedFormSignedUrl(formId, participantId);
            },
            documentSign = function (documentId) {
                window.location.href = routes.documentSignUrl(documentId);
            },
            downloadFormParticipantDocuments = function (formId, participantId) {
                window.location.href = routes.publicDownloadFormDocumentsUrl(formId, participantId);
            };
        return {
            viewDocument: viewDocument,
            envelopeView: envelopeView,
            envelopeSigned: envelopeSigned,
            envelopeSign: envelopeSign,
            envelopeFields: envelopeFields,
            envelopeDashboard: envelopeDashboard,
            contactDashboard: contactDashboard,
            signatureDashboard: signatureDashboard,
            templateDashboard: templateDashboard,
            formDashboard: formDashboard,
            envelopeArchivedDashboard: envelopeArchivedDashboard,
            formArchivedDashboard: formArchivedDashboard,
            templateView: templateView,
            formView: formView,
            downloadFormDocuments: downloadFormDocuments,
            formSigned: formSigned,
            embedEnvelopeSigned: embedEnvelopeSigned,
            viewDocumentEmbed: viewDocumentEmbed,
            documentSign: documentSign,
            embedEnvelopeSign: embedEnvelopeSign,
            embedFormSigned: embedFormSigned,
            downloadFormParticipantDocuments: downloadFormParticipantDocuments
        };
    });
define('core/repository/baserepository',
    ['jquery', 'lib/underscore', 'ko', 'core/utils'],
    function ($, _, ko, utils) {
        var itemsToArray = function(items, observableArray) {
            if (!observableArray) return;
            var underlyingArray = utils.mapMemoToArray(items);
            observableArray(underlyingArray);
        },
            addItemsToArray = function (items, observableArray) {
                if (!observableArray) return;
                var currentItems = observableArray();
                var result = currentItems.concat(items);
                observableArray(result);
                //$.each(utils.mapMemoToArray(items), function(i) {
                //    observableArray.push(this);
                //});
            },
            baseRepository = function(target, getFunction, updateFunction) {
                var self = this;
                self.mapDtoListToContext = function(dtoList, results) {
                        var items1 = _.map(dtoList, function(dto) {
                            return target.fromDto(dto);
                        });
                        itemsToArray(items1, results);
                        return items1; // must return these
                    };
                self.addDtoListToContext = function (dtoList, results) {
                    var items1 = _.map(dtoList, function (dto) {
                        return target.fromDto(dto);
                    });
                    addItemsToArray(items1, results);
                    return items1; // must return these
                };
                self.getData = function (options) {
                    return $.Deferred(function(def) {
                        var results = options && options.results,
                            param = options && options.param,
                            getFunctionOverride = options && options.getFunctionOverride;

                        getFunction = getFunctionOverride || getFunction;


                        getFunction({
                            success: function(dtoList) {
                                mapDtoListToContext(dtoList, results);
                                def.resolve(results);
                            },
                            error: function(response) {
                                def.reject();
                            }
                        }, param);
                    }).promise();
                };
                self.updateData = function(entity, callbacks) {

                    var entityJson = ko.toJSON(entity);

                    return $.Deferred(function(def) {
                        if (!updateFunction) {
                            if (callbacks && callbacks.error) {
                                callbacks.error();
                            }
                            def.reject();
                            return;
                        }

                        updateFunction({
                            success: function(response) {
                                entity.dirtyFlag().reset();
                                if (callbacks && callbacks.success) {
                                    callbacks.success();
                                }
                                def.resolve(response);
                            },
                            error: function(response) {
                                if (callbacks && callbacks.error) {
                                    callbacks.error();
                                }
                                def.reject(response);
                                return;
                            }
                        }, entityJson);
                    }).promise();
                };
            };
        return baseRepository;
    });
define('core/repository',
    [
        'core/repository/repository.envelope',
        'core/repository/repository.envelope.resource',
        'core/repository/repository.envelope.document',
        'core/repository/repository.envelope.recipient',
        'core/repository/repository.contact',
        'core/repository/repository.template',
        'core/repository/repository.template.resource',
        'core/repository/repository.template.document',
        'core/repository/repository.signature',
        'core/repository/repository.form',
        'core/repository/repository.form.resource',
        'core/repository/repository.field',
        'core/repository/repository.envelope.field',
        'core/repository/repository.predefinedlist',
        'core/repository/repository.form.document',
        'core/repository/repository.form.field',
        'core/repository/repository.template.recipient',
        'core/repository/repository.template.field',
        'core/repository/repository.document',
        'core/repository/repository.resources',
        'core/repository/repository.form.participant'
    ],
    function (envelope,
        envelopeResource,
        envelopeDocument,
        envelopeRecipient,
        contact,
        template,
        templateResource,
        templateDocument,
        signature,
        form,
        formResource,
        field,
        envelopeField,
        predefinedList,
        formDocument,
        formField,
        templateRecipient,
        templateField,
        document,
        resources,
        formParticipant
    ) {
        return {
            envelope: envelope,
            envelopeResource: envelopeResource,
            envelopeDocument: envelopeDocument,
            envelopeRecipient: envelopeRecipient,
            contact: contact,
            template: template,
            templateResource: templateResource,
            templateDocument: templateDocument,
            signature: signature,
            form: form,
            formResource: formResource,
            field: field,
            envelopeField: envelopeField,
            predefinedList: predefinedList,
            formDocument: formDocument,
            formField: formField,
            templateRecipient: templateRecipient,
            templateField: templateField,
            document: document,
            resources: resources,
            formParticipant: formParticipant
        };
    });
define('core/repository/repository.contact',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.contact',
     'core/model/model.contact'
    ],
    function (baserepository, dataservice, model) {
        var contact = new baserepository(model);

        contact.getContacts = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function(def) {
                var itemsResult = options && options.itemsResult,
                   itemsCount = options && options.itemsCount,
                   param = options && options.param;

                dataservice.getContacts({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            if (itemsResult != null)
                                contact.addDtoListToContext(dtoList.result.contacts, itemsResult);
                            if (itemsCount != null)
                                itemsCount(dtoList.result.count);
                            def.resolve(dtoList);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function(response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        },
        contact.addContact = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.addContact({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok')
                            def.resolve(dtoList);
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        },
        contact.deleteContacts = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteContacts({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else
                            def.reject(result.error_message);
                    },
                    error: function (response) {
                        def.reject(respose);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        contact.updateContact = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.updateContact({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else
                            def.reject(result.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        contact.importContacts = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.importContacts({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else
                            def.reject(result.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
       

        return contact;
    });
define('core/repository/repository.document',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.document',
     'core/utils',
     'core/model/model.document.field'
    ],
    function (baserepository, dataservice, utils, modelField) {
        var document = new baserepository();
        var documentField = new baserepository(modelField);
        
        document.signDocument = function(options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;

            return $.Deferred(function(def) {
                var param = options && options.param;
                dataservice.publicSignDocument({
                    success: function(response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function(result) {
                        def.reject(result.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        document.getStatus = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.publicGetDocumentStatus({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        document.getFields = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                        param = options && options.param;
                dataservice.publicGetDocumentFields({
                    success: function (response) {
                        if (response.status == 'Ok') {
                            var result = documentField.addDtoListToContext(response.result.fields, ko.observableArray());
                            //if (itemsResult != null)
                            //    itemsResult(result);
                            def.resolve(result);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        document.getDocument = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.publicGetDocument({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        document.saveDocumentsFields = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;

            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.publicSaveDocumentFields({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (result) {
                        def.reject(result.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        document.getDefaultField = function () {
            return modelField.blank();
        };
        return document;
    });
define('core/repository/repository.envelope.document',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.envelope.document',
     'core/model/model.envelope.document',
     'core/config'
    ],
    function (baserepository, dataservice, model,config) {
        var envelopeDocument = new baserepository(model);
        var userCredentials = { userId: config.userId() ? config.userId() : '', privateKey: config.privateKey() ? config.privateKey() : '' };
        //Add here the envelope resources repository custom methods

        envelopeDocument.addDocument = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var documentResult = options && options.documentResult,
                    param = options && options.param;

                dataservice.addDocument({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var result = model.fromDto(dtoList.result.document);
                            if (documentResult != null) documentResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        
        envelopeDocument.getDocuments = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options && options.isPublic;
            var documentResult = options && options.documentResult,
                param = options && options.param;

            if (!isPublic) {
                return $.Deferred(function(def) {
                    dataservice.getDocuments({
                        success: function (dtoList) {
                            if (dtoList.status == 'Ok') {
                                envelopeDocument.addDtoListToContext(dtoList.result.documents, documentResult);
                                def.resolve(documentResult);
                            }
                            else
                                def.reject(dtoList.error_message);
                        },
                        error: function(response) {
                            def.reject(response);
                        }
                    }, param);
                }).promise().done(doneCallback).fail(errorCallback);
            } else {
                return $.Deferred(function (def) {
                    dataservice.publicGetDocuments({
                        success: function (dtoList) {
                            if (dtoList.status == 'Ok') {
                                envelopeDocument.addDtoListToContext(dtoList.result.documents, documentResult);
                                def.resolve(documentResult);
                            }
                            else
                                def.reject(dtoList.error_message);
                        },
                        error: function (response) {
                            def.reject(response);
                        }
                    }, param);
                }).promise().done(doneCallback);

            }
        };
        envelopeDocument.removeDocument = function(options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function(def) {
                var param = options && options.param;

                dataservice.removeDocument({
                    success: function(dtoList) {
                        if (dtoList.status == 'Ok') {
                            def.resolve();
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function(response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelopeDocument.renameDocument = function (envelopeId, documentId, newName, doneCallback, failCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    envelopeId: envelopeId,
                    documentId: documentId,
                    newName: newName
                }, userCredentials);
                dataservice.renameDocument({
                    success: function (result) {
                        if (result.status == "Ok") {
                            def.resolve(result);
                        } else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        return envelopeDocument;
    });
define("core/repository/repository.envelope.field",
    ["core/repository/baserepository",
     "core/dataservice/dataservice.envelope.field",
     "core/model/model.envelope.field"
    ],
    function (baserepository, dataservice, modelField) {
        var envelopeField = new baserepository(modelField);

        envelopeField.getFields = function(options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options && options.isPublic;

            function getFieldsList(def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.getFields({
                    success: function(dto) {
                        if (dto.status === "Ok") {
                            var result = envelopeField.addDtoListToContext(dto.result.fields, itemsResult);
                            if (itemsResult != null)
                                itemsResult(result);
                            def.resolve(result);
                        } else
                            def.reject(dto.error_message);
                    },
                    error: function(dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }

            function publicGetFieldsList(def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.publicGetFields({
                    success: function(dto) {
                        if (dto.status === "Ok") {
                            var result = envelopeField.addDtoListToContext(dto.result.fields, itemsResult);
                            if (itemsResult != null)
                                itemsResult(result);
                            def.resolve(result);
                        } else
                            def.reject(dto.error_message);
                    },
                    error: function(dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }

            return $.Deferred(isPublic ? publicGetFieldsList : getFieldsList).done(successCallback).fail(errorCallback);
        };

        envelopeField.getField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.getFields({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.fields[0]);
                            def.resolve(result);
                        } else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).done(successCallback).fail(errorCallback);
        };
        envelopeField.addField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.addField({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeField.deleteFieldLocation = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteFieldLocation({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            def.resolve();
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeField.updateFieldLocation = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options.isPublic || false;

            function updateFieldLoc(def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.updateFieldLocation({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }

            function publicUpdateFieldLoc(def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.publicUpdateFieldLocation({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }


            return $.Deferred(isPublic?publicUpdateFieldLoc:updateFieldLoc).promise().done(successCallback).fail(errorCallback);
        };
        envelopeField.updateField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.updateField({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeField.deleteFields = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteFields({
                    success: function (dto) {
                        def.resolve();
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeField.fillField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options && options.isPublic;
            if (!isPublic) {
                return $.Deferred(function(def) {
                    var fieldResult = options && options.fieldResult,
                        param = options && options.param;
                    dataservice.fillField({
                        success: function(dto) {
                            if (dto.status === "Ok") {
                                var result = modelField.fromDto(dto.result.field);
                                if (fieldResult != null) fieldResult = result;
                                def.resolve(result);
                            } else
                                def.reject(dto.error_message);
                        },
                        error: function(dto) {
                            if (dto != null)
                                def.reject(dto.error_message);
                            else
                                def.reject('Error when updating field');
                        }
                    }, param);
                }).promise().done(successCallback).fail(errorCallback);
            } else {
                return $.Deferred(function (def) {
                    var fieldResult = options && options.fieldResult,
                        param = options && options.param;
                    dataservice.publicFillField({
                        success: function (dto) {
                            if (dto.status === "Ok") {
                                var result = modelField.fromDto(dto.result.field);
                                if (fieldResult != null) fieldResult = result;
                                def.resolve(result);
                            } else
                                def.reject(dto.error_message);
                        },
                        error: function (dto) {
                            if (dto != null)
                                def.reject(dto.error_message);
                            else 
                                def.reject('Error when updating field');
                        }
                    }, param);
                }).promise().done(successCallback).fail(errorCallback);
            }
        };
        envelopeField.assignField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.assignField({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeField.updateFieldLocationOrder = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.updateFieldLocationOrder({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };

        return envelopeField;
    });
define('core/repository/repository.envelope',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.envelope',
     'core/model/model.envelope',
     'core/utils',
     'core/model/model.auditlog',
     'core/config'
    ],
    function (baserepository, dataservice, model, utils, modelAuditLog,config) {
        var envelope = new baserepository(model, dataservice.getEnvelopes);
        var auditLog = new baserepository(modelAuditLog, dataservice.getEnvelopeAuditLog);
        var userCredentials = { userId: config.userId() ? config.userId() : '', privateKey: config.privateKey() ? config.privateKey() : '' };
        //Add here the envelope repository custom methods

        envelope.getEnvelopes = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    itemsCount = options && options.itemsCount,
                    param = options && options.param;

                dataservice.getEnvelopes({
                    success: function (response) {
                        if (response.status == "Ok") {
                            envelope.addDtoListToContext(response.result.envelopes, itemsResult);
                            itemsCount(response.result.envelopesCount);
                            def.resolve(itemsResult, itemsCount);
                        } else
                            def.reject(response.error_message);

                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        },
        envelope.envelopeRecipientSigned = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function(def) {
                var param = options && options.param;
                dataservice.envelopeRecipientSigned({
                    success: function (response) {                 
                            def.resolve(response);            
                    },
                    error: function(response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        },
        envelope.getEnvelopeCurrentRecipientId = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function(def) {
                var param = options && options.param;
                dataservice.getEnvelopeCurrentRecipientId({
                    success: function (response) {
                        def.resolve(response);
                    },
                    error: function(response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.restartEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.restartEnvelope({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.archiveEnvelopes = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.archiveEnvelopes({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.createEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.createEnvelope({
                    success: function (response) {
                        if (response.status == "Ok")
                            def.resolve(response.result);
                        else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.getEnvelope = function(options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options && options.isPublic;
            if (!isPublic) {
                return $.Deferred(function(def) {
                    var itemsResult = options && options.itemsResult,
                        param = options && options.param;
                    dataservice.getEnvelope({
                        success: function(response) {
                            if (response.status == "Ok") {
                                itemsResult(model.fromDto(response.result.envelope));
                                def.resolve(itemsResult);
                            } else
                                def.reject(response.error_message);
                        },
                        error: function(response) {
                            def.reject(response);
                        }
                    }, param);
                }).promise().done(doneCallback).fail(errorCallback);
            } else {
                return $.Deferred(function (def) {
                    var itemsResult = options && options.itemsResult,
                        param = options && options.param;
                    dataservice.publicGetEnvelope({
                        success: function (response) {
                            if (response.status == "Ok") {
                                itemsResult(model.fromDto(response.result.envelope));
                                def.resolve(itemsResult);
                            } else
                                def.reject(response.error_message);
                        },
                        error: function (response) {
                            def.reject(response);
                        }
                    }, param);
                }).promise().done(doneCallback).fail(errorCallback);

            }
        };
        envelope.updateEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.updateEnvelope({
                    success: function (response) {
                        if (response.status == "Ok") {
                            var result = model.fromDto(response.result.envelope);
                            if (itemsResult != null)
                                itemsResult(result);
                            def.resolve(result);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.renameEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.renameEnvelope({
                    success: function (response) {
                        if (response.status == "Ok") {
                            if (itemsResult != null)
                                itemsResult(model.fromDto(response.result.envelope));
                            def.resolve(itemsResult);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.sendEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.sendEnvelope({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.deleteEnvelopes = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteEnvelopes({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.getEnvelopeAuditLog = function(options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function(def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.getEnvelopeAuditLog({
                    success: function (response) {
                        if (response.status == "Ok") {
                            auditLog.addDtoListToContext(response.result.logs, itemsResult);
                            def.resolve(itemsResult);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function(response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.signEnvelope = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options && options.isPublic;
            if (!isPublic) {
                return $.Deferred(function(def) {
                    var param = options && options.param;
                    dataservice.signEnvelope({
                        success: function(result) {
                            if (result.status == 'Ok') {
                                def.resolve(result);
                            } else
                                def.reject(result.error_message);
                        },
                        error: function(result) {
                            def.reject(result.error_message);
                        }
                    }, param);
                }).promise().done(successCallback).fail(errorCallback);
            } else {
                return $.Deferred(function (def) {
                    var param = options && options.param;
                    dataservice.publicSignEnvelope({
                        success: function (result) {
                            if (result.status == 'Ok') {
                                def.resolve(result);
                            } else
                                def.reject(result.error_message);
                        },
                        error: function (result) {
                            def.reject(result.error_message);
                        }
                    }, param);
                }).promise().done(successCallback).fail(errorCallback);
            }
        };
        envelope.getStatus = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.publicEnvelopeStatus({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.cancelEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.cancelEnvelope({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.retrySignEnvelope = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.retrySignEnvelope({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        envelope.updateEnvelopeFromTemplate = function (envelopeId, templateId, doneCallback, failCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    envelopeId: envelopeId,
                    templateId: templateId
                }, userCredentials);
                dataservice.updateEnvelopeFromTemplate({
                    success: function (result) {
                        if (result.status == "Ok") {
                            def.resolve(result);
                        } else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        envelope.resendEmailNotification = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.resendEmailNotification({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(response);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        return envelope;
    });
define('core/repository/repository.envelope.recipient',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.envelope.recipient',
     'core/model/model.envelope.recipient'
    ],
    function (baserepository, dataservice, model) {
        var envelopeRecipient = new baserepository(model);
        
        envelopeRecipient.addRecipient = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var recipientResult = options && options.recipientResult,
                    param = options && options.param;
                dataservice.addRecipient({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.recipient);
                            if (recipientResult != null) recipientResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeRecipient.removeRecipient = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.removeRecipient({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok')
                            def.resolve();
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        envelopeRecipient.updateRecipient = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var recipientResult = options && options.recipientResult,
                    param = options && options.param;
                dataservice.updateRecipient({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.recipient);
                            if (recipientResult != null) recipientResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        return envelopeRecipient;
    });
define('core/repository/repository.envelope.resource',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.envelope',
     'core/model/model.envelope.resource'
    ],
    function (baserepository, dataservice, model) {
        var envelopesResource = new baserepository(model, dataservice.getEnvelopesResources);
        //Add here the envelope resources repository custom methods

        envelopesResource.getResources = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var resourcesResult = options && options.resourcesResult,                    
                    param = options && options.param;

                dataservice.getEnvelopesResources({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            resourcesResult(model.fromDto(dtoList.result));
                            def.resolve(resourcesResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };

        return envelopesResource;
    });
define("core/repository/repository.field",
    ["core/repository/baserepository",
     "core/dataservice/dataservice.field",
     "core/model/model.field"
    ],
    function (baserepository, dataservice, model) {
        var field = new baserepository(model, dataservice.getFields);

        field.getFields = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            var isPublic = options.isPublic || false;

            function getFieldsList(def) {
                var itemsResult = options && options.itemsResult,
                    itemsCount = options && options.itemsCount,
                    param = options && options.param;
                dataservice.getFields({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            if (itemsResult!=null)
                                field.addDtoListToContext(dto.result.fields, itemsResult);
                            if (itemsCount!=null)
                                itemsCount(dto.result.count);
                            def.resolve(itemsResult, itemsCount);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }

            function publicGetFieldsList(def) {
                var itemsResult = options && options.itemsResult,
                    itemsCount = options && options.itemsCount,
                    param = options && options.param;
                dataservice.publicGetFields({
                    success: function (dto) {
                        if (dto.status === "Ok") {
                            if (itemsResult != null)
                                field.addDtoListToContext(dto.result.fields, itemsResult);
                            if (itemsCount != null)
                                itemsCount(dto.result.count);
                            def.resolve(itemsResult, itemsCount);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }

            var def = $.Deferred(isPublic ? publicGetFieldsList : getFieldsList).promise()
                                  .done(doneCallback)
                                  .fail(errorCallback);

            return def;
        };

        return field;
    });
define('core/repository/repository.form.document',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.form.document',
     'core/model/model.form.document',
     'core/config'
    ],
    function (baserepository, dataservice, model,config) {
        var formDocument = new baserepository(model);
        var userCredentials = { userId: config.userId()?config.userId():'', privateKey: config.privateKey()?config.privateKey():'' };
        
        formDocument.addDocument = function (formId, documentId, order, parseFields, doneCallback, failCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId,
                    documentId: documentId,
                    order: order,
                    parseFields: parseFields || false
                }, userCredentials);

                dataservice.addDocument({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                        var result = model.fromDto(dtoList.result.document);
                        def.resolve(result);
                        } else {
                            def.reject(dtoList.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        

        formDocument.getDocuments = function (formId, doneCallback, failCallback) {
       
            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId
                }, userCredentials);
                
                dataservice.getDocuments({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var documentResult = _.map(dtoList.result.documents, function (dto) { return model.fromDto(dto); });
                            def.resolve(documentResult);
                        } else {
                            def.reject(dtoList.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        formDocument.removeDocument = function (formId, documentId, doneCallback, failCallback) {
            return $.Deferred(function(def) {
                var param = $.extend({
                    formId: formId,
                    documentId: documentId
                }, userCredentials);

                dataservice.removeDocument({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            def.resolve();
                        } else {
                            def.reject(dtoList.error_message);
                        }
                    },
                    error: function(response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        formDocument.publicGetDocuments = function (formId, doneCallback, failCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId
                }, userCredentials);

                dataservice.publicGetDocuments({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var documentResult = _.map(dtoList.result.documents, function (dto) { return model.fromDto(dto); });
                            def.resolve(documentResult);
                        } else {
                            def.reject(dtoList.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        formDocument.renameDocument = function (formId, documentId, newName, doneCallback, failCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId,
                    documentId: documentId,
                    newName: newName
                }, userCredentials);
                dataservice.renameDocument({
                    success: function (result) {
                        if (result.status == "Ok") {
                            def.resolve(result);
                        } else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        formDocument.modifyDocument = function (formId, documentId, newDocumentGuid, order, doneCallback, failCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId,
                    documentId: documentId,
                    newDocumentGuid: newDocumentGuid,
                    order:order
                }, userCredentials);
                dataservice.modifyDocument({
                    success: function (response) {
                        if (response.status == "Ok") {
                            def.resolve(model.fromDto(response.result.document));
                        } else {
                            def.reject(response.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        return formDocument;
    });
define('core/repository/repository.form.field',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.form.field',
     'core/model/model.form.field',
     'core/config'
    ],
    function (baserepository, dataservice, modelField,config) {
        var formField = new baserepository(modelField);
        var userCredentials = { userId: config.userId() ? config.userId() : '', privateKey: config.privateKey() ? config.privateKey() : '' };
        
        formField.getFields = function (documentId, formId, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    documentId: documentId,
                    formId:formId
                }, userCredentials);

                dataservice.getFields({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var fieldsResult = _.map(dtoList.result.fields, function (dto) { return modelField.fromDto(dto); });
                            def.resolve(fieldsResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).done(successCallback).fail(errorCallback);
        };
        formField.getField = function (documentId, formId, fieldId, successCallback, errorCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    documentId: documentId,
                    formId: formId,
                    fieldId: fieldId
                }, userCredentials);

                dataservice.getFields({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var result = modelField.fromDto(dtoList.result.fields[0]);
                            def.resolve(result);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).done(successCallback).fail(errorCallback);
        };

        formField.addField = function (documentId, fieldId, forceNewField, formId, locationHeight, locationWidth, locationX, locationY, name, page, pageWidth, pageHeight, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    documentId: documentId,
                    fieldId: fieldId,
                    forceNewField: forceNewField,
                    formId: formId,
                    locationHeight: locationHeight,
                    locationWidth: locationWidth,
                    locationX: locationX,
                    locationY:locationY,
                    name: name,
                    page: page,
                    pageWidth: pageWidth,
                    pageHeight: pageHeight
                }, userCredentials);
                
                dataservice.addField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        formField.deleteFieldLocation = function (fieldId, formId, locationId, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    fieldId: fieldId,
                    formId: formId,
                    locationId: locationId
                }, userCredentials);

                dataservice.deleteFieldLocation({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            def.resolve();
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        formField.updateFieldLocation = function (documentId, fieldId, formId, locationHeight, locationId, locationWidth, locationX, locationY, page,
                                                    fontBold, fontColor, fontItalic,  fontName, fontSize, fontUnderline, align, pageWidth,pageHeight, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    documentId: documentId,
                    fieldId: fieldId,
                    formId: formId,
                    locationHeight: locationHeight,
                    locationId: locationId,
                    locationWidth: locationWidth,
                    locationX: locationX,
                    locationY: locationY,
                    page: page,
                    fontBold: fontBold,
                    fontColor: fontColor,
                    fontItalic: fontItalic,
                    fontName: fontName,
                    fontSize: fontSize,
                    fontUnderline: fontUnderline,
                    align: align,
                    pageWidth: pageWidth,
                    pageHeight: pageHeight
                    
                }, userCredentials);
                dataservice.updateFieldLocation({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        
        formField.updateField = function (documentId, fieldId, formId, acceptableValues, defaultValue, mandatory, name, order, regularExpression, tooltip, guidanceText,groupName, fieldType, settings, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    documentId: documentId,
                    fieldId: fieldId,
                    formId: formId,
                    acceptableValues:acceptableValues,
                    defaultValue: defaultValue,
                    mandatory: mandatory,
                    name: name,
                    order: order,
                    regularExpression: regularExpression,
                    tooltip: tooltip,
                    guidanceText: guidanceText,
                    groupName: groupName,
                    fieldType: fieldType,
                    settings: settings
                }, userCredentials);

                dataservice.updateField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        
        formField.deleteFields = function (formId, fieldIds, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId,
                    fieldIds: fieldIds
                }, userCredentials);

                dataservice.deleteFields({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            def.resolve();
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        
        formField.publicGetFields = function (documentId, formId,participantId, successCallback, errorCallback) {

            return $.Deferred(function (def) {
                var param = $.extend({
                    documentId: documentId,
                    formId: formId,
                    participantId: participantId
                }, userCredentials);

                dataservice.publicGetFields({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var fieldsResult = _.map(dtoList.result.fields, function (dto) { return modelField.fromDto(dto); });
                            def.resolve(fieldsResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).done(successCallback).fail(errorCallback);
        };
        
        formField.publicFillField = function (data, documentId, fieldId, formId, participantId, successCallback, errorCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    data: data,
                    documentId:documentId,
                    fieldId: fieldId,
                    formId: formId,
                    participantId: participantId
                }, userCredentials);

                dataservice.publicFillField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            def.resolve(dto.result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        
        return formField;
    });
define('core/repository/repository.form',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.form',
     'core/model/model.form',
     'core/config',
     'core/model/model.auditlog'
    ],
    function (baserepository, dataservice, model,config, modelAuditLog) {
        var form = new baserepository(model);
        var userCredentials = { userId: config.userId() ? config.userId() : '', privateKey: config.privateKey() ? config.privateKey() : '' };
        var auditLog = new baserepository(modelAuditLog, dataservice.getEnvelopeAuditLog);

        form.getForms = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    itemsCount = options && options.itemsCount,
                    param = options && options.param;

                dataservice.getForms({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            form.addDtoListToContext(dtoList.result.forms, itemsResult);
                            itemsCount(dtoList.result.count);
                            def.resolve(itemsResult, itemsCount);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        form.getForm = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemResult = options && options.itemResult,
                    param = options && options.param;

                dataservice.getForm({
                    success: function (dto) {
                    if (dto.status == 'Ok') {
                        var result = model.fromDto(dto.result.form);
                        if (itemResult != null) itemResult(result);
                        def.resolve(result);
                    }
                    else
                        def.reject(dto.error_message);
                },
                error: function (dto) {
                    def.reject(dto.error_message);
                }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        form.createForm = function (doneCallback, failCallback, name, templateId, waterMarkImage, waterMarkText, canParticipantDownloadForm, formId, notifyOwnerOnSign, attachSignedDocument, canParticipantPrintForm) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    templateId: templateId? templateId:"",
                    canParticipantDownloadForm: canParticipantDownloadForm ? canParticipantDownloadForm : false,
                    canParticipantPrintForm: canParticipantPrintForm ? canParticipantPrintForm : true,
                    waterMarkText: waterMarkText? waterMarkText: "",
                    waterMarkImage: waterMarkImage? waterMarkImage:"",
                    name: name ? name : "New form",
                    formId: formId? formId:"",
                    notifyOwnerOnSign: notifyOwnerOnSign ? notifyOwnerOnSign : false,
                    attachSignedDocument: attachSignedDocument ? attachSignedDocument : false,
                    canBeCommented: false,
                    showParticipantCommentInSignedDocument: true
                }, userCredentials);
                dataservice.createForm({
                    success: function (dto) {
                        if (dto.status == 'Ok')
                            def.resolve(dto.result);
                        else {
                            def.reject(dto.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        form.deleteForms = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteForms({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        form.completeForm = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.completeForm({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        form.archiveForm = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.archiveForm({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        
        form.updateFormFromTemplate = function ( formId, templateId, doneCallback, failCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    formId: formId,
                    templateId: templateId
                },userCredentials);
                dataservice.updateFormFromTemplate({
                    success: function (result) {
                        if (result.status == "Ok") {
                            def.resolve(result);
                        } else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        form.modifyForm = function (formId, name, fieldsInFinalFileName, canParticipantDownloadForm, waterMarkText, waterMarkImage,
                notifyOwnerOnSign, attachSignedDocument, notifyOtherOnSign, canParticipantPrintForm, requireUserAuthForSign, requestUserAuthByPhoto, 
                enableTypedSignature, enableUploadedSignature, requireUserIdentityValidation, canBeCommented, showParticipantCommentInSignedDocument,
                tags,
            doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param = $.extend({
                    formId: formId,
                    name: name,
                    fieldsInFinalFileName: fieldsInFinalFileName,
                    canParticipantDownloadForm: canParticipantDownloadForm,
                    canParticipantPrintForm: canParticipantPrintForm,
                    waterMarkText: waterMarkText,
                    waterMarkImage: waterMarkImage,
                    notifyOwnerOnSign: notifyOwnerOnSign ? notifyOwnerOnSign : false,
                    attachSignedDocument: attachSignedDocument ? attachSignedDocument : false,
                    notifyOtherOnSign: notifyOtherOnSign,
                    requireUserAuthForSign: requireUserAuthForSign,
                    requestUserAuthByPhoto: requestUserAuthByPhoto,
                    enableTypedSignature: enableTypedSignature,
                    enableUploadedSignature: enableUploadedSignature,
                    requireUserIdentityValidation: requireUserIdentityValidation,
                    canBeCommented: canBeCommented,
                    showParticipantCommentInSignedDocument: showParticipantCommentInSignedDocument,
                    tags: tags

                }, userCredentials);
                
                dataservice.modifyForm({
                    success: function (result) {
                        if (result.status=='Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        form.publishForm = function (formId, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param = $.extend({
                    formId: formId
                }, userCredentials);

                dataservice.publishForm({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        form.archiveForms = function (formIds, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param = $.extend({
                    formIds: formIds
                }, userCredentials);

                dataservice.archiveForms({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        form.publicSignForm = function (formId,participantId, participantName, authData, comment, email, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param = $.extend({
                    formId: formId,
                    participantId: participantId,
                    participantName: participantName,
                    authData: authData == null ? "" : authData,
                    comment: comment,
                    email:email
                }, userCredentials);

                dataservice.publicSignForm({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        form.publicGetFormParticipant = function (formId, participantId, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param = $.extend({
                    formId: formId,
                    participantId: participantId
                }, userCredentials);

                dataservice.publicGetFormParticipant({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result.result.participant);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        
        form.getFormAuditLog = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.getFormAuditLog({
                    success: function (response) {
                        if (response.status == "Ok") {
                            auditLog.addDtoListToContext(response.result.logs, itemsResult);
                            def.resolve(itemsResult);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        form.publicModifyFormParticipant = function (formId, participantId, email, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param ={
                    formId: formId,
                    participantId: participantId,
                    email:email
                };

                dataservice.publicModifyFormParticipant({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result.result.participant);
                        else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        form.publicValidateFormParticipant = function (formId, participantId, code, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param = {
                    formId: formId,
                    participantId: participantId,
                    code: code
                };

                dataservice.publicValidateFormParticipant({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(true);
                        else {
                            def.resolve(false);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        form.publicFormParticipantResentValidationCode = function (formId, participantId, doneCallback, failCallback) {
            return $.Deferred(function (def) {

                var param ={
                    formId: formId,
                    participantId: participantId
                };

                dataservice.publicFormParticipantResentValidationCode({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(true);
                        else {
                            def.resolve(false);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        return form;
    });
define('core/repository/repository.form.participant',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.form.participant',
     'core/model/model.form.participant'
    ],
    function (baserepository, dataservice, model) {
        var formParticipant = new baserepository(model);
        formParticipant.getFormParticipants = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.getFormParticipants({
                    success: function (result) {
                        if (result.status == 'Ok') {
                            var itemResult = ko.observableArray([]);
                            formParticipant.addDtoListToContext(result.result.participants, itemResult);
                            def.resolve(itemResult);
                        } else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };

        return formParticipant;
    });
define('core/repository/repository.form.resource',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.form',
     'core/model/model.form.resource'
    ],
    function (baserepository, dataservice, model) {
        var formsResource = new baserepository(model, dataservice.getFormsResources);
        // is used ? 
        formsResource.getResources = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var resourcesResult = options && options.resourcesResult,
                    param = options && options.param;

                dataservice.getFormsResources({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            resourcesResult(model.fromDto(dtoList.result));
                            def.resolve(resourcesResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };

        return formsResource;
    });
define('core/repository/repository.predefinedlist',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.predefinedlist',
     'core/model/model.predefinedlist'
    ],
    function (baserepository, dataservice, model) {
        var predefinedList = new baserepository(model, dataservice.getPredefinedLists);

        predefinedList.getPredefinedLists = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;

                dataservice.getPredefinedLists({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            predefinedList.addDtoListToContext(dtoList.result.lists, itemsResult);
                            def.resolve(itemsResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        predefinedList.addList = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.addList({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.list);
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        
        predefinedList.deleteList = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;

                dataservice.deleteList({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            predefinedList.addDtoListToContext(dtoList.result.lists, itemsResult);
                            def.resolve(itemsResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        return predefinedList;
    });
define('core/repository/repository.resources',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.resources'
    ],
    function (baserepository, dataservice) {
        var repository = new baserepository();

        repository.getSignatureBackgroundSvg = function () {
            return $.Deferred(function(def) {
                dataservice.getSignatureBackgroundSvg({
                    success: function(data) {
                        def.resolve(data);
                    },
                    error: function() {
                        def.reject();
                    }
                });
            }).promise();
        };

        repository.getStampBackgroundSvg = function () {
            return $.Deferred(function (def) {
                dataservice.getStampBackgroundSvg({
                    success: function (data) {
                        def.resolve(data);
                    },
                    error: function () {
                        def.reject();
                    }
                });
            }).promise();
        };
        return repository;
    });
define('core/repository/repository.signature',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.signature',
     'core/model/model.signature',
     'core/utils'
    ],
    function (baserepository, dataservice, model, utils) {
        var signature = new baserepository(model, dataservice.getSignatures);

        signature.getSignatures = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    itemsCount = options && options.itemsCount,
                    param = options && options.param;
                dataservice.getSignatures({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            signature.addDtoListToContext(dtoList.result.signatures, itemsResult);
                            itemsCount(dtoList.result.count);
                            def.resolve(itemsResult, itemsCount);
                        } else {
                            def.reject(dtoList.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        signature.deleteSignatures = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteSignatures({
                    success: function (result) {
                        if (result.status == 'Ok')
                            def.resolve(result);
                        else
                            def.reject(result.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        signature.getBlank = function () {
            return model.blank();
        };
        signature.createSignature = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;            
            return $.Deferred(function (def) {
                var param = options && options.param,
                    signatureResult = options && options.signatureResult;
                dataservice.createSignature({
                    
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.signature);
                            if (signatureResult != null) signatureResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        signature.updateSignature = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;            
            return $.Deferred(function (def) {
                var param = options && options.param,
                    signatureResult = options && options.signatureResult;
                dataservice.updateSignature({
                    
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.signature);
                            if (signatureResult != null) signatureResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        return signature;
    });
define('core/repository/repository.template.document',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.template.document',
     'core/model/model.template.document',
     'core/config'
    ],
    function (baserepository, dataservice, model, config) {
        var templateDocument = new baserepository(model);
        var userCredentials = { userId: config.userId() ? config.userId() : '', privateKey: config.privateKey() ? config.privateKey() : '' };
        templateDocument.addDocument = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var documentResult = options && options.documentResult,
                    param = options && options.param;

                dataservice.addDocument({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            var result = model.fromDto(dtoList.result.document);
                            if (documentResult != null) documentResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        templateDocument.getDocuments = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var documentResult = options && options.documentResult,
                    param = options && options.param;

                dataservice.getDocuments({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            templateDocument.addDtoListToContext(dtoList.result.documents, documentResult);
                            def.resolve(documentResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        templateDocument.removeDocument = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;

                dataservice.removeDocument({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok')
                            def.resolve();
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        templateDocument.renameDocument = function (templateId, documentId, newName, doneCallback, failCallback) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    templateId: templateId,
                    documentId: documentId,
                    newName: newName
                }, userCredentials);
                dataservice.renameDocument({
                    success: function (result) {
                        if (result.status == "Ok") {
                            def.resolve(result);
                        } else {
                            def.reject(result.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        return templateDocument;
    });
define('core/repository/repository.template.field',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.template.field',
     'core/model/model.template.field'
    ],
    function (baserepository, dataservice, modelField) {
        var templateField = new baserepository(modelField);

        templateField.getFields = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.getFields({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = templateField.addDtoListToContext(dto.result.fields, itemsResult);
                            if (itemsResult != null)
                                itemsResult(result);
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).done(successCallback).fail(errorCallback);
        };
        templateField.getField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.getFields({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.fields[0]);
                            def.resolve(result);
                        } else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).done(successCallback).fail(errorCallback);
        };
        templateField.addField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.addField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateField.deleteFieldLocation = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteFieldLocation({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            def.resolve();
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateField.updateFieldLocation = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.updateFieldLocation({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateField.updateField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.updateField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateField.deleteFields = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteFields({
                    success: function (dto) {
                        def.resolve();
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateField.fillField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.fillField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateField.assignField = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var fieldResult = options && options.fieldResult,
                    param = options && options.param;
                dataservice.assignField({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = modelField.fromDto(dto.result.field);
                            if (fieldResult != null) fieldResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        return templateField;
    });
define('core/repository/repository.template',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.template',
     'core/model/model.template',
     'core/config'
    ],
    function (baserepository, dataservice, model, config) {
        var template = new baserepository(model, dataservice.getTemplates);
        var userCredentials = { userId: config.userId(), privateKey: config.privateKey() };
        
       /* template.getTemplates = function (options) {
            var doneCallback = options && options.doneCallback;
            return $.Deferred(function(def) {
                var itemsResult = options && options.itemsResult,
                    itemsCount = options && options.itemsCount,
                    param = options && options.param;
                dataservice.getTemplates({
                    success: function(dtoList) {
                        template.addDtoListToContext(dtoList.result.templates, itemsResult);
                        if (itemsCount)
                            itemsCount(dtoList.result.templatesCount);
                        def.resolve(itemsResult, itemsCount);
                    },
                    error: function(response) {
                        def.reject();
                    }
                }, param);
            }).promise().done(doneCallback);
        };*/
        template.getTemplates = function (doneCallback, failCallback,page, count, documentGuid, recipientName, name, tag) {
            return $.Deferred(function (def) {
                var param = $.extend({
                    page: page ? page : 1,
                    count: count ? count : 2147483647,
                    documentGuid: documentGuid ? documentGuid : '',
                    recipientName: recipientName ? recipientName : '',
                    name: name ? name : '',
                    tag: tag ? tag : ''

                }, userCredentials);
                dataservice.getTemplates({
                    success: function (dtoList) {
                        if (dtoList.status == "Ok") {
                            var templates = _.map(dtoList.result.templates, function (dto) { return model.fromDto(dto); });
                            def.resolve(templates, dtoList.result.templatesCount);
                        } else {
                            def.reject(dtoList.error_message);
                        }
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(failCallback);
        };
        template.deleteTemplates = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.deleteTemplates({
                    success: function (result) {
                        if (result.status == 'Ok') 
                            def.resolve(result);
                        else
                            def.reject(status.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        template.createTemplate = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.createTemplate({
                    success: function (response) {
                        if (response.status == 'Ok')
                            def.resolve(response.result);
                        else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        template.getTemplate = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;

                dataservice.getTemplate({
                    success: function (response) {
                        if (response.status == "Ok") {
                            itemsResult(model.fromDto(response.result.template));
                            def.resolve(itemsResult);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        template.updateTemplate = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.updateTemplate({
                    success: function (response) {
                        if (response.status == "Ok") {
                            var result = model.fromDto(response.result.template);
                            if (itemsResult != null)
                                itemsResult(result);
                            def.resolve(result);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        template.renameTemplate = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var itemsResult = options && options.itemsResult,
                    param = options && options.param;
                dataservice.renameTemplate({
                    success: function (response) {
                        if (response.status == "Ok") {
                            if (itemsResult != null)
                                itemsResult(model.fromDto(response.result.template));
                            def.resolve(itemsResult);
                        } else
                            def.reject(response.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };
        return template;
    });
define('core/repository/repository.template.recipient',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.template.recipient',
     'core/model/model.template.recipient'
    ],
    function (baserepository, dataservice, model) {
        var templateRecipient = new baserepository(model);

        templateRecipient.addRecipient = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var recipientResult = options && options.recipientResult,
                    param = options && options.param;
                dataservice.addRecipient({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.recipient);
                            if (recipientResult != null) recipientResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateRecipient.removeRecipient = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var param = options && options.param;
                dataservice.removeRecipient({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok')
                            def.resolve();
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        templateRecipient.updateRecipient = function (options) {
            var successCallback = options && options.successCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var recipientResult = options && options.recipientResult,
                    param = options && options.param;
                dataservice.updateRecipient({
                    success: function (dto) {
                        if (dto.status == 'Ok') {
                            var result = model.fromDto(dto.result.recipient);
                            if (recipientResult != null) recipientResult = result;
                            def.resolve(result);
                        }
                        else
                            def.reject(dto.error_message);
                    },
                    error: function (dto) {
                        def.reject(dto.error_message);
                    }
                }, param);
            }).promise().done(successCallback).fail(errorCallback);
        };
        return templateRecipient;
    });
define('core/repository/repository.template.resource',
    ['core/repository/baserepository',
     'core/dataservice/dataservice.template',
     'core/model/model.template.resource'
    ],
    function (baserepository, dataservice, model) {
        var templatesResource = new baserepository(model, dataservice.getTemplatesResources);

        templatesResource.getResources = function (options) {
            var doneCallback = options && options.doneCallback;
            var errorCallback = options && options.errorCallback;
            return $.Deferred(function (def) {
                var resourcesResult = options && options.resourcesResult,
                    param = options && options.param;

                dataservice.getTemplatesResources({
                    success: function (dtoList) {
                        if (dtoList.status == 'Ok') {
                            resourcesResult(model.fromDto(dtoList.result));
                            def.resolve(resourcesResult);
                        }
                        else
                            def.reject(dtoList.error_message);
                    },
                    error: function (response) {
                        def.reject(response);
                    }
                }, param);
            }).promise().done(doneCallback).fail(errorCallback);
        };

        return templatesResource;
    });
define('core/routes',
    [
        'jquery'
    ],
    function($) {
        var prepareUrl = function(url) {
            var s = $(location).attr('protocol') + "//" + $(location).attr('hostname');
            var port = $(location).attr('port');
            if (port != "" && port != '8000') {
                s += ":" + port;
            }
            s += url;
            return s;
        },
            viewDocument = function(documentId) {
                return prepareUrl('/document-viewer/' + documentId);
            },
            viewDocumentEmbedUrl = function(documentId) {
                return prepareUrl('/document-viewer/embed/' + documentId);
            },
            envelopeView = function(envelopeId) {
                return prepareUrl('/signature2/prepare/' + envelopeId);
            },
            envelopeSigned = function(envelopeId) {
                return prepareUrl('/signature2/signed/' + envelopeId);
            },
            embedEnvelopeSigned = function(envelopeId, recipientId) {
                return prepareUrl('/signature2/signedembed/' + envelopeId + '/' + recipientId);
            },
            envelopeSign = function(envelopeId) {
                return prepareUrl('/signature2/sign/' + envelopeId);
            },
            envelopeFields = function(envelopeId, documentId) {
                return prepareUrl('/signature2/fields/' + envelopeId + "#" + documentId);
            },
            envelopeDashboard = function() {
                return prepareUrl('/signature2');
            },
            contactDashboard = function() {
                return prepareUrl('/signature2/contacts');
            },
            signatureDashboard = function() {
                return prepareUrl('/signature2/signatures');
            },
            templateDashboard = function() {
                return prepareUrl('/signature2/templates');
            },
            formDashboard = function() {
                return prepareUrl('/signature2/forms');
            },
            formArchivedDashboard = function() {
                return prepareUrl('/signature2/forms/archived');
            },
            envelopeArchivedDashboard = function() {
                return prepareUrl('/signature2/archived');
            },
            templateView = function(templateId) {
                return prepareUrl('/signature2/templates/prepare/' + templateId);
            },
            embedSignEnvelopeUrl = function(envelopeId, recipientId) {
                return prepareUrl('/signature2/signembed/' + envelopeId + '/' + recipientId);
            },
            embedSignFormUrl = function(formId) {
                return prepareUrl('/signature2/forms/signembed/' + formId);
            },
            formViewUrl = function(formId) {
                return prepareUrl('/signature2/forms/prepare/' + formId);
            },
            downloadFormDocumentsUrl = function(userId, privateKey, formId) {
                return prepareUrl('/signature2/service/GetSignedFormDocuments/' + userId + '/' + privateKey + '/' + formId);
            },
            formSigned = function(envelopeId, participantId) {
                return prepareUrl('/signature2/forms/signed/' + envelopeId + '/' + participantId);
            },
            downloadEnvelopeDocumentsUrl = function(userId, privateKey, envelopeId) {
                return prepareUrl('/signature2/service/GetSignedDocuments/' + userId + '/' + privateKey + '/' + envelopeId);
            },
            publicDownloadEnvelopeDocumentsUrl = function(envelopeId, recipientid) {
                return prepareUrl('/signature2/service/PublicGetSignedDocuments/' + envelopeId + "/" + recipientid);
            },
            publicDownloadFormDocumentsUrl = function(formId, participantId) {
                return prepareUrl('/signature2/service/PublicGetSignedFormDocuments/' + formId + "/" + participantId);
            },
            documentSign = function(documentId) {
                return prepareUrl("/signature2/documents/sign/" + documentId);
            },
            documentSignEmbed = function(documentId) {
                return prepareUrl("/signature/documents/signembed/" + documentId);
            },
            embedFormSignedUrl = function(envelopeId, participantId) {
                return prepareUrl('/signature2/forms/signedembed/' + envelopeId + '/' + participantId);
            }
            ;

        return {
            viewDocumentUrl: viewDocument,
            viewDocumentEmbedUrl: viewDocumentEmbedUrl,
            envelopeViewUrl: envelopeView,
            envelopeSignedUrl: envelopeSigned,
            envelopeSignUrl: envelopeSign,
            envelopeFieldsUrl: envelopeFields,
            envelopeDashboardUrl: envelopeDashboard,
            contactDashboardUrl: contactDashboard,
            signatureDashboardUrl: signatureDashboard,
            templateDashboardUrl: templateDashboard,
            formDashboardUrl: formDashboard,
            envelopeArchivedDashboardUrl: envelopeArchivedDashboard,
            formArchivedDashboardUrl: formArchivedDashboard,
            templateViewUrl: templateView,
            embedSignEnvelopeUrl: embedSignEnvelopeUrl,
            embedSignFormUrl: embedSignFormUrl,
            formViewUrl: formViewUrl,
            downloadFormDocumentsUrl: downloadFormDocumentsUrl,
            formSignedUrl: formSigned,
            embedEnvelopeSignedUrl: embedEnvelopeSigned,
            downloadEnvelopeDocumentsUrl: downloadEnvelopeDocumentsUrl,
            publicDownloadEnvelopeDocumentsUrl: publicDownloadEnvelopeDocumentsUrl,
            publicDownloadFormDocumentsUrl: publicDownloadFormDocumentsUrl,
            documentSignUrl: documentSign,
            documentSignEmbedUrl: documentSignEmbed,
            embedFormSignedUrl: embedFormSignedUrl
        };
    });
define('core/signalr',
    ['jquery', 
     'ko',
     'core/vm',
     'core/config'],
    function ($, ko, vm, config) {
        var init = function () {
            if (!$.connection || config.userId()=='') return;
            var signatureHub = $.connection.signature2Hub.client;
            signatureHub.showDesktopNotification = function (data) {                
                if (desktopNotificationsEnabled != undefined && desktopNotificationsEnabled == "True") {
                    if (window.webkitNotifications) {
                        $.desknoty({
                            icon: "/content/images/favicon.ico",
                            title: "Signature notification",
                            body: data
                        });
                    } else {
                        $.jNotify.init(data,
                            {
                                autoHide: true, // added in v2.0
                                clickOverlay: false, // added in v2.0
                                MinWidth: 250,
                                TimeShown: 8000,
                                ShowTimeEffect: 200,
                                HideTimeEffect: 200,
                                LongTrip: 20,
                                HorizontalPosition: 'right',
                                VerticalPosition: 'bottom',
                                ShowOverlay: false,
                                ColorOverlay: '#000',
                                OpacityOverlay: 0.3,
                                onClosed: function () {

                                },
                                onCompleted: function () {

                                }
                            }, 'jNotify');
                    }
                }
            };
            signatureHub.updateEnvelopeStatus = function (envelopeId, statusId) {
                if (envelopeId != null && statusId != null && vm.envelopes.envelopes().length > 0) {
                    ko.utils.arrayFilter(vm.envelopes.envelopes(), function (item) {                        
                        return item.id() == envelopeId;
                    })[0].status(statusId);
                }
            };
            signatureHub.updateFormParticipantsCount = function (formId, participantsCount) {
                if (formId != null && participantsCount != null && vm.forms.forms().length > 0) {
                    ko.utils.arrayFilter(vm.forms.forms(), function (item) {
                        return item.id() == formId;
                    })[0].participantsCount(participantsCount);
                }
            };
            var userAgent = window.navigator.userAgent;

            if (userAgent.match(/iPad/i) || userAgent.match(/iPhone/i)) {
                $.connection.hub.start({ transport: 'longPolling' });
            }
            else {
                $.connection.hub.start();
            }
            
        };
        return {
            init: init
        };
    });
define('core/utils',
['lib/underscore'],
    function (_) {
        // IE8 array.filter patch
        if (!Array.prototype.filter) {
            Array.prototype.filter = function (fun /*, thisp*/) {
                'use strict';

                if (!this) {
                    throw new TypeError();
                }

                var objects = Object(this);
                var len = objects.length >>> 0;
                if (typeof fun !== 'function') {
                    throw new TypeError();
                }

                var res = [];
                var thisp = arguments[1];
                for (var i in objects) {
                    if (objects.hasOwnProperty(i)) {
                        if (fun.call(thisp, objects[i], i, objects)) {
                            res.push(objects[i]);
                        }
                    }
                }

                return res;
            };
        }
        //ie8 array.indexOf patch
        if (!Array.prototype.indexOf) {
            Array.prototype.indexOf = function (searchElement /*, fromIndex */) {
                'use strict';
                if (this == null) {
                    throw new TypeError();
                }
                var n, k, t = Object(this),
                    len = t.length >>> 0;

                if (len === 0) {
                    return -1;
                }
                n = 0;
                if (arguments.length > 1) {
                    n = Number(arguments[1]);
                    if (n != n) { // shortcut for verifying if it's NaN
                        n = 0;
                    } else if (n != 0 && n != Infinity && n != -Infinity) {
                        n = (n > 0 || -1) * Math.floor(Math.abs(n));
                    }
                }
                if (n >= len) {
                    return -1;
                }
                for (k = n >= 0 ? n : Math.max(len - Math.abs(n), 0) ; k < len; k++) {
                    if (k in t && t[k] === searchElement) {
                        return k;
                    }
                }
                return -1;
            };
        }
        
        var hasProperties = function(obj) {
            for (var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    return true;
                }
            }
            return false;
        },
            invokeFunctionIfExists = function(callback) {
                if (_.isFunction(callback)) {
                    callback();
                }
            },
            mapMemoToArray = function(items) {
                var underlyingArray = [];
                for (var prop in items) {
                    if (items.hasOwnProperty(prop)) {
                        underlyingArray.push(items[prop]);
                    }
                }
                return underlyingArray;
            },
            ensureValidFieldWidthAndHeight = function(location, fieldType) {
                if (location.locationHeight() == 0) {
                    switch (fieldType) {
                    case 1:
                        //signature
                        location.locationHeight(46);
                        break;
                    default:
                        location.locationHeight(25);
                        break;
                    }
                }
                if (location.locationWidth() == 0) {
                    switch (fieldType) {
                    case 1:
                        //signature
                        location.locationWidth(148);
                        break;
                    case 6:
                        //checkbox
                        location.locationWidth(25);
                        break;
                    default:
                        location.locationWidth(205);
                        break;
                    }
                }
            },
            decodeUtf8 = function(dotNetBytes) {
                var result = "";
                var i = 0;
                var c = c1 = c2 = 0;

                // Perform byte-order check.
                if (dotNetBytes.length >= 3) {
                    if ((dotNetBytes[0] & 0xef) == 0xef
                        && (dotNetBytes[1] & 0xbb) == 0xbb
                        && (dotNetBytes[2] & 0xbf) == 0xbf) {
                        // Hmm byte stream has a BOM at the start, we'll skip this.
                        i = 3;
                    }
                }

                while (i < dotNetBytes.length) {
                    c = dotNetBytes[i] & 0xff;

                    if (c < 128) {
                        result += String.fromCharCode(c);
                        i++;
                    } else if ((c > 191) && (c < 224)) {
                        if (i + 1 >= dotNetBytes.length)
                            throw "Un-expected encoding error, UTF-8 stream truncated, or incorrect";
                        c2 = dotNetBytes[i + 1] & 0xff;
                        result += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                        i += 2;
                    } else {
                        if (i + 2 >= dotNetBytes.length || i + 1 >= dotNetBytes.length)
                            throw "Un-expected encoding error, UTF-8 stream truncated, or incorrect";
                        c2 = dotNetBytes[i + 1] & 0xff;
                        c3 = dotNetBytes[i + 2] & 0xff;
                        result += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                        i += 3;
                    }
                }
                return result;
            },
            dateFromIso = function (dateStr, formatString) {
                var format = formatString || "mmm dd, yyyy HH:MM";
                var s = $.trim(dateStr);
                s = s.replace(/\.\d\d\d+/, ""); // remove milliseconds
                s = s.replace(/-/, "/").replace(/-/, "/");
                s = s.replace(/T/, " ").replace(/Z/, " UTC");
                s = s.replace(/([\+\-]\d\d)\:?(\d\d)/, " $1$2"); // -04:00 -> -0400
                return new Date(s).format(format);

            };

        
        return {
            hasProperties: hasProperties,
            invokeFunctionIfExists: invokeFunctionIfExists,
            mapMemoToArray: mapMemoToArray,
            ensureValidFieldWidthAndHeight: ensureValidFieldWidthAndHeight,
            decodeUtf8: decodeUtf8,
            dateFromIso: dateFromIso
        };
    });


define('core/vm',
    [
        'core/vm/vm.envelopes',
        'core/vm/vm.envelopes.resources',
        'core/vm/vm.quicksearch',
        'core/vm/vm.filednd',
        'core/vm/vm.envelope.prepare',
        'core/vm/vm.contacts',
        'core/vm/vm.contactsearch',
        'core/vm/vm.contactdetails',
        'core/vm/vm.contactselect',
        'core/vm/vm.navigationmenu',
        'core/vm/vm.templates',
        'core/vm/vm.templates.resources',
        'core/vm/vm.loading',
        'core/vm/vm.signatures',
        'core/vm/vm.signaturedetails',
        'core/vm/vm.signaturepad',
        'core/vm/vm.embedlink',
        'core/vm/vm.forms',
        'core/vm/vm.forms.resources',
        'core/vm/vm.viewer',
        'core/vm/vm.auditlog',
        'core/vm/vm.form.prepare',
        'core/vm/vm.envelope.sign',
        'core/vm/vm.envelope.prepare.step1',
        'core/vm/vm.envelope.prepare.step2',
        'core/vm/vm.envelope.prepare.step3',
        'core/vm/vm.envelope.prepare.step4',
        'core/vm/vm.envelope.prepare.step5',
        'core/vm/vm.envelope.prepare.step6',
        'core/vm/vm.form.signEmbed',
        'core/vm/vm.template.prepare',
        'core/vm/vm.template.prepare.step1',
        'core/vm/vm.template.prepare.step2',
        'core/vm/vm.template.prepare.step3',
        'core/vm/vm.template.prepare.step4',
        'core/vm/vm.template.prepare.step5',
        'core/vm/vm.template.prepare.step6',
        'core/vm/vm.envelope.signed',
        'core/vm/vm.form.signedEmbed',
        'core/vm/vm.error',
        'core/vm/vm.document.sign',
        'core/vm/vm.entername',
        'core/vm/vm.verify',
        'core/vm/vm.uploadprogress',
        'core/vm/vm.confirmSign',
        'core/vm/vm.form.validate',
        'core/vm/vm.form.signed',
        'core/vm/vm.form.participants',
        'core/vm/vm.document.prepare'
],
    function (
        envelopes,
        envelopesResources,
        quickSearch,
        filednd,
        envelopePrepare,
        contacts,
        contactsearch,
        contactdetails,
        contactSelect,
        navigationMenu,
        templates,
        templatesResources,
        loading,
        signatures,
        signatureDetails,
        signaturePad,
        embedLink,
        forms,
        formsResources,
        viewer,
        auditLog,
        formPrepare,
        envelopeSign,
        envelopePrepareStep1,
        envelopePrepareStep2,
        envelopePrepareStep3,
        envelopePrepareStep4,
        envelopePrepareStep5,
        envelopePrepareStep6,
        formSignEmbed,
        templatePrepare,
        templatePrepareStep1,
        templatePrepareStep2,
        templatePrepareStep3,
        templatePrepareStep4,
        templatePrepareStep5,
        templatePrepareStep6,
        envelopeSigned,
        formSignedEmbed,
        error,
        documentSign,
        enterName,
        verify,
        uploadprogress,
        confirmSign,
        formValidate,
        formSigned,
        formParticipants,
        documentPrepare
    ) {
        return {
            envelopes: envelopes,
            envelopesResources: envelopesResources,
            quickSearch: quickSearch,
            filednd: filednd,
            envelopePrepare: envelopePrepare,
            contacts: contacts,
            contactsearch: contactsearch,
            contactdetails: contactdetails,
            contactSelect: contactSelect,
            navigationMenu: navigationMenu,
            templates: templates,
            templatesResources: templatesResources,
            loading: loading,
            signatures: signatures,
            signatureDetails: signatureDetails,
            signaturePad: signaturePad,
            embedLink: embedLink,
            forms: forms,
            formsResources: formsResources,
            viewer: viewer,
            auditLog: auditLog,
            formPrepare: formPrepare,
            envelopeSign: envelopeSign,
            envelopePrepareStep1: envelopePrepareStep1,
            envelopePrepareStep2: envelopePrepareStep2,
            envelopePrepareStep3: envelopePrepareStep3,
            envelopePrepareStep4: envelopePrepareStep4,
            envelopePrepareStep5: envelopePrepareStep5,
            envelopePrepareStep6: envelopePrepareStep6,
            formSignEmbed: formSignEmbed,
            templatePrepare: templatePrepare,
            templatePrepareStep1: templatePrepareStep1,
            templatePrepareStep2: templatePrepareStep2,
            templatePrepareStep3: templatePrepareStep3,
            templatePrepareStep4: templatePrepareStep4,
            templatePrepareStep5: templatePrepareStep5,
            templatePrepareStep6: templatePrepareStep6,
            envelopeSigned: envelopeSigned,
            formSignedEmbed: formSignedEmbed,
            error: error,
            documentSign: documentSign,
            enterName: enterName,
            verify: verify,
            uploadprogress: uploadprogress,
            confirmSign: confirmSign,
            formValidate: formValidate,
            formSigned: formSigned,
            formParticipants: formParticipants,
            documentPrepare: documentPrepare
        };
    });
define('core/vm/vm.auditlog',
    ['jquery',
        'ko',
        'core/repository',
        'core/config'
    ],
    function ($, ko, repository, config) {
        var items = ko.observableArray([]);
        var filteredItems = ko.computed(function() {
            try {
                return ko.utils.arrayFilter(items(), function (item) {
                    return item.type() == selectedType() || selectedType()==0;
                });
            } catch (ex) {
                return [];
            }
        });
        var inprogress = ko.observable(false);
        var isVisible = ko.observable(false);
        var name = ko.observable("");
        var logType = [{ type: 0, text: "All" }, { type: 1, text: "General" }, { type: 2, text: "Email" }];
        var selectedType = ko.observable(0);
        var doOnKeyUp = function(event) {
            if (!isVisible()) return true;
            var keyCode = (event.which ? event.which : event.keyCode);
            if (keyCode === 27) {
                isVisible(false);
                return false;
            }
            return true;
        };
        var loadEnvelopeLog = function(envelopeId) {
            inprogress(true);
            items.removeAll();
            repository.envelope.getEnvelopeAuditLog({
                itemsResult: items,
                param: {
                    userId: config.userId(),
                    privateKey: config.privateKey(),
                    envelopeId: envelopeId
                },
                doneCallback: function() {
                    inprogress(false);
                },
                errorCallback: errorCallback
            });
        };
        var loadFormLog = function (formId) {
            inprogress(true);
            items.removeAll();
            repository.form.getFormAuditLog({
                itemsResult: items,
                param: {
                    userId: config.userId(),
                    privateKey: config.privateKey(),
                    formId: formId
                },
                doneCallback: function () {
                    inprogress(false);
                },
                errorCallback: errorCallback
            });
        };
        var errorCallback = function(error) {
            config.alert({ title: "Error", message: error });
            return false;
        };
        return {
            logType: logType,
            items: items,
            isVisible: isVisible,
            doOnKeyUp: doOnKeyUp,
            loadEnvelopeLog: loadEnvelopeLog,
            loadFormLog: loadFormLog,
            inprogress: inprogress,
            name: name,
            selectedType: selectedType,
            filteredItems: filteredItems
        };
    });
define('core/vm/vm.confirmSign',
    ['ko', 'core/config'],
    function (ko, config) {

        function getInstance() {
            var isVisible = ko.observable(false),
                onSign = ko.observable().extend({ notify: 'always' }),
                requireUserAuthForSign = ko.observable(false),
                requestUserAuthByPhoto = ko.observable(false),
                requestComment = ko.observable(false),
                canCapture = ko.observable(false),
                authData = ko.observable(""),
                comment = ko.escapedObservable(""),
                sign = function () {
                    if (canSign()) {
                        onSign({ authData: authData(), comment: comment() });
                        isVisible(false);
                    }
                },
                
                closeDialog = function() {
                    isVisible(false);
                },
                
                captureInfoText = ko.computed(function () {
                    var result = "";
                    if (requireUserAuthForSign()) {
                        result = "The owner of the form required you to authorize the signature \n";
                        result += canCapture() ? "Please capture a picture from your webcam" : "Your browser does not support this operation - you can't sign";
                    } else {
                        if (requestUserAuthByPhoto() && canCapture()) {
                           result = "The owner of the form requested you to authorize the signature \n";
                           result +=  "Please capture a picture from your webcam";
                       }
                    }
                    return result;
                }),
                captureInfoTextCss = ko.computed(function () {
                    var result = "small_text";
                    if (!canCapture() && requireUserAuthForSign())
                        result = "errorMessage";
                    return result;
                }),
                canSign = ko.computed(function() {
                    return !requireUserAuthForSign() || (requireUserAuthForSign && authData() && authData().length > 100);
                });

            requireUserAuthForSign.subscribe(function(value) {
                if (value) {
           //         authData = ko.observable(null).extend({ throttle: 500, required: { message: config.validationMessages.required } });
           //         ko.validation.group(authData);
                }
            });
            ko.validation.group(authData);

            return {
                isVisible: isVisible,
                closeDialog: closeDialog,
                onSign: onSign,
                requireUserAuthForSign: requireUserAuthForSign,
                requestUserAuthByPhoto: requestUserAuthByPhoto,
                captureInfoText: captureInfoText,
                canCapture: canCapture,
                captureInfoTextCss: captureInfoTextCss,
                authData: authData,
                canSign: canSign,
                sign: sign,
                requestComment: requestComment,
                comment: comment
        };
        }
        return getInstance;
    });
define('core/vm/vm.contactdetails',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config'],
    function ($, ko, _, repository, config) {
        var currentContact = ko.observable(null),
            inprogress = ko.observable(false),
            id = ko.observable(''),
            firstName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            lastName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            email = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, email: { message: config.validationMessages.invalidEmail }, noSpaces: {} }),
            completed = ko.observable(false),
            isVisible = ko.observable(false),
            addButtonVisible = ko.observable(false),
            updateButtonVisible = ko.observable(false),
            contactsVisible = ko.observable(false),
            validationModel = ko.validatedObservable({ firstName: firstName, lastName:lastName, email:email }),
            updateContact = function() {
                if (inprogress()) return;
                if (validationModel.isValid()) {
                    inprogress(true);
                    repository.contact.updateContact({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            contactId: id(),
                            firstName: firstName(),
                            lastName: lastName(),
                            email: email(),
                        },
                        doneCallback: function(result) {
                            inprogress(false);
                            if (result.status == 'Ok') {      
                                currentContact().firstName(result.result.contact.firstName);
                                currentContact().lastName(result.result.contact.lastName);
                                currentContact().email(result.result.contact.email);
                                closeContactForm();
                            } else {
                                config.alert("error",result.error_message);
                            }
                        },
                        errorCallback: function (error) {
                            config.alert("error", error);
                        }
                    });
                } else {
                    validationModel.errors.showAllMessages();
                }
            },
            addContact = function () {
                if (inprogress()) return;
                if (validationModel.isValid()) {
                    inprogress(true);
                    repository.contact.addContact({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            firstName: firstName(),
                            lastName: lastName(),
                            email: email(),
                        },
                        doneCallback: function (result) {
                            inprogress(false);
                            if (result.status == 'Ok') {
                                completed(true);//bind reload in external view
                                closeContactForm();
                            } else {
                                config.alert("error",result.error_message);
                            }
                        },
                        errorCallback: function (error) {
                            inprogress(false);
                            config.alert("error", error);
                        }
                    });
                } else {
                    validationModel.errors.showAllMessages();
                }
            },
            showEditForm = function (contact) {
                currentContact(contact);
                id(contact.id());
                firstName(contact.firstName());
                lastName(contact.lastName());
                email(contact.email());
                isVisible(true);
                completed(false);
                updateButtonVisible(true);
                addButtonVisible(false);
                contactsVisible(true);
            },

            showAddForm = function () {
                isVisible(true);
                completed(false);
                updateButtonVisible(false);
                addButtonVisible(true);
                contactsVisible(true);
            },
            
            closeContactForm = function() {
                firstName('');
                lastName('');
                email('');
                isVisible(false);
                contactsVisible(false);
            },
            doOnKeyUp = function(event) {
                if (!isVisible()) return true;
                var keyCode = (event.which ? event.which : event.keyCode);
                if (keyCode === 13) {
                    if (currentContact() != null){
                        this.updateContact();
                    } else {
                        this.addContact();
                    }
                    return false;
                }
                if (keyCode === 27) {
                    this.closeContactForm();
                    return false;
                }
                return true;
            },
            
            init = function () {
                validationModel.errors.showAllMessages();
            };
        
        init();
        
        return {
            id:id,
            firstName: firstName,
            lastName: lastName,
            email:email,
            showEditForm: showEditForm,
            showAddForm:showAddForm,
            addContact: addContact,
            updateContact: updateContact,
            closeContactForm: closeContactForm,
            completed: completed,
            doOnKeyUp: doOnKeyUp,
            addButtonVisible: addButtonVisible,
            updateButtonVisible: updateButtonVisible,
            contactsVisible: contactsVisible
        };
    });
define('core/vm/vm.contacts',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config'],
    function ($, ko, _, repository, config) {
        var contacts = ko.observableArray([]),
            inprogress = ko.observable(false),
            totalCount = ko.observable(10),
            page = ko.observable(1),
            itemsPerPage = ko.observable(1000),
            filterFirstName = ko.observable(''),
            filterLastName = ko.observable(''),
            filterEmail = ko.observable(''),
            importedItems = ko.observableArray([]),
            useAnd = ko.observable(false),
            loadContacts = function (options, callback) {
                if (inprogress()) return;

                if (options != null && options.clearAll != null && options.clearAll) {
                    contacts.removeAll();
                    totalCount(0);
                }
                var useAnd = false;
                if (options != null && options.page != null)
                    page(options.page);
                if (options != null && options.firstName != null && options.firstName != "First Name")
                    filterFirstName(options.firstName);
                if (options != null && options.lastName != null && options.lastName!="Last Name")
                    filterLastName(options.lastName);
                if (options != null && options.email != null && options.email != "Email")
                    filterEmail(options.email);
                if (options != null && options.useAnd != null)
                    useAnd=options.useAnd;
                
                inprogress(true);
                repository.contact.getContacts({
                    forceRefresh: true,
                    itemsResult: contacts,
                    itemsCount: totalCount,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        page: page(),
                        count: itemsPerPage(),
                        firstName: filterFirstName(),
                        lastName: filterLastName(),
                        email: filterEmail(),
                        useAnd:useAnd
                    },
                    doneCallback: function() {
                        inprogress(false);
                        resizeElements();
                    },
                    errorCallback: function (error) {
                        inprogress(false);
                        config.alert("error", error);
                    }
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            },
            
            deleteContacts = function (contactsIds) {
                if (inprogress()) return;
                inprogress(true);
                repository.contact.deleteContacts({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        contactsIds: contactsIds
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        if (result.status == 'Ok') {
                            _.each(contactsIds, function(c) {
                                var con = ko.utils.arrayFirst(contacts(), function (cko) {
                                    return cko.id() == c;
                                });
                                contacts.remove(con);
                            });
                        } else {
                            config.alert("error",result.error_message);
                        }
                    },
                    errorCallback: function (error) {
                        config.alert("error", error);
                    }
                });
            },
            deleteContact = function (contact) {
                $.confirm({
                    title: "Delete confirmation",
                    message: "Are you sure you want to delete this contact ?",
                    buttons: {
                        Yes: {
                            'action': function () {
                                deleteContacts([contact.id()]);
                            }
                        },
                        No: { }
                    }
                });
            },
            
            onUploadCompleted = function (e, data) {
                if (data != null) {
                    importedItems.removeAll();
                    $.each(data, function (i) {
                        importedItems.push(this);
                    });
                    importUploadedContacts();
                }
            },
          
            importUploadedContacts = function() {
                inprogress(true);
                repository.contact.importContacts({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        contacts: importedItems()
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        if (result.status == 'Ok') { 
                            $('#importedContacts').text(result.result.imported);
                            $('#ignoredContacts').text(result.result.ignored);
                            $('#importContactsDialog').modal('show');
                            loadContacts({ clearAll: true, page: 1 });
                        } else {
                            config.alert("error",result.error_message);
                        }
                    },
                    errorCallback: function (error) {
                        config.alert("error", error);
                    }
                });
            },
            selectedItems = ko.computed( function (){
                return _.filter(contacts(), function (contact) {
                    return contact.selected() == true;
                });
            }),
            deleteSelected = function () {
                if (inprogress()) return;
                $.confirm({
                    title: "Delete confirmation",
                    message: "Are you sure you want to delete selected contacts?" ,
                    buttons: {
                        Yes: {
                            'class': "",
                            'action': function () {

                                var contactIds = [];
                                $.each(selectedItems(), function () {
                                        contactIds[contactIds.length] = this.id();
                                });
                                if (contactIds.length > 0) {
                                    deleteContacts(contactIds);
                                }
                            }
                        },
                        No: {}
                    }
                });
            },
            checkAll = function () {
                var newValue = !allSelected();
                _.each(contacts(), function (contact) {
                    contact.selected(newValue);
                });
            },
            allSelected = ko.computed(function () {
                 return contacts().length > 0 &&
                     $.grep(contacts(), function (contact) {
                         return contact.selected() == true;
                     }).length == contacts().length;
            }),
            getContactsByEmail = function(email, callback) {
                repository.contact.getContacts({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        page: 1,
                        firstName: "",
                        lastName: "",
                        email: email
                    },
                    doneCallback: function (contactsResult) {
                        if (_.isFunction(callback)) {
                            callback(contactsResult.result);
                        }
                    },
                    errorCallback: function (error) {
                        config.alert("error", error);
                    }
                });
            },
            addContact = function(firstName, lastName, email, callback) {
                repository.contact.addContact({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        firstName: firstName,
                        lastName: lastName,
                        email: email(),
                    },
                    doneCallback: function (result) {
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback: function (error) {
                        config.alert("error", error);
                    }
                });

            },
            init = function () {

            };
        
        init();
        
        return {
            inprogress: inprogress,
            loadContacts: loadContacts,
            totalCount: totalCount,
            page: page,
            itemsPerPage: itemsPerPage,
            contacts: contacts,
            deleteContact: deleteContact,
            onUploadCompleted: onUploadCompleted,
            selectedItems: selectedItems,
            deleteSelected: deleteSelected,
            allSelected: allSelected,
            checkAll: checkAll,
            getContactsByEmail: getContactsByEmail,
            addContact: addContact
        };
    });
define('core/vm/vm.contactsearch',
    [],
    function() {
        var firstName = ko.escapedObservable("").extend({ throttle: 500 }),
            lastName = ko.escapedObservable("").extend({ throttle: 500 }),
            email = ko.escapedObservable("").extend({ throttle: 500 });

        return {
            firstName: firstName,
            lastName: lastName,
            email:email
        };
    });
define('core/vm/vm.contactselect',
    ['ko', 'lib/underscore', 'core/repository', 'core/config'],
    function (ko, _, repository, config) {
        var inprogress = ko.observable(false),
            contacts = ko.observableArray([]),
            filter = ko.observable(''),
            filteredContacts = ko.computed(function () {
                return ko.utils.arrayFilter(contacts(), function (item) {
                    return item.firstName().toLowerCase().indexOf(filter().toLowerCase()) >= 0 || item.lastName().toLowerCase().indexOf(filter().toLowerCase()) >= 0 || item.email().toLowerCase().indexOf(filter().toLowerCase()) >= 0;
                });
            }),
            loadContacts = function(callback) {
                if (inprogress()) return;
                inprogress(true);                
                repository.contact.getContacts({
                    itemsResult: contacts,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        count: 2147483647
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                    }
                });
                if (_.isFunction(callback)) {
                    callback();
                }
            };
        return {
            inprogress: inprogress,
            loadContacts: loadContacts,
            contacts: contacts,
            filter: filter,
            filteredContacts: filteredContacts
        };
    });
define('core/vm/vm.document.prepare',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect',
    'core/model/model.document.recipient',
    'core/model/model.document.field',
    'core/model/model.document.fieldlocation'],
    function (ko, _, repository, config, redirect,recipientModel,fieldModel,locationModel) {
        function getInstance() {
            var
                inprogress = ko.observable(),
                //document = ko.observable(),
                documentId = ko.observable(),
                signatureFields = ko.observableArray([]),
                recipients = ko.observableArray([]),
                timer,
                activeRecipient = ko.observable( recipientModel.blank()),
                previewDocument = ko.observable(),
                fields = ko.observableArray([]),
                pageWidth = ko.observable(850),
                pageHeight = ko.observable(1200),
                cuttedLocation = ko.observable(),
                copiedLocation = ko.observable(),
                cuttedField = ko.observable(),
                copiedField = ko.observable(),
                selectedField = ko.observable(),
                selectedLocation = ko.observable(),
                signatureFieldFromGuid = function (fieldGuid) {
                    return _.find(signatureFields(), function (f) {
                        return f.id() == fieldGuid;
                    });
                },
                signatureFieldFromType = function (typeId) {
                    return _.find(signatureFields(), function (f) {
                        return f.fieldType() == typeId;
                    });
                },
                selectedFieldType = ko.computed({
                    read: function() {
                        return selectedField() != null ? selectedField().fieldType() : 0;
                    },
                    write: function (value) {
                        if (value != null && selectedField() != null && selectedLocation() != null) {
                            var signatureField = $.grep(fields(), function (a) {
                                return a.fieldType() == 1 && a.id() != selectedField().id();
                            });
                            var sourceType = selectedField().fieldType();
                            var targetType = value;
                            if (sourceType != config.signatureFieldType.Signature && targetType == config.signatureFieldType.Signature) {
                                if (signatureField.length > 0) {
                                    signatureField[0].locations.push(selectedLocation());
                                    selectedField().locations.remove(selectedLocation());
                                    fields.remove(selectedField());
                                } else {
                                    selectedField().fieldType(value);
                                }
                            } else if (selectedField().locations().length == 1) {
                                selectedField().fieldType(value);
                            //} else if (sourceType != config.signatureFieldType.Signature && targetType != config.signatureFieldType.Signature) {
                            //    selectedField().fieldType(value);
                            } else {
                                var fieldResult = fieldModel.blank();
                                var fieldId = fields().length + 1;
                                fieldResult.id(fieldId);
                                fieldResult.recipientId(activeRecipient().id());
                                fieldResult.order(fields.length - 1);
                                fieldResult.fieldType(value);
                                fieldResult.name(signatureFieldFromType(value).name());
                                fieldResult.prepareSettings(value);
                                fieldResult.locations = ko.observableArray([]);
                                fieldResult.locations.push(selectedLocation());
                                $.each(fields(), function() {
                                    var field = this;
                                    this.locations.remove(function (l) {
                                        return l.fieldId() != field.id();
                                    });
                                });
                                fields.push(fieldResult);
                                selectedLocation().fieldId(fieldId);
                            }
                        }
                    },
                    owner: this
                }),

                newAcceptableValue = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
                newAcceptableValueListName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
                dateFormats = ko.observableArray([]),
                viewerAction = 'prepare',

                loadSignatureFields = function() {

                    repository.field.getFields({
                        itemsResult: signatureFields,
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey()
                        },
                        doneCallback: function(result) {

                        },
                        errorCallback: errorCallback
                    });


                },


                cancelPrepare = function() {
                    redirect.envelopeDashboard();
                },
                getUniqueFieldName = function (fieldName) {
                    var sameFlds = _.filter(fields(), function(f) {
                        return f.name().match(fieldName+"_")!=null;
                    });
                    return fieldName +"_"+ (sameFlds.length + 1).toString();
                },

                addField = function (fieldId, pageNum, relativeX, relativeY, locationHeight, locationWidth, forceAddField, fieldName, locationProperties) {
                    var signatureFieldId = fieldId;
                    var forceNewField = forceAddField;
                    if (fieldId == config.signatureFieldType.Signature && $.grep(fields(), function (a) {
                        return a.fieldType() === parseInt(fieldId);
                    }).length > 0)
                        forceNewField = false;
                    var fieldResult = fieldModel.blank();
                    fieldResult.id(fields().length + 1);
                    fieldResult.recipientId(activeRecipient().id());
                    fieldResult.order(fields.length - 1);
                    fieldResult.fieldType(signatureFieldFromGuid(signatureFieldId).fieldType());
                    fieldResult.name(getUniqueFieldName(fieldName && fieldName.length > 0 ? fieldName : signatureFieldFromGuid(signatureFieldId).name()));
                    fieldResult.prepareSettings(fieldResult.fieldType());

                    var loca = locationModel.blank();
                    loca.fieldId(fieldResult.id());
                    loca.documentId(documentId());
                    loca.page(pageNum);
                    loca.locationX(relativeX);
                    loca.locationY(relativeY);
                    loca.locationWidth(locationWidth);
                    loca.locationHeight(locationHeight);
                    loca.fontName(locationProperties != null && locationProperties.fontName != null && locationProperties.fontName != '' ? locationProperties.fontName : "Arial");
                    loca.fontColor(locationProperties != null && locationProperties.fontColor != null && locationProperties.fontColor != '' ? locationProperties.fontColor : "black");
                    loca.fontSize(locationProperties != null && locationProperties.fontSize != null && locationProperties.fontSize > 0 ? locationProperties.fontSize : 10);
                    loca.fontSize(locationProperties != null && locationProperties.fontSize != null && locationProperties.fontSize > 0 ? locationProperties.fontSize : 10);
                    loca.align(locationProperties != null && locationProperties.align != null ? locationProperties.align : 0);
                    loca.fontBold(locationProperties != null && locationProperties.fontBold != null ? locationProperties.fontBold : false);
                    loca.fontItalic(locationProperties != null && locationProperties.fontItalic != null ? locationProperties.fontItalic : false);
                    loca.fontUnderline(locationProperties != null && locationProperties.fontUnderline != null ? locationProperties.fontUnderline : false);
                    fieldResult.locations = ko.observableArray([]);
                    fieldResult.locations.push(loca);

                    $.extend(fieldResult, { selected: ko.observable(false) });
                    $.extend(fieldResult, { selectedDirtyFlag: ko.DirtyFlag([fieldResult.selected]) });
                    if (forceNewField && !_.find(fields(), function (a) { return a.id() == fieldResult.id(); })) {
                        fields.push(fieldResult);
                    } else {
                        var mainField = $.grep(fields(), function (a) {
                            return a.fieldType() == parseInt(fieldId);
                        })[0];
                        loca.fieldId(mainField.id());
                        mainField.locations.push(fieldResult.locations.pop());
                    }

                },
                addLocation = function(field, locationProperties) {
                    if (field == null || locationProperties == null) return;
                    var location = locationModel.blank();
                    location.fieldId(field.id());
                    location.documentId(documentId());
                    location.page(locationProperties.pageNum);
                    location.locationX(locationProperties.relativeX);
                    location.locationY(locationProperties.relativeY);
                    location.locationWidth(locationProperties.locationWidth);
                    location.locationHeight(locationProperties.locationHeight);
                    location.fontName(locationProperties.fontName != null && locationProperties.fontName != '' ? locationProperties.fontName : "Arial");
                    location.fontColor(locationProperties.fontColor != null && locationProperties.fontColor != '' ? locationProperties.fontColor : "black");
                    location.fontSize(locationProperties.fontSize != null && locationProperties.fontSize > 0 ? locationProperties.fontSize : 10);
                    location.fontSize(locationProperties.fontSize != null && locationProperties.fontSize > 0 ? locationProperties.fontSize : 10);
                    location.align(locationProperties.align != null ? locationProperties.align : 0);
                    location.fontBold(locationProperties.fontBold != null ? locationProperties.fontBold : false);
                    location.fontItalic(locationProperties.fontItalic != null ? locationProperties.fontItalic : false);
                    location.fontUnderline(locationProperties.fontUnderline != null ? locationProperties.fontUnderline : false);
                    field.locations.push(location);
                },

                updateFieldLocation = function(location, callback) {
                    if (!location) return;
                    if (_.isFunction(callback)) {
                        callback(location);
                    }
                },
                deleteFieldLocation = function(field, location) {


                    field.locations.remove(location);
                    if (field.locations().length == 0) {
                        fields.remove(field);
                    }
                    selectedField(null);
                    selectedLocation(null);
                },
                isValidDate = function(s) {
                    if (!s || s.length == 0) return true;
                    if (s.length != 10) return false;
                    var bits = s.split('.');
                    if (!bits[0] || !bits[1] || !bits[2]) return false;
                    if (bits[2] < 1900 || bits[2] > 2100) return false;
                    var d = new Date(bits[2], bits[1] - 1, bits[0]);
                    return d && (d.getMonth() + 1) == bits[1] && d.getDate() == Number(bits[0]);
                },
                updateField = function(field, callback) {
                    if (!field) return;
                    if (!field.isValid()) {
                        config.alert({ title: "Field not saved", message: 'Field data is not valid' });
                        return;
                    }
                    if (field.fieldType() > 1 && field.fieldType() < 5 && field.defaultValue() != '') {
                        if (field.regularExpression() != null && !field.defaultValue().match(field.regularExpression())) {
                            config.alert({ title: "Field not saved", message: 'Default value is not valid' });
                            return;
                        }
                        if (field.fieldType() == 4 && field.regularExpression() == null && !isValidDate(field.defaultValue())) {
                            config.alert({ title: "Field not saved", message: 'Default date is not valid' });
                            return;
                        }
                    }


                    field.dirtyFlag().reset();

                },


                updateMovedField = function(location, event) {
                    if (!location.selected()) return;
                    clearInterval(timer);
                    timer = setTimeout(function() {
                        if (event.keyCode > -37 && event.keyCode <= 40)
                            updateFieldLocation(location);
                    }, 2000);
                },
                copyFieldLocation = function(field, location) {
                    if (location.selected()) {
                        copiedLocation(location);
                        copiedField(field);
                        cuttedLocation(null);
                        cuttedField(null);
                    }
                },
                cutFieldLocation = function(field, location) {
                    if (location.selected()) {
                        if (field == null) return;
                        cuttedLocation(location);
                        cuttedField(field);
                        copiedLocation(null);
                        copiedField(null);
                        field.locations.remove(location);
                    }
                },
                pasteNewField = function() {
                    if (copiedLocation() != null && copiedField() != null) {
                        var signatureCopiedField = $.grep(signatureFields(), function(a) { return a.fieldType() == copiedField().fieldType(); })[0];
                        addField(signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), true, '', {
                            fontName: copiedLocation().fontName(),
                            fontColor: copiedLocation().fontColor(),
                            fontSize: copiedLocation().fontSize(),
                            fontBold: copiedLocation().fontBold(),
                            fontItalic: copiedLocation().fontItalic(),
                            fontUnderline: copiedLocation().fontUnderline(),
                            align: copiedLocation().align()
                        });
                        copiedLocation(null);
                        copiedField(null);
                        cuttedLocation(null);
                        cuttedField(null);
                    }
                    if (cuttedLocation() != null && cuttedField() != null) {
                        var signatureCuttedField = $.grep(signatureFields(), function(a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                        addField(signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX(), cuttedLocation().locationY(), cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), true, '', {
                            fontName: copiedLocation().fontName(),
                            fontColor: copiedLocation().fontColor(),
                            fontSize: copiedLocation().fontSize(),
                            fontBold: copiedLocation().fontBold(),
                            fontItalic: copiedLocation().fontItalic(),
                            fontUnderline: copiedLocation().fontUnderline(),
                            align: copiedLocation().align()
                        });
                        deleteFieldLocation(cuttedField(), cuttedLocation());
                        copiedLocation(null);
                        copiedField(null);
                        cuttedLocation(null);
                        cuttedField(null);
                    }
                },
                pasteNewLocation = function() {
                    if (copiedLocation() != null && copiedField() != null) {
                        //var documentCopiedField = $.grep(fields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                        //var signatureCopiedField = $.grep(signatureFields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                        addLocation(copiedField(), {
                            pageNum: copiedLocation().page(),
                            relativeX: copiedLocation().locationX() + 0.05,
                            relativeY: copiedLocation().locationY() + 0.05,
                            locationWidth: copiedLocation().locationWidth(),
                            locationHeight: copiedLocation().locationHeight(),
                            fontName: copiedLocation().fontName(),
                            fontColor: copiedLocation().fontColor(),
                            fontSize: copiedLocation().fontSize(),
                            fontBold: copiedLocation().fontBold(),
                            fontItalic: copiedLocation().fontItalic(),
                            fontUnderline: copiedLocation().fontUnderline(),
                            align: copiedLocation().align()
                        });
                        //addField(documentCopiedField != null ? copiedLocation().fieldId() : signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), documentCopiedField != null ? false : true, documentCopiedField != null ? copiedField().name() : '', {
                        //    fontName: copiedLocation().fontName(),
                        //    fontColor: copiedLocation().fontColor(),
                        //    fontSize: copiedLocation().fontSize(),
                        //    fontBold: copiedLocation().fontBold(),
                        //    fontItalic: copiedLocation().fontItalic(),
                        //    fontUnderline: copiedLocation().fontUnderline(),
                        //    align: copiedLocation().align()
                        //});
                        copiedLocation(null);
                        copiedField(null);
                        cuttedLocation(null);
                        cuttedField(null);
                    }
                    if (cuttedLocation() != null && cuttedField() != null) {
                        var documentCuttedField = $.grep(fields(), function(a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                        var signatureCuttedField = $.grep(signatureFields(), function(a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                        addField(documentCuttedField != null ? cuttedLocation().fieldId() : signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX() + 0.05, cuttedLocation().locationY() + 0.05, cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), documentCuttedField != null ? false : true, documentCuttedField != null ? cuttedField().name() : '', {
                            fontName: copiedLocation().fontName(),
                            fontColor: copiedLocation().fontColor(),
                            fontSize: copiedLocation().fontSize(),
                            fontBold: copiedLocation().fontBold(),
                            fontItalic: copiedLocation().fontItalic(),
                            fontUnderline: copiedLocation().fontUnderline(),
                            align: copiedLocation().align()
                        });
                        deleteFieldLocation(cuttedField(), cuttedLocation());
                        copiedLocation(null);
                        copiedField(null);
                        cuttedLocation(null);
                        cuttedField(null);
                    }
                },
                addFieldFromMenu = function(fieldType) {
                    var signatureField = $.grep(signatureFields(), function(a) { return a.fieldType() == fieldType; })[0];
                    var height, width;
                    switch (fieldType) {
                    case 1:
                        //signature
                        height = 46;
                        width = 148;
                        break;
                    case 6:
                        //checkbox
                        height = 25;
                        width = 25;
                        break;
                    default:
                        height = 25;
                        width = 205;
                        break;
                    }
                    addField(signatureField.id(), 1, 0, 0, height, width, true, '');
                },
                selectDefaultValue = function(value) {
                    if (selectedField() != null)
                        selectedField().defaultValue(value);
                },
                addAcceptableValue = function() {
                    newAcceptableValue($.trim(newAcceptableValue()));
                    if ($.grep(newAcceptableValue.errors(), function(error) {
                        return error != null;
                    }).length > 0) {
                        newAcceptableValue.errors.showAllMessages(true);
                        return;
                    };


                    if (selectedField() != null && newAcceptableValue() != '') {
                        if (selectedField().acceptableValuesArray().indexOf(newAcceptableValue()) > -1) {
                            config.alert({ title: "Error", message: "Value already in list" });
                            return;
                        }
                        selectedField().acceptableValuesArray.push(newAcceptableValue());
                        newAcceptableValue('');
                        newAcceptableValue.errors.showAllMessages(false);
                    }

                },
                deleteAcceptableValue = function(value) {
                    $.confirm({
                        title: "Delete Confirmation",
                        message: "Are you sure ?",
                        buttons: {
                            Yes: {
                                action: function() {
                                    selectedField().acceptableValuesArray.remove(value);
                                    if (selectedField().defaultValue() == value)
                                        selectedField().defaultValue('');
                                }
                            },
                            No: {}
                        }
                    });
                },


                resetFields = function() {

                    $.confirm({
                        title: "Reset confirmation",
                        message: "Are you sure you want to reset all fields? This will remove all placed fields.",
                        buttons: {
                            Yes: {
                                action: function() {
                                    fields.removeAll();
                                }
                            },
                            No: {}
                        }
                    });
                },

                isOwnField = function(field) {
                    return true; // compatibilty with envelope viewer 
                },

                regularExpressions = ko.computed(function() {
                    if (selectedField() != null && (selectedField().fieldType() == config.signatureFieldType.SingleLine || selectedField().fieldType() == config.signatureFieldType.SingleLine || selectedField().fieldType() == config.signatureFieldType.Date)) {
                        return config.fieldValidations.filter(function(item) {
                            return $.grep(item.fieldType.split(','), function(e) { return e == selectedField().fieldType(); })[0] != null;
                        });
                    } else
                        return [];
                }),
                getSignatureDocument = function(docGuid, recGuid, callback) {
                    repository.document.getDocument({
                        param: {
                            documentGuid: docGuid,
                            recipientGuid: recGuid
                        },
                        doneCallback: function(docResult) {
                            inprogress(false);
                            if (config.isDownloadable) {
                                activeRecipient().firstName(docResult.result.document.recipient.firstName);
                                activeRecipient().lastName(docResult.result.document.recipient.lastName);
                                activeRecipient().email(docResult.result.document.recipient.email);
                                activeRecipient().userGuid(docResult.result.document.recipient.guid);
                                documentId(docGuid);
                                getDocumentFields();
                            }
                            //if (!docResult.result.document.signedFromAll && !docResult.result.document.recipientSigned)
                            //    getDocumentFields();
                            callback(docResult.result.document);
                        },
                        errorCallback: errorCallback
                    });
                },
                getDocumentFields = function() {
                    repository.document.getFields({
                        param: {
                            recipientGuid:activeRecipient().userGuid(),
                            documentGuid: documentId(),
                            
                        },
                        doneCallback: function(fieldsResult) {
                            if (fieldsResult.length > 0) {
                                $.each(fieldsResult, function() {
                                    var item = this;

                                    fields.push(item);
                                });
                                if (viewerContainer() != null) $(viewerContainer()).trigger("fieldsLoaded.groupdocs", fields().length);
                            }
                        },
                        errorCallback: function() {
                                config.alert({ title: "Error", message: "Error Getting fields" });
                        }
                    });
                },
                viewerContainer = ko.observable(),
                saveFields = function (callback) {
                    inprogress(true);
                    
                    repository.document.saveDocumentsFields({
                        param: {
                            fields: ko.mapping.toJS(fields),
                            documentGuid: documentId(),
                            recipientGuid: activeRecipient().userGuid(),
                        },
                        successCallback: function (response) {
                            if (_.isFunction(callback)) {
                                callback(response.result.document);
                            }
                            if (viewerContainer() != null) $(viewerContainer()).trigger("documentPrepared.groupdocs", response.result);
                            
                        },
                        errorCallback: errorCallback
                    });
                },
                errorCallback = function(error) {

                    config.alert({ title: "Error", message: error });
                    return false;
                };


            ko.validation.group(newAcceptableValue);
            ko.validation.group(newAcceptableValueListName);

            return {
                inprogress:inprogress,
                documentId: documentId,
                cancelPrepare: cancelPrepare,
                previewDocument: previewDocument,
                signatureFields: signatureFields,
                fields: fields,
                pageWidth: pageWidth,
                pageHeight: pageHeight,
                addField: addField,
                updateFieldLocation:updateFieldLocation,
                deleteFieldLocation: deleteFieldLocation,
                updateMovedField: updateMovedField,

                cuttedLocation: cuttedLocation,
                copiedLocation: copiedLocation,
                cuttedField: cuttedField,
                copiedField: copiedField,
                selectedField: selectedField,
                selectedLocation: selectedLocation,
                copyFieldLocation: copyFieldLocation,
                cutFieldLocation: cutFieldLocation,
                pasteNewField: pasteNewField,
                pasteNewLocation: pasteNewLocation,
                addFieldFromMenu: addFieldFromMenu,
                activeRecipient:activeRecipient,

                config: config,
                newAcceptableValue: newAcceptableValue,
                newAcceptableValueListName: newAcceptableValueListName,


                selectDefaultValue: selectDefaultValue,
                addAcceptableValue: addAcceptableValue,
                deleteAcceptableValue: deleteAcceptableValue,

                isOwnField: isOwnField,
                updateField: updateField,
                resetFields: resetFields,

                loadSignatureFields: loadSignatureFields,
                viewerAction: viewerAction,
                getSignatureDocument:getSignatureDocument,
                viewerContainer:viewerContainer,
                regularExpressions: regularExpressions,
                saveFields: saveFields,
                dateFormats: dateFormats,
                selectedFieldType: selectedFieldType
            };
        }
        return getInstance;
    });
define('core/vm/vm.document.sign',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function ($, ko, _, repository, configuration, redirect) {

        function getInstance() {
            var viewerAction = 'sign',
                config = configuration,
                documentId = ko.observable(),
                isPublic = ko.observable(true),
                inprogress = ko.observable(false),
                signature = ko.observable(''),
                fields = ko.observableArray([]),
                signatureFields = ko.observableArray([]),
                name = ko.observable(''),
                email = ko.observable(''),
                isOwnField = ko.observable(true),
                documentGuid = ko.observable(),
                recipientGuid = ko.observable(),
                relativeCorrection = ko.observable(1),
                hasCalcFields = ko.observable(false),
                recipient = {
                    firstName: ko.observable(''),
                    lastName: ko.observable(''),
                    email: ko.observable('')
                },
                signDocument = function(callback) {
                    inprogress(true);
                    var fieldsData = [];
                    ko.utils.arrayForEach(fields(), function(item) {
                        var field = {
                            fieldType: item.fieldType(),
                            data: item.data(),
                            locations: [],
                            id: item.id()
                        };
                        _.each(item.locations(), function(l) {
                            var location = {
                                page: l.page(),
                                locationX: l.locationX(),
                                locationY: l.locationY(),
                                locationWidth: l.locationWidth(),
                                locationHeight: l.locationHeight(),
                                fontName: l.fontName != null ? l.fontName() : null,
                                fontSize: l.fontSize != null ? l.fontSize() : null,
                                fontColor: l.fontColor != null ? l.fontColor() : null,
                                fontBold: l.fontBold != null ? l.fontBold() : null,
                                fontItalic: l.fontItalic != null ? l.fontItalic() : null,
                                fontUnderline: l.fontUnderline != null ? l.fontUnderline() : null,
                                alignment: l.align != null ? l.align() : null,
                                id: l.id != null ? l.id() : null
                            };
                            field.locations.push(location);
                        });
                        fieldsData.push(field);
                    });
                    repository.document.signDocument({
                        param: {
                            documentId: documentId(),
                            name: name(),
                            waterMarkText: '',
                            waterMarkImage: '',
                            fields: fieldsData,
                            documentGuid: documentGuid(),
                            recipientGuid: recipientGuid(),
                            email:email()
                        },
                        successCallback: function(response) {
                            if (!config.isDownloadable)
                                getDocumentStatus(response.result.jobId);
                            else {
                                if (_.isFunction(callback)) {
                                    callback(response.result.document);
                                }
                                if (viewerContainer() != null) $(viewerContainer()).trigger("documentSigned.groupdocs", response.result);
                            }
                        },
                        errorCallback: errorCallback
                    });
                },
                getDocumentStatus = function(jobId) {
                    repository.document.getStatus({
                        param: {
                            jobId: jobId
                        },
                        doneCallback: function(response) {
                            if (response.result.documents.length == 1) {
                                if (response.result.documents[0].status == 1) {
                                    setTimeout(function() {
                                        getDocumentStatus(jobId);
                                    }, 2000);
                                } else {
                                    inprogress(false);
                                    if (!isPublic())
                                        redirect.viewDocument(response.result.documents[0].documentId);
                                    else
                                        redirect.viewDocumentEmbed(response.result.documents[0].documentId);
                                }
                            }
                        },
                        errorCallback: errorCallback
                    });
                },
                errorCallback = function(error) {
                    if (config.viewerContainer != null) $(config.viewerContainer).trigger("error.groupdocs", error);
                    config.alert({ title: "Error", message: error });
                    return false;
                },
                updateFieldLocation = function() {
                },
                addField = function(fieldId, pageNum, relativeX, relativeY, height, width, forceNew, fieldName) {
                    var field = _.find(fields(), function(f) { return f.fieldId() == fieldId; });
                    if (!field) return;
                    field.locations.push(
                        {
                            page: ko.observable(pageNum),
                            locationY: ko.observable(relativeY),
                            locationX: ko.observable(relativeX),
                            locationWidth: ko.observable(width),
                            locationHeight: ko.observable(height),
                            selected: ko.observable(true),
                            fieldId: ko.observable('signature'),
                            locked: ko.observable(false)
                        });
                },
                fieldsToBeFilled = function () {
                    if (!fields() || fields().length == 0)
                        return -1;
                    var invalidFields = 0;
                    $.each(fields(), function() {
                        if (isOwnField(this)) {
                            if (!this.isValid()) {
                                invalidFields++;
                            }
                        }
                    });
                    return invalidFields;
                },
                createDefaultField = function () {
                    fields.push(repository.document.getDefaultField());
                },
                getSignatureDocument = function(docGuid, recGuid, callback) {
                    repository.document.getDocument({
                        param: {
                            documentGuid: docGuid,
                            recipientGuid: recGuid
                        },
                        doneCallback: function (docResult) {
                            inprogress(false);
                            if (config.isDownloadable) {
                                recipient.firstName(docResult.result.document.recipient.firstName);
                                recipient.lastName(docResult.result.document.recipient.lastName);
                                recipient.email(docResult.result.document.recipient.email);
                            }
                            if (!docResult.result.document.signedFromAll && !docResult.result.document.recipientSigned)
                                getDocumentFields();
                            callback(docResult.result.document);
                        },
                        errorCallback: errorCallback
                    });
                },
                getDocumentFields = function() {
                    repository.document.getFields({
                        param: {
                            documentId: documentId(),
                            documentGuid: documentGuid(),
                            recipientGuid: recipientGuid()
                        },
                        doneCallback: function (fieldsResult) {
                            if (fieldsResult.length > 0) {
                                $.each(fieldsResult, function () {
                                    var item = this;
                                    var validators = {};
                                    if (item.fieldType() != configuration.signatureFieldType.Date) {
                                        if (item.regularExpression() != null && item.regularExpression() != '') {
                                            var validation = $.grep(config.fieldValidations, function (r) { return r.expression == item.regularExpression(); });
                                            var errorMessage;
                                            if (validation.length > 0) {
                                                errorMessage = validation[0].name;
                                            } else {
                                                errorMessage = config.validationMessages.invalidValue;
                                            }
                                            validators.pattern = { params: item.regularExpression(), message: errorMessage };
                                        }
                                    }
                                    if (item.mandatory()) {
                                        validators.required = { message: (item.tooltip() != '' ? item.tooltip() : item.name()) + " - " + config.validationMessages.requiredNoStar };
                                        if (item.fieldType() == configuration.signatureFieldType.Checkbox)
                                            validators.validation = {
                                                validator: function (val) {
                                                    return val && val == 'on';
                                                }
                                            };
                                    }
                                    if ((item.data() == null || item.data() == '') && item.defaultValue() != null && item.defaultValue() != '') {
                                        if (item.fieldType() == config.signatureFieldType.File || item.fieldType() == config.signatureFieldType.Stamp) {
                                            item.data(JSON.stringify({ data: item.defaultValue() }));
                                        } else {
                                            item.data(item.defaultValue());
                                        }
                                    }
                                    ko.utils.arrayForEach(item.locations(), function(location) {
                                        $.extend(location, { locked: ko.observable(item.lockDuringSign()) });
                                    });
                                    item.data.extend(validators);
                                    fields.push(item);
                                    if (!hasCalcFields() && item.isCalcField()) hasCalcFields(true);
                                });
                                if (viewerContainer() != null) $(viewerContainer()).trigger("fieldsLoaded.groupdocs", fields().length);
                            } else {
                                if (!recipientGuid() || recipientGuid()=='')
                                    createDefaultField();
                                else
                                    config.alert({ title: "Error", message: "There are no defined fields for this recipient" });
                            }
                        },
                        errorCallback: function () {
                            if (!recipientGuid() || recipientGuid() == '')
                                createDefaultField();
                            else
                                config.alert({ title: "Error", message: "There are no defined fields for this recipient" });
                        }
                    });
                },
                viewerContainer = ko.observable(),
                fileUploaded = function (field, location, evt) {
                    if (config.checkFileApiSupport()) {
                        var frField = new FileReader();
                        frField.onload = function (e) {
                            field.data(JSON.stringify({
                                size: evt.target.files[0].size,
                                type: evt.target.files[0].type,
                                name: evt.target.files[0].name,
                                data: e.target.result
                            }));
                        };
                        frField.readAsDataURL(evt.target.files[0]);
                    } else {
                        requirejs(['lib/fileApi/FileAPI'], function () {
                            var files = FileAPI.getFiles(evt);
                            FileAPI.readAsDataURL(files[0], function (dataUrlObject) {
                                if (dataUrlObject.type == 'load') {
                                    field.data(JSON.stringify({
                                        size: files[0].size,
                                        type: files[0].type,
                                        name: files[0].name,
                                        data: dataUrlObject.result
                                    }));
                                }
                            });
                        });
                    }
                },

                init = function () {
                    fields.removeAll();
                    if (!isPublic()) {
                        repository.field.getFields({
                            itemsResult: signatureFields,
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey()
                            },
                            doneCallback: function(signaturefieldsResult) {
                                inprogress(false);

                            },
                            errorCallback: errorCallback
                        });

                    }
                    if (documentId()!="")
                        getDocumentFields();
                };

            //init();

            return {
                init: init,
                viewerAction: viewerAction,
                config: config,
                documentId: documentId,
                isPublic: isPublic,
                inprogress: inprogress,
                signDocument: signDocument,
                signature: signature,
                signatureFields: signatureFields,
                fields: fields,
                updateFieldLocation: updateFieldLocation,
                addField: addField,
                name: name,
                isOwnField: isOwnField,
                fieldsToBeFilled: fieldsToBeFilled,
                documentGuid: documentGuid,
                recipientGuid: recipientGuid,
                getSignatureDocument: getSignatureDocument,
                viewerContainer: viewerContainer,
                relativeCorrection: relativeCorrection,
                email: email,
                fileUploaded: fileUploaded,
                recipient: recipient,
                hasCalcFields: hasCalcFields
            };
        }

        return getInstance;
    });
define('core/vm/vm.embedlink',
    ['jquery',
        'ko'
    ],
    function ($, ko) {
        var link = ko.observable(),
            title = ko.observable(),
            isVisible = ko.observable(false),
            doOnKeyUp = function (event) {
                if (!isVisible()) return true;
                var keyCode = (event.which ? event.which : event.keyCode);
                if (keyCode === 27) {
                    isVisible(false);
                    return false;
                }
                return true;
            };
        return {
            link: link,
            isVisible: isVisible,
            doOnKeyUp: doOnKeyUp,
            title:title
        };
    });
define('core/vm/vm.entername',
    ['ko', 'core/config'],
    function (ko, config) {

        function getInstance() {
            var isVisible = ko.observable(false),
                onNameSet = ko.observable().extend({ notify: 'always' }),
                requireUserAuthForSign = ko.observable(false),
                requestUserAuthByPhoto = ko.observable(false),
                canCapture = ko.observable(false),
                requestComment = ko.observable(false),
                userIdentedByEmail = ko.observable(false),
                signerName = {
                    firstName: ko.escapedObservable("").extend({ throttle: 500, required: { message: config.validationMessages.required } }),
                    lastName: ko.escapedObservable("").extend({ throttle: 500, required: { message: config.validationMessages.required } }),
                    authData:  ko.observable(),
                    comment: ko.escapedObservable(""),// : ko.observable(null).extend({ throttle: 500, required: { message: config.validationMessages.required } })
                    email: ko.escapedObservable("").extend({ email: { message: config.validationMessages.invalidEmail }, required: { message: config.validationMessages.required } }),
                },
                closeDialog = function() {
                    isVisible(false);
                },
                setName = function() {
                    if (!signerName.isValid()) {
                        signerName.errors.showAllMessages(true);
                        return;
                    }
                    isVisible(false);
                    onNameSet(signerName.firstName() + ' ' + signerName.lastName());
                },
                setDefaultName = function (firstName, lastName, userPrimaryEmail) {
                    signerName.firstName(firstName);
                    signerName.lastName(lastName);
                    signerName.email(userPrimaryEmail);
                },
                captureInfoText = ko.computed(function () {
                    var result = "";
                    if (requireUserAuthForSign()) {
                        result = "The owner of the form required you to authorize the signature \n";
                        result += canCapture() ? "Please capture a picture from your webcam" : "Your browser does not support this operation - you can't sign the form";
                    } else {
                        if (requestUserAuthByPhoto() && canCapture()) {
                           result = "The owner of the form requested you to authorize the signature \n";
                           result +=  "Please capture a picture from your webcam";
                       }
                    }
                    return result;
                }),
                captureInfoTextCss = ko.computed(function () {
                    var result = "small_text";
                    if (!canCapture() && requireUserAuthForSign())
                        result = "errorMessage";
                    return result;
                });

            requireUserAuthForSign.subscribe(function(value) {
                if (value) {
                    signerName.authData = ko.observable(null).extend({ throttle: 500, required: { message: config.validationMessages.required } });
                    ko.validation.group(signerName);
                }
            });
            ko.validation.group(signerName);

            return {
                signerName: signerName,
                isVisible: isVisible,
                closeDialog: closeDialog,
                setName: setName,
                onNameSet: onNameSet,
                setDefaultName: setDefaultName,
                requireUserAuthForSign:requireUserAuthForSign,
                requestUserAuthByPhoto: requestUserAuthByPhoto,
                captureInfoText: captureInfoText,
                canCapture: canCapture,
                captureInfoTextCss: captureInfoTextCss,
                requestComment: requestComment,
                userIdentedByEmail: userIdentedByEmail
            };
        }
        return getInstance;
    });
define('core/vm/vm.envelope.prepare',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            envelope = ko.observable(),
            documents = ko.observableArray([]),
            loadEnvelope = function(envelopeId, callback) {
                inprogress(true);
                repository.envelope.getEnvelope({
                    itemsResult: envelope,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            loadDocuments = function (envelopeId, callback) {
                inprogress(true);
                documents.removeAll();
                repository.envelopeDocument.getDocuments({
                    documentResult: documents,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            updateEnvelope = function (callback) {
                inprogress(true);
                repository.envelope.renameEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        name: envelope().name(),
                    },
                    doneCallback: function(renameResult) {
                        repository.envelope.updateEnvelope({
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                envelopeId: envelope().id(),
                                name: envelope().name(),
                                emailBody: envelope().emailBody(),
                                emailSubject: envelope().emailSubject(),
                                envelopeExpireTime: envelope().envelopeExpireTime(),
                                orderedSignature: envelope().orderedSignature(),
                                ownerShouldSign: envelope().ownerShouldSign(),
                                reminderTime: envelope().reminderTime(),
                                stepExpireTime: envelope().stepExpireTime(),
                                waterMarkText: envelope().waterMarkText(),
                                waterMarkImage: envelope().waterMarkImage(),
                                attachSignedDocument: envelope().attachSignedDocument(),
                                includeViewLink: envelope().includeViewLink(),
                                canBeCommented: envelope().canBeCommented(),
                                inPersonSign: envelope().inPersonSign(),
                                enableTypedSignature: envelope().enableTypedSignature(),
                                enableUploadedSignature: envelope().enableUploadedSignature(),
                                requireUserAuthForSign: envelope().requireUserAuthForSign(),
                                requestUserAuthByPhoto: envelope().requestUserAuthByPhoto(),
                                showRecipientCommentInSignedDocument: envelope().showRecipientCommentInSignedDocument(),
                                tags: envelope().tags()
                            },
                            doneCallback: function(envelopeResult) {
                                inprogress(false);
                                updateRecipientsOrder(function () {
                                    if (_.isFunction(callback))
                                        callback();
                                    else
                                        redirect.envelopeDashboard();
                                },true);
                        },
                            errorCallback: errorCallback
                        });
                    },
                    errorCallback: errorCallback
                });
            },
            sendEnvelope = function () {
                updateRecipientsOrder(function() {
                    updateEnvelope(function() {
                        repository.envelope.sendEnvelope({
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                envelopeId: envelope().id()
                            },
                            doneCallback: function() {
                                inprogress(false);
                                  redirect.envelopeDashboard();
                            },
                            errorCallback: errorCallback
                        });
                    });
                });
            },
            sendAndSign = function() {
                updateRecipientsOrder(function () {
                    updateEnvelope(function () {
                        repository.envelope.sendEnvelope({
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                envelopeId: envelope().id()
                            },
                            doneCallback: function () {
                                inprogress(false);
                                if (envelope().inPersonSign())
                                    redirect.embedEnvelopeSign(envelope().id(), envelope().recipients()[0].id());
                                else
                                    redirect.envelopeSign(envelope().id());
                            },
                            errorCallback: errorCallback
                        });
                    });
                });
            },
            cancelPrepare = function() {
                redirect.envelopeDashboard();
            },
            updateRecipientsOrder = function (sucessCallback, forceUpdate) {
                if (typeof(forceUpdate) == "undefined" || forceUpdate == false) {
                    if (_.filter(envelope().recipients(), function (rec) { return rec.dirtyFlag().isDirty() == true }).length == 0) {
                        if (_.isFunction(sucessCallback))
                            sucessCallback();
                        return;
                    }
                }
                var $deferreds = [];
                for (var i = 0; i < envelope().recipients().length; i++) {
                    var recipient = envelope().recipients()[i];
                    if (recipient.isValid()) {
                        recipient.order(i);
                        $deferreds[i] = $.Deferred(function(def) {

                            repository.envelopeRecipient.updateRecipient({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    envelopeId: envelope().id,
                                    recipientId: recipient.id(),
                                    recipientEmail: recipient.email(),
                                    recipientFirstName: recipient.firstName(),
                                    recipientLastName: recipient.lastName(),
                                    roleId: function() {
                                        switch (recipient.roleId()) {
                                        case 1:
                                            return "58416f6827eb612fef7750b62cf2bf9a";
                                        case 2:
                                            return "693e6cee8a4a21285f86930491b455ec";
                                        default:
                                            return "6df1056f4d9a27ec34698552a6372a68";
                                        }
                                    },
                                    order: recipient.order()
                                },
                                successCallback: function (recipientResult) {
                                    recipient.dirtyFlag().reset();
                                    def.resolve(recipientResult);
                                },
                                errorCallback: function(error) {
                                    def.reject(error);
                                }
                            });
                        }).promise();
                    }
                }
                $.when.apply(null, $deferreds).then(function () {
                    if (_.isFunction(sucessCallback))
                        sucessCallback();
                });

            },
            updateEnvelopeInfo = function (callback) {
                if (envelope().dirtyFlagInfo().isDirty() == false) return;
                inprogress(true);
                repository.envelope.renameEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        name: envelope().name(),
                    },
                    doneCallback: function (renameResult) {
                        repository.envelope.updateEnvelope({
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                envelopeId: envelope().id(),
                                name: envelope().name(),
                                emailBody: envelope().emailBody(),
                                emailSubject: envelope().emailSubject(),
                                envelopeExpireTime: envelope().envelopeExpireTime(),
                                orderedSignature: envelope().orderedSignature(),
                                ownerShouldSign: envelope().ownerShouldSign(),
                                reminderTime: envelope().reminderTime(),
                                stepExpireTime: envelope().stepExpireTime(),
                                waterMarkText: envelope().waterMarkText(),
                                waterMarkImage: envelope().waterMarkImage(),
                                attachSignedDocument: envelope().attachSignedDocument(),
                                includeViewLink: envelope().includeViewLink(),
                                canBeCommented: envelope().canBeCommented(),
                                inPersonSign: envelope().inPersonSign(),
                                enableTypedSignature: envelope().enableTypedSignature(),
                                enableUploadedSignature: envelope().enableUploadedSignature(),
                                requireUserAuthForSign: envelope().requireUserAuthForSign(),
                                requestUserAuthByPhoto: envelope().requestUserAuthByPhoto(),
                                showRecipientCommentInSignedDocument: envelope().showRecipientCommentInSignedDocument(),
                                tags: envelope().tags()
                            },
                            doneCallback: function (envelopeResult) {
                                inprogress(false);
                                envelope().dirtyFlagInfo().reset();
                                if (_.isFunction(callback))
                                    callback();
                            },
                            errorCallback: errorCallback
                        });
                    },
                    errorCallback: errorCallback
                });
            },
            updateEnvelopeReminders = function (callback) {
                //console.log(envelope().tags());

                if (envelope().dirtyFlagReminders().isDirty() == false) return;
                inprogress(true);
                repository.envelope.updateEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        name: envelope().name(),
                        emailBody: envelope().emailBody(),
                        emailSubject: envelope().emailSubject(),
                        envelopeExpireTime: envelope().envelopeExpireTime(),
                        orderedSignature: envelope().orderedSignature(),
                        ownerShouldSign: envelope().ownerShouldSign(),
                        reminderTime: envelope().reminderTime(),
                        stepExpireTime: envelope().stepExpireTime(),
                        waterMarkText: envelope().waterMarkText(),
                        waterMarkImage: envelope().waterMarkImage(),
                        attachSignedDocument: envelope().attachSignedDocument(),
                        includeViewLink: envelope().includeViewLink(),
                        canBeCommented: envelope().canBeCommented(),
                        inPersonSign: envelope().inPersonSign(),
                        enableTypedSignature: envelope().enableTypedSignature(),
                        enableUploadedSignature: envelope().enableUploadedSignature(),
                        requireUserAuthForSign: envelope().requireUserAuthForSign(),
                        requestUserAuthByPhoto: envelope().requestUserAuthByPhoto(),
                        showRecipientCommentInSignedDocument: envelope().showRecipientCommentInSignedDocument(),
                        tags: envelope().tags()
                    },
                    doneCallback: function (envelopeResult) {
                        inprogress(false);
                        envelope().dirtyFlagReminders().reset();
                        if (_.isFunction(callback))
                            callback();
                    },
                    errorCallback: errorCallback
                });

                   
            },
            canSign = ko.computed(function () {
                if (!envelope())
                    return false;
                var signers = _.filter(envelope().recipients(), function (rec) { return rec.role() != 'CC'; });
                return signers.length == 1 && signers[0].role() == 'Owner';

            }),
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };
        
        return {
            inprogress: inprogress,
            envelope: envelope,
            documents: documents,
            loadEnvelope: loadEnvelope,
            updateEnvelope: updateEnvelope,
            sendEnvelope: sendEnvelope,
            cancelPrepare: cancelPrepare,
            loadDocuments: loadDocuments,
            updateRecipientsOrder: updateRecipientsOrder,
            updateEnvelopeInfo: updateEnvelopeInfo,
            updateEnvelopeReminders: updateEnvelopeReminders,
            sendAndSign: sendAndSign,
            canSign: canSign
        };
    });
define('core/vm/vm.envelope.prepare.step1',
    ['ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            documents = ko.observableArray([]),
            parseFields = ko.observable(false),
            templates = ko.observableArray([]),
            selectedTemplate = ko.observable(),
            newName = ko.observable('').extend({ required: { message: config.validationMessages.required } }),
            loadDocuments = function (envelopeId, callback) {
                inprogress(true);
                documents.removeAll();
                repository.envelopeDocument.getDocuments({
                    documentResult: documents,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            loadTemplates = function(callback) {
                repository.template.getTemplates(
                    doneCallback = function (templateResult) {
                        inprogress(false);
                        var tmpTemplates = ko.observableArray([]);
                        _.each(templateResult, function (tpl) {
                            if (tpl.documentsCount() >0  && tpl.fieldsCount() > 0) {
                                $.extend(tpl, { selected: ko.observable(false) });
                                tmpTemplates.push(tpl);
                            }
                        });
                        templates(tmpTemplates());
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback
                );
            },
            addDocument = function (envelopeId, fileId) {
                inprogress(true);
                repository.envelopeDocument.addDocument({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId,
                        documentId: fileId,
                        parseFields: parseFields(),
                        order: 0
                    },
                    doneCallback: function(documentResult) {
                        inprogress(false);
                        documents.push(documentResult);
                    },
                    errorCallback: function(error) {
                        if (error.indexOf("document is already in the") == -1) {
                            errorCallback(error);
                            return;
                        }
                        
                        var doc = _.find(documents(), function(d) {
                            return d.documentId == fileId;
                        });
                        if (doc) {
                            errorCallback(error);
                            return;
                        }
                        inprogress(false);
                        loadDocuments(envelopeId);
                    }
                });
            },
            removeDocument = function(envelopeId, fileId) {
                inprogress(true);
                repository.envelopeDocument.removeDocument({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId,
                        documentId: fileId,
                        order: 0
                    },
                    doneCallback: function() {
                        inprogress(false);
                        documents.remove($.grep(documents(), function(a) { return a.documentId() == fileId(); })[0]);
                    },
                    errorCallback: errorCallback
                });

            },
            viewDocument = function (fileId) {
                redirect.viewDocument(fileId);
            },
            renameDocument = function (document, callback) {
                if (newName() == '')
                    return;
                repository.envelopeDocument.renameDocument(document.envelopeId(), document.documentId(), newName(),
                    function (response) {
                        document.name(response.result.document.name);
                        if (_.isFunction(callback)) {
                            callback(response);
                        }
                    },
                    errorCallback);
            },
            selectTemplate = function (template) {
                if (template.selected()) {
                    $.each(templates().filter(function (fltItem) {
                        return fltItem.selected() && fltItem.id != template.id;
                    }), function () {
                        this.selected(false);
                    });
                    selectedTemplate(template);
                }
            },
            addFromTemplate = function (envelopeId, callback) {

                if (selectedTemplate() == null) return;
                repository.envelope.updateEnvelopeFromTemplate(envelopeId, selectedTemplate().id(),
                    doneCallback = function (data) {
                        repository.envelopeDocument.getDocuments({
                            documentResult: documents,
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                envelopeId: data.result.envelope.id
                            },
                            doneCallback: function (result) {
                                inprogress(false);
                                if (_.isFunction(callback)) {
                                    callback(result);
                                }
                            },
                            errorCallback: errorCallback
                        });
                    },
                    errorCallback
                );

            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };

        return {
            inprogress: inprogress,
            documents: documents,
            parseFields: parseFields,
            addDocument: addDocument,
            removeDocument: removeDocument,
            viewDocument: viewDocument,
            renameDocument: renameDocument,
            newName: newName,
            addFromTemplate: addFromTemplate,
            selectTemplate: selectTemplate,
            templates: templates,
            selectedTemplate: selectedTemplate,
            loadTemplates: loadTemplates
        };
    });
define('core/vm/vm.envelope.prepare.step2',
    ['ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            envelope = ko.observable(),
            contacts = ko.observableArray([]),
            newRecipient = {
                firstName: ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'First name too long' } }),
                lastName: ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'Last name too long' } }),
                email: ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, email: { message: config.validationMessages.invalidEmail }, noSpaces: {} }),
                role: ko.observable(2)
            },
            addOwnerAsRecipient = function(callback) {
                inprogress(true);
                repository.envelope.updateEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        emailBody: envelope().emailBody(),
                        emailSubject: envelope().emailSubject(),
                        envelopeExpireTime: envelope().envelopeExpireTime(),
                        orderedSignature: envelope().orderedSignature(),
                        ownerShouldSign: true,
                        reminderTime: envelope().reminderTime(),
                        stepExpireTime: envelope().stepExpireTime(),
                        waterMarkText: envelope().waterMarkText(),
                        waterMarkImage: envelope().waterMarkImage(),
                        attachSignedDocument: envelope().attachSignedDocument(),
                        includeViewLink: envelope().includeViewLink(),
                        canBeCommented: envelope().canBeCommented(),
                        inPersonSign: envelope().inPersonSign(),
                        enableTypedSignature: envelope().enableTypedSignature(),
                        enableUploadedSignature: envelope().enableUploadedSignature(),
                        requireUserAuthForSign: envelope().requireUserAuthForSign(),
                        requestUserAuthByPhoto: envelope().requestUserAuthByPhoto(),
                        showRecipientCommentInSignedDocument: envelope().showRecipientCommentInSignedDocument(),
                        tags: envelope().tags()
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        envelope().ownerShouldSign(true);
                        envelope().recipients.push($.grep(result.recipients(), function (a) { return a.roleId() == 1; })[0]);
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            addRecipient = function (recipient, callback) {
                if (inprogress() == true)
                    return;
                var recipientToBeAdded;
                if (recipient != null) {
                    recipientToBeAdded = recipient;
                } else {
                    recipientToBeAdded = newRecipient;
                }
                if (!recipientToBeAdded.isValid()) {
                    recipientToBeAdded.errors.showAllMessages(true);
                    return;
                }
                if (recipientToBeAdded.email() == config.userEmail()) {
                    if (envelope().ownerShouldSign()) {
                        config.alert({ title: "Error", message: "Owner already added" });
                        return;
                    }
                    addOwnerAsRecipient(function(envelopeResult) {
                        newRecipient.firstName('');
                        newRecipient.lastName('');
                        newRecipient.email('');
                        newRecipient.role(2);
                        newRecipient.errors.showAllMessages(false);
                        if (_.isFunction(callback)) {
                            callback($.grep(envelopeResult.recipients(), function (a) { return a.roleId() == 1; })[0]);
                        }
                    });
                    return;
                }
                inprogress(true);
                repository.envelopeRecipient.addRecipient({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id,
                        recipientEmail: recipientToBeAdded.email(),
                        recipientFirstName: recipientToBeAdded.firstName(),
                        recipientLastName: recipientToBeAdded.lastName(),
                        roleId: function () {
                            switch (newRecipient.role()) {
                                case 1:
                                    return "58416f6827eb612fef7750b62cf2bf9a";
                                case 2:
                                    return "693e6cee8a4a21285f86930491b455ec";
                                default:
                                    return "6df1056f4d9a27ec34698552a6372a68";
                            }
                        },
                        order: envelope().recipients().length
                    },
                    successCallback: function (recipientResult) {
                        inprogress(false);
                        envelope().recipients.push(recipientResult);
                        newRecipient.firstName('');
                        newRecipient.lastName('');
                        newRecipient.email('');
                        newRecipient.role(2);
                        newRecipient.errors.showAllMessages(false);
                        if (_.isFunction(callback)) {
                            callback(recipientResult);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            removeRecipient = function (recipient, callback) {
                inprogress(true);
                if (recipient.roleId() == 1) {
                    repository.envelope.updateEnvelope({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            envelopeId: envelope().id(),
                            emailBody: envelope().emailBody(),
                            emailSubject: envelope().emailSubject(),
                            envelopeExpireTime: envelope().envelopeExpireTime(),
                            orderedSignature: envelope().orderedSignature(),
                            ownerShouldSign: false,
                            reminderTime: envelope().reminderTime(),
                            stepExpireTime: envelope().stepExpireTime(),
                            waterMarkText: envelope().waterMarkText(),
                            waterMarkImage: envelope().waterMarkImage(),
                            attachSignedDocument: envelope().attachSignedDocument(),
                            includeViewLink: envelope().includeViewLink(),
                            canBeCommented: envelope().canBeCommented(),
                            inPersonSign: envelope().inPersonSign(),
                            enableTypedSignature: envelope().enableTypedSignature(),
                            enableUploadedSignature: envelope().enableUploadedSignature(),
                            requireUserAuthForSign: envelope().requireUserAuthForSign(),
                            requestUserAuthByPhoto: envelope().requestUserAuthByPhoto(),
                            showRecipientCommentInSignedDocument: envelope().showRecipientCommentInSignedDocument(),
                            tags: envelope().tags()
                        },
                        doneCallback: function (result) {
                            inprogress(false);
                            envelope().ownerShouldSign(false);
                            envelope().recipients.remove($.grep(envelope().recipients(), function (a) { return a.roleId() == 1; })[0]);
                            if (_.isFunction(callback)) {
                                callback(result);
                            }
                        },
                        errorCallback: errorCallback
                    });
                } else {
                    repository.envelopeRecipient.removeRecipient({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            envelopeId: envelope().id,
                            recipientId: recipient.id()
                        },
                        successCallback: function (result) {
                            inprogress(false);
                            envelope().recipients.remove($.grep(envelope().recipients(), function (a) { return a.id() == recipient.id(); })[0]);
                            if (_.isFunction(callback)) {
                                callback(result);
                            }
                        },
                        errorCallback:errorCallback
                    });
                }
            },
            updateRecipient = function (recipient, callback) {
                if (!recipient.isValid()) {
                    recipient.errors.showAllMessages(true);
                    return;
                }
                inprogress(true);
                repository.envelopeRecipient.updateRecipient({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id,
                        recipientId: recipient.id(),
                        recipientEmail: recipient.email(),
                        recipientFirstName: recipient.firstName(),
                        recipientLastName: recipient.lastName(),
                        roleId: function () {
                            switch (recipient.roleId()) {
                                case 1:
                                    return "58416f6827eb612fef7750b62cf2bf9a";
                                case 2:
                                    return "693e6cee8a4a21285f86930491b455ec";
                                default:
                                    return "6df1056f4d9a27ec34698552a6372a68";
                            }
                        },
                        order: ko.utils.arrayIndexOf(envelope().recipients(), recipient)
                    },
                    successCallback: function (recipientResult) {
                        inprogress(false);
                        recipient.errors.showAllMessages(false);
                        if (_.isFunction(callback)) {
                            callback(recipientResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            loadContacts = function (callback) {
                inprogress(true);
                repository.contact.getContacts({
                    itemsResult: contacts,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        count: 2147483647
                    },
                    doneCallback: function (contactsResult) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(contactsResult);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };

        ko.validation.group(newRecipient);
        
        return {
            inprogress: inprogress,
            envelope: envelope,
            contacts: contacts,
            newRecipient: newRecipient,
            addOwnerAsRecipient: addOwnerAsRecipient,
            addRecipient: addRecipient,
            removeRecipient: removeRecipient,
            updateRecipient: updateRecipient,
            loadContacts: loadContacts
        };
    });
define('core/vm/vm.envelope.prepare.step3',
    ['ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            envelope = ko.observable(),
            messageInvalidSettings = "Cannot have In-person sign and Sequential signing",
            inPersonSign = ko.computed({
                read: function () {
                    if (envelope())
                        return envelope().inPersonSign();
                    else
                        return false;
                },
                write: function (value) {
                    if (value && orderedSignature())
                        config.alert({ title: "Error", message: messageInvalidSettings });
                    else
                        envelope().inPersonSign(value);
                },
                owner: this
            }),
            orderedSignature = ko.computed({
                read: function () {
                    if (envelope())
                        return envelope().orderedSignature();
                    else
                        return false;
                },
                write: function (value) {
                    if (value && inPersonSign())
                        config.alert({ title: "Error", message: messageInvalidSettings });
                    else
                        envelope().orderedSignature(value);
                },
                owner: this
            });
            
        return {
            inprogress: inprogress,
            envelope: envelope,
            inPersonSign: inPersonSign,
            orderedSignature: orderedSignature
        };
    });
define('core/vm/vm.envelope.prepare.step4',
    ['ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function (ko, _, repository, configuration, redirect) {
        var inprogress = ko.observable(false),
            envelope = ko.observable();

        return {
            inprogress: inprogress,
            envelope: envelope
        };
    });
define('core/vm/vm.envelope.prepare.step5',
    ['ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function (ko, _, repository, configuration, redirect) {
        var inprogress = ko.observable(false),
            viewerAction = 'prepare',
            config = configuration,
            envelope = ko.observable(),
            signatureFields = ko.observableArray([]),
            recipients = ko.computed(function() {
                try {
                    return ko.utils.arrayFilter(envelope().recipients(), function(recipient) {
                        return recipient.roleId() != 3;
                    });
                } catch(e) {
                    return [];
                }
            }),
            fields = ko.observableArray([]),
            documents = ko.observableArray([]),
            previewDocument = ko.observable(),
            previewRecipient = ko.observable(),
            pageWidth = ko.observable(850),
            pageHeight = ko.observable(1200),
            timer,
            cuttedLocation = ko.observable(),
            copiedLocation = ko.observable(),
            cuttedField = ko.observable(),
            copiedField = ko.observable(),
            selectedField = ko.observable(),
            selectedLocation = ko.observable(),
            predefinedLists = ko.observableArray([]),
            selectedPredefinedList = ko.observable(),
            fieldsLoaded = ko.observable(false),
            newAcceptableValue = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            newAcceptableValueListName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            regularExpressions = ko.computed(function () {
                if (selectedField()!=null && (selectedField().fieldType() == configuration.signatureFieldType.SingleLine || selectedField().fieldType() == configuration.signatureFieldType.SingleLine || selectedField().fieldType() == configuration.signatureFieldType.Date)) {
                    return configuration.fieldValidations.filter(function(item) {
                        return $.grep(item.fieldType.split(','), function (e) { return e == selectedField().fieldType(); })[0] != null;
                    });
                } else
                    return [];
            }),
            init = function(callback) {
                inprogress(true);
                repository.field.getFields({
                    itemsResult: signatureFields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey()
                    },
                    doneCallback: function(fieldsResult) {
                        repository.predefinedList.getPredefinedLists({
                            itemsResult: predefinedLists,
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey()
                            },
                            doneCallback: function(listsResult) {
                                inprogress(false);
                                if (_.isFunction(callback)) {
                                    callback(fieldsResult, listsResult);
                                }
                            },
                            errorCallback:errorCallback
                        });
                    },
                    errorCallback:errorCallback
                });


            },
            isOwnField = function(field) {
                return previewRecipient() != null ? field.recipientId() == previewRecipient().id() : false;
            },
            getRecipientNameById = function(recipientId) {
                if (envelope() != null && envelope().recipients().length > 0) {
                    return $.grep(envelope().recipients(), function (r) {
                        return r.id() == recipientId;
                    })[0].fullName();
                }
                return '';
            },
            addField = function(fieldId, pageNum, relativeX, relativeY, locationHeight, locationWidth, forceNewField, fieldName) {
                inprogress(true);
                repository.envelopeField.addField({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        documentId: previewDocument().documentId(),
                        recipientId: previewRecipient().id(),
                        fieldId: fieldId,
                        forceNewField: forceNewField,
                        page: pageNum,
                        locationX: relativeX,
                        locationY: relativeY,
                        locationHeight: locationHeight,
                        locationWidth: locationWidth,
                        name: fieldName,
                        pageWidth: pageWidth(),
                        pageHeight: pageHeight()
                    },
                    successCallback: function(fieldResult) {
                        inprogress(false);
                        fieldResult.locations.remove(function (item) {
                            return item.documentId() != previewDocument().documentId();
                        });
                        if (forceNewField && !_.find(fields(), function (a) { return a.id() == fieldResult.id(); })) {
                            fields.push(fieldResult);
                            var document = $.grep(documents(), function(d) { return d.documentId() == fieldResult.locations()[0].documentId(); })[0];
                            document.fieldsCount(document.fieldsCount() + 1);
                            document.fields().push(fieldResult);
                        } else {
                            $.grep(fields(), function(a) { return a.id() == fieldResult.id(); })[0].locations.push(fieldResult.locations.pop());
                        }
                        if (ownLocations().length > fieldResult.locations()[fieldResult.locations().length-1].order()) {
                            fieldsLoaded(false);
                            getDocumentFields(previewDocument().documentId());
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            ownLocations = function() {
                var locations = ko.observableArray([]);
                $.each(fields(), function () {
                    if (isOwnField(this)) {
                        $.each(this.locations(), function () {
                            locations.push(this);
                        });
                    }
                });
                return locations();
            },
            updateFieldLocation = function (location, callback) {
                if (!location) return;
                inprogress(true);
                repository.envelopeField.updateFieldLocation({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        documentId: previewDocument().documentId(),
                        recipientId: previewRecipient().id(),
                        locationId: location.id(),
                        fieldId: location.fieldId(),
                        page: location.page(),
                        locationX: location.locationX(),
                        locationY: location.locationY(),
                        locationHeight: location.locationHeight(),
                        locationWidth: location.locationWidth(),
                        fontBold: location.fontBold(),
                        fontColor: location.fontColor(),
                        fontItalic: location.fontItalic(),
                        fontName: location.fontName(),
                        fontSize: location.fontSize(),
                        fontUnderline: location.fontUnderline(),
                        align: location.align(),
                        pageWidth: pageWidth(),
                        pageHeight: pageHeight()
                    },
                    successCallback: function(fieldResult) {
                        inprogress(false);
                        location.dirtyFlag().reset();
                        var fld = _.find(fields(), function (f) {
                            return f.id() == location.fieldId();
                        });
                        if (fld && fld.recipientId() != previewRecipient().id()) {
                            inprogress(true);
                            repository.envelopeField.assignField({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    envelopeId: envelope().id(),
                                    documentId: previewDocument().documentId(),
                                    currentRecipientId: previewRecipient().id(),
                                    newRecipientId: fld.recipientId(),
                                    fieldId: location.fieldId()
                                },
                                successCallback: function(assignedFieldResult) {
                                    inprogress(false);
                                    if (_.isFunction(callback)) {
                                        callback(assignedFieldResult);
                                    }
                                },
                                errorCallback: function(error) {
                                    errorCallback(error);
                                    if (_.isFunction(callback)) {
                                        callback(false);
                                    }
                                } 
                            });
                        } else {
                            if (_.isFunction(callback)) {
                                callback(fieldResult);
                            }
                        }
                    },
                    errorCallback: function (error) {
                        inprogress(false);
                        config.alert({ title: "Error", message: error });
                        fieldsLoaded(false);
                        getDocumentFields(previewDocument().documentId());
                        if (_.isFunction(callback)) {
                            callback(false);
                        }
                    }
                });
            },
            isValidDate = function (s) {
                if (!s || s.length == 0) return true;
                if (s.length != 10) return false;
                var bits = s.split('.');
                if (!bits[0] || !bits[1] || !bits[2]) return false;
                if (bits[2] < 1900 || bits[2] > 2100) return false;
                var d = new Date(bits[2], bits[1] - 1, bits[0]);
                return d && (d.getMonth() + 1) == bits[1] && d.getDate() == Number(bits[0]);
            },
            updateField = function (field, callback) {
                if (!field) return;
                if (!field.isValid()) {
                    config.alert({ title: "Field not saved", message: 'Field data is not valid' });
                    return;
                }
                if (field.fieldType() == config.signatureFieldType.Date) {
                    if (!field.settings().minYear.isValid() || !field.settings().maxYear.isValid()) {
                        config.alert({ title: "Field not saved", message: 'Invalid date settings' });
                        return;
                    }
                }
                if (field.fieldType() > 1 && field.fieldType() < 5 && field.defaultValue() != '') {
                    if (field.regularExpression() != null && !field.defaultValue().match(field.regularExpression())) {
                        config.alert({ title: "Field not saved", message: 'Default value is not valid' });
                        return;
                    }
                    if (field.fieldType() == 4 && field.regularExpression() == "" && !isValidDate(field.defaultValue())) {
                        config.alert({ title: "Field not saved", message: 'Default date is not valid' });
                        return;
                    }
                }
                inprogress(true);
                repository.envelopeField.updateField({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        documentId: previewDocument().documentId(),
                        recipientGuid: previewRecipient().id(),
                        fieldId: field.id(),
                        name: field.name(),
                        regularExpression: field.regularExpression(),
                        order: field.order(),
                        mandatory: field.mandatory(),
                        acceptableValues: field.acceptableValues(),
                        defaultValue: field.defaultValue(),
                        tooltip: field.tooltip(),
                        guidanceText: field.guidanceText(),
                        groupName: field.groupName(),
                        fieldType: field.fieldType(),
                        settings: ko.toJSON(field.settings()),
                        lockDuringSign: field.lockDuringSign()
                    },
                    successCallback: function(fieldResult) {
                        inprogress(false);
                        field.dirtyFlag().reset();
                        if (_.isFunction(callback)) {
                            callback(fieldResult);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            deleteFieldLocation = function(field, location) {
                inprogress(true);
                repository.envelopeField.deleteFieldLocation({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        fieldId: location.fieldId(),
                        locationId: location.id()
                    },
                    successCallback: function() {
                        inprogress(false);
                        field.locations.remove(location);
                        if (field.locations().length == 0) {
                            fields.remove(field);
                            var document = $.grep(documents(), function(d) { return d.documentId() == location.documentId(); })[0];
                            document.fieldsCount(document.fieldsCount() - 1);
                            document.fields.remove(field);
                        }
                        selectedField(null);
                        selectedLocation(null);
                    },
                    errorCallback: errorCallback
                });
            },
            updateMovedField = function(location, event) {
                if (!location.selected()) return;
                clearInterval(timer);
                timer = setTimeout(function() {
                    if (event.keyCode > -37 && event.keyCode <= 40)
                        updateFieldLocation(location);
                }, 2000);
            },
            getDocumentFields = function (documentId, callback) {
                if (fieldsLoaded()) {
                    if (_.isFunction(callback)) {
                        callback(fields());
                    }
                    return;
                }
                inprogress(true);
                fields.removeAll();
                selectedField(null);
                selectedLocation(null);
                repository.envelopeField.getFields({
                    itemsResult: fields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        envelopeId: envelope().id(),
                        documentId: documentId
                    },
                    successCallback: function (fieldsResult) {
                        inprogress(false);
                        var document = ko.utils.arrayFirst(documents(), function (doc) {
                            return doc.documentId() === documentId;
                        });
                        document.fields.removeAll();
                        ko.utils.arrayForEach(fieldsResult, function (docField) {
                            docField.locations.remove(function (item) {
                                return item.documentId() != documentId;
                            });
                        });
                        _.map(fieldsResult, function (fld) {
                            document.fields().push(fld);
                        });
                        fieldsLoaded(true);
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                        //document.fields(fieldsResult);
                    },
                    errorCallback:errorCallback
                });
            },
            getDocumentField = function (documentId, fieldId, callback) {
                inprogress(true);
                repository.envelopeField.getField({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        envelopeId: envelope().id(),
                        documentId: documentId,
                        fieldId: fieldId
                    },
                    successCallback: function (fieldsResult) {
                        inprogress(false);
                        fieldsResult.locations.remove(function (item) {
                            return item.documentId() != documentId;
                        });
                        var document = ko.utils.arrayFirst(documents(), function (doc) {
                            return doc.documentId() === documentId;
                        });
                        var field = ko.utils.arrayFirst(document.fields(), function (f) {
                            return f.id() === fieldId;
                        });
                        fields.replace(field, fieldsResult);
                        document.fields.replace(field, fieldsResult);
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            copyFieldLocation = function (field, location) {
                if (location.selected()) {
                    copiedLocation(location);
                    copiedField(field);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            cutFieldLocation = function(field, location) {
                if (location.selected()) {
                    if (field == null) return;
                    cuttedLocation(location);
                    cuttedField(field);
                    copiedLocation(null);
                    copiedField(null);
                    field.locations.remove(location);
                }
            },
            pasteNewField = function() {
                if (copiedLocation() != null && copiedField() != null) {
                    var signatureCopiedField = $.grep(signatureFields(), function(a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    addField(signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), true, '');
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
                if (cuttedLocation() != null && cuttedField() != null) {
                    var signatureCuttedField = $.grep(signatureFields(), function(a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    addField(signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX(), cuttedLocation().locationY(), cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), true, '');
                    deleteFieldLocation(cuttedField(), cuttedLocation());
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            pasteNewLocation = function() {
                if (copiedLocation() != null && copiedField() != null) {
                    var envelopeCopiedField = $.grep(fields(), function(a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    var signatureCopiedField = $.grep(signatureFields(), function(a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    addField(envelopeCopiedField != null ? copiedLocation().fieldId() : signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), envelopeCopiedField != null ? false : true, envelopeCopiedField != null ? copiedField().name() : '');
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
                if (cuttedLocation() != null && cuttedField() != null) {
                    var envelopeCuttedField = $.grep(fields(), function(a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    var signatureCuttedField = $.grep(signatureFields(), function(a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    addField(envelopeCuttedField != null ? cuttedLocation().fieldId() : signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX() + 0.05, cuttedLocation().locationY() + 0.05, cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), envelopeCuttedField != null ? false : true, envelopeCuttedField != null ? cuttedField().name() : '');
                    deleteFieldLocation(cuttedField(), cuttedLocation());
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            addFieldFromMenu = function(fieldType) {
                var signatureField = $.grep(signatureFields(), function(a) { return a.fieldType() == fieldType; })[0];
                var height, width;
                switch (fieldType) {
                case 1:
                    //signature
                    height = 46;
                    width = 148;
                    break;
                case 6:
                    //checkbox
                    height = 25;
                    width = 25;
                    break;
                default:
                    height = 25;
                    width = 205;
                    break;
                }
                addField(signatureField.id(), 1, 0, 0, height, width, true, '');
            },
            selectDefaultValue = function(value) {
                if (selectedField() != null)
                    selectedField().defaultValue(value);
            },
            addAcceptableValue = function () {
                newAcceptableValue($.trim(newAcceptableValue()));
                if ($.grep(newAcceptableValue.errors(), function(error) {
                    return error != null;
                }
                ).length > 0) {
                    newAcceptableValue.errors.showAllMessages(true);
                    return;
                }
                ;
                if (selectedField() != null && newAcceptableValue() != '') {
                    if (selectedField().acceptableValuesArray().indexOf(newAcceptableValue()) > -1) {
                        config.alert({ title: "Error", message: "Value already in list" });
                        return;
                    }
                    selectedField().acceptableValuesArray.push(newAcceptableValue());
                    newAcceptableValue('');
                    selectedPredefinedList(null);
                    newAcceptableValue.errors.showAllMessages(false);
                }
            },
            deleteAcceptableValue = function(value) {
                $.confirm({
                    title: "Delete Confirmation",
                    message: "Are you sure ?",
                    buttons: {
                        Yes: {
                            action: function() {
                                selectedField().acceptableValuesArray.remove(value);
                                if (selectedField().defaultValue() == value)
                                    selectedField().defaultValue('');
                            }
                        },
                        No: {}
                    }
                });
            },
            addNewAcceptableValuesList = function() {
                if ($.grep(newAcceptableValueListName.errors(), function(error) {
                    return error != null;
                }
                ).length > 0) {
                    newAcceptableValueListName.errors.showAllMessages(true);
                    return;
                }
                ;
                if (selectedField() != null && newAcceptableValueListName() != '') {
                    inprogress(true);
                    repository.predefinedList.addList({
                        itemsResult: predefinedLists,
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            name: newAcceptableValueListName(),
                            defaultValue: selectedField().defaultValue(),
                            values: selectedField().acceptableValues()
                        },
                        successCallback: function(result) {
                            inprogress(false);
                            predefinedLists.push(result);
                        },
                        errorCallback:errorCallback
                    });
                    newAcceptableValueListName('');
                    newAcceptableValueListName.errors.showAllMessages(false);
                }
            },
            deleteAcceptableValuesList = function () {
                if (selectedPredefinedList() == null) return;
                inprogress(true);
                repository.predefinedList.deleteList({
                    itemsResult: predefinedLists,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        listId: selectedPredefinedList().id()
                    },
                    successCallback: function (result) {
                        inprogress(false);
                        var selected = selectedPredefinedList();
                        selectedPredefinedList(null);
                        predefinedLists.remove(selected);
                    },
                    errorCallback: function (error) {
                        config.alert({ title: "error", message: error });
                    }
                });
            },
            resetFields = function () {
                inprogress(true);
                repository.envelopeField.getFields({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        envelopeId: envelope().id(),
                        documentId: ""
                    },
                    successCallback: function(fieldsResult) {
                        var fieldIds = [];
                        $.each(fieldsResult, function() {
                            fieldIds[fieldIds.length] = this.id();
                        });
                        if (fieldIds.length > 0) {
                            repository.envelopeField.deleteFields({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    envelopeId: envelope().id(),
                                    fieldIds: fieldIds
                                },
                                successCallback: function(result) {
                                    inprogress(false);
                                    fields.removeAll();
                                    selectedField(null);
                                    selectedLocation(null);
                                },
                                errorCallback: errorCallback
                            });
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            },
            activateNextLocation = function (callback) {
                var locations = ko.observableArray([]);
                locations(ownLocations());
                
                locations(locations.sort(function(left, right) {
                    var p1 = left.order();
                    var p2 = right.order();
                    return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                }));
                var currentLocation = ko.utils.arrayFirst(locations(), function(item) {
                    return item.id() == selectedLocation().id();
                });
                if (currentLocation != null)
                    currentLocation.selected(false);
                var nextLocation = null;
                for (var i = 1; i < fields().length; i++) {
                    nextLocation = ko.utils.arrayFirst(locations(), function(item) {
                        return item.order() == selectedLocation().order() + i;
                    });
                    if (nextLocation!=null)
                        break;
                }
                if (nextLocation==null)
                    nextLocation = locations()[0];
                if (nextLocation == null)
                    return;
                nextLocation.selected(true);
                selectedField(
                    $.grep(fields(), function (f) {
                        return f.id() == nextLocation.fieldId();
                    })[0]);
                selectedLocation(nextLocation);
                if (_.isFunction(callback)) {
                    callback(fields());
                }
            },
            activatePrevLocation = function(callback) {
                var locations = ko.observableArray([]);
                locations(ownLocations());
                locations.sort(function (left, right) {
                    var p1 = left.order();
                    var p2 = right.order();
                    return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                });
                var currentLocation = ko.utils.arrayFirst(locations(), function (item) {
                    return item.id() == selectedLocation().id();
                });
                if (currentLocation != null)
                    currentLocation.selected(false);
                var prevLocation = null;
                for (var i = 1; i < fields().length; i++) {
                    prevLocation = ko.utils.arrayFirst(locations(), function (item) {
                        return item.order() == selectedLocation().order() - i;
                    });
                    if (prevLocation != null)
                        break;
                }

                if (prevLocation == null)
                    prevLocation = locations()[locations().length - 1];
                if (prevLocation == null)
                    return;
                prevLocation.selected(true);
                selectedField(
                    $.grep(fields(), function (f) {
                        return f.id() == prevLocation.fieldId();
                    })[0]);
                selectedLocation(prevLocation);
                if (_.isFunction(callback)) {
                    callback(fields());
                }
            };
        

        selectedPredefinedList.subscribe(function (newValue) {
            if (newValue != null) {
                $.confirm({
                    title: "Apply list confirmation",
                    message: "Are you sure that you apply the selected list?",
                    buttons: {
                        Yes: {
                            action: function () {
                                selectedField().acceptableValuesArray(newValue.values());
                                selectedField().defaultValue('');
                            }
                        },
                        No: {}
                    }
                });
            }
        });        
        ko.validation.group(newAcceptableValue);
        ko.validation.group(newAcceptableValueListName);

        return {
            inprogress: inprogress,
            viewerAction: viewerAction,
            config: config,
            regularExpressions: regularExpressions,
            envelope: envelope,
            signatureFields: signatureFields,
            fields: fields,
            documents: documents,
            previewDocument: previewDocument,
            previewRecipient: previewRecipient,
            pageWidth: pageWidth,
            pageHeight: pageHeight,
            cuttedLocation: cuttedLocation,
            copiedLocation: copiedLocation,
            cuttedField: cuttedField,
            copiedField: copiedField,
            selectedField: selectedField,
            selectedLocation: selectedLocation,
            predefinedLists: predefinedLists,
            selectedPredefinedList: selectedPredefinedList,
            newAcceptableValue: newAcceptableValue,
            newAcceptableValueListName: newAcceptableValueListName,
            init: init,
            isOwnField: isOwnField,
            addField: addField,
            updateFieldLocation: updateFieldLocation,
            updateField: updateField,
            deleteFieldLocation: deleteFieldLocation,
            updateMovedField: updateMovedField,
            getDocumentFields: getDocumentFields,
            getDocumentField: getDocumentField,
            copyFieldLocation: copyFieldLocation,
            cutFieldLocation: cutFieldLocation,
            pasteNewField: pasteNewField,
            pasteNewLocation: pasteNewLocation,
            addFieldFromMenu: addFieldFromMenu,
            selectDefaultValue: selectDefaultValue,
            addAcceptableValue: addAcceptableValue,
            deleteAcceptableValue: deleteAcceptableValue,
            addNewAcceptableValuesList: addNewAcceptableValuesList,
            resetFields: resetFields,
            getRecipientNameById: getRecipientNameById,
            recipients: recipients,
            fieldsLoaded: fieldsLoaded,
            deleteAcceptableValuesList: deleteAcceptableValuesList,
            activateNextLocation: activateNextLocation,
            activatePrevLocation: activatePrevLocation
        };
    });
define('core/vm/vm.envelope.prepare.step6',
    ['ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function (ko, _, repository, configuration, redirect) {
        var inprogress = ko.observable(false),
            envelope = ko.observable(),
            documents = ko.observableArray([]),
            fields = ko.observableArray([]),
            loadFields = function(callback) {
                if (inprogress()) return;
                inprogress(true);
                fields.removeAll();
                repository.envelopeField.getFields({
                    itemsResult: fields,
                    param: {
                        userId: configuration.userId(),
                        privateKey: configuration.privateKey(),
                        recipientId: "",
                        envelopeId: envelope().id(),
                        documentId: ""
                    },
                    successCallback: function(fieldsResult) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            getOrderedLocationsList = function(recipient, document) {
                var locations = ko.observableArray([]);
                ko.utils.arrayForEach(fields(), function(field) {
                    if (field.recipientId() == recipient.id()) {
                        ko.utils.arrayForEach(field.locations(), function(location) {
                            if (location.documentId() == document.documentId()) {
                                locations.push({
                                    location: location,
                                    fieldId: field.id(),
                                    name: field.name(),
                                    order: location.order(),
                                    fieldTypeText: field.fieldTypeText()
                                });
                            }
                        });
                    }
                });
                return locations.sort(function (left, right) {
                    var p1 = left.order;
                    var p2 = right.order;
                    return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                });;
            },
            getFields = function (recipient, document) {
                return ko.utils.arrayFilter(fields(), function(item) {
                    return $.grep(item.locations(), function(location) {
                        return location.documentId() == document.documentId();
                    }).length > 0 && item.recipientId() == recipient.id();
                });
            },
            updateFieldLocationOrder = function(item, order) {
                inprogress(true);
                var field = ko.utils.arrayFirst(fields(), function (f) {
                    return f.id()==item.location.fieldId();
                });
                repository.envelopeField.updateFieldLocationOrder({
                    param: {
                        userId: configuration.userId(),
                        privateKey: configuration.privateKey(),
                        envelopeId: envelope().id(),
                        documentId: item.location.documentId(),
                        recipientId: field.recipientId(),
                        locationId: item.location.id(),
                        fieldId: item.location.fieldId(),
                        order: order+1
                    },
                    successCallback: function (fieldResult) {
                        inprogress(false);
                    },
                    errorCallback: errorCallback
                });
            },
            canSign = function () { },
            errorCallback = function (error) {
                inprogress(false);
                configuration.alert({ title: "Error", message: error });
                return false;
            };

        return {
            inprogress: inprogress,
            envelope: envelope,
            documents: documents,
            fields: fields,
            loadFields: loadFields,
            getFields: getFields,
            canSign: canSign,
            updateFieldLocationOrder: updateFieldLocationOrder,
            getOrderedLocationsList: getOrderedLocationsList
        };
    });
define('core/vm/vm.envelope.sign',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect',
        'core/eventManager'],
    function ($, ko, _, repository, configuration, redirect, event) {
        var viewerAction = 'sign',
            config = configuration,
            eventManager = new event({
                envelopeFieldFilledCallback: function (data) {
                    var fieldData = JSON.parse(data.data);
                    var field = ko.utils.arrayFirst(fields(), function (item) {
                        return item.id() == fieldData.fieldId;
                    });
                    field.progress(data.percent);
                }
            }),
            isPublic = ko.observable(false),
            recipientId = ko.observable(),
            inprogress = ko.observable(false),
            envelope = ko.observable(),
            documents = ko.observableArray([]),
            signDocument = ko.observable(),
            fields = ko.observableArray([]),
            locations = ko.observableArray([]),
            hideStartButton = ko.observable(false),
            pageWidth = ko.observable(8350),
            pageHeight = ko.observable(1200),
            signatureFields = ko.observableArray([]),
            recipientStatus = ko.computed(function() {
                try {
                    return $.grep(envelope().recipients(), function(r) {
                        return r.id() == recipientId();
                    })[0].status();
                } catch(e) {
                    return 0;
                }
            }),
            isOwnField = function (field) {
                if (recipientId() != null) {
                    return field.recipientId() == recipientId();
                }
                return false;
            },
            getRecipientNameById = function(recipientId) {
                if (envelope() != null && envelope().recipients().length > 0) {
                    return $.grep(envelope().recipients(), function(r) {
                        return r.id() == recipientId;
                    })[0].fullName();
                }
                return '';
            },
            loadEnvelope = function(envelopeId, callback) {
                inprogress(true);
                repository.envelope.getEnvelope({
                    isPublic: isPublic(),
                    itemsResult: envelope,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId,
                        recipientId: recipientId()
                    },
                    doneCallback: function (envelopeResult) {    
                        repository.envelopeDocument.getDocuments({
                            isPublic: isPublic(),
                            documentResult: documents,
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                envelopeId: envelopeId,
                                recipientId: recipientId()
                            },
                            doneCallback: function(documentResult) {
                                inprogress(false);
                                if (envelopeResult().inPersonSign() == true && recipientStatus() == 4) {
                                    var recipientsLeft = $.grep(envelope().recipients(), function (r) {
                                        return r.status() == 1;
                                    });
                                    //console.log(recipientsLeft);
                                    if (recipientsLeft.length == 0)
                                        redirect.embedEnvelopeSigned(envelope().id(), recipientId());
                                    else
                                        recipientId(recipientsLeft[0].id());
                                }
                                if (_.isFunction(callback)) {
                                    callback(envelopeResult, documentResult);
                                }
                            },
                            errorCallback:errorCallback
                        });
                    },
                    errorCallback:errorCallback
                });
            },
            getDocumentFields = function(documentId, callback) {
                inprogress(true);
                fields.removeAll();
                locations.removeAll();
                var fieldLocations = [];
                repository.envelopeField.getFields({
                    isPublic: isPublic(),
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        envelopeId: envelope().id(),
                        //documentId: documentId
                    },
                    successCallback: function(fieldsResult) {
                        inprogress(false);
                        ko.utils.arrayForEach(fieldsResult, function (docField) {
                            docField.locations.remove(function (item) {
                                return item.documentId() != documentId;
                            });
                        });
                        var needSignatureFields = false;
                        $.each(fieldsResult, function() {
                            var item = this;
                            var validators = {};
                            if (item.fieldType() != configuration.signatureFieldType.Date) {
                                if (item.regularExpression() != null && item.regularExpression() != '') {
                                    var errorMessage = $.grep(config.fieldValidations, function (r) { return r.expression == item.regularExpression(); })[0].errorMessage;
                                    validators.pattern = { params: item.regularExpression(), message: errorMessage };
                                }
                            }
                            var groupMandatory = false;
                            if (item.fieldType() == configuration.signatureFieldType.Checkbox && item.groupName() != "") {
                                groupMandatory = _.filter(fieldsResult, function (fld) {
                                    return fld.recipientId() == item.recipientId() && fld.groupName() == item.groupName() && item.mandatory()
                                            && fld.locations && fld.locations()[0] && fld.locations()[0].documentId() == signDocument().documentId();
                                }).length > 0;
                            }
                            if (item.mandatory() || groupMandatory) {
                                validators.required = { message: '' };
                                if (item.fieldType() == configuration.signatureFieldType.Checkbox)
                                    validators.validation = {
                                        validator: function (val) {
                                            if (item.groupName() != '') {
                                                var checkedGroupFields = _.filter(fields(), function (fld) {
                                                    return fld.recipientId() == item.recipientId() &&  fld.groupName() == item.groupName() && fld.data() == 'on';
                                                });
                                                return checkedGroupFields.length > 0;
                                            }
                                            else
                                                return val && val == 'on';
                                        }
                                    };
                            }
                            if ((item.data() == null || item.data() == '') &&   item.defaultValue()!=null && item.defaultValue()!='' && item.recipientId()==recipientId()) {
                                item.data(item.defaultValue());
                                if (item.locations().length>0)
                                    fillField(item, item.locations()[0]);
                            }
                            ko.utils.arrayForEach(item.locations(), function (location) {
                                if (!item.lockDuringSign()) needSignatureFields = true;
                                $.extend(location, { locked: ko.observable(item.lockDuringSign()) });
                            });
                            item.data.extend(validators);
                            item.dirtyFlag = new ko.DirtyFlag([item.data]);
                            fields.push(item);
                            if (isOwnField(item)) {
                                $.each(item.locations(), function() {
                                    fieldLocations.push(this);
                                });
                            }
                        });
                        if (fieldLocations.length > 0) {
                            /*
                            fieldLocations.sort(function (left, right) {
                                var pageHeight = 1105;
                                var pageWidth = 854;
                                var pageSize = pageHeight * pageWidth;
                                var p1 = left.page() * pageHeight*pageSize + left.locationY() * pageWidth + left.locationX();
                                var p2 = right.page() * pageHeight*pageSize + right.locationY() * pageWidth + right.locationX();
                                return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                            });
                            */
                            fieldLocations.sort(function (left, right) {
                                var p1 = left.order();
                                var p2 = right.order();
                                return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                            });
                            locations(fieldLocations);
                            activateLocation(locations()[0]);
                            if (_.isFunction(callback)) {
                                callback(fieldsResult);
                            }
                        }
                        if (signatureFields().length == 0 && needSignatureFields) {
                            repository.field.getFields({
                                isPublic: isPublic(),
                                itemsResult: signatureFields,
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey()
                                },
                                doneCallback: function() {},
                                errocCallback: errorCallback
                            });
                        }

                    },
                    errorCallback:errorCallback
                });
            },
            fillField = function(field, location) {
                if (field.data() == null) return;
                inprogress(true);
                repository.envelopeField.fillField({
                    isPublic: isPublic(),
                    itemsResult: fields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: field.envelopeId(),
                        documentId: location.documentId(),
                        recipientId: field.recipientId(),
                        fieldId: field.id(),
                        data: field.data(),
                        //signatureId: signatureId
                    },
                    successCallback: function (fieldsResult) {
                        inprogress(false);
                    },
                    errorCallback: function (error) {
                        field.data('');
                        errorCallback(error);
                    }
                });
            },
            signEnvelope = function (data) {
                inprogress(true);
                repository.envelope.signEnvelope({
                    isPublic: isPublic(),
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        recipientId: recipientId(),
                        authData: data.authData,
                        comment: data.comment
                    },
                    successCallback: function(result) {
                        inprogress(false);
                        if (!isPublic())
                            redirect.envelopeSigned(envelope().id());
                        else {
                            //console.log('signed');
                            if (!envelope().inPersonSign())
                                redirect.embedEnvelopeSigned(envelope().id(), recipientId());
                            else {
                                $.grep(envelope().recipients(), function(r) {
                                    return r.id() == recipientId();
                                })[0].status(4);
                                var recipientsLeft = $.grep(envelope().recipients(), function(r) {
                                    return r.status() == 1;
                                });
                                //console.log(recipientsLeft);
                                if (recipientsLeft.length == 0)
                                    redirect.embedEnvelopeSigned(envelope().id(), recipientId());
                                else
                                    recipientId(recipientsLeft[0].id());
                            }
                        }
                    },
                    errorCallback:function(error) {
                        errorCallback(error, function() {
                            window.location.reload();
                        });
                    }
                });
            },
            getActiveLocation = function() {
                return _.find(locations(), function(item) { return item.selected(); });
            },
            getActiveField = function () {
                var location = getActiveLocation();
                return _.find(fields(), function (item) { return item.id()==location.fieldId(); });
            },
            activateNextLocation = function() {
                var selectedLocation = getActiveLocation();
                if (selectedLocation != null) {
                    var selectedLocationIndex = locations.indexOf(selectedLocation);
                    var nextLocationIndex;
                    if (locations().length > selectedLocationIndex + 1) {
                        nextLocationIndex = selectedLocationIndex + 1;
                    } else {
                        nextLocationIndex = 0;
                    }
                    activateLocation(locations()[nextLocationIndex]);
                } else {
                    if (locations().length > 0) {
                        activateLocation(locations()[0]);
                    }
                }
                hideStartButton(true);
            },
            activatePrevLocation = function() {
                var selectedLocation = getActiveLocation();
                if (selectedLocation != null) {
                    var selectedLocationIndex = locations.indexOf(selectedLocation);
                    var prevLocationIndex;
                    if (selectedLocationIndex > 0) {
                        prevLocationIndex = selectedLocationIndex - 1;
                    } else {
                        prevLocationIndex = locations().length - 1;
                    }
                    activateLocation(locations()[prevLocationIndex]);
                }
                hideStartButton(true);
            },
            fieldsToBeFilled = function () {
                if (!fields() || fields().length == 0)
                    return -1;
                var invalidFields = 0;
                $.each(fields(), function () {
                    if (isOwnField(this)) {
                        if (!this.isValid()) {
                            invalidFields++;
                        }
                    }
                });
                return invalidFields;
            },
            hasPrevLocation = function() {
                return locations.indexOf(getActiveLocation()) == 0;
            },
            hasNextLocation = function() {
                return locations.indexOf(getActiveLocation()) < locations().length - 1;
            },
            activateLocation = function (location) {
                $.each(locations(), function () { this.selected(false); });
                if (location == null) return;
                location.selected(true);
                hideStartButton(true);
            },
            activateFirstInvalidLocation = function () {
                var field;
                $.each(fields(), function () {
                    if (isOwnField(this)) {
                        if (!this.isValid()) {
                            field = this;
                            return false;
                        }
                    }
                });
                if (field != null)
                    activateLocation(field.locations()[0]);
            },
            fileUploaded = function (field, location, evt) {
                if (config.checkFileApiSupport()) {
                    var frField = new FileReader();
                    frField.onload = function(e) {
                        field.data(JSON.stringify({
                            size: evt.target.files[0].size,
                            type: evt.target.files[0].type,
                            name: evt.target.files[0].name,
                            data: e.target.result
                        }));
                        fillField(field, location);
                    };
                    frField.readAsDataURL(evt.target.files[0]);
                } else {
                    requirejs(['lib/fileApi/FileAPI'], function () {
                        var files = FileAPI.getFiles(evt);
                        FileAPI.readAsDataURL(files[0], function (dataUrlObject) {
                            if (dataUrlObject.type == 'load') {
                                field.data(JSON.stringify({
                                    size: files[0].size,
                                    type: files[0].type,
                                    name: files[0].name,
                                    data: dataUrlObject.result
                                }));
                                fillField(field, location);
                            }
                        });
                    });
                }
            },
            updateFieldLocation = function (location) {
                if (!location) return;
                inprogress(true);
                repository.envelopeField.updateFieldLocation({
                    isPublic: isPublic(),
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope().id(),
                        documentId: signDocument().documentId(),
                        recipientId: recipientId(),
                        locationId: location.id(),
                        fieldId: location.fieldId(),
                        page: location.page(),
                        locationX: location.locationX(),
                        locationY: location.locationY(),
                        locationHeight: location.locationHeight(),
                        locationWidth: location.locationWidth(),
                        fontBold: location.fontBold(),
                        fontColor: location.fontColor(),
                        fontItalic: location.fontItalic(),
                        fontName: location.fontName(),
                        fontSize: location.fontSize(),
                        fontUnderline: location.fontUnderline(),
                        align: location.align(),
                        pageWidth: pageWidth(),
                        pageHeight: pageHeight()
                    },
                    successCallback: function (fieldResult) {
                        inprogress(false);
                        location.dirtyFlag().reset();
                    },
                    errorCallback: function (error) {
                        inprogress(false);
                        config.alert({ title: "Error", message: error });
                    }
                });
            },
            errorCallback = function (error, closeCallback) {
                config.alert({ title: "Error", message: error, closeCallback: closeCallback });
                return false;
            };
        
        return {
            viewerAction: viewerAction,
            config: config,
            isPublic: isPublic,
            recipientId: recipientId,
            inprogress: inprogress,
            envelope: envelope,
            loadEnvelope: loadEnvelope,
            documents: documents,
            signDocument: signDocument,
            fields: fields,
            recipientStatus: recipientStatus,
            isOwnField: isOwnField,
            getDocumentFields: getDocumentFields,
            fillField: fillField,
            signEnvelope: signEnvelope,
            locations: locations,
            activateNextLocation: activateNextLocation,
            activatePrevLocation: activatePrevLocation,
            getRecipientNameById: getRecipientNameById,
            fieldsToBeFilled: fieldsToBeFilled,
            hasPrevLocation: hasPrevLocation,
            hasNextLocation: hasNextLocation,
            getActiveLocation: getActiveLocation,
            activateLocation: activateLocation,
            activateFirstInvalidLocation: activateFirstInvalidLocation,
            hideStartButton: hideStartButton,
            getActiveField: getActiveField,
            fileUploaded: fileUploaded,
            updateFieldLocation: updateFieldLocation,
            signatureFields: signatureFields
        };
    });
define('core/vm/vm.envelope.signed',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect',
        'core/routes'],
    function ($, ko, _, repository, configuration, redirect, routes) {
        var viewerAction = 'signed',
            config = configuration,
            isPublic = ko.observable(false),
            recipientId = ko.observable(),
            inprogress = ko.observable(false),
            envelopeId = ko.observable(),
            documents = ko.observableArray([]),
            signDocument = ko.observable(),
            envelopeStatus = ko.observable(-1),
            loadDocuments = function(callback) {
                inprogress(true);
                repository.envelopeDocument.getDocuments({
                    isPublic: isPublic(),
                    documentResult: documents,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId(),
                        recipientId: recipientId()
                    },
                    doneCallback: function(documentResult) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(documentResult);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            getDownloadUrl = function() {
                if (isPublic()) {
                    return routes.publicDownloadEnvelopeDocumentsUrl(envelopeId(), recipientId());
                } else {
                    return routes.downloadEnvelopeDocumentsUrl(config.userId(), config.privateKey(), envelopeId());
                }
            },
            getEnvelopeStatus = function(callback, failedCallback) {
                inprogress(true);
                repository.envelope.getStatus({
                    isPublic: isPublic(),
                    documentResult: documents,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelopeId(),
                        recipientId: recipientId()
                    },
                    doneCallback: function (status) {
                        envelopeStatus(status.result);
                        if (status.result == 99) {
                            setTimeout(function () {
                                getEnvelopeStatus(callback);
                            }, 2000);
                        }
                        else if (status.result == 4) {
                            inprogress(false);
                            if (_.isFunction(failedCallback)) {
                                failedCallback();
                            }
                        } else {
                            inprogress(false);
                            if (_.isFunction(callback)) {
                                callback(status);
                            }
                        }                        
                    },
                    errorCallback:errorCallback
                });
            },
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                return false;
            };

        return {
            viewerAction: viewerAction,
            config: config,
            isPublic: isPublic,
            recipientId: recipientId,
            inprogress: inprogress,
            envelopeId: envelopeId,
            loadDocuments: loadDocuments,
            documents: documents,
            signDocument: signDocument,
            getDownloadUrl: getDownloadUrl,
            getEnvelopeStatus: getEnvelopeStatus,
            envelopeStatus: envelopeStatus
        };
    });
define('core/vm/vm.envelopes',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function($, ko, _, repository, config, redirect) {
        var envelopes = ko.observableArray([]),
            inprogress = ko.observable(false),
            totalCount = ko.observable(10),
            statusId = ko.observable('-6'),
            page = ko.observable(1),
            itemsPerPage = ko.observable(1000),
            documentId = ko.observable(''),
            recipientEmail = ko.observable(''),
            date = ko.observable(''),
            name = ko.observable(''),
            tag = ko.observable(''),
            anySelected = ko.computed(function () {
                return $.grep(envelopes(), function(envelope) {
                    return envelope.selected() == true;
                }).length > 0;
            }),
            allSelected = ko.computed(function () {
                return $.grep(envelopes(), function (envelope) {
                    return envelope.selected() == true;
                }).length == envelopes().length;
            }),
            checkAccessRights = function (envelope) {
                if (envelope.inPersonSign() == true && envelope.ownerGuid() == config.userId())
                    return true;
                var hasAccess = false;
                $.each(envelope.recipients(), function() {
                    var recipient = this;
                    if (recipient.userGuid() == config.userId() || recipient.email() == config.userEmail()) {
                        hasAccess = true;
                    }
                });
                return hasAccess;
            },
            checkIfRecipientIsCC = function (envelope) {
                var hasAccess = false;
                $.each(envelope.recipients(), function () {
                    var recipient = this;
                    if ((recipient.userGuid() == config.userId() || recipient.email() == config.userEmail()) && recipient.roleId()==3 ) {
                        hasAccess = true;
                    }
                });
                return hasAccess;
            },
            checkIfRecipientIsOwner = function (envelope) {
                var hasAccess = false;
                $.each(envelope.recipients(), function () {
                    var recipient = this;
                    if ((recipient.userGuid() == config.userId() || recipient.email() == config.userEmail()) && recipient.roleId() == 1) {
                        hasAccess = true;
                    }
                });
                return hasAccess;
            },
            statusText = function (envelope) {
                var currentRecipient = $.grep(envelope.recipients(), function (r) {
                    return r.userGuid() == config.userId();
                })[0];
                switch (envelope.status()) {
                    case -1:
                        return "Draft";
                    case 0:
                        return "Annotation";
                    case 1:
                        if (currentRecipient != null) {
                            switch (currentRecipient.status()) {
                                case 1:
                                    return "Sign";
                                case 2:
                                    return "You delegated";
                                case 3:
                                    return "You rejected";
                                case 4:
                                    return "You already signed";
                                default:
                                    return "Pending";
                            }
                        }
                        else 
                            return "Pending";
                    case 2:
                        return "Expired";
                    case 3:
                        return "Canceled";
                    case 4:
                        return "Failed";
                    case 5:
                        return "Completed";
                    case 6:
                        return "Archived";
                    case 99:
                        return "Scheduled";
                }
                return "";
            },
            errorHandler = function (value) {
                if (value == "") return;
                inprogress(false);
                config.alert({ title: "Notification", message: value });
            },
            loadEnvelopes = function (options, callback) {
                if (inprogress()) return;

                if (options != null && options.clearAll != null && options.clearAll) {
                    envelopes.removeAll();
                    totalCount(0);
                }
                if (options != null && options.page != null)
                    page(options.page);
                if (options != null && options.recipientEmail != null)
                    recipientEmail(options.recipientEmail);
                if (options != null && options.documentId != null)
                    documentId(options.documentId);
                if (options != null && options.date != null)
                    date(options.date);
                if (options != null && options.statusId != null)
                    statusId(options.statusId);
                if (options != null && options.name != null)
                    name(options.name);
                if (options != null && options.tag != null)
                    tag(options.tag);
                inprogress(true);
                repository.envelope.getEnvelopes({
                    forceRefresh: true,
                    itemsResult: envelopes,
                    itemsCount: totalCount,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        statusId: statusId(),
                        page: page(),
                        count: itemsPerPage(),
                        documentId: documentId(),
                        recipientEmail: recipientEmail(),
                        date: date(),
                        name: name(),
                        tag: tag()
                    },
                    doneCallback: function() {
                        inprogress(false);
                        resizeElements();
                    },
                    errorCallback: errorHandler
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            },
            openEnvelope = function (envelope) {
                if (envelope.status() == -1) { //draft
                    redirect.envelopeView(envelope.id());
                }
                else if (envelope.status() == 99) {
                    config.alert({ title: "Notification", message: "Please wait until document is processed" });
                }
                else if (envelope.status() == 2 ) {
                    config.alert({ title: "Error", message: "This envelope has been expired" });
                }
                else if (envelope.status() == 3 ) {
                    config.alert({ title: "Error", message: "This envelope is canceled" });
                }
                else if (envelope.status() == 4) {
                    config.alert({ title: "Error", message: "This envelope has failed" });
                }
                else if (envelope.status() == 1) { //inprogress
                    if (!checkIfRecipientIsCC(envelope)) {
                        if (checkAccessRights(envelope)) {
                            repository.envelope.envelopeRecipientSigned({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    envelopeId: envelope.id(),
                                    recipientId: config.userId()
                                },
                                doneCallback: function(result) {
                                    if (!result.signed) {
                                        if (envelope.inPersonSign()) {
                                            if (envelope.ownerGuid() == config.userId())
                                                redirect.embedEnvelopeSign(envelope.id(), envelope.recipients()[0].id());
                                        } else {
                                            if (!envelope.orderedSignature()) {
                                                redirect.envelopeSign(envelope.id());
                                            } else {
                                                repository.envelope.getEnvelopeCurrentRecipientId({
                                                    param: {
                                                        userId: config.userId(),
                                                        privateKey: config.privateKey(),
                                                        envelopeId: envelope.id()
                                                    },
                                                    doneCallback: function(recipientId) {
                                                        if (recipientId == config.userId() && checkAccessRights(envelope)) {
                                                            redirect.envelopeSign(envelope.id());
                                                        } else {
                                                            config.alert("error", "please wait your turn");
                                                        }
                                                    },
                                                    errorCallback: errorHandler
                                                });
                                            }
                                        }
                                    } else {
                                        config.alert("error", "The envelope is not signed by all recipients yet.");
                                        //redirect.envelopeSigned(envelope.id());
                                    }
                                },
                                errorCallback: errorHandler
                            });
                        } else {
                            config.alert({ title: "Notification", message: "The envelope is not signed yet" });
                        }
                    }
                } else {
                    redirect.envelopeSigned(envelope.id());
                }
            },
            restartEnvelope = function(envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.restartEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope.id()
                    },
                    doneCallback: function () {
                        inprogress(false);
                        loadEnvelopes({ clearAll: true, page: 1 });
                    },
                    errorCallback: errorHandler
                });
            },
            archiveEnvelope = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.archiveEnvelopes({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeIds: [envelope.id()]
                    },
                    doneCallback: function () {
                        inprogress(false);
                        loadEnvelopes({ clearAll: true, page: 1 });
                    },
                    errorCallback: errorHandler
                });
            },
            createEnvelope = function() {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.createEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: "",
                        name: "New envelope"
                    },
                    doneCallback: function (result) {
                        //inprogress(false);
                        redirect.envelopeView(result.envelope.id);
                    },
                    errorCallback: errorHandler
                });
            },
            createEnvelopeFromDocument = function (documents) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.createEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: "",
                        name: "New envelope"
                    },
                    doneCallback: function (envelopeResult) {
                        inprogress(false);
                        var $deferreds = [];
                        for (var i = 0; i < documents.length; i++) {
                            $deferreds[i] = $.Deferred(function(def) {
                                repository.envelopeDocument.addDocument({
                                    param: {
                                        userId: config.userId(),
                                        privateKey: config.privateKey(),
                                        envelopeId: envelopeResult.envelope.id,
                                        documentId: documents[i],
                                        parseFields: false,
                                        order: 0
                                    },
                                    doneCallback: function(documentResult) {
                                        def.resolve(documentResult);
                                    },
                                    errorCallback: function (error) {
                                        def.reject(error);
                                    }
                                });
                            }).promise();
                        }
                        $.when.apply(null, $deferreds).then(function () {
                            redirect.envelopeView(envelopeResult.envelope.id);
                        });
                    },
                    errorCallback: errorHandler
                });
            },
            deleteEnvelope = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.deleteEnvelopes({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopesIds: [envelope.id()]
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        envelopes.remove(envelope);
                    },
                    errorCallback: errorHandler
                });
            },
            deleteSelectedEnvelopes = function () {
                if (inprogress()) return;
                var items = [];
                var ignoredItems = 0;
                $.each(envelopes(), function() {
                    var status = this.status();
                    if (this.selected() ){ 
                        if (status == -1 || status == 2 || status == 3 || status == 4 || status == 6) {
                            items[items.length] = this.id();
                        } else {
                            ignoredItems++;
                        }
                    }
                });
                if (ignoredItems > 0) {
                    setTimeout(function() {
                        config.alert({ title: "Notification", message: ignoredItems + " "+ (ignoredItems == 1 ? "item was" : "items were") + " not processed, the status doesn't allow deleting" });
                    },100);
                }
                        
                if (items.length > 0) {
                    inprogress(true);
                    repository.envelope.deleteEnvelopes({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            envelopesIds: items
                        },
                        doneCallback: function (result) {
                            inprogress(false);
                            _.each(items, function (e) {
                                var con = ko.utils.arrayFirst(envelopes(), function (envelope) {
                                    return envelope.id() == e;
                                });
                                envelopes.remove(con);
                            });
                        },
                        errorCallback: errorHandler
                    });
                }

            },
            archiveSelectedEnvelopes = function () {
                if (inprogress()) return;
                var items = [];
                var ignoredItems = 0;
                $.each(envelopes(), function () {
                    if (this.selected() )
                    {
                        if(this.status() == 5){
                            items[items.length] = this.id();
                        } else {
                            ignoredItems++;
                        }
                    }
                });
                
                if (ignoredItems > 0) {
                    setTimeout(function () {
                        config.alert({ title: "Notification", message: ignoredItems + " " + (ignoredItems == 1 ? "item was" : "items were") + " not processed, the status doesn't allow archiving" });
                    }, 100);
                }
                if (items.length > 0) {
                    inprogress(true);
                    repository.envelope.archiveEnvelopes({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            envelopeIds: items
                        },
                        doneCallback: function (result) {
                            inprogress(false);
                            loadEnvelopes({ page: 1, clearAll: true });
                        },
                        errorCallback: errorHandler
                    });
                }
            },
            copyEnvelope = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.createEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: envelope.id(),
                        name: "New envelope"
                    },
                    doneCallback: function (result) {
                        redirect.envelopeView(result.envelope.id);
                    },
                    errorCallback: errorHandler
                });
            },
            resendEmailNotification = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.resendEmailNotification({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope.id()
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                    },
                    errorCallback: errorHandler
                });
            }, checkAll = function () {
                var newValue = !allSelected();
                _.each(envelopes(), function(envelope) {
                    envelope.selected(newValue);
                });
            },
            createTemplate = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.template.createTemplate({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: envelope.id(),
                        name: "New template"
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        redirect.templateView(result.template.id);
                    },
                    errorCallback: errorHandler
                });
            },
            cancelEnvelope = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.cancelEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope.id()
                    },
                    doneCallback: function () {
                        inprogress(false);
                        loadEnvelopes({ clearAll: true, page: 1 });
                    },
                    errorCallback: errorHandler
                });
            },
            retrySignEnvelope = function (envelope) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.retrySignEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeId: envelope.id()
                    },
                    doneCallback: function () {
                        inprogress(false);
                    },
                    errorCallback: errorHandler
                });
            },
            loadEnvelopeDocuments = function (envelope, callback) {
                if (envelope.documentNames() == '') {
                    repository.envelopeDocument.getDocuments({
                        isPublic: false,
                        documentResult: ko.observableArray(),
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            envelopeId: envelope.id()
                        },
                        doneCallback: function(documentResult) {
                            var names = [];
                            ko.utils.arrayForEach(documentResult(), function (item) {
                                if (item.name()!='')
                                    names.push(item.name());
                            });
                            if (names.length>0)
                                envelope.documentNames("Document(s): " + names.join(', '));
                            if (_.isFunction(callback)) {
                                callback();
                            }
                        },
                        errorCallback: errorHandler
                    });
                }
            },
            init = function () {

            };


        ko.bindingHandlers.timeAgo = {
            update: function(element, valueAccessor, allBindingsAccessor) {
                $(element).timeago();
            }
        };
            

        init();

        return {
            inprogress: inprogress,
            loadEnvelopes: loadEnvelopes,
            openEnvelope: openEnvelope,
            restartEnvelope: restartEnvelope,
            archiveEnvelope: archiveEnvelope,
            createEnvelope: createEnvelope,
            createEnvelopeFromDocument: createEnvelopeFromDocument,
            deleteEnvelope: deleteEnvelope,
            envelopes: envelopes,
            totalCount: totalCount,
            itemsPerPage: itemsPerPage,
            page: page,
            statusId: statusId,
            anySelected: anySelected,
            allSelected: allSelected,
            checkAll: checkAll,
            statusText: statusText,
            deleteSelectedEnvelopes: deleteSelectedEnvelopes,
            archiveSelectedEnvelopes: archiveSelectedEnvelopes,
            copyEnvelope: copyEnvelope,
            createTemplate: createTemplate,
            checkIfRecipientIsOwner: checkIfRecipientIsOwner,
            cancelEnvelope: cancelEnvelope,
            retrySignEnvelope: retrySignEnvelope,
            resendEmailNotification: resendEmailNotification,
            loadEnvelopeDocuments: loadEnvelopeDocuments
        };
    });
define('core/vm/vm.envelopes.resources',
    ['ko', 'lib/underscore', 'core/repository', 'core/config'],
    function(ko, _, repository, config) {
        var inprogress = ko.observable(false),
            dashboardInprogress = ko.observable(false),
            resources = ko.observableArray([]),
            statusId = ko.observable(),
            selectedDocument = ko.observable(),
            selectedDate = ko.observable(),
            selectedRecipient = ko.observable(),
            selectedStatus = ko.observable(),
            selectedTag = ko.observable(),
            loadResources = function(callback) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelopeResource.getResources({
                    resourcesResult: resources,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        statusIds: statusId()
                    },
                    doneCallback: function() {
                        inprogress(false);
                    }
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            }, 
            init = function() {
                
            };
        return {
            inprogress: inprogress,
            loadResources: loadResources,
            resources: resources,
            statusId: statusId,
            selectedDocument: selectedDocument,
            selectedDate: selectedDate,
            selectedRecipient: selectedRecipient,
            selectedStatus: selectedStatus,
            dashboardInprogress: dashboardInprogress,
            selectedTag: selectedTag
        };
    });
define('core/vm/vm.error',
    ['jquery',
        'ko'
    ],
    function ($, ko) {
        function getInstance() {
            var isVisible = ko.observable(false),
                errorText = ko.observable(''),
                onBeforeShow = function (){},
                onBeforeClose = function() {};
            return {
                isVisible: isVisible,
                errorText: errorText,
                onBeforeShow: onBeforeShow,
                onBeforeClose: onBeforeClose
            };
        }
        return getInstance;
    });
define('core/vm/vm.filednd',
    [],
    function () {
        return {
        };
    });
define('core/vm/vm.form.participants',
    ['jquery',
        'ko',
        'core/repository',
        'core/config',
        'core/redirect'
    ],
    function ($, ko, repository, config, redirect) {
        var participants = ko.observableArray([]),
            inprogress = ko.observable(false),
            isVisible = ko.observable(false),
            form = ko.observable(),
            doOnKeyUp = function (event) {
                if (!isVisible()) return true;
                var keyCode = (event.which ? event.which : event.keyCode);
                if (keyCode === 27) {
                    isVisible(false);
                    return false;
                }
                return true;
            },
            loadParticipants = function () {
                inprogress(true);
                repository.formParticipant.getFormParticipants({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        formId: form().id()
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        participants(result());
                        isVisible(true);
                    },
                    errorCallback: errorCallback
                });
            },
            view = function (participant) {
                redirect.formSigned(form().id(), participant.id());
            },
            download = function (participant) {
                redirect.downloadFormParticipantDocuments(form().id(), participant.id());
            },
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                inprogress(false);
                return false;
            };
        return {
            participants: participants,
            isVisible: isVisible,
            loadParticipants: loadParticipants,
            inprogress: inprogress,
            form: form,
            doOnKeyUp: doOnKeyUp,
            view: view,
            download: download
        };
    });
define('core/vm/vm.form.prepare',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {

        var progressCount = ko.observable(0),
            inprogress = ko.computed({
                read: function () {
                    return progressCount() > 0;
                },
                write: function (value) {
                    if (value) {
                        progressCount(progressCount() + 1);
                    } else {
                        progressCount(progressCount() - 1);
                    }
                },
                owner: this
            }),


            form = ko.observable(),
            documents = ko.observableArray([]),
            newName = ko.observable('').extend({ required: { message: config.validationMessages.required } }),
            templates = ko.observableArray([]),
            selectedTemplate = ko.observable(),
            signatureFields = ko.observableArray([]),
            previewDocument = ko.observable(),
            fields = ko.observableArray([]),
            formFields = ko.observableArray([]),
            pageWidth = ko.observable(850),
            pageHeight = ko.observable(1200),
            cuttedLocation = ko.observable(),
            copiedLocation = ko.observable(),
            cuttedField = ko.observable(),
            copiedField = ko.observable(),
            selectedField = ko.observable(),
            selectedLocation = ko.observable(),
            newAcceptableValue = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            newAcceptableValueListName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            predefinedLists = ko.observableArray([]),
            selectedPredefinedList = ko.observable(),
            timer,
            fieldsForFinalFileName = ko.observableArray([]),
            outputFilename = ko.observable(),
            viewerAction = 'prepare',
            parseFields = ko.observable(false),
            init = function (formId, callback) {
                //return;
                //if (inprogress()) return;
                inprogress(true);

                repository.form.getForm({
                    itemResult: form,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        formId: formId
                    },
                    doneCallback: function (result) {
                        parseFields(result.parseFields());
                        repository.formDocument.getDocuments(formId,
                            function (documentResult) {
                                documents(documentResult);
                                repository.template.getTemplates(
                                    function (templateResult) {
                                        inprogress(false);
                                        var tmpTemplates = ko.observableArray([]);
                                        _.each(templateResult, function (tpl) {
                                            if (tpl.documentsCount() == 1 && tpl.fieldsCount() > 0) {
                                                $.extend(tpl, { selected: ko.observable(false) });
                                                tmpTemplates.push(tpl);
                                            }
                                        });
                                        templates(tmpTemplates());
                                        //if (documents().length > 0)
                                        //    getDocumentFields(documents()[0].id);
                                        if (_.isFunction(callback)) {
                                            callback(result, documents);
                                        }
                                    },
                                    errorCallback
                                );
                            },
                            errorCallback);
                    },
                    errorCallback: errorCallback
                });


            },
            loadSignatureFields = function () {
                inprogress(true);
                repository.field.getFields({
                    itemsResult: signatureFields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey()
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                    },
                    errorCallback: errorCallback
                });
                inprogress(true);
                repository.predefinedList.getPredefinedLists({
                    itemsResult: predefinedLists,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey()

                    },
                    doneCallback: function (resul) {
                        inprogress(false);
                    },
                    errorCallback: errorCallback
                });
            },
            addDocument = function (fileId, callback) {
                inprogress(true);
                repository.formDocument.addDocument(form().id, fileId, 0, parseFields(),
                    function (documentResult) {
                        inprogress(false);
                        documents.push(documentResult);
                        if (_.isFunction(callback)) {
                            callback(documentResult);
                        }
                        //previewDocument(documents()[0]);
                    },
                    errorCallback);
            },
            removeDocument = function (fileId) {
                inprogress(true);
                repository.formDocument.removeDocument(form().id(), fileId(),
                    function () {
                        inprogress(false);
                        documents.remove($.grep(documents(), function (a) { return a.id() == fileId(); })[0]);
                        fields.removeAll();
                        fieldsForFinalFileName.removeAll();
                        previewDocument(null);
                    },
                    errorCallback);
            },
            viewDocument = function (fileId) {
                inprogress(true);
                redirect.viewDocument(fileId);
            },
            manageFields = function (documentId) {
               // redirect.formFields(form().id(), documentId); //??
            },
            updateForm = function () {
                saveForm(function () {
                    redirect.formDashboard();
                }, true);
            },
            saveForm = function (successCallback, forceSave) {
                if (typeof (forceSave) == "undefined" || forceSave == false) {
                    if (form().dirtyFlag().isDirty() == false && _.every(fieldsForFinalFileName(), function (fld) { return fld.selectedDirtyFlag().isDirty() == false; })) {
                        if (_.isFunction(successCallback))
                            successCallback();
                        return;
                    }
                }
                inprogress(true);

                var flds = [];
                _.each(fieldsForFinalFileName(), function (fld) {
                    if (fld.selected()) {
                        flds.push(fld.name());
                    }
                    fld.selectedDirtyFlag().reset();
                });
                return repository.form.modifyForm(form().id(), form().name(), flds, form().canParticipantDownloadForm(),
                    form().waterMarkText(), form().waterMarkImage(), form().notifyOwnerOnSign(), form().attachSignedDocument(),
                    form().notifyOtherOnSign(), form().canParticipantPrintForm(), form().requireUserAuthForSign(), form().requestUserAuthByPhoto(),
                    form().enableTypedSignature(), form().enableUploadedSignature(), form().requireUserIdentityValidation(),
                    form().canBeCommented(), form().showParticipantCommentInSignedDocument(), form().tags(),
                    function (result) {
                        inprogress(false);
                        form().dirtyFlag().reset();
                        if (successCallback)
                            successCallback();
                    },
                    errorCallback
                );

            },
            cancelPrepare = function () {
                redirect.formDashboard();
            },
            addField = function (fieldId, pageNum, relativeX, relativeY, locationHeight, locationWidth, forceNewField, fieldName) {
                inprogress(true);
                repository.formField.addField(previewDocument().id(), fieldId, forceNewField, form().id(), locationHeight, locationWidth, relativeX, relativeY, fieldName, pageNum,pageWidth(),pageHeight(),
                    function (fieldResult) {
                        inprogress(false);
                        fieldResult.locations.remove(function (item) {
                            return item.documentGuid() != previewDocument().id();
                        });
                        $.extend(fieldResult, { selected: ko.observable(false) });
                        $.extend(fieldResult, { selectedDirtyFlag: ko.DirtyFlag([fieldResult.selected]) });
                        if (forceNewField && ! _.find(fields(), function(a) { return a.id() == fieldResult.id(); })) {
                            if (fieldResult.fieldType() == config.signatureFieldType.SingleLine || fieldResult.fieldType() == config.signatureFieldType.Dropdown || fieldResult.fieldType() == config.signatureFieldType.Date) {
                                fieldsForFinalFileName.push(fieldResult);
                            }
                            fields.push(fieldResult);
                        } else {
                            $.grep(fields(), function (a) { return a.id() == fieldResult.id(); })[0].locations.push(fieldResult.locations.pop());
                        }
                    },
                    errorCallback
                );
            },
            updateFieldLocation = function (location, callback) {
                if (!location) return;
                inprogress(true);
                repository.formField.updateFieldLocation(previewDocument().id(), location.fieldGuid(), form().id(), location.locationHeight(), location.id(), location.locationWidth(),
                                                          location.locationX(), location.locationY(), location.page(), location.fontBold(), location.fontColor(), location.fontItalic(),
                                                            location.fontName(), location.fontSize(), location.fontUnderline(), location.align(),pageWidth(),pageHeight(),

                    successCallback = function (fieldResult) {
                        inprogress(false);
                        location.dirtyFlag().reset();
                        if (_.isFunction(callback)) {
                            callback(fieldResult);
                        }
                    },
                    function (error) {
                        inprogress(false);
                        config.alert({ title: "Error", message: error });
                        getDocumentFields(previewDocument().id());
                    }
                );
            },

            deleteFieldLocation = function (field, location) {
                inprogress(true);
                repository.formField.deleteFieldLocation(location.fieldGuid(), form().id(), location.id(),
                    successCallback = function () {
                        inprogress(false);
                        field.locations.remove(location);
                        if (field.locations().length == 0) {
                            fields.remove(field);
                            fieldsForFinalFileName.remove(field);
                            generateOutputFilename();
                        }
                        selectedField(null);
                        selectedLocation(null);
                    },
                    errorCallback
                );
            },
             isValidDate = function (s) {
                 if (!s || s.length == 0) return true;
                 if (s.length != 10) return false;
                 var bits = s.split('.');
                 if (!bits[0] || !bits[1] || !bits[2]) return false;
                 if (bits[2] < 1900 || bits[2] > 2100) return false;
                 var d = new Date(bits[2], bits[1] - 1, bits[0]);
                 return d && (d.getMonth() + 1) == bits[1] && d.getDate() == Number(bits[0]);
             },
            updateField = function (field, callback) {
                if (!field) return;
                if (!field.isValid()) {
                    config.alert({ title: "Field not saved", message: 'Field data is not valid' });
                    return;
                }
                if (field.fieldType() == config.signatureFieldType.Date) {
                    if (!field.settings().minYear.isValid() || !field.settings().maxYear.isValid()) {
                        config.alert({ title: "Field not saved", message: 'Invalid date settings' });
                        return;
                    }
                }
                if (field.fieldType() > 1 && field.fieldType() < 5 && field.defaultValue() != '') {
                    if (field.regularExpression() != null && !field.defaultValue().match(field.regularExpression())) {
                        config.alert({ title: "Field not saved", message: 'Default value is not valid' });
                        return;
                    }
                    if (field.fieldType() == 4 && field.regularExpression() == null && !isValidDate(field.defaultValue())) {
                        config.alert({ title: "Field not saved", message: 'Default date is not valid' });
                        return;
                    }
                }
                inprogress(true);
                repository.formField.updateField(previewDocument().id(), field.id(), form().id(), field.acceptableValuesArray().join(";"), field.defaultValue(), field.mandatory(), field.name(), "", field.regularExpression(), field.tooltip(), field.guidanceText(), field.groupName(), field.fieldType(), ko.toJSON(field.settings()),

                    successCallback = function (fieldResult) {
                        inprogress(false);
                        fieldsForFinalFileName.remove(field);
                        if (fieldResult.fieldType() == config.signatureFieldType.SingleLine || fieldResult.fieldType() == config.signatureFieldType.Dropdown || fieldResult.fieldType() == config.signatureFieldType.Date) 
                            fieldsForFinalFileName.push(field);
                        
                        field.dirtyFlag().reset();
                        if (_.isFunction(callback)) {
                            callback(fieldResult);
                        }
                    },
                    errorCallback
                );
            },

            updateMovedField = function (location, event) {
                if (!location.selected()) return;
                clearInterval(timer);
                timer = setTimeout(function () {
                    if (event.keyCode > -37 && event.keyCode <= 40)
                        updateFieldLocation(location);
                }, 2000);
            },
            getDocumentFields = function (documentId, callback) {
                inprogress(true);
                selectedField(null);
                selectedLocation(null);
                repository.formField.getFields(null, form().id(),
                    function(fieldsResult) {
                        inprogress(false);
                        fields.removeAll();
                        formFields(fieldsResult);
                        var fileNameFields = [];
                        _.each(formFields(), function(field) {
                            $.extend(field, { selected: ko.observable(false) });
                            $.extend(field, { selectedDirtyFlag: ko.DirtyFlag([field.selected]) });
                            if (field.fieldType() == config.signatureFieldType.SingleLine || field.fieldType() == config.signatureFieldType.Dropdown || field.fieldType() == config.signatureFieldType.Date) {
                                if ($.inArray(field.name(), form().fieldsInFinalFileName()) != -1)
                                    field.selected(true);
                                field.selectedDirtyFlag().reset();
                                fileNameFields.push(field);
                            }
                        });
                        ko.utils.arrayForEach(formFields(), function (item) {
                            var field = ko.mapping.fromJS(ko.toJS(item));
                            field.settings = ko.observable(field.settings);
                            _.each(field.locations(), function(location) {
                                if (location.documentGuid() != documentId) {
                                    var index = field.locations().indexOf(location);
                                    field.locations().splice(index, 1);
                                }
                            });
                            if (field.locations().length>0)
                                fields.push(field);
                        });
                        setTimeout(function () { // ie stop this script
                            var finalFields = form().fieldsInFinalFileName();
                            fileNameFields = _.sortBy(fileNameFields, function (fld) {
                                var idx = finalFields.indexOf(fld.name());
                                return idx == -1 ? fileNameFields.length : idx;

                            });
                            fieldsForFinalFileName(fileNameFields);
                            setTimeout(function () {
                                generateOutputFilename();
                            }, 1);
                        }, 1);
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                    },
                    errorCallback);


                
                /*
                repository.formField.getFields(documentId, form().id(),
                    successCallback = function (fieldsResult) {
                        inprogress(false);
                        fields(fieldsResult);
                        var fileNameFields = [];
                        _.each(fields(), function (field) {
                            $.extend(field, { selected: ko.observable(false) });
                            $.extend(field, { selectedDirtyFlag: ko.DirtyFlag([field.selected]) });
                            if (field.fieldType() == config.signatureFieldType.SingleLine || field.fieldType() == config.signatureFieldType.Dropdown || field.fieldType() == config.signatureFieldType.Date) {
                                if ($.inArray(field.name(), form().fieldsInFinalFileName()) != -1)
                                    field.selected(true);
                                field.selectedDirtyFlag().reset();
                                fileNameFields.push(field);
                            }
                        });
                        setTimeout(function() { // ie stop this script
                            var finalFields = form().fieldsInFinalFileName();
                            fileNameFields = _.sortBy(fileNameFields, function (fld) {
                                var idx = finalFields.indexOf(fld.name());
                                return idx == -1 ? fileNameFields.length : idx;

                            });
                            fieldsForFinalFileName(fileNameFields);
                            setTimeout(function() {
                                generateOutputFilename();
                            }, 1);
                            
                        }, 1);
                        
                        if (_.isFunction(callback)) {
                            callback();
                        }
                    },
                    errorCallback
                );
                */
            },
            getDocumentField = function (documentId, fieldId, callback) {
                inprogress(true);
                repository.formField.getField(documentId, form().id(), fieldId,
                    function (fieldsResult) {
                        inprogress(false);
                        var field = ko.utils.arrayFirst(fields(), function (f) {
                            return f.id() === fieldId;
                        });
                        fields.replace(field, fieldsResult);
                        if (_.isFunction(callback)) {
                            callback();
                        }
                    },
                    errorCallback
                );
            },
            copyFieldLocation = function (field, location) {
                if (location.selected()) {
                    copiedLocation(location);
                    copiedField(field);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            cutFieldLocation = function (field, location) {
                if (location.selected()) {
                    if (field == null) return;
                    cuttedLocation(location);
                    cuttedField(field);
                    copiedLocation(null);
                    copiedField(null);
                    field.locations.remove(location);
                }
            },
            pasteNewField = function () {
                if (copiedLocation() != null && copiedField() != null) {
                    var signatureCopiedField = $.grep(signatureFields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    addField(signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), true, '');
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
                if (cuttedLocation() != null && cuttedField() != null) {
                    var signatureCuttedField = $.grep(signatureFields(), function (a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    addField(signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX(), cuttedLocation().locationY(), cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), true, '');
                    deleteFieldLocation(cuttedField(), cuttedLocation());
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            pasteNewLocation = function () {
                if (copiedLocation() != null && copiedField() != null) {
                    var formCopiedField = $.grep(fields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    var signatureCopiedField = $.grep(signatureFields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    addField(formCopiedField != null ? copiedLocation().fieldGuid() : signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), formCopiedField != null ? false : true, formCopiedField != null ? copiedField().name() : '');
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
                if (cuttedLocation() != null && cuttedField() != null) {
                    var formCuttedField = $.grep(fields(), function (a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    var signatureCuttedField = $.grep(signatureFields(), function (a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    addField(formCuttedField != null ? cuttedLocation().fieldId() : signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX() + 0.05, cuttedLocation().locationY() + 0.05, cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), formCuttedField != null ? false : true, formCuttedField != null ? cuttedField().name() : '');
                    deleteFieldLocation(cuttedField(), cuttedLocation());
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            addFieldFromMenu = function (fieldType) {
                var signatureField = $.grep(signatureFields(), function (a) { return a.fieldType() == fieldType; })[0];
                var height, width;
                switch (fieldType) {
                    case 1:
                        //signature
                        height = 46;
                        width = 148;
                        break;
                    case 6:
                        //checkbox
                        height = 25;
                        width = 25;
                        break;
                    default:
                        height = 25;
                        width = 205;
                        break;
                }
                addField(signatureField.id(), 1, 0, 0, height, width, true, '');
            },
            selectDefaultValue = function (value) {
                if (selectedField() != null)
                    selectedField().defaultValue(value);
            },
            addAcceptableValue = function () {
                newAcceptableValue($.trim(newAcceptableValue()));
                if ($.grep(newAcceptableValue.errors(), function (error) {
                        return error != null;
                }).length > 0) {
                    newAcceptableValue.errors.showAllMessages(true);
                    return;
                };


                if (selectedField() != null && newAcceptableValue() != '') {
                    if (selectedField().acceptableValuesArray().indexOf(newAcceptableValue()) > -1) {
                        config.alert({ title: "Error", message: "Value already in list" });
                        return;
                    }
                    selectedField().acceptableValuesArray.push(newAcceptableValue());
                    newAcceptableValue('');
                    selectedPredefinedList(null);
                    newAcceptableValue.errors.showAllMessages(false);
                }

            },
            deleteAcceptableValue = function (value) {
                $.confirm({
                    title: "Delete Confirmation",
                    message: "Are you sure ?",
                    buttons: {
                        Yes: {
                            action: function () {
                                selectedField().acceptableValuesArray.remove(value);
                                if (selectedField().defaultValue() == value)
                                    selectedField().defaultValue('');
                            }
                        },
                        No: {}
                    }
                });
            },
            addNewAcceptableValuesList = function () {
                if ($.grep(newAcceptableValueListName.errors(), function (error) {
                    return error != null;
                }).length > 0) {
                    newAcceptableValueListName.errors.showAllMessages(true);
                    return;
                };

                if (selectedField() != null && newAcceptableValueListName() != '') {
                    inprogress(true);
                    repository.predefinedList.addList({
                        itemsResult: predefinedLists,
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            name: newAcceptableValueListName(),
                            defaultValue: selectedField().defaultValue(),
                            values: selectedField().acceptableValues()
                        },
                        successCallback: function (result) {
                            inprogress(false);
                            predefinedLists.push(result);
                        },
                        errorCallback: function (error) {
                            config.alert({ title: "error", message: error });
                        }
                    });
                    newAcceptableValueListName('');
                    newAcceptableValueListName.errors.showAllMessages(false);
                }
            },
            deleteAcceptableValuesList = function () {
                if (selectedPredefinedList() == null) return;
                inprogress(true);
                repository.predefinedList.deleteList({
                    itemsResult: predefinedLists,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        listId: selectedPredefinedList().id()
                    },
                    successCallback: function (result) {
                        inprogress(false);
                        var selected = selectedPredefinedList();
                        selectedPredefinedList(null);
                        predefinedLists.remove(selected);
                    },
                    errorCallback: function (error) {
                        config.alert({ title: "error", message: error });
                    }
                });
            },
            addFromTemplate = function (callback) {

                if (selectedTemplate() == null) return;
                inprogress(true);
                $.each(documents(), function () {
                    var item = this;
                    removeDocument(item.id);
                });
                fields.removeAll();
                fieldsForFinalFileName.removeAll();
                previewDocument(null);
                repository.form.updateFormFromTemplate(form().id(), selectedTemplate().id(),
                    function (data) {
                        inprogress(false);
                        init(form().id(), callback);
                    },
                    errorCallback
                );
            },
            selectTemplate = function (template) {
                if (template.selected()) {
                    $.each(templates().filter(function (fltItem) {
                        return fltItem.selected() && fltItem.id != template.id;
                    }), function () {
                        this.selected(false);
                    });
                    selectedTemplate(template);
                }
            },
            resetFields = function () {

                $.confirm({
                    title: "Reset confirmation",
                    message: "Are you sure you want to reset all fields? This will remove all placed fields.",
                    buttons: {
                        Yes: {
                            action: function () {
                                var flds = [];
                                _.each(fields(), function (field) {
                                    flds[flds.length] = field.id();
                                });
                                if (flds.length > 0) {
                                    inprogress(true);
                                    repository.formField.deleteFields(form().id(), flds,
                                        function () {
                                            inprogress(false);
                                            fields.removeAll();
                                            fieldsForFinalFileName.removeAll();
                                        },
                                        errorCallback);
                                }

                            }
                        },
                        No: {}
                    }
                });
            },
            publishForm = function () {
                $.confirm({
                    title: "Publish confirmation",
                    message: "This will publish the form. Are you sure?",
                    buttons: {
                        Yes: {
                            action: function () {
                                saveForm(function () {
                                    inprogress(true);
                                    repository.form.publishForm(form().id(),
                                        function () {
                                            inprogress(false);
                                            redirect.formDashboard();
                                        },
                                        errorCallback
                                    );
                                });
                            }
                        },
                        No: {}
                    }
                });
            },
            generateOutputFilename = function () {
                var items = [];
                var fieldsTmp = fieldsForFinalFileName();
                _.each(fieldsTmp, function (fld) {
                    if (fld.selected()) {
                        items.push(fld.name() + 'value');
                    }
                });
                if (items.length > 0)
                    outputFilename(items.join('_') + ".pdf");
                else
                    outputFilename('form_{timestamp}_{participantId}.pdf');
            },
            isOwnField = function (field) {
                return true;// compatibilty with envelope viewer 
            },
            renameDocument = function (document, callback) {
                if (newName() == '')
                    return;
                repository.formDocument.renameDocument(document.formGuid(), document.documentGuid(), newName(),
                    function (response) {
                        document.name(response.result.document.name);
                        if (_.isFunction(callback)) {
                            callback(response);
                        }
                    },
                    errorCallback);
            },
            replaceDocument = function (oldDocument, newDocumentGuid, callback) {
                repository.formDocument.modifyDocument(oldDocument.formGuid(), oldDocument.documentGuid(), newDocumentGuid, 0,
                    function (newDocument) {
                        documents.push(newDocument);
                        documents.remove(oldDocument);
                        previewDocument(null);
                        getDocumentFields(newDocument.documentGuid(), function () {
                            if (_.isFunction(callback)) {
                                callback(newDocument);
                            }
                        });
                    },
                    errorCallback);
            },
            regularExpressions = ko.computed(function () {
                if (selectedField() != null && (selectedField().fieldType() == config.signatureFieldType.SingleLine || selectedField().fieldType() == config.signatureFieldType.SingleLine || selectedField().fieldType() == config.signatureFieldType.Date)) {
                    return config.fieldValidations.filter(function (item) {
                        return $.grep(item.fieldType.split(','), function (e) { return e == selectedField().fieldType(); })[0] != null;
                    });
                } else
                    return [];
            }),
            getFieldsForDocument = function (documentGuid) {
                var result = _.filter(formFields(), function (item) {
                    return _.some(item.locations(), function (location) {
                        return location.documentGuid() == documentGuid;
                    });
                });
                return result;
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };
        selectedPredefinedList.subscribe(function (newValue) {
            if (newValue != null) {
                $.confirm({
                    title: "Apply list confirmation",
                    message: "Are you sure that you apply the selected list?",
                    buttons: {
                        Yes: {
                            action: function () {
                                selectedField().acceptableValuesArray(newValue.values());
                                selectedField().defaultValue('');
                            }
                        },
                        No: {}
                    }
                });
            }
        });
        ko.validation.group(newAcceptableValue);
        ko.validation.group(newAcceptableValueListName);

        return {
            inprogress: inprogress,
            form: form,
            documents: documents,
            templates: templates,
            selectedTemplate: selectedTemplate,
            selectTemplate: selectTemplate,
            init: init,
            addDocument: addDocument,
            removeDocument: removeDocument,
            viewDocument: viewDocument,
            manageFields: manageFields,
            updateForm: updateForm,
            cancelPrepare: cancelPrepare,
            previewDocument: previewDocument,
            signatureFields: signatureFields,
            fields: fields,
            pageWidth: pageWidth,
            pageHeight: pageHeight,
            updateFieldLocation: updateFieldLocation,
            addField: addField,
            deleteFieldLocation: deleteFieldLocation,
            updateMovedField: updateMovedField,
            getDocumentFields: getDocumentFields,
            getDocumentField: getDocumentField,
            cuttedLocation: cuttedLocation,
            copiedLocation: copiedLocation,
            cuttedField: cuttedField,
            copiedField: copiedField,
            selectedField: selectedField,
            selectedLocation: selectedLocation,
            copyFieldLocation: copyFieldLocation,
            cutFieldLocation: cutFieldLocation,
            pasteNewField: pasteNewField,
            pasteNewLocation: pasteNewLocation,
            addFieldFromMenu: addFieldFromMenu,
            addFromTemplate: addFromTemplate,
            publishForm: publishForm,
            config: config,
            newAcceptableValue: newAcceptableValue,
            newAcceptableValueListName: newAcceptableValueListName,
            predefinedLists: predefinedLists,
            selectedPredefinedList: selectedPredefinedList,
            selectDefaultValue: selectDefaultValue,
            addAcceptableValue: addAcceptableValue,
            deleteAcceptableValue: deleteAcceptableValue,
            addNewAcceptableValuesList: addNewAcceptableValuesList,
            isOwnField: isOwnField,
            updateField: updateField,
            resetFields: resetFields,
            fieldsForFinalFileName: fieldsForFinalFileName,
            generateOutputFilename: generateOutputFilename,
            outputFilename: outputFilename,
            loadSignatureFields: loadSignatureFields,
            viewerAction: viewerAction,
            saveForm: saveForm,
            parseFields: parseFields,
            renameDocument: renameDocument,
            newName: newName,
            replaceDocument: replaceDocument,
            regularExpressions: regularExpressions,
            deleteAcceptableValuesList: deleteAcceptableValuesList,
            getFieldsForDocument: getFieldsForDocument
        };
    });
define('core/vm/vm.form.signed',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/routes'],
    function ($, ko, _, repository, configuration, routes) {
        var viewerAction = 'signed',
            config = configuration,
            inprogress = ko.observable(false),
            formId = ko.observable(''),
            participants = ko.observableArray([]),
            defaultParticipantId = ko.observable(),
            selectedParticipant = ko.observable(),
            selectedDocument = ko.observable(),
            loadParticipants = function() {
                inprogress(true);
                repository.formParticipant.getFormParticipants({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        formId: formId()
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        participants(result());
                        var selected = ko.utils.arrayFirst(participants(), function (item) {
                            return item.id() == defaultParticipantId();
                        });
                        if (selected != null) {
                            selectedParticipant(selected);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            downloadLink = ko.computed(function () {
                return formId()!=null && selectedParticipant()!=null ? routes.publicDownloadFormDocumentsUrl(formId(), selectedParticipant().id()) : "";
            }),
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                inprogress(false);
                return false;
            },
            init = function () {
                loadParticipants();
            };

        //init();

        return {
            init: init,
            viewerAction: viewerAction,
            config: config,
            inprogress: inprogress,
            formId: formId,
            participants: participants,
            selectedParticipant: selectedParticipant,
            selectedDocument: selectedDocument,
            downloadLink: downloadLink,
            defaultParticipantId: defaultParticipantId,
        };
    });
define('core/vm/vm.form.signedEmbed',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/routes'],
    function ($, ko, _, repository, configuration, routes) {
        var viewerAction = 'signed',
            config = configuration,
            inprogress = ko.observable(false),
            documents = ko.observableArray([]),
            signedDocument = ko.observable(null),
            documentGuid = ko.observable(''),
            canDownload = ko.observable(false),
            canPrint = ko.observable(false),
            formId = ko.observable(''),
            participantId = ko.observable(''),
            loadForm = function (callback) {
                inprogress(true);
                repository.form.publicGetFormParticipant(formId(), participantId(),
                    function (result) {
                        if (result.status == 1) {
                            setTimeout(function () {
                                loadForm(callback);
                            }, 2000);
                        } else {
                            inprogress(false);
                            documents.removeAll();
                            _.each(result.signedDocuments, function (doc) {
                                documents.push({
                                        name : ko.observable(doc.name),
                                        documentGuid : ko.observable(doc.documentGuid)
                                });
                            });
                            signedDocument(documents[0]);
                            if (_.isFunction(callback)) {
                                callback(result.signedDocuments[0]);
                            }                            
                        }
                    }, errorCallback
                );

            },
            downloadLink = ko.computed( function() {
                if (canDownload())
                    return routes.publicDownloadFormDocumentsUrl(formId(),participantId());
                else
                    return '#';
            }),
            errorCallback = function(error) {
                config.alert({ title: "Error", message: error });
                inprogress(false);
                return false;
            },
            init = function() {
                
            };
            
        init();
        
        return {
            viewerAction: viewerAction,
            config: config,
            inprogress: inprogress,
            formId: formId,
            participantId:participantId,
            loadForm: loadForm,
            documentGuid: documentGuid,
            canDownload: canDownload,
            downloadLink: downloadLink,
            canPrint: canPrint,
            documents: documents,
            signedDocument: signedDocument
        };
    });
define('core/vm/vm.form.signEmbed',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect',
        'core/eventManager'],
    function ($, ko, _, repository, configuration, redirect, event) {
        var viewerAction = 'sign',
            config = configuration,
            eventManager = new event({
                formFieldFilledCallback: function (data) {
                    var fieldData = JSON.parse(data.data);
                    var field = ko.utils.arrayFirst(fields(), function (item) {
                        return item.id() == fieldData.fieldId;
                    });
                    field.progress(data.percent);
                }
            }),
            inprogress = ko.observable(false),
             _formId = '',
            _participandId = '',
           // form = ko.observable(),
           isValidated = ko.observable(false), 
            documents = ko.observableArray([]),
            signDocument = ko.observable(),
            fields = ko.observableArray([]),
            locations = ko.observableArray([]),
            hideStartButton = ko.observable(false),
            isOwnField = function (field) {
                return true;
            },
            loadDocument = function (formId, particpiantId, callback) {
                inprogress(true);
                _participandId = particpiantId;
                _formId = formId;
                repository.formDocument.publicGetDocuments(formId,
                    function (documentResult) {
                        inprogress(false);
                        documents(documentResult);
                        signDocument(documentResult[0]);
                        if (_.isFunction(callback)) {
                            callback(documentResult[0]);
                        }
                    }, errorCallback);
            },
            loadFields = function (documentId, callback) {
                if (inprogress()) return;
                inprogress(true);
                fields.removeAll();
                locations.removeAll();
                repository.formField.publicGetFields(null, _formId, _participandId,
                    function(fieldsResult) {
                        var fieldLocations = [];
                        ko.utils.arrayForEach(fieldsResult, function(docField) {
                            docField.locations.remove(function(item) {
                                return item.documentGuid() != documentId;
                            });
                        });
                        _.each(fieldsResult, function (item) {
                            var validators = {};
                            if (item.fieldType() != configuration.signatureFieldType.Date) {
                                if (item.regularExpression() != null && item.regularExpression() != '') {
                                    var errorMessage = $.grep(config.fieldValidations, function (r) { return r.expression == item.regularExpression(); })[0].errorMessage;
                                    validators.pattern = { params: item.regularExpression(), message: errorMessage };
                                }
                            }
                            var groupMandatory = false;
                            if (item.fieldType() == configuration.signatureFieldType.Checkbox && item.groupName() != "") {
                                groupMandatory = _.filter(fieldsResult, function(fld) {
                                    return fld.groupName() == item.groupName() && item.mandatory();
                                }).length > 0;
                            }
                            if (item.mandatory() || groupMandatory) {
                                validators.required = { message: "" };
                                if (item.fieldType() == configuration.signatureFieldType.Checkbox)
                                    validators.validation = {
                                        validator: function(val) {
                                            if (item.groupName() != '') {
                                                var checkedGroupFields = _.filter(fields(), function(fld) {
                                                    return fld.groupName() == item.groupName() && fld.data() == 'on';
                                                });
                                                return checkedGroupFields.length > 0;
                                            } else
                                                return val && val == 'on';
                                        }
                                    };
                            }
                            if ((item.data() == null || item.data() == '') && item.defaultValue() != null && item.defaultValue() != '') {
                                item.data(item.defaultValue());
                                fillField(item, item.locations()[0]);
                            }
                            item.data.extend(validators);
                            item.dirtyFlag = new ko.DirtyFlag([item.data]);
                            fields.push(item);
                            if (isOwnField(item)) {
                                _.each(item.locations(), function (l) {
                                    fieldLocations.push(l);
                                });
                            }
                        });
                        if (fieldLocations.length > 0) {
                            /*
                            fieldLocations.sort(function (left, right) {
                                var pageHeight = 1105;
                                var pageWidth = 854;
                                var pageSize = pageHeight * pageWidth;
                                var p1 = left.page() * pageHeight*pageSize + left.locationY() * pageWidth + left.locationX();
                                var p2 = right.page() * pageHeight*pageSize + right.locationY() * pageWidth + right.locationX();
                                return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                            });
                            */
                            fieldLocations.sort(function (left, right) {
                                var p1 = left.order();
                                var p2 = right.order();
                                return p1 == p2 ? 0 : (p1 < p2 ? -1 : 1);
                            });
                            locations(fieldLocations);
                        }
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                        inprogress(false);
                    },
                    errorCallback
                );
            },
            fillField = function (field, location) {
                if (field.data() == null) return;
                inprogress(true);
                repository.formField.publicFillField(field.data(), location.documentGuid(), field.id(), _formId, _participandId,
                    function (fieldsResult) {
                        inprogress(false);
                    },
                    errorCallback
                );
            },
            signForm = function (participantName,authData, comment,email) {
                inprogress(true);
                repository.form.publicSignForm(_formId, _participandId, participantName,authData, comment,email,
                    function (result) {
                        inprogress(false);
                        redirect.embedFormSigned(_formId, _participandId);
                    },
                    function(error) {
                        errorCallback(error, function () {
                            window.location.reload();
                        });
                    }
                );
            },
            getActiveLocation = function () {
                return _.find(locations(), function (item) { return item.selected(); });
            },
            activateNextLocation = function () {
                var selectedLocation = getActiveLocation();
                if (selectedLocation != null) {
                    var selectedLocationIndex = locations.indexOf(selectedLocation);
                    var nextLocationIndex;
                    if (locations().length > selectedLocationIndex + 1) {
                        nextLocationIndex = selectedLocationIndex + 1;
                    } else {
                        nextLocationIndex = 0;
                    }
                    activateLocation(locations()[nextLocationIndex]);
                } else {
                    if (locations().length > 0) {
                        activateLocation(locations()[0]);
                    }
                }
                hideStartButton(true);
            },
            activatePrevLocation = function () {
                var selectedLocation = getActiveLocation();
                if (selectedLocation != null) {
                    var selectedLocationIndex = locations.indexOf(selectedLocation);
                    var prevLocationIndex;
                    if (selectedLocationIndex > 0) {
                        prevLocationIndex = selectedLocationIndex - 1;
                    } else {
                        prevLocationIndex = locations().length - 1;
                    }
                    activateLocation(locations()[prevLocationIndex]);
                }
                hideStartButton(true);
            },
            fieldsToBeFilled = function () {
                if (!fields() || fields().length == 0)
                    return -1;
                var invalidFields = 0;
                $.each(fields(), function () {
                    if (isOwnField(this)) {
                        if (!this.isValid()) {
                            invalidFields++;
                        }
                    }
                });
                return invalidFields;
            },
            hasPrevLocation = function () {
                return locations.indexOf(getActiveLocation()) == 0;
            },
            hasNextLocation = function () {
                return locations.indexOf(getActiveLocation()) < locations().length - 1;
            },
            activateLocation = function (location) {
                if (location == null) return;
                $.each(locations(), function () { this.selected(false); });
                location.selected(true);
                hideStartButton(true);
            },
            getActiveField = function () {
                var location = getActiveLocation();
                return _.find(fields(), function (item) { return item.id() == location.fieldGuid(); });
            },
            activateFirstInvalidLocation = function () {
                var field;
                $.each(fields(), function () {
                    if (isOwnField(this)) {
                        if (!this.isValid()) {
                            field = this;
                            return false;
                        }
                    }
                });
                if (field != null)
                    activateLocation(field.locations()[0]);
            },
            fileUploaded = function (field, location, evt) {
                if (config.checkFileApiSupport()) {
                    var frField = new FileReader();
                    frField.onload = function(e) {
                        field.data(JSON.stringify({
                            size: evt.target.files[0].size,
                            type: evt.target.files[0].type,
                            name: evt.target.files[0].name,
                            data: e.target.result
                        }));
                        fillField(field, location);
                    };
                    frField.readAsDataURL(evt.target.files[0]);
                } else {
                    requirejs(['lib/fileApi/FileAPI'], function() {
                        var files = FileAPI.getFiles(evt);
                        FileAPI.readAsDataURL(files[0], function (dataUrlObject) {
                            if (dataUrlObject.type == 'load') {
                                field.data(JSON.stringify({
                                    size: files[0].size,
                                    type: files[0].type,
                                    name: files[0].name,
                                    data: dataUrlObject.result
                                }));
                                fillField(field, location);
                            }
                        });
                    });
                }
            },
            errorCallback = function (error, closeCallback) {
                inprogress(false);
                config.alert({ title: "Error", message: error, closeCallback: closeCallback });
                return false;
            };
        return {
            viewerAction: viewerAction,
            config: config,
            inprogress: inprogress,
            documents: documents,
            signDocument: signDocument,
            fields: fields,
            isOwnField: isOwnField,
            fillField: fillField,
            signForm: signForm,
            locations: locations,
            activateNextLocation: activateNextLocation,
            activatePrevLocation: activatePrevLocation,
            fieldsToBeFilled: fieldsToBeFilled,
            hasPrevLocation: hasPrevLocation,
            hasNextLocation: hasNextLocation,
            getActiveLocation: getActiveLocation,
            activateLocation: activateLocation,
            activateFirstInvalidLocation: activateFirstInvalidLocation,
            hideStartButton: hideStartButton,
            getActiveField: getActiveField,
            loadDocument: loadDocument,
            loadFields: loadFields,
            fileUploaded: fileUploaded
        };
    });
define('core/vm/vm.form.validate',
    ['ko', 'core/config', 'core/repository'],
    function (ko, config, repository) {

        function getInstance() {
            var isVisible = ko.observable(false),
                inprogress = ko.observable(false),
                email = ko.observable().extend({ required: { message: config.validationMessages.required }, email: { message: config.validationMessages.invalidEmail }, noSpaces: {} }),
                code = ko.escapedObservable(""),
                emailExist = ko.observable(false),
                formId = ko.observable(),
                participantId = ko.observable(),

                validate = function () {
                    if (!code() || code().length != 10)
                        return;
                    inprogress(true);
                    repository.form.publicValidateFormParticipant(formId(), participantId(), code(),
                         function (result) {
                             inprogress(false);
                             if (result == true)
                                 isVisible(false);
                             else {
                                 config.alert({ title: "Error", message: "Provided code is not valid" });
                             }
                             
                         },
                         errorCallback
                     );
                    
                },
                setEmail = function () {
                    if (!email.isValid())
                        return;
                    inprogress(true);
                    repository.form.publicModifyFormParticipant(formId(), participantId(), email(),
                         function (result) {
                             inprogress(false);
                             email(result.email);
                             emailExist(result.email && result.email.length > 5);
                         },
                         errorCallback
                     );
                },
                loadParticipant = function () {
                    inprogress(true);
                    repository.form.publicGetFormParticipant(formId(), participantId(),
                        function (result) {
                            inprogress(false);
                            if (result.status == 1) {//tdo status
                                
                            }
                            email(result.email);
                            emailExist(result.email && result.email.length > 5);
                        },
                        errorCallback
                    );

                },
                resentValidationCode= function () {
                    inprogress(true);
                    repository.form.publicFormParticipantResentValidationCode(formId(), participantId(),
                         function (result) {
                             inprogress(false);
                             if (result == true)
                                 config.alert({ title: "Information", message: "Email was sent to "+email() });
                            

                         },
                         errorCallback
                     );

                },
                errorCallback = function (error) {
                    config.alert({ title: "Error", message: error });
                    inprogress(false);
                    return false;
                },
                init = function (formid, participantid) {
                    isVisible(true);
                    formId(formid);
                    participantId(participantid);
                    loadParticipant();
                }
            ;
            //ko.validation.group(email);

            return {
                isVisible: isVisible,
                inprogress: inprogress,
                validate: validate,
                email: email,
                code: code,
                emailExist:emailExist,
                setEmail: setEmail,
                init: init,
                resentValidationCode: resentValidationCode
            };
        }
        return getInstance;
    });
define('core/vm/vm.forms',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function ($, ko, _, repository, config, redirect) {
        var forms = ko.observableArray([]),
            inprogress = ko.observable(false),
            totalCount = ko.observable(10),
            statusId = ko.observable('-3'),
            page = ko.observable(1),
            itemsPerPage = ko.observable(1000),
            documentId = ko.observable(''),
            date = ko.observable(''),
            name = ko.observable(''),
            tag = ko.observable(''),
            loadForms = function(options, callback) {
                if (inprogress()) return;

                if (options != null && options.clearAll != null && options.clearAll) {
                    forms.removeAll();
                    totalCount(0);
                }
                if (options != null && options.page != null)
                    page(options.page);
                if (options != null && options.documentId != null)
                    documentId(options.documentId);
                if (options != null && options.date != null)
                    date(options.date);
                if (options != null && options.statusId != null)
                    statusId(options.statusId);
                if (options != null && options.name != null)
                    name(options.name);
                if (options != null && options.tag != null)
                    tag(options.tag);
                inprogress(true);
                repository.form.getForms({
                    forceRefresh: true,
                    itemsResult: forms,
                    itemsCount: totalCount,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        statusId: statusId(),
                        page: page(),
                        pageSize: itemsPerPage(),
                        documentId: documentId(),
                        date: date(),
                        name: name(),
                        tag: tag()
                    },
                    doneCallback: function() {
                        inprogress(false);
                        resizeElements();
                    },
                    errorCallback:errorCallback
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            },
            createForm = function() {
                if (inprogress()) return;
                inprogress(true);
                repository.form.createForm(
                    doneCallback= function(result) {
                       // dispaly progress intil redirect happen inprogress(false);
                        redirect.formView(result.form.id);
                    },
                    errorCallback
                );
            },
            openForm = function(form) {
                if (form.status() == -1) { //draft
                    redirect.formView(form.id());
                }
            },
            completeForm = function(form) {
                if (inprogress()) return;
                inprogress(true);
                repository.form.completeForm({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        formId: form.id()
                    },
                    doneCallback: function() {
                        inprogress(false);
                        loadForms({ clearAll: true, page: 1 });
                    },
                    errorCallback:errorCallback
                });
            },
            deleteForm = function(form) {
                if (inprogress()) return;
                inprogress(true);
                repository.form.deleteForms({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        formsIds: [form.id()]
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        forms.remove(form);
                    },
                    errorCallback:errorCallback
                });
            },
            archiveForm = function(form) {
                if (inprogress()) return;
                inprogress(true);
                repository.form.archiveForm({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        formId: form.id()
                    },
                    doneCallback: function() {
                        inprogress(false);
                        loadForms({ clearAll: true, page: 1 });
                    },
                    errorCallback:errorCallback
                });
            },
            selectedItems = ko.computed( function (){
                return _.filter(forms(), function (form) {
                    return form.selected() == true;
                });
            }),
            deleteSelected = function () {
                 if (inprogress()) return;
                 $.confirm({
                     title: "Delete confirmation",
                     message: "Are you sure you want to delete selected forms?" + (statusId()!='3'? " <br />Note: Only forms with status 'Draft' will be deleted.":""),
                     buttons: {
                         Yes: {
                             'class': "",
                             'action': function () {
                                 var ignoredItems = 0;
                                 var formIds = [];
                                 $.each(selectedItems(), function () {
                                     if (this.status() == -1 || this.status() == 3) { // drafts and archived can be deleted only
                                         formIds[formIds.length] = this.id();
                                     } else {
                                         ignoredItems++;
                                     }
                                 });
                                 if (ignoredItems > 0) {
                                     setTimeout(function () {
                                         config.alert({ title: "Notification", message: ignoredItems + " " + (ignoredItems == 1 ? "item was" : "items were") + " not processed, the status doesn't allow deleting" });
                                     }, 100);
                                 }
                                 if (formIds.length > 0) {
                                     inprogress(true);
                                     repository.form.deleteForms({
                                         param: {
                                             userId: config.userId(),
                                             privateKey: config.privateKey(),
                                             formsIds: formIds
                                         },
                                         doneCallback: function(result) {
                                             inprogress(false);
                                             _.each(formIds, function (f) {
                                                 var frm = ko.utils.arrayFirst(forms(), function (form) {
                                                     return form.id() == f;
                                                 });
                                                 forms.remove(frm);
                                             });
                                         },
                                         errorCallback:errorCallback
                                     });
                                 }
                             }
                         },
                         No: {}
                     }
                 });   
            },
            archiveSelected= function () {
                var self = this;
                $.confirm({
                    title: "Archive confirmation",
                    message: "Are you sure you want to archive selected forms? <br />Note: Only forms with status 'Completed' will be archived.",
                    buttons: {
                        Yes: {
                            'class': "",
                            'action': function () {
                                var ignoredItems = 0;
                                var formIds = [];
                                $.each(selectedItems(), function () {
                                    if (this.status() == 2) {
                                        formIds[formIds.length] = this.id();
                                    } else {
                                        ignoredItems++;
                                    }
                                });
                                if (ignoredItems > 0) {
                                    setTimeout(function () {
                                        config.alert({ title: "Notification", message: ignoredItems + " " + (ignoredItems == 1 ? "item was" : "items were") + " not processed, the status doesn't allow archivng" });
                                    }, 100);
                                }
                                if (formIds.length > 0) {
                                    inprogress(true);
                                    repository.form.archiveForms(formIds,
                                        doneCallback = function(result) {
                                            inprogress(false);
                                            loadForms({ clearAll: true, page: 1 });
                                        },
                                        errorCallback);
                                }
                            }
                        },
                        No: {}
                    }
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            },
            checkAll = function () {
                var newValue = !allSelected();
                _.each(forms(), function (form) {
                    form.selected(newValue);
                });
            },
            allSelected = ko.computed(function () {
                return forms().length > 0 &&
                    $.grep(forms(), function(form) {
                        return form.selected() == true;
                    }).length == forms().length;
            }),
            publishForm = function (form) {
                repository.form.publishForm(form.id(),
                                       function () {
                                           inprogress(false);
                                           loadForms({ clearAll: true, page: 1 });
                                       },
                                       errorCallback
                                   );
               
            },
            copyForm = function (form) {
                if (inprogress()) return;
                inprogress(true);
                repository.form.createForm(
                    doneCallback = function (result) {
                        redirect.formView(result.form.id);
                    },
                    errorCallback,
                    '','','','','',form.id()
                );
            },
            createFormFromDocument = function (documents) {
                if (inprogress()) return;
                inprogress(true);
                repository.form.createForm(
                    doneCallback = function (formResult) {
                        inprogress(false);
                        var $deferreds = [];
                        for (var i = 0; i < documents.length; i++) {
                            $deferreds[i] = $.Deferred(function (def) {
                                repository.formDocument.addDocument(formResult.form.id, documents[i], 0, false,
                                    doneCallback = function (documentResult) {
                                        def.resolve(documentResult);

                                    },
                                    errorCallback = function (error) {
                                        inprogress(false);
                                        def.reject(error);
                                    });
                            }).promise();
                        }
                        $.when.apply(null, $deferreds).then(function () {
                            inprogress(false);
                            redirect.formView(formResult.form.id);
                        });
                    },
                    errorCallback
                );
            },
            loadFormDocuments = function (form, callback) {
                if (form.documentNames() == '') {
                    repository.formDocument.publicGetDocuments(form.id(),
                        function(documentResult) {
                            var names = [];
                            ko.utils.arrayForEach(documentResult, function (item) {
                                names.push(item.name());
                            });
                            if (names.length > 0)
                                form.documentNames("Document(s): " + names.join(', '));
                            if (_.isFunction(callback)) {
                                callback();
                            }
                        }, errorCallback);
                }
            },
            init = function() {

            };
        
        init();

        return {
            inprogress: inprogress,
            loadForms: loadForms,
            forms: forms,
            totalCount: totalCount,
            itemsPerPage: itemsPerPage,
            page: page,
            createForm: createForm,
            openForm: openForm,
            completeForm: completeForm,
            deleteForm: deleteForm,
            archiveForm: archiveForm,
            statusId: statusId,
            checkAll: checkAll,
            selectedItems: selectedItems,
            deleteSelected: deleteSelected,
            archiveSelected: archiveSelected,
            allSelected: allSelected,
            publishForm: publishForm,
            copyForm: copyForm,
            createFormFromDocument: createFormFromDocument,
            loadFormDocuments: loadFormDocuments
        };
    });
define('core/vm/vm.forms.resources',
    ['ko', 'lib/underscore', 'core/repository', 'core/config'],
    function (ko, _, repository, config) {
        var inprogress = ko.observable(false),
            resources = ko.observableArray([]),
            statusId = ko.observable(),
            selectedDocument = ko.observable(),
            selectedDate = ko.observable(),
            selectedStatus = ko.observable(),
            selectedTag = ko.observable(),
            dashboardInprogress = ko.observable(),
            loadResources = function (callback) {
                if (inprogress()) return;
                inprogress(true);
                repository.formResource.getResources({
                    resourcesResult: resources,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        statusIds: statusId()
                    },
                    doneCallback: function () {
                        inprogress(false);
                    }
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            },
            init = function () {

            };
        return {
            inprogress: inprogress,
            loadResources: loadResources,
            resources: resources,
            statusId: statusId,
            selectedDocument: selectedDocument,
            selectedDate: selectedDate,
            selectedStatus: selectedStatus,
            dashboardInprogress: dashboardInprogress,
            selectedTag: selectedTag
        };
    });
define('core/vm/vm.loading',
    ['ko'],
    function (ko) {
        var inprogress = ko.observable(false);
        return {
            inprogress: inprogress
        };
    });
define('core/vm/vm.navigationmenu',
    ['ko',
    'core/repository',
    'core/config',
    'core/redirect'],  
    function (ko, repository, config, redirect) {
        var areas = {
                Envelopes: 0,
                Templates: 1,
                Forms: 2,
                Contacts: 3,
                Signatures: 4,
                Archived: 5
            },
            inprogress = ko.observable(false),
            selectedArea = ko.observable(0),
            openEnvelopeDashboard = function () {
                redirect.envelopeDashboard();
            },
            createEnvelope = function () {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.createEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: "",
                        name: "New envelope"
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        redirect.envelopeView(result.envelope.id);
                    },
                    errorCallback:errorCallback
                });

            },
            openContactDashboard = function() {
                redirect.contactDashboard();
            },
            openTemplateDashboard = function() {
                redirect.templateDashboard();
            },
            openSignatureDashboard = function () {
                redirect.signatureDashboard();
            },
            openFormDashboard = function () {
                redirect.formDashboard();
            },
            showArchivedLink = ko.computed(function () {
                return selectedArea() == areas.Envelopes || selectedArea() == areas.Forms || selectedArea() == areas.Archived;
            }),
            openArchivedDashboard = function() {
                if (selectedArea() == areas.Envelopes) {
                    redirect.envelopeArchivedDashboard();
                }
                if (selectedArea() == areas.Forms) {
                    redirect.formArchivedDashboard();
                }
            },
            createForm = function () {
                if (inprogress()) return;
                inprogress(true);
                repository.form.createForm(
                    doneCallback = function (result) {
                        inprogress(false);
                        redirect.formView(result.form.id);
                    },
                    errorCallback
                );
            },
            createTemplate = function () {
                if (inprogress()) return;
                inprogress(true);
                repository.template.createTemplate({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: "",
                        name: "New template"
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        redirect.templateView(result.template.id);
                    },
                    errorCallback:errorCallback
                });
            },
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                return false;
            }
        ;
        return {
            inprogress: inprogress,
            areas: areas,
            selectedArea: selectedArea,
            openEnvelopeDashboard: openEnvelopeDashboard,
            createEnvelope: createEnvelope,
            openContactDashboard: openContactDashboard,
            openTemplateDashboard: openTemplateDashboard,
            openSignatureDashboard: openSignatureDashboard,
            openFormDashboard: openFormDashboard,
            showArchivedLink: showArchivedLink,
            openArchivedDashboard: openArchivedDashboard,
            createForm: createForm,
            createTemplate: createTemplate
        };
    });
define('core/vm/vm.quicksearch',
    [],
    function() {
        var searchText = ko.escapedObservable(""),
            clear = function() {
                searchText("");
            };
        return {
            searchText: searchText,
            clear: clear
        };
    });
define('core/vm/vm.signaturedetails',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config'],
    function ($, ko, _, repository, config) {
        var currentSignature = ko.observable(repository.signature.getBlank()),
            inprogress = ko.observable(false),
            isVisible = ko.observable(false),
            isNew = ko.observable(false),
            setNewSignature = function() {
                isNew(true);
                currentSignature(repository.signature.getBlank());
                currentSignature().errors.showAllMessages(true);
            },
            editSignature = function(signature) {
                isNew(false);
                currentSignature(signature);
            },
            doOnKeyUp = function(event) {
                if (!isVisible()) return true;
                var keyCode = (event.which ? event.which : event.keyCode);
                if (keyCode === 13) {
                    if (isNew()) {
                        addSignature();
                    } else {
                        updateSignature();
                    }
                    return false;
                }
                if (keyCode === 27) {
                    isVisible(false);
                    return false;
                }
                return true;
            },
            addSignature = function(callback) {
                if (!currentSignature().isValid()) {
                    currentSignature().errors.showAllMessages(true);
                    return;
                }
                if (inprogress() == true)
                    return;
                inprogress(true);
                repository.signature.createSignature({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        envelopeName: currentSignature().name(),
                        companyName: currentSignature().companyName(),
                        position: currentSignature().position(),
                        firstName: currentSignature().firstName(),
                        lastName: currentSignature().lastName(),
                        textInitials: currentSignature().textInitials(),
                        signatureData: currentSignature().signatureImageUrl(),
                        initialsData: ""
                    },
                    successCallback: function (signatureResult) {
                        inprogress(false);
                        isVisible(false);
                        if (_.isFunction(callback)) {
                            callback(signatureResult);
                        }

                    },
                    errorCallback: errorCallback
                });
            },
            updateSignature = function (callback) {
                if (!currentSignature().isValid()) {
                    currentSignature().errors.showAllMessages(true);
                    return;
                }
                repository.signature.updateSignature({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        signatureId: currentSignature().id(),
                        name: currentSignature().name(),
                        companyName: currentSignature().companyName(),
                        position: currentSignature().position(),
                        firstName: currentSignature().firstName(),
                        lastName: currentSignature().lastName(),
                        textInitials: currentSignature().textInitials(),
                        signatureData: currentSignature().signatureImageUrl(),
                        initialsData: ""
                    },
                    successCallback: function (signatureResult) {
                        inprogress(false);
                        isVisible(false);
                        if (_.isFunction(callback)) {
                            callback(signatureResult);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            },
            init = function() {
            };

        init();
        return {
            inprogress: inprogress,
            currentSignature: currentSignature,
            isVisible: isVisible,
            isNew: isNew,
            setNewSignature: setNewSignature,
            editSignature: editSignature,
            doOnKeyUp: doOnKeyUp,
            addSignature: addSignature,
            updateSignature: updateSignature
        };
    });
define('core/vm/vm.signaturepad',
    ['jquery',
     'lib/underscore',
        'ko',
        'core/repository',
        'core/config'
    ],
    function ($, _, ko, repository, config) {

        function getInstance() {
            var isVisible = ko.observable(false),
                inprogress = ko.observable(true),
                showSelectTab = ko.observable(true),
                showSaveButton = ko.observable(true),
                showTypeItTab = ko.observable(true),
                showUploadTab = ko.observable(true),
                fontsLoading = ko.observable(false),
                signatures = ko.observableArray([]),
                itemsCount = ko.observable(),
                fontsArray = ko.observableArray([]),
                loadedFontsArray = ko.observableArray([]),
                signatureText = ko.escapedObservable(config.userName()),
                uploadedImage = ko.observable(),
                saveToMySignatures = ko.observable(false),
                vectorPad = ko.observable(true),
                signatureColors = ko.observableArray(config.signatureColors),
                signatureColor = ko.observable(config.signatureColors[0]),
                expanded = ko.observable(false),
                drawPadSvg,
                drawPadCanvas,
                forceRasterSignatureCanvas = false,
                initialized = false,
                padIndex = ko.observable(Math.floor(Math.random() * 9999) + 1),
                matchWidth = ko.observable(false),
                activeSignatureColor = ko.computed({
                    read: function() {
                        return vectorPad() ? signatureColor() == "" ? config.signatureColors[0] : signatureColor() : config.signatureColors[0];
                    },
                    write: function(value) {
                        if (vectorPad()) {
                            if (value == '')
                                signatureColor(config.signatureColors[0]);
                            else
                                signatureColor(value);
                        }
                    }
                }),
                signatureIsValid = function() {
                    if (vectorPad()) {
                        if (typeof(drawPadSvg) != "undefined")
                            return drawPadSvg.getPaths().length > 0;
                        return false;
                    }
                    return drawPadCanvas.getSignatureImage().length > 650;
                },
                padWidth = 264,
                padHeight = 88,
                signaturesLodaded = false,
                loadSignatures = function() {
                    if (signatures().length == 0 && showSelectTab() && !signaturesLodaded) {
                        inprogress(true);
                        repository.signature.getSignatures({
                            itemsResult: signatures,
                            itemsCount: itemsCount,
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                page: 1,
                                count: 100000,
                                name: ''
                            },
                            doneCallback: function(result) {
                                inprogress(false);
                                signaturesLodaded = true;
                            },
                            errorCallback: errorCallback
                        });
                    }
                },
                saveSignature = function(envelopeName, signatureData) {
                    inprogress(true);
                    repository.signature.createSignature({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            envelopeName: envelopeName,
                            companyName: '',
                            position: '',
                            firstName: '',
                            lastName: '',
                            textInitials: '',
                            signatureData: signatureData,
                            initialsData: ''
                        },
                        successCallback: function(signatureResult) {
                            inprogress(false);
                            if (showSelectTab())
                                signatures.unshift(signatureResult);
                            saveToMySignatures(false);
                        },
                        errorCallback: errorCallback
                    });
                },
                onPopupShow = function() {
                },
                errorCallback = function(error) {
                    config.alert({ title: "Error", message: error });
                    return false;
                },
                savedSignatureAfterRender = function() {
                },
                createImageFromTypedSignature = function(fontName, fontSize) {
                    var tmpCanvas = document.createElement('canvas'), tmpContext = null;
                    tmpCanvas.style.position = 'absolute';
                    tmpCanvas.style.top = '-999em';
                    tmpCanvas.width = padWidth;
                    tmpCanvas.height = padHeight;
                    document.body.appendChild(tmpCanvas);
                    if (!tmpCanvas.getContext && FlashCanvas)
                        FlashCanvas.initElement(tmpCanvas);
                    tmpContext = tmpCanvas.getContext('2d');
                    //tmpContext.fillStyle = '#ffffff';
                    //tmpContext.fillRect(0, 0, padWidth, padHeight);
                    tmpContext.lineWidth = 2;
                    tmpContext.strokeStyle = activeSignatureColor();
                    tmpContext.font = "normal " + fontSize + " '" + fontName + "'";
                    tmpContext.fillStyle = activeSignatureColor();
                    tmpContext.fillText(signatureText() == "" ? "Signature" : signatureText(), 5, 60);
                    return tmpCanvas.toDataURL.apply(tmpCanvas);
                },
                createSvgFromTypedSignature = function(fontName, fontSize, width, height) {
                    //var fontHeight = parseInt(fontSize.replace("px", ""));
                    var w = width || padWidth;
                    var h = height || padHeight;

                    var svg = $("<svg />")
                        .attr("xmlns", "http://www.w3.org/2000/svg")
                        .attr("width", "100%")
                        .attr("height", "100%")
                        //.attr("height", padHeight)
                        .attr("viewBox", "0 0 " + w + " " + h)
                        .attr("preserveAspectRatio", "none")
                        .append(
                            $("<text />")
                                .attr("font-family", fontName)
                                .attr("font-size", fontSize)
                                .attr("fill", activeSignatureColor())
                                .attr("y", "50%")
                                .attr("x", "50%")
                                //.attr("dominant-baseline", "central")
                                .attr("dy", "0.3em")
                                .attr("text-anchor", "middle")
                                .html(signatureText() == "" ? "Signature" : signatureText())
                        )                   
                        .append(
                            $("<defs />")
                                .append(
                                    $("<link />")
                                        .attr("href", 'http://fonts.googleapis.com/css?family=' + fontName.replace(/ /g, '+'))
                                        .attr("type", "text/css")
                                        .attr("rel", "stylesheet")
                                        .attr("xmlns", "http://www.w3.org/1999/xhtml")
                                )
                                .append(
                                    $("<style />")
                                        .attr("type", "text/css")
                                        .html("@import url(" + 'http://fonts.googleapis.com/css?family=' + fontName.replace(/ /g, '+') + ")")
                                )
                        )
                    ;
                    return $("<div>")
                        .append(svg)
                        .html();
                },
                readUploadedFile = function(file) {
                    var frSignature = new FileReader();
                    frSignature.onload = function(e) {
                        uploadedImage(e.target.result);
                    };
                    frSignature.readAsDataURL(file);
                },
                fileDragged = function (item, event, files) {
                    if (files.length > 0) {
                        var inpFile = files[0];
                        if (inpFile.type == 'image/jpeg' || inpFile.type == 'image/jpg' || inpFile.type == 'image/png' || inpFile.type == 'image/gif')
                            readUploadedFile(inpFile);
                        else
                            config.alert({ title: "Error", message: "Please select image file" });
                    }
                },
                fileUploaded = function(item, event) {
                    
                    if (config.checkFileApiSupport()) {
                        var input = event.target;
                        var inpFile = input.files[0];
                        if (inpFile.type == 'image/jpeg' || inpFile.type == 'image/jpg' || inpFile.type == 'image/png' || inpFile.type == 'image/gif')
                            readUploadedFile(inpFile);
                        else
                            config.alert({ title: "Error", message: "Please select image file" });
                       
                    } else {
                        requirejs(['lib/fileApi/FileAPI'], function () {
                            var files = FileAPI.getFiles(event);
                            var fileExtension = "";
                            if (files[0].name.lastIndexOf(".") > 0) {
                                fileExtension = files[0].name.substring(files[0].name.lastIndexOf(".") + 1, files[0].name.length).toLowerCase();
                            }
                            if (fileExtension == 'jpeg' || fileExtension == 'jpg' || fileExtension == 'png' || fileExtension == 'gif')
                                FileAPI.readAsDataURL(files[0], function (dataUrlObject) {
                                    if (dataUrlObject.type == 'load') {
                                        uploadedImage(dataUrlObject.result);
                                    }
                                });
                            else
                                config.alert({ title: "Error", message: "Please select image file" });
                        });
                    }
                },
                show = function () {
                    init().done(function () {
                        if (vectorPad()) {
                            if (typeof (drawPadSvg) != "undefined") {
                                drawPadSvg.clear();
                            }
                        } else {
                            drawPadCanvas.clearDrawAndUploadData();
                            drawPadCanvas.clearCanvas();
                        }
                        uploadedImage(null);
                        isVisible(true);
                    });
                },
                hide = function() {
                    isVisible(false);
                },
                clear = function() {
                    init().done(function() {
                        if (vectorPad())
                            drawPadSvg.clear();
                        else {
                            drawPadCanvas.clearDrawAndUploadData();
                            drawPadCanvas.clearCanvas();
                        }
                    });
                },
                getSignatureData = function() {
                    var signatureData;
                    if (vectorPad())
                        signatureData = drawPadSvg.getSvg();
                    else
                        signatureData = drawPadCanvas.getSignatureImage();
                    return signatureData;
                },
                loadFonts = function () {
                    var notLoaded = [];
                    WebFont.load({
                        google: {
                            families: fontsArray()
                        },
                        loading: function() {
                            fontsLoading(true);
                        },
                        active: function() {
                            fontsLoading(false);
                        },
                        inactive: function() {
                            fontsLoading(false);
                            if (notLoaded.length > 0) {
                                var url = ('https:' == document.location.protocol ? 'https' : 'http') + '://fonts.googleapis.com/css?family=';
                                while (notLoaded.length) {
                                    var fonts = notLoaded.splice(0, 5);
                                    var fontFamilyUrl = url + fonts.join('|').replace(/ /g, '+');
                                    if (document.createStyleSheet)
                                        document.createStyleSheet(fontFamilyUrl);
                                    else {
                                        $("<link/>", {
                                            rel: "stylesheet",
                                            type: "text/css",
                                            href: fontFamilyUrl
                                        }).appendTo("head");
                                    }
                                    var arr = loadedFontsArray();
                                    _.each(fonts,function(element) {
                                        arr[element] = true;
                                    });
                                    loadedFontsArray.valueHasMutated();
                                }
                            }
                        },
                        fontloading: function() {
                        },
                        fontactive: function (font) {
                            var arr = loadedFontsArray();
                            arr[font] = true;
                            loadedFontsArray.valueHasMutated();

                            if (!fontsLoading()) return;

                            var firstThreeLoaded = _.every(_.first(arr, 3), function(val) {
                                return val;
                            });
                            if (firstThreeLoaded && fontsLoading()) {
                                fontsLoading(false);
                            }
                        },
                        fontinactive: function(fontFamily, fontDescription) { // when failed to load font - there is an issue with IE8 - it can't load all fonts at once
                            notLoaded.push(fontFamily);
                            /*
                            return;
                            var url = ('https:' == document.location.protocol ? 'https' : 'http') + '://fonts.googleapis.com/css?family=' + fontFamily.replace(/ /g, '+');
                                
                            if (document.createStyleSheet) {
                                try {
                                    document.createStyleSheet(url);
                                } catch (e) {
                                    fontsArray.remove(fontFamily);
                                } 
                                    
                            } else {
                                $("<link/>", {
                                    rel: "stylesheet",
                                    type: "text/css",
                                    href: url
                                }).appendTo("head");
                            }
                            fontsLoading(false);
                            */
                        }
                    });
                },
                applyDrawSignature = function() {
                    if (!signatureIsValid()) {
                        config.alert({ title: "Error", message: "Please draw the signature" });
                        return false;
                    }
                    var signatureData = getSignatureData();
                    hide();
                    return signatureData;
                },
                init = function () {
                    return $.Deferred(function (def) {
                        if (!forceRasterSignatureCanvas && config.checkBrowserForSvgSupport()) {
                            require(["svgSignaturePad"], function () {
                                drawPadSvg = new signaturePad("#signature-draw-container-" + padIndex(), signatureColor);
                                vectorPad(true);
                            });
                        } else {
                            require(["rasterSignaturePad"], function () {
                                drawPadCanvas = $('#signature-pad-' + padIndex()).signaturePad({ lineTop: 80, drawOnly: true, lineWidth: 0 });
                                vectorPad(false);
                            });
                        }
                        if (initialized) {
                            def.resolve();
                            return;
                        }
                        try {
                            fontsArray(config.fontsArray);
                        } catch(e) { //IE8
                            fontsArray(config.fontsArray);
                        } 
                        var arr = [];
                        _.each(config.fontsArray, function(font) {
                            arr[font] = false;
                        });
                        loadedFontsArray(arr);
                        require(["webfont", "signatureUpload"], function () {
                            initialized = true;
                            loadFonts();
                            def.resolve();
                        });
                        if (!config.checkFileApiSupport()) {
                            $("#dropFilesArea").remove();
                            if (typeof (window.FileAPI) == "undefined") {
                                window.FileAPI = {
                                    debug: false,
                                    cors: false,
                                    media: false,
                                    staticPath: '/scripts/lib/fileApi/',
                                    flashImageUrl: '/scripts/lib/fileApi/FileAPI.flash.image.swf',
                                    postNameConcat: function(name, idx) {
                                        return name + (idx != null ? '[' + idx + ']' : '');
                                    }
                                };
                                requirejs(['lib/fileApi/FileAPI'], function() {});
                            }
                        }
                    });
                };
            return {
                isVisible: isVisible,
                inprogress: inprogress,
                showSelectTab: showSelectTab,
                showSaveButton: showSaveButton,
                showTypeItTab: showTypeItTab,
                showUploadTab: showUploadTab,
                signatures: signatures,
                loadSignatures: loadSignatures,
                saveSignature: saveSignature,
                onPopupShow: onPopupShow,
                fontsArray: fontsArray,
                loadedFontsArray: loadedFontsArray,
                signatureText: signatureText,
                uploadedImage: uploadedImage,
                saveToMySignatures: saveToMySignatures,
                savedSignatureAfterRender: savedSignatureAfterRender,
                createImageFromTypedSignature: createImageFromTypedSignature,
                fileDragged: fileDragged,
                fileUploaded: fileUploaded,
                vectorPad: vectorPad,
                createSvgFromTypedSignature: createSvgFromTypedSignature,
                signatureColor: signatureColor,
                signatureColors: signatureColors,
                activeSignatureColor: activeSignatureColor,
                show: show,
                getSignatureData: getSignatureData,
                clear: clear,
                hide: hide,
                fontsLoading: fontsLoading,
                config: config,
                applyDrawSignature: applyDrawSignature,
                padIndex: padIndex,
                matchWidth: matchWidth,
                expanded: expanded,
                init: init
            };
        }

        return getInstance;
    });
define('core/vm/vm.signatures',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function ($, ko, _, repository, config, redirect) {
        var signatures = ko.observableArray([]),
            inprogress = ko.observable(false),
            totalCount = ko.observable(10),
            page = ko.observable(1),
            itemsPerPage = ko.observable(10),
            name = ko.observable(''),
            loadSignatures = function(options, callback) {
                if (inprogress()) return;
                if (options != null && options.clearAll != null && options.clearAll) {
                    signatures.removeAll();
                    totalCount(0);
                }
                if (options != null && options.page != null)
                    page(options.page);
                if (options != null && options.name != null)
                    name(options.name);
                inprogress(true);
                repository.signature.getSignatures({
                    itemsResult: signatures,
                    itemsCount: totalCount,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        page: page(),
                        count: itemsPerPage(),
                        name: name()
                    },
                    doneCallback: function() {
                        inprogress(false);
                        resizeElements();
                    },
                    errorCallback: errorCallback
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            },
            deleteSignature = function(signature) {
                if (inprogress()) return;
                inprogress(true);
                repository.signature.deleteSignatures({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        signaturesIds: [signature.id()]
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        signatures.remove(signature);
                    },
                    errorCallback:errorCallback
                });
            },
            selectedItems = ko.computed(function () {
                return _.filter(signatures(), function (signature) {
                    return signature.selected() == true;
                });
            }),
            deleteSelected = function () {
                if (inprogress()) return;
                $.confirm({
                    title: "Delete confirmation",
                    message: "Are you sure you want to delete selected signatures?",
                    buttons: {
                        Yes: {
                            'class': "",
                            'action': function () {

                                var signatureIds = [];
                                $.each(selectedItems(), function () {
                                    signatureIds[signatureIds.length] = this.id();
                                });
                                if (signatureIds.length > 0) {
                                    inprogress(true);
                                    repository.signature.deleteSignatures({
                                        param: {
                                            userId: config.userId(),
                                            privateKey: config.privateKey(),
                                            signaturesIds: signatureIds
                                        },
                                        doneCallback: function (result) {
                                            inprogress(false);
                                            if (result.status == 'Ok') {
                                                _.each(signatureIds, function (s) {
                                                    var sig = ko.utils.arrayFirst(signatures(), function (cko) {
                                                        return cko.id() == s;
                                                    });
                                                    signatures.remove(sig);
                                                });
                                            } else {
                                                config.alert("error", result.error_message);
                                            }
                                        },
                                        errorCallback: errorCallback
                                    });
                                }
                            }
                        },
                        No: {}
                    }
                });
            },
            checkAll = function () {
                var newValue = !allSelected();
                _.each(signatures(), function (signature) {
                    signature.selected(newValue);
                });
            },
            allSelected = ko.computed(function () {
                return signatures().length > 0 &&
                    $.grep(signatures(), function (signature) {
                        return signature.selected() == true;
                    }).length == signatures().length;
            }),
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                return false;
            };


        return {
            inprogress: inprogress,
            signatures: signatures,
            totalCount: totalCount,
            itemsPerPage: itemsPerPage,
            page: page,
            loadSignatures: loadSignatures,
            deleteSignature: deleteSignature,
            selectedItems: selectedItems,
            deleteSelected: deleteSelected,
            allSelected: allSelected,
            checkAll: checkAll,
            config: config
        };
    });
define('core/vm/vm.template.prepare',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            template = ko.observable(),
            documents = ko.observableArray([]),
            loadTemplate = function (templateId, callback) {
                inprogress(true);
                repository.template.getTemplate({
                    itemsResult: template,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: templateId
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            loadDocuments = function (templateId, callback) {
                inprogress(true);
                documents.removeAll();
                repository.templateDocument.getDocuments({
                    documentResult: documents,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: templateId
                    },
                    doneCallback: function (result) {
                        inprogress(false);                   
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            updateTemplate = function () {
                inprogress(true);
                repository.template.renameTemplate({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id(),
                        name: template().name(),
                    },
                    doneCallback: function (renameResult) {
                        repository.template.updateTemplate({
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey(),
                                templateId: template().id(),
                                name: template().name(),
                                emailBody: template().emailBody(),
                                emailSubject: template().emailSubject(),
                                templateExpireTime: template().templateExpireTime(),
                                orderedSignature: template().orderedSignature(),
                                ownerShouldSign: template().ownerShouldSign(),
                                reminderTime: template().reminderTime(),
                                stepExpireTime: template().stepExpireTime(),
                                waterMarkText: template().waterMarkText(),
                                waterMarkImage: template().waterMarkImage(),
                                enableTypedSignature: template().enableTypedSignature(),
                                enableUploadedSignature: template().enableUploadedSignature(),
                                tags: template().tags()
                            },
                            doneCallback: function (templateResult) {
                                inprogress(false);
                                updateRecipientsOrder(function () {
                                    redirect.templateDashboard();
                                });
                            },
                            errorCallback:errorCallback
                        });
                    }
                });
            },
            updateRecipientsOrder = function (sucessCallback) {

                var $deferreds = [];
                for (var i = 0; i < template().recipients().length; i++) {
                    var recipient = template().recipients()[i];
                    if (recipient.isValid()) {
                        recipient.order(i);
                        $deferreds[i] = $.Deferred(function (def) {

                            repository.templateRecipient.updateRecipient({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    recipientId: recipient.id(),
                                    templateId: template().id,
                                    nickname:recipient.nickname,
                                    roleId: function () {
                                        switch (recipient.roleId()) {
                                            case 1:
                                                return "58416f6827eb612fef7750b62cf2bf9a";
                                            case 2:
                                                return "693e6cee8a4a21285f86930491b455ec";
                                            default:
                                                return "6df1056f4d9a27ec34698552a6372a68";
                                        }
                                    },
                                    order: recipient.order()
                                },
                                successCallback: function (recipientResult) {
                                    def.resolve(recipientResult);
                                },
                                errorCallback: function (error) {
                                    def.reject(error);
                                }
                            });
                        }).promise();
                    }
                }
                $.when.apply(null, $deferreds).then(function () {
                    if (_.isFunction(sucessCallback))
                        sucessCallback();
                });

            },
            cancelPrepare = function () {
                redirect.templateDashboard();
            },
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                return false;
            };
        

        return {
            inprogress: inprogress,
            template: template,
            documents: documents,
            loadTemplate: loadTemplate,
            loadDocuments: loadDocuments,
            updateTemplate: updateTemplate,
            cancelPrepare: cancelPrepare
        };
    });


define('core/vm/vm.template.prepare.step1',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            documents = ko.observableArray([]),
            newName = ko.observable('').extend({ required: { message: config.validationMessages.required } }),
            parseFields = ko.observable(false),
            addDocument = function(templateId, fileId) {
                inprogress(true);
                repository.templateDocument.addDocument({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: templateId,
                        documentId: fileId,
                        parseFields: parseFields(),
                        order: 0
                    },
                    doneCallback: function(documentResult) {
                        inprogress(false);
                        documents.push(documentResult);
                    },
                    errorCallback: errorCallback
                });
            },
            removeDocument = function(templateId, fileId) {
                inprogress(true);
                repository.templateDocument.removeDocument({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: templateId,
                        documentId: fileId,
                        order: 0
                    },
                    doneCallback: function() {
                        inprogress(false);
                        documents.remove($.grep(documents(), function(a) { return a.documentId() == fileId(); })[0]);
                    },
                    errorCallback:errorCallback
                });

            },
            viewDocument = function(fileId) {
                redirect.viewDocument(fileId);
            },
            renameDocument = function (document, callback) {
                if (newName() == '')
                    return;
                repository.templateDocument.renameDocument(document.templateId(), document.documentId(), newName(),
                    function (response) {
                        document.name(response.result.document.name);
                        if (_.isFunction(callback)) {
                            callback(response);
                        }
                    },
                    errorCallback);
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };

        return {
            inprogress: inprogress,
            documents: documents,
            parseFields: parseFields,
            addDocument: addDocument,
            removeDocument: removeDocument,
            viewDocument: viewDocument,
            renameDocument: renameDocument,
            newName: newName
        };
    });


define('core/vm/vm.template.prepare.step2',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            template = ko.observable(),
            newRecipient = {
                nickname: ko.escapedObservable('').extend({ required: { message: config.validationMessages.required }, maxLength: { params: 100, message: 'Name too long' } }),
                role: ko.observable(2)
            },
            addOwnerAsRecipient = function(callback) {
                inprogress(true);
                repository.template.updateTemplate({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id(),
                        emailBody: template().emailBody(),
                        emailSubject: template().emailSubject(),
                        templateExpireTime: template().templateExpireTime(),
                        orderedSignature: template().orderedSignature(),
                        ownerShouldSign: true,
                        reminderTime: template().reminderTime(),
                        stepExpireTime: template().stepExpireTime(),
                        waterMarkText: template().waterMarkText(),
                        waterMarkImage: template().waterMarkImage(),
                        enableTypedSignature: template().enableTypedSignature(),
                        enableUploadedSignature: template().enableUploadedSignature(),
                        tags: template().tags()
                    },
                    doneCallback: function(result) {
                        inprogress(false);
                        template().ownerShouldSign(true);
                        template().recipients.push($.grep(result.recipients(), function (a) { return a.roleId() == 1; })[0]);
                        if (_.isFunction(callback)) {
                            callback(result);
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            addRecipient = function (recipient, callback) {
                if (inprogress() == true)
                    return;
                var recipientToBeAdded;
                if (recipient != null) {
                    recipientToBeAdded = recipient;
                } else {
                    recipientToBeAdded = newRecipient;
                }
                if (!recipientToBeAdded.isValid()) {
                    recipientToBeAdded.errors.showAllMessages(true);
                    return;
                }

                inprogress(true);
                repository.templateRecipient.addRecipient({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id,
                        nickname: recipientToBeAdded.nickname(),
                        roleId: function () {
                            switch (newRecipient.role()) {
                                case 1:
                                    return "58416f6827eb612fef7750b62cf2bf9a";
                                case 2:
                                    return "693e6cee8a4a21285f86930491b455ec";
                                default:
                                    return "6df1056f4d9a27ec34698552a6372a68";
                            }
                        },
                        order: 0
                    },
                    successCallback: function (recipientResult) {
                        inprogress(false);
                        template().recipients.push(recipientResult);
                        newRecipient.nickname('');
                        newRecipient.role(2);
                        newRecipient.errors.showAllMessages(false);
                        if (_.isFunction(callback)) {
                            callback(recipientResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            removeRecipient = function (recipient, callback) {
                inprogress(true);
                if (recipient.roleId() == 1) {
                    repository.template.updateTemplate({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            templateId: template().id(),
                            emailBody: template().emailBody(),
                            emailSubject: template().emailSubject(),
                            templateExpireTime: template().templateExpireTime(),
                            orderedSignature: template().orderedSignature(),
                            ownerShouldSign: false,
                            reminderTime: template().reminderTime(),
                            stepExpireTime: template().stepExpireTime(),
                            waterMarkText: template().waterMarkText(),
                            waterMarkImage: template().waterMarkImage(),
                            enableTypedSignature: template().enableTypedSignature(),
                            enableUploadedSignature: template().enableUploadedSignature(),
                            tags: template().tags()
                        },
                        doneCallback: function (result) {
                            inprogress(false);
                            template().ownerShouldSign(false);
                            template().recipients.remove($.grep(template().recipients(), function (a) { return a.roleId() == 1; })[0]);
                            if (_.isFunction(callback)) {
                                callback(result);
                            }
                        }
                    });
                } else {
                    repository.templateRecipient.removeRecipient({
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            templateId: template().id,
                            recipientId: recipient.id()
                        },
                        successCallback: function (result) {
                            inprogress(false);
                            template().recipients.remove($.grep(template().recipients(), function (a) { return a.id() == recipient.id(); })[0]);
                            if (_.isFunction(callback)) {
                                callback(result);
                            }
                        },
                        errorCallback:errorCallback
                    });
                }
            },
            updateRecipient = function (recipient, callback) {
                if (!recipient.isValid()) {
                    recipient.errors.showAllMessages(true);
                    return;
                }
                inprogress(true);
                repository.templateRecipient.updateRecipient({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id,
                        recipientId: recipient.id(),
                        nickname: recipient.nickname(),
                        roleId: function () {
                            switch (recipient.roleId()) {
                                case 1:
                                    return "58416f6827eb612fef7750b62cf2bf9a";
                                case 2:
                                    return "693e6cee8a4a21285f86930491b455ec";
                                default:
                                    return "6df1056f4d9a27ec34698552a6372a68";
                            }
                        },
                        order: recipient.order()
                    },
                    successCallback: function (recipientResult) {
                        inprogress(false);
                        recipient.errors.showAllMessages(false);
                        if (_.isFunction(callback)) {
                            callback(recipientResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };

        ko.validation.group(newRecipient);
        
        return {
            inprogress: inprogress,
            template: template,
            newRecipient: newRecipient,
            addOwnerAsRecipient: addOwnerAsRecipient,
            addRecipient: addRecipient,
            removeRecipient: removeRecipient,
            updateRecipient: updateRecipient
        };
    });


define('core/vm/vm.template.prepare.step3',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            template = ko.observable();


        return {
            inprogress: inprogress,
            template: template
        };
    });


define('core/vm/vm.template.prepare.step4',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            template = ko.observable();

        return {
            inprogress: inprogress,
            template: template
        };
    });


define('core/vm/vm.template.prepare.step5',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, configuration, redirect) {
        var inprogress = ko.observable(false),
            template = ko.observable(),
            documents = ko.observableArray([]),
            viewerAction = 'prepare',
            config = configuration,
            signatureFields = ko.observableArray([]),
            fields = ko.observableArray([]),
            previewDocument = ko.observable(),
            previewRecipient = ko.observable(),
            pageWidth = ko.observable(850),
            pageHeight = ko.observable(1200),
            timer,
            cuttedLocation = ko.observable(),
            copiedLocation = ko.observable(),
            cuttedField = ko.observable(),
            copiedField = ko.observable(),
            selectedField = ko.observable(),
            selectedLocation = ko.observable(),
            predefinedLists = ko.observableArray([]),
            selectedPredefinedList = ko.observable(),
            newAcceptableValue = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            newAcceptableValueListName = ko.escapedObservable('').extend({ required: { message: config.validationMessages.required } }),
            regularExpressions = ko.computed(function () {
                if (selectedField() != null && (selectedField().fieldType() == configuration.signatureFieldType.SingleLine || selectedField().fieldType() == configuration.signatureFieldType.SingleLine || selectedField().fieldType() == configuration.signatureFieldType.Date)) {
                    return configuration.fieldValidations.filter(function (item) {
                        return $.grep(item.fieldType.split(','), function (e) { return e == selectedField().fieldType(); })[0] != null;
                    });
                } else
                    return [];
            }),
            recipientsToSign = ko.computed(function () {
                try {
                    return ko.utils.arrayFilter(template().recipients(), function (recipient) {
                        return recipient.roleId() != 3;
                    });
                } catch (e) {
                    return [];
                }
            }),
            init = function (callback) {
                inprogress(true);
                repository.field.getFields({
                    itemsResult: signatureFields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey()
                    },
                    doneCallback: function (fieldsResult) {
                        repository.predefinedList.getPredefinedLists({
                            itemsResult: predefinedLists,
                            param: {
                                userId: config.userId(),
                                privateKey: config.privateKey()
                            },
                            doneCallback: function (listsResult) {
                                inprogress(false);
                                if (_.isFunction(callback)) {
                                    callback(fieldsResult, listsResult);
                                }
                            },
                            errorCallback: errorCallback
                        });
                    },
                    errorCallback: errorCallback
                });


            },
            isOwnField = function (field) {
                return previewRecipient() != null ? field.recipientId() == previewRecipient().id() : false;
            },
            getRecipientNameById = function (recipientId) {
                if (template() != null && template().recipients().length > 0) {
                    return $.grep(template().recipients(), function (r) {
                        return r.id() == recipientId;
                    })[0].fullName();
                }
                return '';
            },
            addField = function (fieldId, pageNum, relativeX, relativeY, locationHeight, locationWidth, forceNewField, fieldName) {
                inprogress(true);
                repository.templateField.addField({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id(),
                        documentId: previewDocument().documentId(),
                        recipientId: previewRecipient().id(),
                        fieldId: fieldId,
                        forceNewField: forceNewField,
                        page: pageNum,
                        locationX: relativeX,
                        locationY: relativeY,
                        locationHeight: locationHeight,
                        locationWidth: locationWidth,
                        name: fieldName,
                        pageWidth: pageWidth(),
                        pageHeight: pageHeight()
                    },
                    successCallback: function (fieldResult) {
                        inprogress(false);
                        fieldResult.locations.remove(function (item) {
                            return item.documentId() != previewDocument().documentId();
                        });
                        if (forceNewField && !_.find(fields(), function (a) { return a.id() == fieldResult.id(); })) {
                            fields.push(fieldResult);
                            var document = $.grep(documents(), function (d) { return d.documentId() == fieldResult.locations()[0].documentId(); })[0];
                            document.fieldsCount(document.fieldsCount() + 1);
                        } else {
                            $.grep(fields(), function (a) { return a.id() == fieldResult.id(); })[0].locations.push(fieldResult.locations.pop());
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            updateFieldLocation = function (location, callback) {
                if (!location) return;
                inprogress(true);
                repository.templateField.updateFieldLocation({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id(),
                        documentId: previewDocument().documentId(),
                        recipientId: previewRecipient().id(),
                        locationId: location.id(),
                        fieldId: location.fieldId(),
                        page: location.page(),
                        locationX: location.locationX(),
                        locationY: location.locationY(),
                        locationHeight: location.locationHeight(),
                        locationWidth: location.locationWidth(),
                        fontBold: location.fontBold(),
                        fontColor: location.fontColor(),
                        fontItalic: location.fontItalic(),
                        fontName: location.fontName(),
                        fontSize: location.fontSize(),
                        fontUnderline: location.fontUnderline(),
                        align: location.align(),
                        pageWidth: pageWidth(),
                        pageHeight: pageHeight()
                    },
                    successCallback: function (fieldResult) {
                        inprogress(false);
                        location.dirtyFlag().reset();
                        var fld = _.find(fields(), function (f) {
                            return f.id() == location.fieldId();
                        });
                        if (fld && fld.recipientId() != previewRecipient().id()) {
                            inprogress(true);
                            repository.templateField.assignField({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    templateId: template().id(),
                                    documentId: previewDocument().documentId(),
                                    currentRecipientId: previewRecipient().id(),
                                    newRecipientId: fld.recipientId(),
                                    fieldId: location.fieldId()
                                },
                                successCallback: function (assignedFieldResult) {
                                    inprogress(false);
                                },
                                errorCallback: errorCallback
                            });
                        }
                        if (_.isFunction(callback)) {
                            callback(fieldResult);
                        }
                    },
                    errorCallback: function (error) {
                        inprogress(false);
                        config.alert({ title: "Error", message: error });
                        getDocumentFields(previewDocument().documentId());
                        if (_.isFunction(callback)) {
                            callback(false);
                        }
                    }
                });
            },
            isValidDate = function (s) {
                if (!s || s.length == 0) return true;
                if (s.length != 10) return false;
                var bits = s.split('.');
                if (!bits[0] || !bits[1] || !bits[2]) return false;
                if (bits[2] < 1900 || bits[2] > 2100) return false;
                var d = new Date(bits[2], bits[1] - 1, bits[0]);
                return d && (d.getMonth() + 1) == bits[1] && d.getDate() == Number(bits[0]);
            },
            updateField = function (field, callback) {
                if (!location) return;
                if (field.fieldType() == config.signatureFieldType.Date) {
                    if (!field.settings().minYear.isValid() || !field.settings().maxYear.isValid()) {
                        config.alert({ title: "Field not saved", message: 'Invalid date settings' });
                        return;
                    }
                }
                if (!field.isValid()) {
                    config.alert({ title: "Field not saved", message: 'Field data is not valid' });
                    return;
                }
                if (field.fieldType() > 1 && field.fieldType() < 5 && field.defaultValue() != '') {
                    if (field.regularExpression() != null && !field.defaultValue().match(field.regularExpression())) {
                        config.alert({ title: "Field not saved", message: 'Default value is not valid' });
                        return;
                    }
                    if (field.fieldType() == 4 && field.regularExpression() == null && !isValidDate(field.defaultValue())) {
                        config.alert({ title: "Field not saved", message: 'Default date is not valid' });
                        return;
                    }
                }
                inprogress(true);
                repository.templateField.updateField({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id(),
                        documentId: previewDocument().documentId(),
                        recipientGuid: previewRecipient().id(),
                        fieldId: field.id(),
                        name: field.name(),
                        regularExpression: field.regularExpression(),
                        order: field.order(),
                        mandatory: field.mandatory(),
                        acceptableValues: field.acceptableValues(),
                        defaultValue: field.defaultValue(),
                        tooltip: field.tooltip(),
                        guidanceText: field.guidanceText(),
                        groupName: field.groupName(),
                        fieldType: field.fieldType(),
                        settings: ko.toJSON(field.settings())
                    },
                    successCallback: function (fieldResult) {
                        inprogress(false);
                        field.dirtyFlag().reset();
                        if (_.isFunction(callback)) {
                            callback(fieldResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            deleteFieldLocation = function (field, location) {
                inprogress(true);
                repository.templateField.deleteFieldLocation({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template().id(),
                        fieldId: location.fieldId(),
                        locationId: location.id()
                    },
                    successCallback: function () {
                        inprogress(false);
                        field.locations.remove(location);
                        if (field.locations().length == 0) {
                            fields.remove(field);
                            var document = $.grep(documents(), function (d) { return d.documentId() == location.documentId(); })[0];
                            document.fieldsCount(document.fieldsCount() - 1);
                        }
                        selectedField(null);
                        selectedLocation(null);
                    },
                    errorCallback: errorCallback
                });
            },
            updateMovedField = function (location, event) {
                if (!location.selected()) return;
                clearInterval(timer);
                timer = setTimeout(function () {
                    if (event.keyCode > -37 && event.keyCode <= 40)
                        updateFieldLocation(location);
                }, 2000);
            },
            getDocumentFields = function (documentId, callback) {
                inprogress(true);
                fields.removeAll();
                selectedField(null);
                selectedLocation(null);
                repository.templateField.getFields({
                    itemsResult: fields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        templateId: template().id(),
                        documentId: documentId
                    },
                    successCallback: function (fieldsResult) {
                        inprogress(false);
                        var document = ko.utils.arrayFirst(documents(), function (doc) {
                            return doc.documentId() === documentId;
                        });
                       // document.fields.removeAll();
                        ko.utils.arrayForEach(fieldsResult, function (docField) {
                            docField.locations.remove(function (item) {
                                return item.documentId() != documentId;
                            });
                        });
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                       
                    },
                    errorCallback: errorCallback
                });
            },
            getDocumentField = function (documentId, fieldId, callback) {
                inprogress(true);
                repository.templateField.getField({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        templateId: template().id(),
                        documentId: documentId,
                        fieldId: fieldId
                    },
                    successCallback: function (fieldsResult) {
                        inprogress(false);
                        fieldsResult.locations.remove(function (item) {
                            return item.documentId() != documentId;
                        });
                        var field = ko.utils.arrayFirst(fields(), function (f) {
                            return f.id() === fieldId;
                        });
                        fields.replace(field, fieldsResult);
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            copyFieldLocation = function (field, location) {
                if (location.selected()) {
                    copiedLocation(location);
                    copiedField(field);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            cutFieldLocation = function (field, location) {
                if (location.selected()) {
                    if (field == null) return;
                    cuttedLocation(location);
                    cuttedField(field);
                    copiedLocation(null);
                    copiedField(null);
                    field.locations.remove(location);
                }
            },
            pasteNewField = function () {
                if (copiedLocation() != null && copiedField() != null) {
                    var signatureCopiedField = $.grep(signatureFields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    addField(signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), true, '');
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
                if (cuttedLocation() != null && cuttedField() != null) {
                    var signatureCuttedField = $.grep(signatureFields(), function (a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    addField(signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX(), cuttedLocation().locationY(), cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), true, '');
                    deleteFieldLocation(cuttedField(), cuttedLocation());
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            pasteNewLocation = function () {
                if (copiedLocation() != null && copiedField() != null) {
                    var templateCopiedField = $.grep(fields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    var signatureCopiedField = $.grep(signatureFields(), function (a) { return a.fieldType() == copiedField().fieldType(); })[0];
                    addField(templateCopiedField != null ? copiedLocation().fieldId() : signatureCopiedField.id(), copiedLocation().page(), copiedLocation().locationX() + 0.05, copiedLocation().locationY() + 0.05, copiedLocation().locationHeight(), copiedLocation().locationWidth(), templateCopiedField != null ? false : true, templateCopiedField != null ? copiedField().name() : '');
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
                if (cuttedLocation() != null && cuttedField() != null) {
                    var templateCuttedField = $.grep(fields(), function (a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    var signatureCuttedField = $.grep(signatureFields(), function (a) { return a.fieldType() == cuttedField().fieldType(); })[0];
                    addField(templateCuttedField != null ? cuttedLocation().fieldId() : signatureCuttedField.id(), cuttedLocation().page(), cuttedLocation().locationX() + 0.05, cuttedLocation().locationY() + 0.05, cuttedLocation().locationHeight(), cuttedLocation().locationWidth(), templateCuttedField != null ? false : true, templateCuttedField != null ? cuttedField().name() : '');
                    deleteFieldLocation(cuttedField(), cuttedLocation());
                    copiedLocation(null);
                    copiedField(null);
                    cuttedLocation(null);
                    cuttedField(null);
                }
            },
            addFieldFromMenu = function (fieldType) {
                var signatureField = $.grep(signatureFields(), function (a) { return a.fieldType() == fieldType; })[0];
                var height, width;
                switch (fieldType) {
                    case 1:
                        //signature
                        height = 46;
                        width = 148;
                        break;
                    case 6:
                        //checkbox
                        height = 25;
                        width = 25;
                        break;
                    default:
                        height = 25;
                        width = 205;
                        break;
                }
                addField(signatureField.id(), 1, 0, 0, height, width, true, '');
            },
            selectDefaultValue = function (value) {
                if (selectedField() != null)
                    selectedField().defaultValue(value);
            },
            addAcceptableValue = function () {
                newAcceptableValue($.trim(newAcceptableValue()));
                if ($.grep(newAcceptableValue.errors(), function (error) {
                    return error != null;
                }
                ).length > 0) {
                    newAcceptableValue.errors.showAllMessages(true);
                    return;
                }
                ;
                if (selectedField() != null && newAcceptableValue() != '') {
                    if (selectedField().acceptableValuesArray().indexOf(newAcceptableValue()) > -1) {
                        config.alert({ title: "Error", message: "Value already in list" });
                        return;
                    }
                    selectedField().acceptableValuesArray.push(newAcceptableValue());
                    newAcceptableValue('');
                    selectedPredefinedList(null);
                    newAcceptableValue.errors.showAllMessages(false);
                }
            },
            deleteAcceptableValue = function (value) {
                $.confirm({
                    title: "Delete Confirmation",
                    message: "Are you sure ?",
                    buttons: {
                        Yes: {
                            action: function () {
                                selectedField().acceptableValuesArray.remove(value);
                                if (selectedField().defaultValue() == value)
                                    selectedField().defaultValue('');
                            }
                        },
                        No: {}
                    }
                });
            },
            addNewAcceptableValuesList = function () {
                if ($.grep(newAcceptableValueListName.errors(), function (error) {
                    return error != null;
                }
                ).length > 0) {
                    newAcceptableValueListName.errors.showAllMessages(true);
                    return;
                }
                ;
                if (selectedField() != null && newAcceptableValueListName() != '') {
                    inprogress(true);
                    repository.predefinedList.addList({
                        itemsResult: predefinedLists,
                        param: {
                            userId: config.userId(),
                            privateKey: config.privateKey(),
                            name: newAcceptableValueListName(),
                            defaultValue: selectedField().defaultValue(),
                            values: selectedField().acceptableValues()
                        },
                        successCallback: function (result) {
                            inprogress(false);
                            predefinedLists.push(result);
                        },
                        errorCallback: errorCallback
                    });
                    newAcceptableValueListName('');
                    newAcceptableValueListName.errors.showAllMessages(false);
                }
            },
            deleteAcceptableValuesList = function () {
                if (selectedPredefinedList() == null) return;
                inprogress(true);
                repository.predefinedList.deleteList({
                    itemsResult: predefinedLists,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        listId: selectedPredefinedList().id()
                    },
                    successCallback: function (result) {
                        inprogress(false);
                        var selected = selectedPredefinedList();
                        selectedPredefinedList(null);
                        predefinedLists.remove(selected);
                    },
                    errorCallback: function (error) {
                        config.alert({ title: "error", message: error });
                    }
                });
            },
            resetFields = function () {
                inprogress(true);
                repository.templateField.getFields({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        templateId: template().id(),
                        documentId: ""
                    },
                    successCallback: function (fieldsResult) {
                        var fieldIds = [];
                        $.each(fieldsResult, function () {
                            fieldIds[fieldIds.length] = this.id();
                        });
                        if (fieldIds.length > 0) {
                            repository.templateField.deleteFields({
                                param: {
                                    userId: config.userId(),
                                    privateKey: config.privateKey(),
                                    templateId: template().id(),
                                    fieldIds: fieldIds
                                },
                                successCallback: function (result) {
                                    inprogress(false);
                                    fields.removeAll();
                                    selectedField(null);
                                    selectedLocation(null);
                                },
                                errorCallback: errorCallback
                            });
                        }
                    },
                    errorCallback:errorCallback
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };
        
        selectedPredefinedList.subscribe(function (newValue) {
            if (newValue != null) {
                $.confirm({
                    title: "Apply list confirmation",
                    message: "Are you sure that you apply the selected list?",
                    buttons: {
                        Yes: {
                            action: function () {
                                selectedField().acceptableValuesArray(newValue.values());
                                selectedField().defaultValue('');
                            }
                        },
                        No: {}
                    }
                });
            }
        });
        ko.validation.group(newAcceptableValue);
        ko.validation.group(newAcceptableValueListName);


        return {
            inprogress: inprogress,
            documents: documents,
            template: template,
            viewerAction: viewerAction,
            config: config,
            regularExpressions: regularExpressions,
            signatureFields: signatureFields,
            fields: fields,
            previewDocument: previewDocument,
            previewRecipient: previewRecipient,
            pageWidth: pageWidth,
            pageHeight: pageHeight,
            cuttedLocation: cuttedLocation,
            copiedLocation: copiedLocation,
            cuttedField: cuttedField,
            copiedField: copiedField,
            selectedField: selectedField,
            selectedLocation: selectedLocation,
            predefinedLists: predefinedLists,
            selectedPredefinedList: selectedPredefinedList,
            newAcceptableValue: newAcceptableValue,
            newAcceptableValueListName: newAcceptableValueListName,
            init: init,
            isOwnField: isOwnField,
            addField: addField,
            updateFieldLocation: updateFieldLocation,
            updateField: updateField,
            deleteFieldLocation: deleteFieldLocation,
            updateMovedField: updateMovedField,
            getDocumentFields: getDocumentFields,
            getDocumentField: getDocumentField,
            copyFieldLocation: copyFieldLocation,
            cutFieldLocation: cutFieldLocation,
            pasteNewField: pasteNewField,
            pasteNewLocation: pasteNewLocation,
            addFieldFromMenu: addFieldFromMenu,
            selectDefaultValue: selectDefaultValue,
            addAcceptableValue: addAcceptableValue,
            deleteAcceptableValue: deleteAcceptableValue,
            addNewAcceptableValuesList: addNewAcceptableValuesList,
            resetFields: resetFields,
            getRecipientNameById: getRecipientNameById,
            recipientsToSign: recipientsToSign,
            deleteAcceptableValuesList: deleteAcceptableValuesList
        };
    });


define('core/vm/vm.template.prepare.step6',
    ['ko',
    'lib/underscore',
    'core/repository',
    'core/config',
    'core/redirect'],
    function (ko, _, repository, config, redirect) {
        var inprogress = ko.observable(false),
            template = ko.observable(),
            documents = ko.observableArray([]),
            fields = ko.observableArray([]),
            loadFields = function (callback) {
                if (inprogress()) return;
                inprogress(true);
                fields.removeAll();
                repository.templateField.getFields({
                    itemsResult: fields,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        recipientId: "",
                        templateId: template().id(),
                        documentId: ""
                    },
                    successCallback: function (fieldsResult) {
                        inprogress(false);
                        if (_.isFunction(callback)) {
                            callback(fieldsResult);
                        }
                    },
                    errorCallback: errorCallback
                });
            },
            getFields = function (recipient, document) {
                return ko.utils.arrayFilter(fields(), function (item) {
                    return $.grep(item.locations(), function (location) {
                        return location.documentId() == document.documentId();
                    }).length > 0 && item.recipientId() == recipient.id();
                });
            },
            errorCallback = function (error) {
                inprogress(false);
                config.alert({ title: "Error", message: error });
                return false;
            };


        return {
            inprogress: inprogress,
            template: template,
            documents: documents,
            fields: fields,
            loadFields: loadFields,
            getFields: getFields
        };
    });


define('core/vm/vm.templates',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/repository',
        'core/config',
        'core/redirect'],
    function($, ko, _, repository, config, redirect) {
        var templates = ko.observableArray([]),
            inprogress = ko.observable(false),
            totalCount = ko.observable(10),

            page = ko.observable(1),
            itemsPerPage = ko.observable(10),
            documentGuid= ko.observable(''),
            recipientName = ko.observable(''),
            name = ko.observable(''),
            tag = ko.observable(''),


            loadTemplates = function(options, callback) {
                if (inprogress()) return;
                if (options != null && options.clearAll != null && options.clearAll) {
                    templates.removeAll();
                    totalCount(0);
                }
                if (options != null && options.page != null)
                    page(options.page);
                if (options != null && options.recipientName != null)
                    recipientName(options.recipientName);
                if (options != null && options.documentId != null)
                    documentGuid(options.documentId);
                if (options != null && options.name != null)
                    name(options.name);
                if (options != null && options.tag != null)
                    tag(options.tag);
                inprogress(true);
                repository.template.getTemplates(
                    function (itemsResult, itemsCount) {
                        inprogress(false);
                        ko.utils.arrayPushAll(templates, itemsResult);
                        totalCount(itemsCount);
                        resizeElements();
                    },
                    errorCallback, page(),itemsPerPage(),documentGuid(),recipientName(),name(), tag()
                );

                if (_.isFunction(callback)) {
                    callback();
                }
            },
            createTemplate = function () {
                if (inprogress()) return;
                inprogress(true);
                repository.template.createTemplate({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: "",
                        name: "New template"
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        redirect.templateView(result.template.id);
                    },
                    errorCallback: errorCallback
                });
            },
            openTemplate = function(template) {
                redirect.templateView(template.id());
            },
            deleteTemplate = function (template) {
                if (inprogress()) return;
                inprogress(true);
                repository.template.deleteTemplates({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templatesIds: [template.id()]
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        templates.remove(template);
                    },
                    errorCallback: errorCallback
                });
            },
            createEnvelopeFromTemplate = function(template) {
                if (inprogress()) return;
                inprogress(true);
                repository.envelope.createEnvelope({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: template.id(),
                        envelopeId: "",
                        name: "New envelope"
                    },
                    doneCallback: function (result) {
                        inprogress(false);
                        redirect.envelopeView(result.envelope.id);
                    },
                    errorCallback: errorCallback
                });
            },
            createFormFromTemplate = function (template) {
                if (inprogress()) return;
                inprogress(true);
                repository.form.createForm(
                    doneCallback = function (result) {
                        inprogress(false);
                        redirect.formView(result.form.id);
                    },
                    errorCallback, 'New Form', template.id()
                );
            },
            createTemplateFromDocument = function (documents) {
                if (inprogress()) return;
                inprogress(true);
                repository.template.createTemplate({
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey(),
                        templateId: "",
                        envelopeId: "",
                        name: "New template"
                    },
                    doneCallback: function (templateResult) {
                        inprogress(false);
                        var $deferreds = [];
                        for (var i = 0; i < documents.length; i++) {
                            $deferreds[i] = $.Deferred(function(def) {
                                repository.templateDocument.addDocument({
                                    param: {
                                        userId: config.userId(),
                                        privateKey: config.privateKey(),
                                        templateId: templateResult.template.id,
                                        documentId: documents[i],
                                        parseFields: false,
                                        order: 0
                                    },
                                    doneCallback: function(documentResult) {
                                        def.resolve(documentResult);
                                    },
                                    errorCallback: function(error) {
                                        def.reject(error);
                                    }
                                });
                            }).promise();
                        }
                        $.when.apply(null, $deferreds).then(function () {
                            redirect.templateView(templateResult.template.id);
                        });
                    },
                    errorCallback:errorCallback
                });
            },
            selectedItems = ko.computed(function () {
                return _.filter(templates(), function (template) {
                    return template.selected() == true;
                });
            }),
            deleteSelected = function () {
                if (inprogress()) return;
                $.confirm({
                    title: "Delete confirmation",
                    message: "Are you sure you want to delete selected templates?",
                    buttons: {
                        Yes: {
                            'class': "",
                            'action': function () {

                                var templateIds = [];
                                $.each(selectedItems(), function () {
                                    templateIds[templateIds.length] = this.id();
                                });
                                if (templateIds.length > 0) {
                                    inprogress(true);
                                    repository.template.deleteTemplates({
                                        param: {
                                            userId: config.userId(),
                                            privateKey: config.privateKey(),
                                            templatesIds: templateIds
                                        },
                                        doneCallback: function (result) {
                                            inprogress(false);
                                            if (result.status == 'Ok') {
                                                _.each(templateIds, function (t) {
                                                    var tpl = ko.utils.arrayFirst(templates(), function (template) {
                                                        return template.id() == t;
                                                    });
                                                    templates.remove(tpl);
                                                });
                                            } else {
                                                config.alert("error", result.error_message);
                                            }
                                        },
                                        errorCallback: errorCallback
                                    });
                                }
                            }
                        },
                        No: {}
                    }
                });
            },
            checkAll = function () {
                var newValue = !allSelected();
                _.each(templates(), function (template) {
                    template.selected(newValue);
                });
            },
            allSelected = ko.computed(function () {
                return templates().length > 0 &&
                    $.grep(templates(), function (template) {
                        return template.selected() == true;
                    }).length == templates().length;
            }),
            errorCallback = function (error) {
                config.alert({ title: "Error", message: error });
                return false;
            };


        return {
            inprogress: inprogress,
            templates: templates,
            totalCount: totalCount,
            itemsPerPage: itemsPerPage,
            page: page,
            loadTemplates: loadTemplates,
            createTemplate: createTemplate,
            openTemplate: openTemplate,
            deleteTemplate: deleteTemplate,
            createEnvelopeFromTemplate: createEnvelopeFromTemplate,
            createFormFromTemplate: createFormFromTemplate,
            createTemplateFromDocument: createTemplateFromDocument,
            selectedItems: selectedItems,
            deleteSelected: deleteSelected,
            allSelected: allSelected,
            checkAll: checkAll
        };
    });
define('core/vm/vm.templates.resources',
    ['ko', 'lib/underscore', 'core/repository', 'core/config'],
    function (ko, _, repository, config) {
        var inprogress = ko.observable(false),
            resources = ko.observableArray([]),
            selectedDocument = ko.observable(),
            selectedRecipient = ko.observable(),
            selectedTag = ko.observable(),
            dashboardInprogress = ko.observable(),
            loadResources = function (callback) {
                if (inprogress()) return;
                inprogress(true);
                repository.templateResource.getResources({
                    resourcesResult: resources,
                    param: {
                        userId: config.userId(),
                        privateKey: config.privateKey()
                    },
                    doneCallback: function () {
                        inprogress(false);
                    }
                });

                if (_.isFunction(callback)) {
                    callback();
                }
            };
        return {
            inprogress: inprogress,
            loadResources: loadResources,
            resources: resources,
            selectedDocument: selectedDocument,
            selectedRecipient: selectedRecipient,
            dashboardInprogress: dashboardInprogress,
            selectedTag: selectedTag
        };
    });
define('core/vm/vm.uploadprogress',
    ['jquery',
        'ko',
        'core/repository',
        'core/config'
    ],
    function($, ko, repository, config) {

        var uploadingFiles = ko.observableArray([]),
            addFileUploadInfo = function (fileId, fileName) {
                var fileUplInfo = {
                    id: fileId,
                    sizeInKb: ko.observable(0),
                    percentCompleted: ko.observable(0),
                    uploadSpeed: ko.observable(0),
                    remainingTime: ko.observable(0),
                    name: fileName
                };
                uploadingFiles.push(fileUplInfo);
            },
            removeFileUploadInfo = function(id) {
                var item = ko.utils.arrayFirst(uploadingFiles(), function(item) { return item.id === id; });
                uploadingFiles.remove(item);

            },
            doProgress = function (id,  loaded, total, bytesPerMSec, remainTime) {
                if (total > 0) {
                    var fileUplInfo = ko.utils.arrayFirst(uploadingFiles(), function (item) { return item.id === id; });
                    fileUplInfo.percentCompleted(Math.round(loaded / total * 100));
                    fileUplInfo.uploadSpeed(Math.round(bytesPerMSec / (1024 / 1000)));
                    fileUplInfo.remainingTime(Math.round(remainTime / 1000));
                }
            },
            currentFilesCount=ko.computed(function() {
                return uploadingFiles().length;
            }),
            init = function() {
                
            };
            
        init();

        return {
            init: init,
            uploadingFiles: uploadingFiles,
            addFileUploadInfo: addFileUploadInfo,
            removeFileUploadInfo: removeFileUploadInfo,
            currentFilesCount: currentFilesCount,
            doProgress: doProgress
        };
    });
define('core/vm/vm.verify',
    ['jquery',
        'ko',
        'lib/underscore',
        'core/utils'
    ],
    function ($, ko,_,utils) {
        var progressVisible = ko.observable(false),
            successVisible = ko.observable(false),
            failVisible = ko.observable(false),
            percentCompleted = ko.observable(0),
            recipients = ko.observableArray([]),
            dates = ko.observableArray([]),
            references = ko.observableArray([]),
            filesInUpload = ko.observableArray([]),
            uploadDialogVisible = ko.observable(false),
            resetResultDialgos = function() {
                progressVisible(false);
                successVisible(false);
                failVisible(false);
                
            },
            doOnKeyUp = function(event) {
                if (!progressVisible()) return true;
                var keyCode = (event.which ? event.which : event.keyCode);
                if (keyCode === 27) {
                    uploadDialogVisible(false);
                    resetResultDialgos();
                    return false;
                }
                return true;
            },
            loadData = function (dto) {
                resetResultDialgos();
                recipients.removeAll();
                dates.removeAll();
                references.removeAll();
                if (dto.code == 'Ok' && dto.authentic) {
                    if (dto.recipients) {
                        _.each(dto.recipients, function(recip) {
                            recipients.push(recip.Name);
                        });
                    }
                    if (dto.datesSigned) {
                        _.each(dto.datesSigned, function(date) {
                            dates.push(utils.dateFromIso(date).format('mmm dd yyyy hh:MM:ss'));
                        });
                    }
                    if (dto.references) {
                        _.each(dto.references, function(reference) {
                            references.push(reference);
                        });
                    }
                    successVisible(true);
                } else {
                    failVisible(true);
                }
            },
            //upload dialog properties
            cancelUpload = function() {
            },
            closeDialog = function () {
                uploadDialogVisible(false);
            },
            onDialogShow = function () {
            };
        return {
            progressVisible: progressVisible,
            doOnKeyUp: doOnKeyUp,
            percentCompleted: percentCompleted,
            recipients: recipients,
            dates: dates,
            references: references,
            loadData: loadData,
            successVisible:successVisible,
            failVisible: failVisible,
            cancelUpload: cancelUpload,
            filesInUpload: filesInUpload,
            uploadDialogVisible: uploadDialogVisible,
            closeDialog: closeDialog,
            onDialogShow: onDialogShow
        };
    });
define('core/vm/vm.viewer',
    ['jquery',
        'ko',
        'core/repository',
        'core/config'
    ],
    function($, ko, repository, config) {
        function getInstance(viewerContainer, viewerOptions) {
            var options = {
                fileId: "",
                userId: config.userId(),
                privateKey: config.privateKey(),
                userKey: config.privateKey(),
                baseUrl: config.serviceAddress() + "/shared/",
                quality: 80,
                use_pdf: 'false',
                serviceUrl: config.serviceAddress(),
                _mode: "full",
                usePageNumberInUrlHash: false,
                variableHeightPageSupport: false
            },
                viewerAdapter = null,
                signatureBackgroundSvg = ko.observable(),
                stampBackgroundSvg = ko.observable(),
                init = function () {
                    repository.resources.getSignatureBackgroundSvg().done(function(data) {
                        signatureBackgroundSvg(data);
                    });
                    repository.resources.getStampBackgroundSvg().done(function (data) {
                        stampBackgroundSvg(data);
                    });
                },
                adapter = function(mode) {
                    if (viewerAdapter == null) {
                        if (mode)
                            options._mode = mode;                        

                        if (viewerContainer !== undefined) {
                            if (viewerOptions !== undefined && viewerOptions.docSpace !== undefined)
                                options.docSpace = viewerOptions.docSpace;
                            else
                                options.docSpace = $(viewerContainer).find('.document_viewer');
                            if (viewerOptions !== undefined && viewerOptions.navigation !== undefined)
                                options.navigation = viewerOptions.navigation;
                            else
                                options.navigation = $(viewerContainer).find('#viewer-navigation');
                            if (viewerOptions !== undefined && viewerOptions.zooming !== undefined)
                                options.zooming = viewerOptions.zooming;
                            else
                                options.zooming = $(viewerContainer).find('#viewer-zoom');
                            if (viewerOptions !== undefined && viewerOptions.thumbnails !== undefined)
                                options.thumbnails = viewerOptions.thumbnails;
                            else
                                options.thumbnails = $(viewerContainer).find('#thumbnails-container');
                            if (viewerOptions !== undefined && viewerOptions.thumbnailsSlider !== undefined)
                                options.thumbnailsSlider = viewerOptions.thumbnailsSlider;
                            else
                                options.thumbnailsSlider = $(viewerContainer).find("#thumbs_btn");
                            if (viewerOptions !== undefined && viewerOptions.selectionContent !== undefined)
                                options.selectionContent = viewerOptions.selectionContent;
                            else
                                options.selectionContent = $(viewerContainer).find("#selection-content");
                        } else {
                            options.docSpace = $('.document_viewer');
                            options.navigation = $('#viewer-navigation');
                            options.zooming = $('#viewer-zoom');
                            options.thumbnails = $('#thumbnails-container');
                            options.thumbnailsSlider = $("#thumbs_btn");
                            options.selectionContent = $("#selection-content");
                        }
                        options.docViewerId = 'doc_viewer' + Math.floor(Math.random() * 9999) + 1;

                        viewerAdapter = new DocViewerAdapter(options);
                        viewerAdapter.docViewerWidget = viewerAdapter.docSpace;
                        viewerAdapter.docViewerViewModel.signatureBackgroundSvg = signatureBackgroundSvg;
                        viewerAdapter.docViewerViewModel.stampBackgroundSvg = stampBackgroundSvg;

                        //funciton is overriden because prepare of envelope/form doesn't work
                        viewerAdapter.docViewerViewModel.recalculatePageLeft = function() {};

                        viewerAdapter.docViewerWidget.bind('_onProcessPages', function (e, response) {
                            var model = viewerAdapter.docViewerViewModel;
                            var width = 0;
                            var height = 0;
                            if (typeof (response.page_size.Width) != "undefined") {
                                width = response.page_size.Width;
                                height = response.page_size.Height;
                            } else if (typeof (response.documentDescription) != "undefined") {
                                var documentDescription = JSON.parse(response.documentDescription);
                                width = documentDescription.widthForMaxHeight*2.083;
                                height = documentDescription.maxPageHeight*2.083;
                            }

                            model.heightWidthRatio = parseFloat(height / width);
                            model.pageHeight(Math.round(model.pageImageWidth * model.heightWidthRatio * (model.initialZoom / 100)));
                            model.originalPageWidth = width;
                            model.originalPageHeight = height;
                        });

                        if (viewerAdapter.docViewerViewModel._mode == 'embed') {
                            viewerAdapter.docViewerViewModel.initialZoom = (($('.document_viewer').width() - 2 * viewerAdapter.docViewerViewModel.imageHorizontalMargin - 20) / viewerAdapter.docViewerViewModel.initialWidth * 100);
                            viewerAdapter.docViewerViewModel.scale(viewerAdapter.docViewerViewModel.initialZoom / 100);
                        }
                    }
                    return viewerAdapter;
                };

            init();

            return {
                init: init,
                adapter: adapter
            };
        }
        return getInstance;
    });
(function ($, undefined) {
    $.widget('ui.SignatureUpload', {});
    $.extend($.ui.SignatureUpload.prototype, $.ui.uploader.prototype, {
        _portalService: Container.Resolve("PortalService"),
        _create: function () {
            this.options['onComplete'] = this._onUploadCompleted;
            $.ui.uploader.prototype._create.apply(this, arguments);
        },
        _onUploadCompleted: function (id, fid) {
            if (fid && fid.code && fid.code.toLowerCase() == "ok")
                $(this.element).trigger('onComplete', [fid, id]);
            if (fid && fid.error)
                jerror(fid.error);
        }
    });
})(jQuery);

(function () {
    var root = this;

    define3rdPartyModules();
    loadPluginsAndBoot();


    var downloadablePrefix = "";
    if ((typeof (gdSignaturePrefix) != "undefined") && gdSignaturePrefix) {
        var useHttpHandlers = (typeof (gdUseHttpHandlers) != "undefined" && gdUseHttpHandlers);
        downloadablePrefix = "/" + gdSignaturePrefix + (useHttpHandlers ? "-handler" : "/embedded");
    }

    require.config({
        baseUrl:  '/Scripts/Signature2/',
        paths: {
            "lib": downloadablePrefix + "/scripts/lib",
            "signatureUpload": downloadablePrefix + "/scripts/signature2/widgets/signatureUpload",
            "svgSignaturePad": downloadablePrefix + "/scripts/lib/signaturepad",
            "rasterSignaturePad": downloadablePrefix + "/scripts/lib/jquery.signaturepad.min",
            "webfont": "https://ajax.googleapis.com/ajax/libs/webfont/1.0.29/webfont"
        }
        
    });
    function define3rdPartyModules() {
        define('jquery', [], function () { return root.jQuery; });
        define('ko', [], function () { return root.ko; });
        define('lib/amplify', [], function () { return root.amplify; });
        define('lib/underscore', [], function () { return root._; });
        define('lib/sammy', [], function () { return root.Sammy; });
        if (root.jQuery.ui.SignatureUpload!=null)
            define('signatureUpload', [], function () { return root.jQuery.ui.SignatureUpload; });
    }
    
    function loadPluginsAndBoot() {
        require([], boot);
    }
    
    function boot() {
        require(['core/binder', 'ko', 'core/signalr'], function (bs, ko, signalr) {
            ko.validation.init({
                insertMessages: false,
                messagesOnModified: true,
                grouping: { deep: true, observable: true }
            });
            signalr.init();
            
        });
    }
})();
define("signDocument",
['jquery',
    'core/config',
    'core/binder',
    'core/vm',
    'signatureUpload'],
    function ($, config, binder, vm) {

        function getInstance() {

            var viewerContainer;
            var viewerOptions = {};
            var viewer;
            var vmDocumentSign = vm.documentSign(), vmSignaturePad = vm.signaturePad(), vmError = vm.error(), vmEnterName = vm.enterName();
            var signButton, signButtonContainer;
            var timer;
            var initUi = function() {
                $.ctrl = function() {
                };
                $("#mainwrapper").removeClass("mainwrap_sidescroll").css("top", "0px");


                //This is an IE fix because pointer-events does not work in IE
                $(document).on('mouseover','.fileApiContainer', '.doc-page', function (e) {
                    $(this).hide();
                    $(this).addClass('sign_input_field');
                    var bottomElement = document.elementFromPoint(e.clientX, e.clientY);
                    $(this).show();
                    $(bottomElement).trigger(e.type);
                    return false;
                });
                $(document).on('mouseleave', '.fileApiContainer', function (e) {
                    $(this).removeClass('sign_input_field');
                    $(".signature_doc_field").tooltip('hide');
                    return false;
                });

                },
                initViewModels = function () {
                    var self = this;
                    vmError.onBeforeShow = function () {
                        $('<div class="modal-backdrop"></div>').appendTo(viewerContainer);
                    };
                    vmError.onBeforeClose = function () {
                        $(viewerContainer).find(".modal-backdrop").remove();
                    };
                    if (showErrorDialog) vmError.isVisible(true);
                    else vmError.isVisible(false);
                    var fieldStartPosition = {x: 0, y: 0};

                    vmDocumentSign.isPublic(isPublic);
                    binder.bind($(viewerContainer).find("#viewer_mainwrapper"));
                    var adapter = viewer.adapter(isPublic ? 'embed' : null).docViewerViewModel;
                    adapter.vm = vmDocumentSign;
                    vmDocumentSign.documentId(documentId);
                    vmDocumentSign.viewerContainer(viewerContainer);
                    if ((typeof viewerOptions !== 'undefined') && (typeof viewerOptions.showHeader !== 'undefined') && !viewerOptions.showHeader) {
                        $(viewerContainer).find(".viewer_header").hide().height(0);
                        $(viewerContainer).find(".embed_signature").css("top", "0");
                    }
                    if ((typeof viewerOptions !== 'undefined') && viewerOptions.documentGuid != null)
                        vmDocumentSign.documentGuid(viewerOptions.documentGuid);
                    if ((typeof viewerOptions !== 'undefined') && viewerOptions.recipientGuid != null)
                        vmDocumentSign.recipientGuid(viewerOptions.recipientGuid);
                    if ((typeof viewerOptions !== 'undefined') && viewerOptions.showTypeItTab != null)
                        vmSignaturePad.showTypeItTab(viewerOptions.showTypeItTab);
                    if ((typeof viewerOptions !== 'undefined') && viewerOptions.showUploadTab != null)
                        vmSignaturePad.showUploadTab(viewerOptions.showUploadTab);
                    if ((typeof viewerOptions !== 'undefined') && viewerOptions.signaturePenColors != null && viewerOptions.signaturePenColors.length > 0) {
                        vmSignaturePad.signatureColors(viewerOptions.signaturePenColors);
                    }
                    $(viewerContainer).bind('onDocumentLoadComplete', function (e, data) {
                        // fix issue with IE and FF causing the dropdowns to close once they are clicked
                        $(viewerContainer).find(".pages_container").unbind("click");
                    });
                    if (config.isDownloadable && (typeof viewerOptions !== 'undefined') && viewerOptions.documentGuid != '' && viewerOptions.recipientGuid != '')
                        vmDocumentSign.getSignatureDocument(viewerOptions.documentGuid, viewerOptions.recipientGuid, function (doc) {
                            if (!doc.signedFromAll) {
                                if (doc.recipient.signed) {
                                    vmError.errorText("Please wait all recipients to sign");
                                    vmError.isVisible(true);
                                }
                                $(viewerContainer).find("button.sign_document").show();
                                if (doc.recipient.firstName == '' && doc.recipient.lastName=='')
                                    vmSignaturePad.signatureText("Anonymous");
                                else
                                    vmSignaturePad.signatureText(doc.recipient.firstName + ' ' + doc.recipient.lastName);
                                adapter.loadDocument(doc.name);
                            } else {
                                $(viewerContainer).find("button.sign_document").hide();
                                adapter.loadDocument(doc.signedName);
                            }
                        });
                    else
                        adapter.loadDocument(documentId);

                    vmSignaturePad.showSelectTab(!isPublic);
                    vmSignaturePad.showSaveButton(!isPublic);
                    vmEnterName.onNameSet.subscribe(function(newValue) {
                        signDocument(newValue, vmEnterName.signerName.email());
                    });
                    $(viewerContainer).find("#thumbs_btn").click(function() {
                        $(this).toggleClass("thumbs_btn_slide", 'slow');
                        $(viewerContainer).find(".thumbnailsContainer").toggle('slide', 'slow');
                        return false;
                    });
                    vmSignaturePad.savedSignatureAfterRender = function() {
                        var widthSignatureLi = 228;
                        $(viewerContainer).find('.signature-types').each(function() {
                            var countLi = $(this).find('li').size(),
                                addToEven = 0,
                                rawsLi = 1;
                            if ($('.modal-blue').hasClass('expanded')) {
                                if (countLi % 2) {
                                    addToEven = 1;
                                }
                                rawsLi = 2;
                                $(this).find('li:nth-child(' + (countLi + addToEven) / 2 + ')').find('.signature-type').addClass('last');
                            }
                            $(this).width((((countLi + addToEven) * widthSignatureLi) / rawsLi) - 10);
                            $(this).css({ 'margin-left': 0 });
                        });
                    };
                    $(viewerContainer).find(".document_viewer").delegate(".signature_doc_field_signature:has(svg):not(.foreign), .signature_doc_field_signature:has(img):not(.foreign), .signature_doc_field_signature:has(.sig_background):not(.foreign) ", "touchstart", function(e) {
                        fieldStartPosition.x = e.originalEvent.changedTouches[0].screenX;
                        fieldStartPosition.y = e.originalEvent.changedTouches[0].screenY;
                    });

                    // fix issue with dvselectable and Firefox, preventing text field to get focus once clicked
                    $(viewerContainer).find(".document_viewer").delegate("input, textarea", "click", function (e) {
                        this.focus();
                    });
                    $(viewerContainer).find(".document_viewer").delegate(".signature_doc_field_signature:has(svg):not(.foreign), .signature_doc_field_signature:has(img):not(.foreign), .signature_doc_field_signature:has(.sig_background):not(.foreign) ", "click touchend", function(e) {
                        if (e.type == 'touchend') {
                            if (e.originalEvent.changedTouches[0].screenX != fieldStartPosition.x || e.originalEvent.changedTouches[0].screenY != fieldStartPosition.y) return false;
                        }
                        var field = ko.contextFor(this).$parents[1];
                        vmSignaturePad.show();
                        
                        $(viewerContainer).find(".signature-dialog").undelegate();
                        $(viewerContainer).find(".signature-dialog").delegate("#apply-draw", "click", function () {
                            var signatureData = vmSignaturePad.applyDrawSignature();
                            if (signatureData == false)
                                return false;
                            if (vmSignaturePad.saveToMySignatures())
                                vmSignaturePad.saveSignature("", signatureData);
                            field.data(signatureData);
                            return false;
                        });
                        $(viewerContainer).find(".signature-dialog").delegate("#apply-upload", "click", function () {
                            if (vmSignaturePad.uploadedImage() == null) {
                                config.alert({ title: "Error", message: "Please upload the signature" });
                            } else {
                                vmSignaturePad.hide();
                                if (vmSignaturePad.saveToMySignatures())
                                    vmSignaturePad.saveSignature("", vmSignaturePad.uploadedImage());
                                field.data(vmSignaturePad.uploadedImage());
                            }
                            return false;
                        });
                        $(viewerContainer).find(".signature-dialog").delegate(".saved-signature", "click", function (e) {
                            if ($(e.srcElement).hasClass('svg-not-supported')) return false;
                            var signature = ko.contextFor(this).$data;
                            vmSignaturePad.hide();
                            field.data(signature.signatureImageUrl());
                            return false;
                        });
                        $(viewerContainer).find(".signature-dialog").delegate(".typed-signature", "click", function () {
                            var fontName = ko.contextFor(this).$data;
                            var $this = $(this);
                            var fontSize = $this.find('span').css('font-size');
                            var w = Math.floor($this.width());
                            var h = Math.floor($this.height());
                            var signature;
                            if (vmSignaturePad.vectorPad())
                                signature = vmSignaturePad.createSvgFromTypedSignature(fontName, fontSize, w, h);
                            else
                                signature = vmSignaturePad.createImageFromTypedSignature(fontName, fontSize);
                            vmSignaturePad.hide();
                            if (vmSignaturePad.saveToMySignatures())
                                vmSignaturePad.saveSignature("", signature);
                            field.data(signature);
                            return false;
                        });
                        $(viewerContainer).find(".signature-dialog").delegate(".reset-signature", "click", function () {
                            vmSignaturePad.clear();
                        });
                        return false;
                    });

                    $(viewerContainer).find(".document_viewer").delegate(".signature_doc_field:has(input):not(.foreign)", "keyup", function (e) {
                        clearInterval(timer);
                        timer = setTimeout(function() {
                            if (!vmDocumentSign.hasCalcFields()) return;
                            $.each(vmDocumentSign.fields(), function (index, item) {
                                if (item.isCalcField()) {
                                    var formulaRegex = /(getField\("[\w\d\s]+"\)\.value)/g;
                                    var script = item.settings().calculationScript;
                                    script = script.replace(new RegExp('this.getField', 'g'), 'getField');
                                    var matches, output = [];
                                    while (matches = formulaRegex.exec(script)) {
                                        output.push(matches[1]);
                                    }
                                    $.each(output, function(index, field) {
                                        var fieldName = /getField\("(.+)"\)\.value/g.exec(field);
                                        if (fieldName != null) {
                                            var fieldData = ko.utils.arrayFirst(vmDocumentSign.fields(), function(documentField) {
                                                return documentField.name() == fieldName[1];
                                            });
                                            script = script.replace(new RegExp('getField\\("' + fieldName[1] + '"\\)\.value', 'g'), parseFloat(fieldData.data()) ? fieldData.data() : 0);
                                        }
                                    });
                                    script = script.replace(/AFMakeNumber/g, 'parseFloat');
                                    var event = {}; // needed for evaluating the script
                                    self["AFSimple_Calculate"] = AFSimple_Calculate;
                                    var calcResult = eval(script);
                                    if (!isNaN(calcResult) && calcResult != '-Infinity' && calcResult != 'Infinity') {
                                        item.data(calcResult);
                                    }
                                }
                            });
                        }, 500);
                    });

                    $(signButton).click(function (e) {
                        if ($(signButton).hasClass('disabled')) return false;
                        if (isPublic) {
                            if (config.isDownloadable && vmDocumentSign.recipient.firstName() != '' && vmDocumentSign.recipient.lastName() != '' && vmDocumentSign.recipient.email() != '')
                                signDocument();
                            else
                                vmEnterName.isVisible(true);
                        } else
                            signDocument(config.userName(), config.userEmail());
                        e.stopPropagation();
                        return false;
                    });
                    var signDocument = function(userName, email) {
                        $.confirm({
                            title: "Sign confirmation",
                            message: "Are you sure you want to sign this document?",
                            buttons: {
                                Yes: {
                                    'action': function() {
                                        $(viewerContainer).find(".loading_overlay").show();
                                        $(viewerContainer).find("button.sign_document").hide();
                                        vmDocumentSign.name(userName);
                                        vmDocumentSign.email(email);
                                        vmDocumentSign.signDocument(function (result) {
                                            if (config.isDownloadable) {
                                                $(viewerContainer).find(".loading_overlay").hide();
                                                if (result.signedFromAll != null && !result.signedFromAll) {
                                                    vmError.errorText("Please wait all recipients to sign");
                                                    vmError.isVisible(true);
                                                } else {
                                                    vmDocumentSign.fields.removeAll();
                                                    adapter.initialZoom = (($(viewerContainer).find('.document_viewer').width() - 2 * adapter.imageHorizontalMargin - 20) / adapter.initialWidth * 100);
                                                    adapter.scale(adapter.initialZoom / 100);
                                                    adapter.loadDocument(result.signedName);
                                                }
                                            }

                                        });
                                    }
                                },
                                No: {}
                            }
                        });
                    };

                    $(viewerContainer).on("onDocumentLoadComplete", function () {
                        vmDocumentSign.relativeCorrection(adapter.originalPageWidth / adapter.pageImageWidth);
                        // resizeWindows is moved here because of IE9 js error regarding dvselectable
                        function resizeWindow() {
                            adapter.scale((($('.document_viewer').width() - 2 * adapter.imageHorizontalMargin - 20) / adapter.initialWidth));
                            adapter.setZoom((($('.document_viewer').width() - 2 * adapter.imageHorizontalMargin - 20) / adapter.initialWidth) * 100);
                            if ($(":focus").length > 0 && ko.contextFor($(":focus")[0]) != null && ko.contextFor($(":focus")[0]).$data != null && ko.contextFor($(":focus")[0]).$data.selected!=null) {
                                ko.contextFor($(":focus")[0]).$data.selected(true);
                                ko.contextFor($(":focus")[0]).$data.selected.valueHasMutated();
                            }
                        }
                        var doResize;
                        var winWidth = $(window).outerWidth(), winHeight = $(window).outerHeight();
                        $(window).resize(function (e) {
                            //workaround for IE9
                            if (vmSignaturePad.isVisible()) return false;
                            var winNewWidth = $(window).outerWidth(),
                                winNewHeight = $(window).outerHeight();
                            if (winWidth != winNewWidth || winHeight != winNewHeight) {
                                clearTimeout(doResize);
                                doResize = setTimeout(resizeWindow, 100);
                            }
                            winWidth = winNewWidth;
                            winHeight = winNewHeight;

                            //if ($(e.target).hasClass("signature_doc_field")) return;
                            //clearTimeout(doResize);
                            //doResize = setTimeout(resizeWindow, 100);
                        });
                    });

                    if (!config.checkFileApiSupport()) {
                        window.FileAPI = {
                            debug: false,
                            cors: false,
                            media: false,
                            staticPath: (config.isDownloadable ? config.downloadablePrefix : "") + '/scripts/lib/fileApi/',
                            flashImageUrl: '/scripts/lib/fileApi/FileAPI.flash.image.swf',
                            postNameConcat: function (name, idx) {
                                return name + (idx != null ? '[' + idx + ']' : '');
                            }
                        };
                        requirejs.undef('lib/fileApi/FileAPI');
                        requirejs(['lib/fileApi/FileAPI'], function () { });
                    }

                    vmDocumentSign.init();
                },
                bindViewModels = function () {
                    binder.bind($(signButtonContainer), vmDocumentSign);
                    if (isPublic) {
                        binder.bind($(viewerContainer).find('#errorDialog'), vmError);
                        binder.bind($(viewerContainer).find('#enter-name-dialog'), vmEnterName);
                    }
                },
                setupSignaturePad = function () {
                    binder.bind($(viewerContainer).find('.signature-dialog'), vmSignaturePad);
                    vmSignaturePad.expanded(false);
                    if (typeof(signatureColor) != "undefined")
                        vmSignaturePad.signatureColor(signatureColor);
                    vmSignaturePad.signatureColor.subscribe(function(newValue) {
                        $(viewerContainer).find("#signature-draw-container-" + vmSignaturePad.padIndex() + " path").css("fill", newValue);
                    });
                },
                
                init = function(container, options) {
                    viewerContainer = container;
                    viewerOptions = options;

                    viewer = vm.viewer(container, options);
                    signButton = options.signButton !== undefined ? $(options.signButton) : $(viewerContainer).find(".sign_document");
                    signButtonContainer = options.signButtonContainer !== undefined ? $(options.signButtonContainer) : $(viewerContainer).find('.sign_button_container');

                    setupSignaturePad();
                    initUi();
                    initViewModels();
                    bindViewModels();
                },
                // AcroJS calc field function
                AFSimple_Calculate = function (operator, items) {
                    var fields = ko.utils.arrayFilter(vmDocumentSign.fields(), function (field) {
                        return ko.utils.arrayFirst(items, function (item) {
                            return field.name() == item;
                        });
                    });
                    var fieldData = [];
                    $.each(fields, function (index, item) {
                        if (parseInt(item.data())) {
                            fieldData.push(parseInt(item.data()));
                        }
                    });
                    switch (operator) {
                        case "SUM":
                            var sum = 0;
                            $.each(fieldData, function (index, item) {
                                sum += parseInt(item) ? parseInt(item) : 0;
                            });
                            return sum;
                        case "PRD":
                            var prd = 1;
                            $.each(fieldData, function (index, item) {
                                prd *= parseInt(item) ? parseInt(item) : 1;
                            });
                            return prd;
                        case "AVG":
                            var avgSum = 0;
                            $.each(fieldData, function (index, item) {
                                avgSum += parseInt(item) ? parseInt(item) : 0;
                            });
                            var avg = avgSum / fieldData.length;
                            return avg;
                        case "MIN":
                            return Math.min.apply(Math, fieldData);
                        case "MAX":
                            return Math.max.apply(Math, fieldData);
                    };
                }

            return {
                init: init
            };
        }

        return getInstance;
    });

require(["signDocument"]);
define("prepareDocument",
    ['core/vm', 'core/binder', 'core/config', 'core/redirect'],
    function (vm, binder, config, redirect) {
        function getInstance() {
            var viewerContainer,
                vmViewer,
                viewerOptions = {},
                vmDocumentPrepare = vm.documentPrepare(),
                deselectField = function() {
                    $("input").blur();
                    $("textarea").blur();
                    $("select").blur();
                    $.each(vmDocumentPrepare.fields(), function() {
                        $.each(this.locations(), function() {
                            this.selected(false);
                        });
                    });
                    vmDocumentPrepare.selectedField(null);
                    vmDocumentPrepare.selectedLocation(null);
                },
                
                initViewer = function () {
                    
                    var adapter = vmViewer.adapter('embed');
                    adapter.docViewerViewModel.vm = vmDocumentPrepare;
                    adapter.docViewerWidget.bind('onDocumentLoadComplete', function(e, data) {
                        vmDocumentPrepare.loadSignatureFields();
                        // fix issue with IE causing the page to scroll to top when the page is clicked
                        $(viewerContainer).find(".pages_container").unbind("click");
                    });
                    if (config.isDownloadable && (typeof viewerOptions !== 'undefined') && viewerOptions.documentGuid != '' && viewerOptions.recipientGuid != '') {
                        vmDocumentPrepare.getSignatureDocument(viewerOptions.documentGuid, viewerOptions.recipientGuid, function(doc) {
                            adapter.docViewerViewModel.loadDocument(doc.name);

                        });
                    }
                    else
                        vmViewer.adapter().docViewerViewModel.loadDocument(documentId);
                    if ((typeof viewerOptions !== 'undefined') && viewerOptions.dateFormats != null && viewerOptions.dateFormats.length > 0) {
                        vmDocumentPrepare.dateFormats(viewerOptions.dateFormats);
                    }

                    $(document).keyup(function(event) {
                        $(".toolTip").tooltip('enable');
                    });
                    $(document).keydown(function(event) {
                        $(".toolTip").tooltip('hide');
                        $(".toolTip").tooltip('disable');
                        if ($(event.target).is('input') || $(event.target).is('textarea')) return true;
                        var field = vmDocumentPrepare.selectedField();
                        var location = vmDocumentPrepare.selectedLocation();
                        if (field == null || location == null)
                            return;
                        var pageImageWidth = vmViewer.adapter().docViewerViewModel.pageWidth();
                        var pageImageHeight = vmViewer.adapter().docViewerViewModel.pageHeight();
                        if (field != null && location != null) {
                            switch (event.keyCode) {
                            case 37: //left
                                if (event.ctrlKey) {
                                    if (location.locationX() - 1 / pageImageWidth > 0) {
                                        location.locationWidth(location.locationWidth() - 1);
                                        if (field.fieldType() == config.signatureFieldType.Signature)
                                            location.locationHeight(location.locationWidth() / 3);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                } else {
                                    if (location.locationX() - 1 / pageImageWidth > 0) {
                                        location.locationX(location.locationX() - 1 / pageImageWidth);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                }
                                break;
                            case 38: //up
                                if (event.ctrlKey) {
                                    if ((location.locationY() - 1 / pageImageHeight) > 0) {
                                        location.locationHeight(location.locationHeight() - 1);
                                        if (field.fieldType() == config.signatureFieldType.Signature)
                                            location.locationWidth(location.locationHeight() * 3);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                } else {
                                    if ((location.locationY() - 1 / pageImageHeight) > 0) {
                                        location.locationY(location.locationY() - 1 / pageImageHeight);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                }
                                break;
                            case 39: //right
                                if (event.ctrlKey) {
                                    var allowed = true;
                                    if (field.fieldType() == config.signatureFieldType.Signature) {
                                        var newHeight = (location.locationWidth() + 1) / 3;
                                        if (pageImageHeight * location.locationY() + newHeight >= pageImageHeight)
                                            allowed = false;
                                    }
                                    if (allowed && (pageImageWidth * location.locationX() + location.locationWidth() < pageImageWidth)) {
                                        location.locationWidth(location.locationWidth() + 1);
                                        if (field.fieldType() == config.signatureFieldType.Signature)
                                            location.locationHeight(location.locationWidth() / 3);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                } else {
                                    if (pageImageWidth * location.locationX() + location.locationWidth() < pageImageWidth) {
                                        location.locationX(location.locationX() + 1 / pageImageWidth);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                }
                                break;
                            case 40: //down
                                if (event.ctrlKey) {
                                    allowed = true;
                                    if (field.fieldType() == config.signatureFieldType.Signature) {
                                        var newWidth = (location.locationHeight() + 1) * 3;
                                        if (pageImageWidth * location.locationX() + newWidth >= pageImageWidth)
                                            allowed = false;
                                    }
                                    if (allowed && (pageImageHeight * location.locationY() + location.locationHeight() < pageImageHeight)) {
                                        location.locationHeight(location.locationHeight() + 1);
                                        if (field.fieldType() == config.signatureFieldType.Signature)
                                            location.locationWidth(location.locationHeight() * 3);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                } else {
                                    if (pageImageHeight * location.locationY() + location.locationHeight() < pageImageHeight) {
                                        location.locationY(location.locationY() + 1 / pageImageHeight);
                                        vmDocumentPrepare.updateMovedField(location, event);
                                    }
                                }
                                break;
                            case 67: //c
                                if (event.ctrlKey) {
                                    vmDocumentPrepare.copyFieldLocation(field, location);
                                }
                                break;
                            case 88: //x
                                if (event.ctrlKey) {
                                    vmDocumentPrepare.cutFieldLocation(field, location);
                                }
                                break;
                            case 46: //del
                                $.confirm({
                                    title: "Delete confirmation",
                                    message: "Are you sure you want to delete this field?",
                                    zIndex: '5050',
                                    buttons: {
                                        Yes: {
                                            'class': "",
                                            'action': function() {
                                                vmDocumentPrepare.deleteFieldLocation(field, location);
                                            }
                                        },
                                        No: {}
                                    }
                                });
                                break;
                            case 9: //tab
                                var locations = ko.observableArray([]);
                                    $.each(vmDocumentPrepare.fields(), function() {
                                        $.each(this.locations(), function() {
                                            locations.push(this);
                                        });
                                });


                                locations.sort(function(left, right) {
                                    return left.page() + left.locationY() == right.page() + right.locationY() ? 0 : (left.page() + left.locationY() < right.page() + right.locationY() ? -1 : 1);
                                });
                                var prevLocation;
                                var selectedLocationIndex = locations.indexOf(location);
                                if (event.shiftKey) {
                                    if (selectedLocationIndex > 0) {
                                        prevLocation = locations()[selectedLocationIndex - 1];
                                    } else {
                                        prevLocation = locations()[locations().length - 1];
                                    }
                                    prevLocation.selected(true);
                                    location.selected(false);
                                    vmDocumentPrepare.selectedField(
                                        $.grep(vmDocumentPrepare.fields(), function(f) {
                                            return f.id() == prevLocation.fieldId();
                                        })[0]);
                                    vmDocumentPrepare.selectedLocation(prevLocation);
                                    $("input").blur();
                                    $("textarea").blur();
                                    $("select").blur();

                                } else {
                                    var nextLocation;
                                    if (locations().length > selectedLocationIndex + 1) {
                                        nextLocation = locations()[selectedLocationIndex + 1];
                                    } else {
                                        nextLocation = locations()[0];
                                    }
                                    nextLocation.selected(true);
                                    location.selected(false);
                                    vmDocumentPrepare.selectedField(
                                        $.grep(vmDocumentPrepare.fields(), function(f) {
                                            return f.id() == nextLocation.fieldId();
                                        })[0]);
                                    vmDocumentPrepare.selectedLocation(nextLocation);
                                    $("input").blur();
                                    $("textarea").blur();
                                    $("select").blur();
                                }

                                var selectedField = $(".signature_doc_field.active");
                                if (selectedField.length == 1) {
                                    $('html, body').animate({
                                        scrollTop: selectedField.offset().top - 350
                                    }, 300);
                                }
                                break;
                            case 27: // esc
                                    deselectField();
                                break;
                            }
                        }
                        switch (event.keyCode) {
                        case 86: //v
                            if (event.ctrlKey && !event.shiftKey) {
                                vmDocumentPrepare.pasteNewField();
                            }
                            if (event.ctrlKey && event.shiftKey) {
                                vmDocumentPrepare.pasteNewLocation();
                            }
                            break;
                        case 49: //1
                            if (event.ctrlKey) {
                                vmDocumentPrepare.addFieldFromMenu(1);
                            }
                            break;
                        case 50: //2
                            if (event.ctrlKey) {
                                vmDocumentPrepare.addFieldFromMenu(2);
                            }
                            break;
                        case 51: //3
                            if (event.ctrlKey) {
                                vmDocumentPrepare.addFieldFromMenu(3);
                            }
                            break;
                        case 52: //4
                            if (event.ctrlKey) {
                                vmDocumentPrepare.addFieldFromMenu(4);
                            }
                            break;
                        case 53: //5
                            if (event.ctrlKey) {
                                vmDocumentPrepare.addFieldFromMenu(5);
                            }
                            break;
                        case 54: //6
                            if (event.ctrlKey) {
                                vmDocumentPrepare.addFieldFromMenu(6);
                            }
                            break;
                        }
                        return false;
                    });
                },
                initUi = function () {
                    $('link[rel=stylesheet][href*="signature/jqueryUI"]').remove();
                    $('.toolTip').tooltip();
                    $(".sidebar_tabs").tabs();
                    $.ctrl = function() {};

                    $("#tabs-3").delegate(".listbox", "click", function() {
                        vmDocumentPrepare.manageFields(ko.contextFor(this).$data.documentId());
                        return false;
                    });


                    $(".step5_wrapper").delegate(".prev-field", "click", function () {
                        var e = jQuery.Event("keydown");
                        e.keyCode = 9;
                        e.shiftKey = true;
                        $(document).trigger(e);
                        return false;
                    });
                    $(".step5_wrapper").delegate(".next-field", "click", function () {
                        var e = jQuery.Event("keydown");
                        e.keyCode = 9;
                        $(document).trigger(e);
                        return false;
                    });

                    $(".cancel_prepare").click(function() {
                        vmDocumentPrepare.cancelPrepare();
                        return false;
                    });

                    $(".document_viewer").delegate(".signature_doc_field", "click touchend", function() {
                        var location = ko.contextFor(this).$data;
                        var field = ko.contextFor(this).$parents[1];
                        if (vmDocumentPrepare.selectedLocation() != location) {
                            deselectField();
                            location.selected(true);
                            vmDocumentPrepare.selectedField(field);
                            vmDocumentPrepare.selectedLocation(location);
                        }
                        return false;
                    });
                    $(".document_viewer").delegate(".page-image", "click", function() {
                        deselectField();
                        return false;
                    });
                    $(".document_viewer").delegate(".signature_doc_field .popclose, .signature_doc_field .ta_del", "click", function() {
                        var location = ko.contextFor(this).$data;
                        var field = ko.contextFor(this).$parents[1];
                        $.confirm({
                            title: "Delete confirmation",
                            message: "Are you sure you want to delete this field?",
                            zIndex: '5050',
                            buttons: {
                                Yes: {
                                    'class': "",
                                    'action': function() {
                                        vmDocumentPrepare.deleteFieldLocation(field, location);;
                                        vmDocumentPrepare.selectedField(null);
                                        vmDocumentPrepare.selectedLocation(null);

                                    }
                                },
                                No: {}
                            }
                        });
                        return false;
                    });
                    $(".document_viewer").bind('onDocumentLoadComplete', function(e, data) {

                        var pageImageWidth = vmViewer.adapter().docViewerViewModel.pageWidth();
                        var pageImageHeight = vmViewer.adapter().docViewerViewModel.pageHeight();
                        vmDocumentPrepare.pageHeight(pageImageHeight);
                        vmDocumentPrepare.pageWidth(pageImageWidth);

                    });

                    $(".step5_wrapper").delegate(".close_settings", "click", function() {
                        deselectField();
                        return false;
                    });
                    

                    $(".step5_wrapper").delegate("ul.dropdown_values_list li", "click", function() {
                        vmDocumentPrepare.selectDefaultValue(ko.contextFor(this).$data);
                        return false;
                    });
                    $(".step5_wrapper").delegate("ul.dropdown_values_list a.delete", "click", function() {
                        vmDocumentPrepare.deleteAcceptableValue(ko.contextFor(this).$data);
                        return false;
                    });
                    $(".step5_wrapper").delegate(".copy-field", "click", function() {
                        vmDocumentPrepare.copyFieldLocation(vmDocumentPrepare.selectedField(), vmDocumentPrepare.selectedLocation());
                        return false;
                    });

                    $(".step5_wrapper").delegate(".paste-field", "click", function() {
                        $.confirm({
                            title: "Copy confirmation",
                            message: "You can copy field as a new field or to create a new location for the copied field. What do you want to do?",
                            zIndex: '5050',
                            buttons: {
                                'Copy Field': {
                                    'class': "btn red_button",
                                    'action': function() {
                                        vmDocumentPrepare.pasteNewField();
                                    }
                                },
                                'Create new location': {
                                    'class': "btn red_button",
                                    'action': function() {
                                        vmDocumentPrepare.pasteNewLocation();
                                    }
                                },
                                Cancel: {
                                    'class': "btn right"
                                }
                            }
                        });
                        return false;
                    });
                    $('.toolTip').tooltip();

                    var stickyNavigationOffsetTop = 90;
                    var stickyNavigation = function() {
                        //if ($.active > 0)
                        //    return;
                        var scrollTop = $(window).scrollTop() - stickyNavigationOffsetTop + 100;
                        var leftPos = 890;
                        if ($(".document_viewer").width() + $('.step5_tool_wrapper').width() > $(window).width()) {
                            leftPos = $(window).width() - $('.step5_tool_wrapper').width() - 50;
                        }
                        if (scrollTop > 0) {
                            $('.step5_tool_wrapper').css({ 'position': 'absolute', 'top': scrollTop + 'px', 'left': leftPos + 'px' });
                        } else {
                            $('.step5_tool_wrapper').css({ 'position': 'absolute', 'top': 'auto', 'left': leftPos + 'px' });
                        }
                    };
                    stickyNavigation();
                    $(window).scroll(function() {
                        stickyNavigation();
                    });

                    vmDocumentPrepare.selectedField.subscribe(function (newValue) {
                        $(".sidebar_tabs").tabs("select", 0);
                    });

                    vmDocumentPrepare.selectedLocation.subscribe(function (newValue) {
                        if (newValue == null) {
                            $(".signature_doc_field").tooltip('enable');
                        } else {
                            $(".signature_doc_field.active").tooltip('hide');
                            $(".signature_doc_field.active").tooltip('disable');
                        }
                    });

                    $('html').click(function() {
                        if ($(".dropdown_menu_button").hasClass('active')) {
                            $(".dropdown_menu_button.active").next(".dropdown_menu").hide('blind', 'fast');
                            $(".dropdown_menu_button.active").removeClass("active");
                        }
                        $(".toolTip").tooltip('hide');
                    });


                },

                init = function(container, options) {
                    viewerContainer = container;
                    viewerOptions = options;
                    vmDocumentPrepare.documentId(documentId);
                    vmDocumentPrepare.viewerContainer(viewerContainer);

                    binder.bind($(viewerContainer), vmDocumentPrepare);
                    $("#thumbs_btn").hide();
                    vmViewer = vm.viewer(container, options);
                    initViewer();

                    initUi();

                    vmDocumentPrepare.previewDocument(documentId);

                };

           
            return {
                init: init
            };
        }
        return getInstance;
    });
require(["prepareDocument"]);
